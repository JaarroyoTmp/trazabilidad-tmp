<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TMP ¬∑ Alta / Edici√≥n / Baja de Instrumentos</title>

  <!-- Lector QR con c√°mara -->
  <script src="https://unpkg.com/html5-qrcode@2.3.8/minified/html5-qrcode.min.js"></script>

  <style>
    :root{
      --bg:#0f1b2d;
      --panel:#12233b;
      --muted:#a9b4c3;
      --txt:#e8f0ff;
      --primary:#1e88e5;
      --primary-600:#1565c0;
      --accent:#ff8f00;
      --danger:#e53935;
      --ok:#2e7d32;
      --chip:#20324b;
      --input:#0b1627;
      --border:#1c2a44;
    }
    *{box-sizing:border-box;}
    body{
      margin:0;
      font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Ubuntu;
      background:var(--bg);
      color:var(--txt);
    }
    header{
      padding:14px 18px;
      border-bottom:1px solid var(--border);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:14px;
      background:linear-gradient(180deg,#0f1b2d 0,#0f1b2df0 100%);
      position:sticky;
      top:0;
      z-index:10;
    }
    .brand-wrap{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .brand-logo{
      height:42px;
      width:auto;
    }
    .brand-titles{
      display:flex;
      flex-direction:column;
    }
    .brand-titles h1{
      margin:0;
      font-size:1.15rem;
    }
    .brand-titles span{
      font-size:.8rem;
      color:var(--muted);
    }
    .chip{
      background:var(--chip);
      color:#cfe1ff;
      padding:6px 10px;
      border-radius:999px;
      font-size:.8rem;
      border:1px solid var(--border);
    }
    .btn-header{
      border-radius:999px;
      border:1px solid var(--border);
      background:transparent;
      color:#cfe1ff;
      padding:8px 14px;
      font-size:.85rem;
      cursor:pointer;
    }
    .btn-header:hover{
      background:#14233a;
    }
    main{
      max-width:1000px;
      margin:20px auto 40px;
      padding:0 16px;
    }

    .tabs{
      display:flex;
      gap:8px;
      margin:10px 0 18px;
      flex-wrap:wrap;
    }
    .tab{
      background:var(--chip);
      border:1px solid var(--border);
      color:#cfe1ff;
      padding:8px 14px;
      border-radius:10px;
      cursor:pointer;
      font-weight:600;
      font-size:.9rem;
    }
    .tab.active{
      background:var(--primary);
      border-color:transparent;
      color:#fff;
    }

    .panel{
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:16px;
      padding:18px;
      display:none;
    }
    .panel.active{display:block;}

    h2{
      margin:0 0 12px;
      font-size:1.1rem;
    }

    .grid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:16px;
    }
    @media(max-width:900px){
      .grid{grid-template-columns:1fr;}
    }

    .row{display:flex; gap:10px; flex-wrap:wrap;}
    label{
      display:block;
      font-size:.85rem;
      color:#cfe1ff;
      margin-bottom:4px;
    }
    input,select,textarea{
      width:100%;
      background:var(--input);
      color:var(--txt);
      border-radius:10px;
      border:1px solid var(--border);
      padding:9px 11px;
      font-size:.95rem;
    }
    textarea{min-height:80px;resize:vertical;}

    .actions{
      display:flex; gap:10px; flex-wrap:wrap; margin-top:12px;
    }
    .btn{
      border-radius:10px;
      padding:9px 13px;
      font-size:.9rem;
      font-weight:600;
      cursor:pointer;
      display:inline-flex; align-items:center; gap:6px;
    }
    .btn-primary{background:var(--primary); color:#fff;}
    .btn-primary:hover{background:var(--primary-600);}
    .btn-accent{background:var(--accent); color:#132235;}
    .btn-warn{background:var(--danger); color:#fff;}
    .btn-ghost{background:transparent; border:1px solid var(--border); color:#cfe1ff;}
    .btn-ghost:hover{background:#14233a;}

    .alert{margin-top:14px; padding:10px 12px; border-radius:10px; border:1px solid transparent;}
    .alert.ok{background:#17351d; color:#baf3c1; border-color:#214d28;}
    .alert.err{background:#3a1414; color:#ffb3b2; border-color:#572222;}
    .alert.info{background:#102941; color:#b3d6ff; border-color:#1d3b60;}
    .hidden{display:none;}

    .qr-box{
      background:#0c1a2c;
      border:1px dashed var(--border);
      border-radius:12px;
      height:320px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:.9rem;
      text-align:center;
      color:var(--muted);
    }

    .btn-float{
      position:fixed;
      right:20px;
      bottom:20px;
      background:#1e88e5;
      color:#fff;
      border:none;
      border-radius:999px;
      padding:9px 18px;
      cursor:pointer;
      font-size:.9rem;
      box-shadow:0 0 10px rgba(0,0,0,.4);
      z-index:20;
    }
    .btn-float:hover{background:#1565c0;}
  </style>
</head>

<body>

<header>
  <div class="brand-wrap">
    <img src="img/tmp-quality.png" alt="TMP" class="brand-logo">
    <div class="brand-titles">
      <h1>TMP ¬∑ Control Metrol√≥gico</h1>
      <span>Alta, edici√≥n y baja de instrumentos</span>
    </div>
  </div>

  <button class="btn-header" onclick="window.location.href='home.html'">üè† Volver al panel</button>
</header>

<main>
  <div class="tabs">
    <button id="tabAlta" class="tab active">Alta / Edici√≥n</button>
    <button id="tabBaja" class="tab">Baja por QR / C√≥digo</button>
  </div>

  <!-- PANEL ALTA -->
  <section id="panelAlta" class="panel active">
    <h2>Ficha del instrumento</h2>
    <div id="msgAlta" class="alert info hidden"></div>

    <div class="grid">

      <!-- C√ìDIGO -->
      <div>
        <label>C√≥digo (√∫nico) *</label>
        <div class="row">
          <input id="codigo" placeholder="Ej. 400600">
          <button class="btn btn-ghost" id="btnBuscarCodigo">Buscar</button>
        </div>
      </div>

      <div>
        <label>Descripci√≥n *</label>
        <input id="descripcion" placeholder="Ej. Tamp√≥n liso P/NP">
      </div>

      <div>
        <label>Fabricante *</label>
        <input id="fabricante" placeholder="Ej. Mitutoyo">
      </div>

      <div>
        <label>Rango / Especificaci√≥n</label>
        <input id="rango" placeholder="Ej. √ò8 H7">
      </div>

      <div>
        <label>Precisi√≥n</label>
        <input id="precision" placeholder="Ej. 0.01 mm / Atributo">
      </div>

      <div>
        <label>Tipo de calibraci√≥n</label>
        <input id="tipo_calibracion" placeholder="Interna / Externa">
      </div>

      <!-- ‚úî √öNICO CAMPO DE UBICACI√ìN REAL -->
      <div>
        <label>Ubicaci√≥n actual / Destino</label>
        <input id="ubicacion_actual" placeholder="Laboratorio, Producci√≥n, Mantenimiento, Cliente...">
      </div>

      <div>
        <label>√öltima calibraci√≥n</label>
        <input id="fecha_calibracion" type="date">
      </div>

      <div>
        <label>Pr√≥xima calibraci√≥n</label>
        <input id="fecha_proxima_calibracion" type="date">
      </div>

      <div style="grid-column:1/-1">
        <label>Observaciones</label>
        <textarea id="observaciones" placeholder="Notas internas, incidencia, cliente, etc."></textarea>
      </div>

    </div>

    <div class="actions">
      <button class="btn btn-primary" id="btnGuardar">üíæ Guardar / Actualizar</button>
      <button class="btn btn-accent" id="btnLimpiar">üßΩ Limpiar</button>
    </div>

  </section>

  <!-- PANEL BAJA -->
  <section id="panelBaja" class="panel">
    <h2>Dar de baja por QR / c√≥digo</h2>
    <div id="msgBaja" class="alert info hidden"></div>

    <div class="grid">
      <div>
        <div id="qrReader" class="qr-box">
          Enfoca el c√≥digo QR del instrumento.
        </div>

        <div class="actions" style="margin-top:10px">
          <button class="btn btn-primary" id="btnIniciarEscaneo">üì∑ Iniciar escaneo</button>
          <button class="btn btn-ghost" id="btnDetenerEscaneo">‚úã Detener</button>
        </div>
      </div>

      <div>
        <label>Dar de baja manualmente</label>
        <div class="row">
          <input id="codigoBaja" placeholder="C√≥digo del instrumento">
          <button class="btn btn-warn" id="btnBajaManual">üóë Dar de baja</button>
        </div>
      </div>
    </div>
  </section>
</main>

<button class="btn-float" onclick="window.location.href='home.html'">üè† Inicio</button>
<!-- Configuraci√≥n Supabase -->
<script type="module" src="config.mjs"></script>

<!-- L√≥gica principal -->
<script type="module">

  const supabase = window.supabase;
  const $ = id => document.getElementById(id);

  const msgAlta = $("msgAlta");
  const msgBaja = $("msgBaja");

  const f = {
    codigo: $("codigo"),
    descripcion: $("descripcion"),
    fabricante: $("fabricante"),
    rango: $("rango"),
    precision: $("precision"),
    tipo_calibracion: $("tipo_calibracion"),
    ubicacion_actual: $("ubicacion_actual"),
    fecha_calibracion: $("fecha_calibracion"),
    fecha_proxima_calibracion: $("fecha_proxima_calibracion"),
    observaciones: $("observaciones"),
  };

  function showMsg(el, text, type="info") {
    el.className = "alert " + type;
    el.textContent = text;
    el.classList.remove("hidden");
  }
  function hideMsg(el){
    el.classList.add("hidden");
  }

  /* ============================
     TABS
  ============================ */
  const tabAlta = $("tabAlta");
  const tabBaja = $("tabBaja");
  const panelAlta = $("panelAlta");
  const panelBaja = $("panelBaja");

  tabAlta.onclick = () => {
    tabAlta.classList.add("active");
    tabBaja.classList.remove("active");
    panelAlta.classList.add("active");
    panelBaja.classList.remove("active");
  };

  tabBaja.onclick = () => {
    tabBaja.classList.add("active");
    tabAlta.classList.remove("active");
    panelBaja.classList.add("active");
    panelAlta.classList.remove("active");
  };

  /* ============================
     LIMPIAR FORMULARIO
  ============================ */
  function limpiarFormulario(){
    for(const key in f){ f[key].value = ""; }
    hideMsg(msgAlta);
  }

  $("btnLimpiar").onclick = limpiarFormulario;

  /* ============================
     BUSCAR POR C√ìDIGO
  ============================ */
  async function buscarPorCodigo(){
    hideMsg(msgAlta);

    const codigo = f.codigo.value.trim();
    if(!codigo){
      showMsg(msgAlta,"Introduce un c√≥digo.","err");
      return;
    }

    const { data, error } = await supabase
      .from("instrumentos")
      .select("*")
      .eq("codigo", codigo)
      .maybeSingle();

    if(error){
      console.error(error);
      showMsg(msgAlta,"Error al buscar: " + error.message,"err");
      return;
    }

    if(!data){
      showMsg(msgAlta,`No existe el c√≥digo ${codigo}. Se crear√° al guardar.`,"info");
      limpiarFormulario();
      f.codigo.value = codigo;
      return;
    }

    // Cargar datos
    f.descripcion.value = data.descripcion ?? "";
    f.fabricante.value = data.fabricante ?? "";
    f.rango.value = data.rango ?? "";
    f.precision.value = data.precision ?? "";
    f.tipo_calibracion.value = data.tipo_calibracion ?? "";
    f.ubicacion_actual.value = data.ubicacion_actual ?? "";
    f.fecha_calibracion.value = (data.fecha_calibracion ?? "").substring(0,10);
    f.fecha_proxima_calibracion.value = (data.fecha_proxima_calibracion ?? "").substring(0,10);
    f.observaciones.value = data.observaciones ?? "";

    showMsg(msgAlta,`Instrumento ${codigo} cargado.`,"ok");
  }

  $("btnBuscarCodigo").onclick = buscarPorCodigo;

  f.codigo.addEventListener("keydown", e => {
    if(e.key === "Enter"){
      e.preventDefault();
      buscarPorCodigo();
    }
  });

  /* ============================
     GUARDAR / UPSERT
  ============================ */
  async function guardarInstrumento(){
    hideMsg(msgAlta);

    const codigo = f.codigo.value.trim();
    const descripcion = f.descripcion.value.trim();
    const fabricante = f.fabricante.value.trim();

    if(!codigo || !descripcion || !fabricante){
      showMsg(msgAlta,"C√≥digo, descripci√≥n y fabricante son obligatorios.","err");
      return;
    }

    // Generaci√≥n del QR
    const baseUrl =
      window.location.origin && window.location.origin !== "null"
        ? window.location.origin + "/qr/"
        : "https://trazabilidad-tmp.vercel.app/qr/";

    const qr_link = baseUrl + encodeURIComponent(codigo);
    const qr_url =
      "https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=" +
      encodeURIComponent(qr_link);

    const payload = {
      codigo,
      descripcion,
      fabricante,
      rango: f.rango.value || null,
      precision: f.precision.value || null,
      tipo_calibracion: f.tipo_calibracion.value || null,
      ubicacion_actual: f.ubicacion_actual.value || null,
      fecha_calibracion: f.fecha_calibracion.value || null,
      fecha_proxima_calibracion: f.fecha_proxima_calibracion.value || null,
      observaciones: f.observaciones.value || null,
      qr_url,
      qr_link
    };

    const { error } = await supabase
      .from("instrumentos")
      .upsert(payload, { onConflict: "codigo" });

    if(error){
      console.error(error);
      showMsg(msgAlta,"Error al guardar: " + error.message,"err");
      return;
    }

    showMsg(msgAlta,`Instrumento ${codigo} guardado correctamente.`,"ok");
  }

  $("btnGuardar").onclick = guardarInstrumento;

  /* ============================
     BAJA T√âCNICA POR QR / C√ìDIGO
  ============================ */
  let html5Qr = null;

  async function iniciarEscaneo(){
    hideMsg(msgBaja);

    try{
      if(!html5Qr){
        html5Qr = new Html5Qrcode("qrReader");
      }

      const config = {
        fps: 10,
        qrbox: { width: 220, height: 220 }
      };

      await html5Qr.start(
        { facingMode: "environment" },
        config,
        async decodedText => {
          await detenerEscaneo();

          let code = decodedText;

          // Si el QR contiene /qr/CODIGO
          if(decodedText.startsWith("http")){
            const parts = decodedText.split("/");
            code = decodeURIComponent(parts.filter(Boolean).pop());
          }

          confirmarBaja(code);
        }
      );

      showMsg(msgBaja,"Escaneando...","info");
    } catch(e){
      console.error(e);
      showMsg(msgBaja,"No se pudo iniciar la c√°mara.","err");
    }
  }

  async function detenerEscaneo(){
    try{
      if(html5Qr && html5Qr.isScanning){
        await html5Qr.stop();
      }
      if(html5Qr){ await html5Qr.clear(); }
    }catch(e){ console.error(e); }
  }

  async function confirmarBaja(codigo){
    const ok = confirm(`‚ö†Ô∏è ¬øDeseas dar de BAJA T√âCNICA el instrumento ${codigo}?`);
    if(!ok) return;

    const { error } = await supabase
      .from("instrumentos")
      .delete()
      .eq("codigo", codigo);

    if(error){
      console.error(error);
      showMsg(msgBaja,"Error al eliminar: " + error.message,"err");
      return;
    }

    showMsg(msgBaja,`Instrumento ${codigo} eliminado.`,"ok");
  }

  $("btnIniciarEscaneo").onclick = iniciarEscaneo;
  $("btnDetenerEscaneo").onclick = detenerEscaneo;

  $("btnBajaManual").onclick = () => {
    const code = $("codigoBaja").value.trim();
    if(!code){
      showMsg(msgBaja,"Introduce un c√≥digo.","err");
      return;
    }
    confirmarBaja(code);
  };

</script>

</body>
</html>
