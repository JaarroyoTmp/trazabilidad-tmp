<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TMP ¬∑ Alta / Edici√≥n de Instrumentos</title>

  <style>
    :root{
      --bg:#0f1b2d;
      --panel:#12233b;
      --muted:#a9b4c3;
      --txt:#e8f0ff;
      --primary:#1e88e5;
      --primary-600:#1565c0;
      --accent:#ff8f00;
      --danger:#e53935;
      --chip:#20324b;
      --input:#0b1627;
      --border:#1c2a44;
    }

    *{box-sizing:border-box;}

    body{
      margin:0;
      background:var(--bg);
      color:var(--txt);
      font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto;
    }

    header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:16px 20px;
      border-bottom:1px solid var(--border);
      background:#0f1b2d;
    }

    main{
      max-width:950px;
      margin:20px auto 40px;
      padding:0 18px;
    }

    h2{ margin:0 0 12px; }

    .panel{
      background:var(--panel);
      border-radius:14px;
      padding:18px;
      border:1px solid var(--border);
    }

    label{
      display:block;
      margin-bottom:4px;
      font-size:.9rem;
    }

    input,textarea{
      width:100%;
      background:var(--input);
      border:1px solid var(--border);
      border-radius:10px;
      padding:10px;
      color:var(--txt);
      font-size:.95rem;
      outline:none;
    }

    input:focus,textarea:focus{
      border-color:var(--primary);
      box-shadow:0 0 0 1px rgba(30,136,229,.4);
    }

    .grid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:16px;
    }

    @media(max-width:800px){
      .grid{grid-template-columns:1fr;}
    }

    .btn{
      padding:10px 16px;
      border-radius:10px;
      border:0;
      cursor:pointer;
      font-weight:600;
      font-size:.9rem;
    }

    .btn-primary{
      background:var(--primary);
      color:#fff;
    }

    .btn-primary:hover{
      background:var(--primary-600);
    }

    .btn-ghost{
      background:transparent;
      border:1px solid var(--border);
      color:var(--txt);
    }

    .alert{
      margin-top:14px;
      padding:10px;
      border-radius:10px;
      font-weight:500;
      border:1px solid transparent;
    }

    .alert.ok{
      background:#17351d;
      border-color:#235a2f;
      color:#c6f7cb;
    }

    .alert.err{
      background:#3a1414;
      border-color:#571f1f;
      color:#ffb3b0;
    }

    .alert.info{
      background:#102941;
      border-color:#1c3b60;
      color:#b3d6ff;
    }

    .hidden{display:none;}

    .row{
      display:flex;
      gap:12px;
      margin-top:14px;
    }
  </style>
</head>

<body>

<header>
  <div style="display:flex;align-items:center;gap:12px;">
    <img src="img/tmp-quality.png" height="42" />
    <div>
      <div style="font-weight:700;">TMP ¬∑ Alta / Edici√≥n</div>
      <div style="font-size:13px;color:var(--muted);">Gesti√≥n de instrumentos</div>
    </div>
  </div>

  <button class="btn btn-ghost" onclick="window.location.href='home.html'">üè† Volver</button>
</header>

<main>

  <section class="panel">
    <h2>Ficha del instrumento</h2>
    <div id="msg" class="alert hidden"></div>

    <div class="grid">

      <div>
        <label>C√≥digo (√∫nico) *</label>
        <div style="display:flex;gap:10px;">
          <input id="codigo" placeholder="Ej: 400600">
          <button id="btnBuscar" class="btn btn-ghost">Buscar</button>
        </div>
      </div>

      <div>
        <label>Descripci√≥n *</label>
        <input id="descripcion" placeholder="Ej: Calibre 150 mm">
      </div>

      <div>
        <label>Fabricante *</label>
        <input id="fabricante" placeholder="Ej: Mitutoyo">
      </div>

      <div>
        <label>Rango</label>
        <input id="rango" placeholder="Ej: 0-150 mm">
      </div>

      <div>
        <label>Precisi√≥n</label>
        <input id="precision" placeholder="Ej: 0.01 mm">
      </div>

      <div>
        <label>Tipo de calibraci√≥n</label>
        <input id="tipo_calibracion" placeholder="Interna / Externa">
      </div>

      <div>
        <label>√öltima calibraci√≥n</label>
        <input id="fecha_calibracion" type="date">
      </div>

      <div>
        <label>Pr√≥xima calibraci√≥n</label>
        <input id="fecha_proxima_calibracion" type="date">
      </div>

      <!-- NUEVO CAMPO DESTINO -->
      <div style="grid-column:1/-1;">
        <label>DESTINO (ubicaci√≥n actual)</label>
        <input id="destino" placeholder="Ej: Laboratorio, Producci√≥n, Cliente, M√°quina 4...">
      </div>

      <div style="grid-column:1/-1;">
        <label>Observaciones</label>
        <textarea id="observaciones" placeholder="Notas internas"></textarea>
      </div>

    </div>

    <div class="row">
      <button id="btnGuardar" class="btn btn-primary">üíæ Guardar / Actualizar</button>
      <button id="btnLimpiar" class="btn btn-ghost">Limpiar</button>
    </div>
  </section>

</main>

<script type="module" src="config.mjs"></script>

<script type="module">
  const sb = window.supabase;

  const $ = id => document.getElementById(id);
  const msg = $("msg");

  function showMsg(text, type){
    msg.textContent = text;
    msg.className = "alert " + type;
    msg.classList.remove("hidden");
  }

  function hideMsg(){ msg.classList.add("hidden"); }

  const f = {
    codigo: $("codigo"),
    descripcion: $("descripcion"),
    fabricante: $("fabricante"),
    rango: $("rango"),
    precision: $("precision"),
    tipo_calibracion: $("tipo_calibracion"),
    fecha_calibracion: $("fecha_calibracion"),
    fecha_proxima_calibracion: $("fecha_proxima_calibracion"),
    destino: $("destino"),
    observaciones: $("observaciones"),
  };

  function limpiar(){
    for (const k in f) f[k].value = "";
    hideMsg();
  }

  async function buscar(){
    hideMsg();
    const code = f.codigo.value.trim();
    if (!code){
      showMsg("Introduce un c√≥digo.", "err");
      return;
    }

    const { data, error } = await sb
      .from("instrumentos")
      .select("*")
      .eq("codigo", code)
      .maybeSingle();

    if (error){
      console.error(error);
      showMsg("Error buscando instrumento.", "err");
      return;
    }

    if (!data){
      showMsg(`No existe ${code}. Se crear√° uno nuevo.`, "info");
      return;
    }

    // Cargar datos (NO tocamos ubicacion_actual aqu√≠)
    f.descripcion.value = data.descripcion || "";
    f.fabricante.value = data.fabricante || "";
    f.rango.value = data.rango || "";
    f.precision.value = data.precision || "";
    f.tipo_calibracion.value = data.tipo_calibracion || "";
    f.fecha_calibracion.value = (data.fecha_calibracion || "").substring(0,10);
    f.fecha_proxima_calibracion.value = (data.fecha_proxima_calibracion || "").substring(0,10);
    f.observaciones.value = data.observaciones || "";

    // DESTINO SOLO INFORMAR, NO SE USA PARA ACTUALIZAR EN EDICI√ìN
    f.destino.value = data.ubicacion_actual || "";

    showMsg(`Instrumento ${code} cargado.`, "ok");
  }

  async function guardar(){
    hideMsg();

    const codigo = f.codigo.value.trim();
    const descripcion = f.descripcion.value.trim();
    const fabricante = f.fabricante.value.trim();
    const destino = f.destino.value.trim();

    if (!codigo || !descripcion || !fabricante){
      showMsg("C√≥digo, descripci√≥n y fabricante son obligatorios.", "err");
      return;
    }

    const { data: existente } = await sb
      .from("instrumentos")
      .select("*")
      .eq("codigo", codigo)
      .maybeSingle();

    let payload = {
      codigo,
      descripcion,
      fabricante,
      rango: f.rango.value.trim() || null,
      precision: f.precision.value.trim() || null,
      tipo_calibracion: f.tipo_calibracion.value.trim() || null,
      fecha_calibracion: f.fecha_calibracion.value || null,
      fecha_proxima_calibracion: f.fecha_proxima_calibracion.value || null,
      observaciones: f.observaciones.value.trim() || null,
    };

    if (!existente){
      // NUEVO ‚Üí ubicacion_actual = DESTINO
      payload.ubicacion_actual = destino;
    }

    const { error } = await sb
      .from("instrumentos")
      .upsert(payload, { onConflict: "codigo" });

    if (error){
      console.error(error);
      showMsg("Error guardando: " + error.message, "err");
      return;
    }

    showMsg("Instrumento guardado correctamente.", "ok");
  }

  $("btnBuscar").onclick = buscar;
  $("btnGuardar").onclick = guardar;
  $("btnLimpiar").onclick = limpiar;
</script>

</body>
</html>


