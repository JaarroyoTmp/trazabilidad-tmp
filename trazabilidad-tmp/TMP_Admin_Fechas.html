<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TMP ¬∑ Admin Fechas de Calibraci√≥n</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg0:#020617;
      --bg1:#020c1a;
      --bg2:#071422;
      --panel:#0b1624;
      --card:#111827;
      --border:#24334a;
      --accent:#38bdf8;
      --accent-soft:#0ea5e9;
      --danger:#f97373;
      --ok:#22c55e;
      --warn:#fbbf24;
      --txt:#e5f1ff;
      --muted:#9ca3af;
    }

    *{box-sizing:border-box;}

    body{
      margin:0;
      font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
      color:var(--txt);
      background:
        radial-gradient(1000px 800px at 0 0,#0f172a 0,transparent 55%),
        radial-gradient(1000px 800px at 100% 0,#020617 0,transparent 55%),
        var(--bg0);
    }

    .wrap{
      max-width:1180px;
      margin:20px auto 40px;
      padding:0 18px;
    }

    header{
      display:flex;
      align-items:center;
      gap:14px;
      padding:10px 0 16px;
      border-bottom:1px solid #1f2937;
    }

    .brand-title{
      font-size:18px;
      font-weight:700;
      letter-spacing:.03em;
    }

    .brand-sub{
      font-size:12px;
      color:var(--muted);
    }

    .badge{
      font-size:11px;
      border-radius:999px;
      padding:5px 10px;
      background:#0f172a;
      border:1px solid var(--border);
      color:var(--muted);
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    .badge-online{
      background:#022c22;
      border-color:#15803d;
      color:#bbf7d0;
    }
    .badge-offline{
      background:#3f1f1f;
      border-color:#b91c1c;
      color:#fecaca;
    }

    .main-grid{
      margin-top:18px;
      display:grid;
      grid-template-columns:minmax(0,1.3fr) minmax(0,1fr);
      gap:16px;
    }

    .card{
      background:linear-gradient(145deg,#020617,#020c1a 40%,#030712);
      border-radius:18px;
      border:1px solid var(--border);
      padding:16px 16px 14px;
      box-shadow:0 18px 45px rgba(0,0,0,.75);
      position:relative;
      overflow:hidden;
    }
    .card::before{
      content:"";
      position:absolute;
      inset:-1px;
      border-radius:inherit;
      background:conic-gradient(
        from 180deg,
        rgba(56,189,248,.85),
        transparent 40%,
        transparent 60%,
        rgba(59,130,246,.7),
        rgba(56,189,248,.85)
      );
      opacity:0;
      mix-blend-mode:screen;
      pointer-events:none;
      transition:opacity .25s ease;
    }
    .card:hover::before{
      opacity:.22;
    }
    .card > *{position:relative;z-index:1;}

    .card-title-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
    }
    .card-title{
      font-size:15px;
      font-weight:600;
      color:var(--accent);
      display:flex;
      align-items:center;
      gap:8px;
    }
    .card-title span.emoji{
      font-size:18px;
    }
    .card-sub{
      font-size:12px;
      color:var(--muted);
    }

    label{
      display:block;
      font-size:12px;
      color:var(--muted);
      margin-bottom:4px;
    }

    input,button,select{
      font-family:inherit;
      color:inherit;
    }

    input[type="text"], input[type="date"]{
      width:100%;
      border-radius:10px;
      border:1px solid #1f2937;
      background:#020617;
      padding:8px 10px;
      font-size:13px;
      color:var(--txt);
      outline:none;
      transition:border-color .15s ease, box-shadow .15s ease;
    }
    input[type="text"]:focus,
    input[type="date"]:focus{
      border-color:var(--accent);
      box-shadow:0 0 0 1px rgba(56,189,248,.4);
    }

    .row{
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
    }

    .btn{
      border-radius:999px;
      border:1px solid var(--border);
      background:#020617;
      padding:7px 12px;
      font-size:12px;
      color:var(--txt);
      display:inline-flex;
      align-items:center;
      gap:6px;
      cursor:pointer;
      transition:background .18s ease, transform .18s ease, box-shadow .18s ease;
    }
    .btn span.icon{font-size:14px;}
    .btn-primary{
      background:linear-gradient(135deg,#0ea5e9,#2563eb);
      border-color:#38bdf8;
      color:#e0f2fe;
    }
    .btn-danger{
      border-color:#fecaca;
      color:#fecaca;
      background:#450a0a;
    }
    .btn:disabled{
      opacity:.5;
      cursor:default;
      box-shadow:none;
      transform:none;
    }
    .btn:not(:disabled):hover{
      background:#020b17;
      transform:translateY(-1px);
      box-shadow:0 10px 28px rgba(0,0,0,.7);
    }
    .btn-primary:not(:disabled):hover{
      filter:brightness(1.05);
      box-shadow:0 12px 30px rgba(56,189,248,.55);
    }

    .search-bar{
      margin-top:6px;
      padding:10px;
      border-radius:12px;
      background:rgba(15,23,42,.7);
      border:1px solid #1e293b;
    }

    .mini{
      font-size:11px;
      color:var(--muted);
    }

    table{
      width:100%;
      border-collapse:collapse;
      margin-top:10px;
      font-size:12px;
    }
    thead{
      background:#020617;
    }
    th,td{
      padding:7px 6px;
      border-bottom:1px solid #111827;
      text-align:left;
      white-space:nowrap;
    }
    tbody tr:nth-child(even){
      background:#020617;
    }
    tbody tr:hover{
      background:#04101e;
      cursor:pointer;
    }
    .chip{
      display:inline-flex;
      align-items:center;
      gap:4px;
      padding:3px 8px;
      border-radius:999px;
      border:1px solid #1f2937;
      background:#020617;
      font-size:11px;
      color:var(--muted);
    }
    .chip-ok{
      border-color:#22c55e;
      color:#bbf7d0;
      background:#052e16;
    }
    .chip-alert{
      border-color:#f97373;
      color:#fecaca;
      background:#450a0a;
    }
    .chip-warn{
      border-color:#fbbf24;
      color:#fef9c3;
      background:#422006;
    }

    .status-pill{
      font-size:11px;
      padding:3px 8px;
      border-radius:999px;
      border:1px solid #1f2937;
      display:inline-flex;
      align-items:center;
      gap:4px;
    }
    .status-ok{
      border-color:#22c55e;
      color:#bbf7d0;
      background:#052e16;
    }
    .status-fuera{
      border-color:#f97373;
      color:#fecaca;
      background:#450a0a;
    }
    .status-prox{
      border-color:#fbbf24;
      color:#fef9c3;
      background:#422006;
    }
    .status-sin{
      border-color:#4b5563;
      color:#9ca3af;
      background:#020617;
    }

    .detail-grid{
      display:grid;
      grid-template-columns:repeat(2,minmax(0,1fr));
      gap:10px;
      margin-top:4px;
    }

    .divider{
      margin:10px 0;
      border-top:1px solid #111827;
    }

    .muted{
      color:var(--muted);
    }

    .highlight{
      box-shadow:0 0 0 1px rgba(56,189,248,.7);
    }

    .toast{
      position:fixed;
      bottom:16px;
      right:18px;
      max-width:320px;
      background:#020617;
      border-radius:14px;
      border:1px solid #1f2937;
      padding:10px 12px;
      font-size:12px;
      display:flex;
      align-items:flex-start;
      gap:8px;
      box-shadow:0 18px 45px rgba(0,0,0,.9);
      opacity:0;
      pointer-events:none;
      transform:translateY(8px);
      transition:opacity .25s ease,transform .25s ease;
      z-index:50;
    }
    .toast.show{
      opacity:1;
      pointer-events:auto;
      transform:translateY(0);
    }
    .toast-icon{font-size:16px;}
    .toast-main{font-weight:600;margin-bottom:2px;}
    .toast-close{
      margin-left:auto;
      border:none;
      background:transparent;
      color:var(--muted);
      cursor:pointer;
      font-size:14px;
    }

    @media (max-width:840px){
      .main-grid{
        grid-template-columns:1fr;
      }
    }
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <div>
      <div class="brand-title">TMP ¬∑ Admin Fechas de Calibraci√≥n</div>
      <div class="brand-sub">Edici√≥n r√°pida de fechas de calibraci√≥n y pr√≥ximas calibraciones (solo instrumentos).</div>
    </div>
    <span id="badgeOnline" class="badge badge-offline" style="margin-left:auto;">Offline</span>
  </header>

  <div class="main-grid">

    <!-- LISTADO / BUSCADOR -->
    <section class="card">
      <div class="card-title-row">
        <div class="card-title">
          <span class="emoji">üìã</span>
          <span>Instrumentos</span>
        </div>
        <div class="card-sub">Buscar por c√≥digo o descripci√≥n y seleccionar el equipo a editar.</div>
      </div>

      <div class="search-bar">
        <div class="row">
          <div style="flex:1 1 220px;">
            <label for="txtBuscar">Buscar instrumento</label>
            <input id="txtBuscar" type="text" placeholder="C√≥digo exacto o parcial, o texto de la descripci√≥n‚Ä¶" />
          </div>
          <button id="btnBuscar" class="btn btn-primary">
            <span class="icon">üîç</span> Buscar
          </button>
          <button id="btnLimpiarFiltro" class="btn">
            Limpiar
          </button>
        </div>
        <p class="mini">Se consultan los datos en Supabase en tiempo real. Puedes introducir solo parte del c√≥digo (ej. ‚Äú402‚Äù) o un texto de la descripci√≥n.</p>
      </div>

      <div style="margin-top:10px;max-height:390px;overflow:auto;border-radius:12px;border:1px solid #111827;">
        <table>
          <thead>
            <tr>
              <th>C√≥digo</th>
              <th>Descripci√≥n</th>
              <th>Estado</th>
              <th>√öltima cal.</th>
              <th>Pr√≥xima cal.</th>
            </tr>
          </thead>
          <tbody id="tbodyInstrumentos">
            <tr><td colspan="5" class="mini muted" style="padding:10px;">Escribe un criterio de b√∫squeda y pulsa ‚ÄúBuscar‚Äù.</td></tr>
          </tbody>
        </table>
      </div>

      <p class="mini" style="margin-top:6px;">
        Haz clic en una fila para cargar el instrumento en el panel derecho y editar sus fechas.
      </p>
    </section>

    <!-- DETALLE / EDICI√ìN -->
    <section class="card">
      <div class="card-title-row">
        <div class="card-title">
          <span class="emoji">üõ†</span>
          <span>Edici√≥n de fechas</span>
        </div>
        <div class="card-sub">Modifica fechas de calibraci√≥n sin restricciones (pasado / futuro).</div>
      </div>

      <div id="detalleVacio" class="mini muted">
        No hay ning√∫n instrumento seleccionado. Selecciona uno en la tabla de la izquierda.
      </div>

      <div id="detalleBox" style="display:none;">
        <div class="detail-grid">
          <div>
            <label>C√≥digo</label>
            <div id="detCodigo" class="chip">‚Äî</div>
          </div>
          <div>
            <label>Estado actual</label>
            <div id="detEstado" class="status-pill status-sin">‚Äî</div>
          </div>
          <div>
            <label>Descripci√≥n</label>
            <div id="detDescripcion" class="mini">‚Äî</div>
          </div>
          <div>
            <label>Ubicaci√≥n</label>
            <div id="detUbicacion" class="mini">‚Äî</div>
          </div>
        </div>

        <div class="divider"></div>

        <div class="detail-grid">
          <div>
            <label>√öltima calibraci√≥n (fecha_calibracion)</label>
            <input id="detFechaCal" type="date">
          </div>
          <div>
            <label>Pr√≥xima calibraci√≥n (fecha_proxima_calibracion)</label>
            <input id="detFechaProx" type="date">
          </div>
        </div>

        <p class="mini" style="margin-top:6px;">
          Puedes introducir fechas pasadas, actuales o futuras. Si dejas un campo vac√≠o, se almacenar√° como <code>NULL</code> en Supabase.
        </p>

        <div class="divider"></div>

        <div class="row" style="justify-content:flex-end;margin-top:4px;">
          <button id="btnResetFechas" class="btn btn-danger">
            <span class="icon">üßπ</span> Vaciar fechas
          </button>
          <button id="btnGuardarFechas" class="btn btn-primary">
            <span class="icon">üíæ</span> Guardar en Supabase
          </button>
        </div>

        <p id="detInfoMsg" class="mini muted" style="margin-top:6px;">
          Cambios pendientes sin guardar.
        </p>
      </div>
    </section>
  </div>
</div>

<!-- Toast -->
<div id="toast" class="toast">
  <div class="toast-icon">‚ÑπÔ∏è</div>
  <div>
    <div class="toast-main" id="toastMain">Mensaje</div>
    <div class="mini" id="toastSub">Detalle del mensaje.</div>
  </div>
  <button id="toastClose" class="toast-close">‚úï</button>
</div>

<script type="module">
  // ========= SUPABASE CONFIG =========
  const SUPABASE_URL = "https://uukxdslfmxesufuxjzvt.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV1a3hkc2xmbXhlc3VmdXhqenZ0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjExMjg5MjksImV4cCI6MjA3NjcwNDkyOX0.7bmDUEQTfl6Y5jdzORyFZUFtOs7GM0dNdfp1zsURkWw";

  let supabase = null;
  const state = {
    instrumentos: [],
    seleccionado: null
  };

  const $ = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));

  const badgeOnline = $("#badgeOnline");
  const tbodyInstrumentos = $("#tbodyInstrumentos");
  const txtBuscar = $("#txtBuscar");
  const btnBuscar = $("#btnBuscar");
  const btnLimpiarFiltro = $("#btnLimpiarFiltro");

  const detalleVacio = $("#detalleVacio");
  const detalleBox = $("#detalleBox");
  const detCodigo = $("#detCodigo");
  const detDescripcion = $("#detDescripcion");
  const detEstado = $("#detEstado");
  const detUbicacion = $("#detUbicacion");
  const detFechaCal = $("#detFechaCal");
  const detFechaProx = $("#detFechaProx");
  const detInfoMsg = $("#detInfoMsg");
  const btnGuardarFechas = $("#btnGuardarFechas");
  const btnResetFechas = $("#btnResetFechas");

  const toast = $("#toast");
  const toastMain = $("#toastMain");
  const toastSub = $("#toastSub");
  const toastClose = $("#toastClose");

  function setOnline(ok){
    if (ok){
      badgeOnline.textContent = "Online (Supabase)";
      badgeOnline.classList.add("badge-online");
      badgeOnline.classList.remove("badge-offline");
    } else {
      badgeOnline.textContent = "Offline";
      badgeOnline.classList.remove("badge-online");
      badgeOnline.classList.add("badge-offline");
    }
  }

  async function ensureSupabase(){
    if (!supabase){
      try{
        const { createClient } = await import("https://esm.sh/@supabase/supabase-js@2.45.5");
        supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      }catch(e){
        console.error("No se pudo crear el cliente Supabase:", e);
        supabase = null;
      }
    }
    setOnline(!!supabase);
    return supabase;
  }

  function showToast(main, sub){
    toastMain.textContent = main;
    toastSub.textContent = sub || "";
    toast.classList.add("show");
    setTimeout(()=>toast.classList.remove("show"), 6000);
  }
  toastClose.addEventListener("click",()=>toast.classList.remove("show"));

  function fmtFecha(d){
    if (!d) return "‚Äî";
    return d;
  }

  function estadoPill(estado, fechaProx){
    const est = (estado||"").toLowerCase().trim();
    const hoy = new Date();
    const proxDate = fechaProx ? new Date(fechaProx) : null;
    let cls="status-sin", txt="SIN ESTADO";

    if (proxDate && proxDate < hoy){ cls="status-fuera"; txt="FUERA"; }
    else if (proxDate && (proxDate - hoy) < 30*86400000){ cls="status-prox"; txt="PR√ìXIMA"; }
    else if (est === "calibrado"){ cls="status-ok"; txt="CALIBRADO"; }
    else if (est){ cls="status-sin"; txt=est.toUpperCase(); }

    return {cls,txt};
  }

  function renderTabla(){
    if (!state.instrumentos.length){
      tbodyInstrumentos.innerHTML = `
        <tr><td colspan="5" class="mini muted" style="padding:10px;">
          No se han encontrado instrumentos con ese criterio.
        </td></tr>
      `;
      return;
    }
    tbodyInstrumentos.innerHTML = state.instrumentos.map(inst=>{
      const sel = state.seleccionado && state.seleccionado.id === inst.id;
      const {cls,txt} = estadoPill(inst.estado, inst.fecha_proxima_calibracion);
      return `
        <tr data-id="${inst.id}" class="${sel ? "highlight" : ""}">
          <td>${inst.codigo || "‚Äî"}</td>
          <td>${inst.descripcion || "‚Äî"}</td>
          <td><span class="status-pill ${cls}">${txt}</span></td>
          <td>${fmtFecha(inst.fecha_calibracion)}</td>
          <td>${fmtFecha(inst.fecha_proxima_calibracion)}</td>
        </tr>
      `;
    }).join("");

    $$("#tbodyInstrumentos tr").forEach(tr=>{
      tr.addEventListener("click", ()=>{
        const id = tr.getAttribute("data-id");
        const inst = state.instrumentos.find(x=>String(x.id)===String(id));
        if (inst) seleccionarInstrumento(inst);
      });
    });
  }

  function seleccionarInstrumento(inst){
    state.seleccionado = inst;
    detalleVacio.style.display = "none";
    detalleBox.style.display = "block";

    detCodigo.textContent = inst.codigo || "‚Äî";
    detDescripcion.textContent = inst.descripcion || "‚Äî";
    detUbicacion.textContent = inst.ubicacion_actual || "‚Äî";

    const {cls,txt} = estadoPill(inst.estado, inst.fecha_proxima_calibracion);
    detEstado.className = "status-pill " + cls;
    detEstado.textContent = txt;

    detFechaCal.value = inst.fecha_calibracion || "";
    detFechaProx.value = inst.fecha_proxima_calibracion || "";

    detInfoMsg.textContent = "Sin cambios pendientes.";
    detInfoMsg.classList.remove("muted");
    detInfoMsg.classList.add("muted");

    renderTabla();
  }

  async function buscarInstrumentos(){
    const term = txtBuscar.value.trim();
    await ensureSupabase();
    if (!supabase){
      showToast("Supabase no disponible","Revisa la conexi√≥n o la URL/KEY.");
      return;
    }
    if (!term){
      showToast("Introduce un criterio de b√∫squeda","C√≥digo, parte del c√≥digo o descripci√≥n.");
      return;
    }

    btnBuscar.disabled = true;
    btnBuscar.textContent = "Buscando‚Ä¶";

    try{
      const like = `%${term}%`;
      const { data, error } = await supabase
        .from("instrumentos")
        .select("id,codigo,descripcion,fabricante_tipo,rango,estado,ubicacion_actual,fecha_calibracion,fecha_proxima_calibracion")
        .or(`codigo.ilike.${like},descripcion.ilike.${like}`)
        .order("codigo",{ascending:true})
        .limit(100);

      if (error){
        console.error(error);
        showToast("Error al consultar instrumentos", error.message || "Consulta fallida.");
        return;
      }

      state.instrumentos = data || [];
      state.seleccionado = null;
      renderTabla();
      detalleBox.style.display = "none";
      detalleVacio.style.display = "block";
      showToast("B√∫squeda completada", `${state.instrumentos.length} instrumento(s) encontrados.`);
    } finally {
      btnBuscar.disabled = false;
      btnBuscar.textContent = "Buscar";
    }
  }

  async function guardarFechas(){
    if (!state.seleccionado){
      alert("Selecciona primero un instrumento en la tabla.");
      return;
    }
    await ensureSupabase();
    if (!supabase){
      showToast("Supabase no disponible","No se pueden guardar cambios ahora.");
      return;
    }

    const fechaCal = detFechaCal.value || null;
    const fechaProx = detFechaProx.value || null;

    if (!confirm("¬øDeseas guardar estas fechas en Supabase?")) return;

    btnGuardarFechas.disabled = true;
    btnGuardarFechas.textContent = "Guardando‚Ä¶";

    try{
      const { error } = await supabase
        .from("instrumentos")
        .update({
          fecha_calibracion: fechaCal,
          fecha_proxima_calibracion: fechaProx
        })
        .eq("id", state.seleccionado.id);

      if (error){
        console.error(error);
        showToast("Error al guardar", error.message || "No se pudieron actualizar las fechas.");
        return;
      }

      // Actualizar copia local
      state.seleccionado.fecha_calibracion = fechaCal;
      state.seleccionado.fecha_proxima_calibracion = fechaProx;
      const idx = state.instrumentos.findIndex(x=>x.id===state.seleccionado.id);
      if (idx>=0) state.instrumentos[idx] = {...state.seleccionado};

      renderTabla();
      seleccionarInstrumento(state.seleccionado);

      showToast("Fechas actualizadas","Los cambios se han guardado correctamente en Supabase.");
      detInfoMsg.textContent = "Cambios guardados en Supabase.";
    } finally {
      btnGuardarFechas.disabled = false;
      btnGuardarFechas.textContent = "Guardar en Supabase";
    }
  }

  function resetFechas(){
    if (!state.seleccionado){
      alert("Selecciona primero un instrumento.");
      return;
    }
    if (!confirm("Esto dejar√° ambas fechas en blanco (NULL) en Supabase. ¬øSeguro?")) return;
    detFechaCal.value = "";
    detFechaProx.value = "";
    detInfoMsg.textContent = "Fechas vaciadas localmente. Pulsa ‚ÄúGuardar en Supabase‚Äù para aplicar.";
  }

  // Eventos
  btnBuscar.addEventListener("click", buscarInstrumentos);
  btnLimpiarFiltro.addEventListener("click", ()=>{
    txtBuscar.value = "";
    state.instrumentos = [];
    state.seleccionado = null;
    renderTabla();
    detalleBox.style.display = "none";
    detalleVacio.style.display = "block";
  });
  txtBuscar.addEventListener("keydown", e=>{
    if (e.key === "Enter") buscarInstrumentos();
  });

  btnGuardarFechas.addEventListener("click", guardarFechas);
  btnResetFechas.addEventListener("click", resetFechas);

  detFechaCal.addEventListener("change", ()=>{
    detInfoMsg.textContent = "Hay cambios pendientes sin guardar.";
  });
  detFechaProx.addEventListener("change", ()=>{
    detInfoMsg.textContent = "Hay cambios pendientes sin guardar.";
  });

  // Arranque
  (async ()=>{ await ensureSupabase(); })();
</script>
</body>
</html>
