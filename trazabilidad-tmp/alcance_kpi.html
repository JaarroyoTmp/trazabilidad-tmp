<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>TMP ¬∑ Alcance, KPIs y Objetivos del Laboratorio</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="img/tmp-quality.png" />

  <!-- Chart.js para los gr√°ficos -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      --bg:#020617;
      --bg-gradient:radial-gradient(circle at 0% 0%, #1d3557 0, transparent 55%),
                    radial-gradient(circle at 100% 0%, #0f172a 0, transparent 55%),
                    linear-gradient(180deg,#020617,#020617);
      --panel:#020617;
      --panel-soft:#030b19;
      --card:#020617;
      --border:#1e293b;
      --txt:#e5f0ff;
      --muted:#94a3b8;
      --accent:#0ea5e9;
      --accent-soft:#1d4ed8;
      --accent-strong:#38bdf8;
      --danger:#ef4444;
      --warning:#f59e0b;
      --success:#22c55e;
    }

    *{box-sizing:border-box;}

    body{
      margin:0;
      font-family:system-ui,-apple-system,"Segoe UI",Roboto;
      background:var(--bg);
      background-image:var(--bg-gradient);
      color:var(--txt);
      -webkit-font-smoothing:antialiased;
    }

    header{
      position:sticky;
      top:0;
      z-index:20;
      backdrop-filter:blur(18px);
      background:linear-gradient(90deg,rgba(15,23,42,.92),rgba(15,23,42,.85));
      border-bottom:1px solid rgba(148,163,184,.2);
      padding:14px 20px;
      display:flex;
      align-items:center;
      justify-content:space-between;
    }

    .brand{
      display:flex;
      align-items:center;
      gap:12px;
    }

    .brand-logo{
      height:42px;
      width:42px;
      border-radius:999px;
      background:radial-gradient(circle at 30% 0%,#38bdf8,transparent 55%),
                 radial-gradient(circle at 70% 80%,#0ea5e9,transparent 55%);
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
    }
    .brand-logo img{
      height:34px;
      width:auto;
    }

    .brand-text-title{
      font-size:18px;
      font-weight:600;
      letter-spacing:.04em;
    }
    .brand-text-sub{
      font-size:12px;
      color:var(--muted);
    }

    .header-right{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }

    .chip{
      border-radius:999px;
      border:1px solid rgba(148,163,184,.4);
      padding:4px 10px;
      font-size:11px;
      display:inline-flex;
      align-items:center;
      gap:6px;
      color:var(--muted);
      background:rgba(15,23,42,.8);
    }
    .chip-dot{
      width:7px;
      height:7px;
      border-radius:999px;
      background:#22c55e;
      box-shadow:0 0 0 4px rgba(34,197,94,.25);
    }

    .btn{
      border-radius:999px;
      border:1px solid rgba(148,163,184,.4);
      padding:7px 13px;
      font-size:12px;
      background:rgba(15,23,42,.9);
      color:var(--txt);
      display:inline-flex;
      align-items:center;
      gap:6px;
      cursor:pointer;
      text-decoration:none;
      box-shadow:0 10px 30px rgba(0,0,0,.65);
      transition:transform .15s ease, box-shadow .15s ease, background .15s ease;
    }
    .btn:hover{
      transform:translateY(-1px);
      box-shadow:0 16px 40px rgba(15,23,42,.85);
      background:#020617;
    }

    .btn-primary{
      border-color:var(--accent-strong);
      background:linear-gradient(135deg,var(--accent-strong),var(--accent-soft));
      color:#e0f2fe;
    }
    .btn-primary:hover{
      filter:brightness(1.06);
    }

    main{
      max-width:1180px;
      margin:20px auto 40px;
      padding:0 18px 30px;
      display:flex;
      flex-direction:column;
      gap:18px;
    }

    /* Layout principal: 2 columnas */
    .layout-top{
      display:grid;
      grid-template-columns:1.3fr 1.1fr;
      gap:18px;
    }

    @media (max-width:960px){
      .layout-top{
        grid-template-columns:1fr;
      }
    }

    .card{
      background:radial-gradient(circle at 0 0,rgba(56,189,248,.18),transparent 55%),
                 radial-gradient(circle at 100% 100%,rgba(59,130,246,.18),transparent 55%),
                 linear-gradient(145deg,#020617,#020617);
      border-radius:18px;
      border:1px solid rgba(148,163,184,.24);
      padding:16px 16px 14px;
      position:relative;
      overflow:hidden;
    }

    .card::before{
      content:"";
      position:absolute;
      inset:-2px;
      border-radius:inherit;
      background:conic-gradient(from 210deg,rgba(56,189,248,.4),transparent,transparent);
      opacity:0;
      pointer-events:none;
      transition:opacity .3s ease;
      z-index:-1;
    }

    .card:hover::before{
      opacity:1;
    }

    .card-header-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      margin-bottom:6px;
    }

    .card-title{
      font-size:16px;
      font-weight:600;
      color:#e0f2fe;
      display:flex;
      align-items:center;
      gap:8px;
    }

    .card-sub{
      font-size:12px;
      color:var(--muted);
      margin-bottom:8px;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:5px;
      font-size:11px;
      border-radius:999px;
      padding:3px 9px;
      border:1px solid rgba(148,163,184,.45);
      background:rgba(15,23,42,.9);
      color:var(--muted);
    }

    .tag{
      font-size:11px;
      padding:2px 8px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.35);
      color:var(--muted);
      white-space:nowrap;
    }

    .tag-accent{
      border-color:var(--accent-strong);
      color:var(--accent-strong);
    }

    .badge-kpi{
      font-size:11px;
      padding:2px 8px;
      border-radius:999px;
      border:1px solid rgba(56,189,248,.45);
      background:rgba(15,23,42,.9);
      color:#bae6fd;
      white-space:nowrap;
    }

    .badge-ok{
      border-color:var(--success);
      color:#bbf7d0;
    }

    .badge-warn{
      border-color:var(--warning);
      color:#fed7aa;
    }

    /* Lista de magnitudes */
    .mag-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(210px,1fr));
      gap:10px;
      margin-top:6px;
    }

    .mag-card{
      background:rgba(15,23,42,.9);
      border-radius:12px;
      border:1px solid rgba(30,64,175,.7);
      padding:9px 10px 8px;
      display:flex;
      flex-direction:column;
      gap:4px;
    }

    .mag-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:6px;
    }

    .mag-title{
      font-size:13px;
      font-weight:600;
    }

    .mag-icon{
      width:24px;
      height:24px;
      border-radius:999px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:14px;
      background:radial-gradient(circle at 30% 0%,rgba(56,189,248,.8),transparent 55%),
                 radial-gradient(circle at 70% 90%,rgba(29,78,216,.9),transparent 55%);
      box-shadow:0 0 0 3px rgba(37,99,235,.35);
    }

    .mag-meta{
      font-size:11px;
      color:var(--muted);
    }

    .mag-range{
      font-size:11px;
      display:flex;
      flex-wrap:wrap;
      gap:4px;
      margin-top:2px;
    }

    /* KPIs Alcance */
    .kpi-alcance-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
      gap:8px;
    }

    .kpi-alcance-card{
      background:#020617;
      border-radius:12px;
      border:1px solid rgba(51,65,85,.9);
      padding:9px 10px 8px;
      display:flex;
      flex-direction:column;
      gap:3px;
    }

    .kpi-alc-label{
      font-size:11px;
      color:var(--muted);
    }

    .kpi-alc-value{
      font-size:18px;
      font-weight:600;
    }

    .kpi-alk-note{
      font-size:11px;
      color:var(--muted);
    }

    /* Gr√°ficos */
    .charts-grid{
      display:grid;
      grid-template-columns:1fr;
      gap:12px;
    }

    .chart-box{
      background:rgba(15,23,42,.95);
      border-radius:14px;
      border:1px solid rgba(30,64,175,.7);
      padding:10px 12px 10px;
    }

    .chart-title{
      font-size:13px;
      margin-bottom:6px;
      color:#e0f2fe;
    }

    canvas{
      max-height:260px;
    }

    /* Secci√≥n inferior */
    .layout-bottom{
      display:grid;
      grid-template-columns: minmax(0,1.4fr) minmax(0,1fr);
      gap:18px;
    }

    @media (max-width:960px){
      .layout-bottom{
        grid-template-columns:1fr;
      }
    }

    .list{
      font-size:13px;
      color:var(--muted);
      margin:4px 0 0;
      padding-left:18px;
    }
    .list li{
      margin-bottom:3px;
    }

    .callout{
      margin-top:6px;
      font-size:12px;
      color:var(--muted);
      border-radius:10px;
      border:1px dashed rgba(148,163,184,.4);
      padding:7px 9px;
      background:rgba(15,23,42,.75);
    }

    .callout strong{
      color:#e0f2fe;
    }

    .legend-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(150px,1fr));
      gap:8px;
      margin-top:6px;
      font-size:12px;
      color:var(--muted);
    }

    .legend-item{
      display:flex;
      align-items:flex-start;
      gap:6px;
    }

    .legend-dot{
      width:9px;
      height:9px;
      border-radius:3px;
      flex-shrink:0;
    }

    .legend-dot.estado{
      background:linear-gradient(135deg,#60a5fa,#38bdf8);
    }

    .legend-dot.ubic{
      background:linear-gradient(135deg,#22c55e,#4ade80);
    }

    .legend-dot.venc{
      background:linear-gradient(135deg,#f97316,#ef4444);
    }

    footer{
      max-width:1180px;
      margin:10px auto 16px;
      padding:0 18px;
      font-size:12px;
      color:var(--muted);
      text-align:center;
    }
  </style>
</head>
<body>

<header>
  <div class="brand">
    <div class="brand-logo">
      <img src="img/tmp-quality.png" alt="TMP">
    </div>
    <div>
      <div class="brand-text-title">Laboratorio TMP ¬∑ Alcance, KPIs y Objetivos</div>
      <div class="brand-text-sub">Magnitudes cubiertas, rangos de trabajo y salud metrol√≥gica en tiempo real</div>
    </div>
  </div>

  <div class="header-right">
    <div class="chip">
      <span class="chip-dot"></span>
      <span id="chip-online-text">Conectado a Supabase</span>
    </div>
    <a href="home.html" class="btn">
      ‚Üê Volver al panel principal
    </a>
  </div>
</header>

<main>

  <!-- BLOQUE SUPERIOR: ALCANCE + KPIs -->
  <section class="layout-top">

    <!-- Alcance descriptivo -->
    <article class="card">
      <div class="card-header-row">
        <div class="card-title">
          üìê Alcance del laboratorio interno TMP
          <span class="badge-kpi" id="badge-ins-total">Instrumentos: ‚Äì</span>
        </div>
        <span class="tag tag-accent">Documento de referencia para auditor√≠a</span>
      </div>

      <p class="card-sub">
        El laboratorio interno TMP da soporte directo al taller de mecanizado, garantizando la trazabilidad
        metrol√≥gica de los equipos utilizados en producci√≥n, verificaci√≥n y calibraci√≥n de patrones.
      </p>

      <div class="mag-grid">

        <div class="mag-card">
          <div class="mag-head">
            <div class="mag-title">Dimensional</div>
            <div class="mag-icon">üìè</div>
          </div>
          <div class="mag-meta">
            Pie de rey, micr√≥metros, alt√≠metros, relojes comparadores, reglas, escuadras, m√°rmoles,
            tampones y anillos roscados P/NP, calas patr√≥n...
          </div>
          <div class="mag-range">
            <span class="tag">Rango t√≠pico: 0 ‚Äì 1000 mm</span>
            <span class="tag">Resoluci√≥n: 0,001 / 0,01 mm</span>
          </div>
        </div>

        <div class="mag-card">
          <div class="mag-head">
            <div class="mag-title">Par / Mec√°nica</div>
            <div class="mag-icon">üîß</div>
          </div>
          <div class="mag-meta">
            Llaves dinamom√©tricas y equipos asociados para control de par en montaje y aprietes cr√≠ticos.
          </div>
          <div class="mag-range">
            <span class="tag">Rango orientativo: 0 ‚Äì 2000 N¬∑m</span>
            <span class="tag">Resoluci√≥n seg√∫n modelo</span>
          </div>
        </div>

        <div class="mag-card">
          <div class="mag-head">
            <div class="mag-title">Dureza</div>
            <div class="mag-icon">üß±</div>
          </div>
          <div class="mag-meta">
            Equipos de durometr√≠a (Shore / Rockwell / Brinell, seg√∫n equipo instalado) para validaci√≥n
            de tratamientos t√©rmicos y materiales.
          </div>
          <div class="mag-range">
            <span class="tag">Escalas habituales: HRC / HRB / HB / Shore</span>
            <span class="tag">Resoluci√≥n conforme a equipo</span>
          </div>
        </div>

        <div class="mag-card">
          <div class="mag-head">
            <div class="mag-title">Masa / Pesaje</div>
            <div class="mag-icon">‚öñÔ∏è</div>
          </div>
          <div class="mag-meta">
            Balanzas y b√°sculas empleadas en procesos internos (control de piezas, consumibles, etc.),
            trazadas a patrones externos.
          </div>
          <div class="mag-range">
            <span class="tag">Rangos t√≠picos: g ‚Äì decenas de kg</span>
            <span class="tag">Resoluci√≥n: 0,1 g ‚Äì 10 g</span>
          </div>
        </div>

      </div>

      <div class="callout">
        <strong>Nota:</strong> los rangos y resoluciones indicados representan el alcance interno habitual del laboratorio TMP.
        Los patrones de referencia se calibran en laboratorios externos acreditados, manteniendo la trazabilidad al SI.
      </div>
    </article>

    <!-- KPIs espec√≠ficos de alcance -->
    <article class="card">
      <div class="card-header-row">
        <div class="card-title">
          üìä KPIs t√©cnicos del laboratorio
        </div>
        <span class="badge-kpi" id="badge-salud-global">Salud del sistema: ‚Äì</span>
      </div>

      <p class="card-sub">
        Indicadores directos sobre la situaci√≥n metrol√≥gica global, calculados a partir de la tabla
        <code>instrumentos</code> en Supabase.
      </p>

      <div class="kpi-alcance-grid">
        <div class="kpi-alcance-card">
          <div class="kpi-alc-label">Instrumentos activos</div>
          <div class="kpi-alc-value" id="kpi-activos">‚Äì</div>
          <div class="kpi-alk-note" id="kpi-activos-note"></div>
        </div>

        <div class="kpi-alcance-card">
          <div class="kpi-alc-label">En laboratorio</div>
          <div class="kpi-alc-value" id="kpi-lab">‚Äì</div>
          <div class="kpi-alk-note" id="kpi-lab-note"></div>
        </div>

        <div class="kpi-alcance-card">
          <div class="kpi-alc-label">En uso (fuera)</div>
          <div class="kpi-alc-value" id="kpi-uso">‚Äì</div>
          <div class="kpi-alk-note" id="kpi-uso-note"></div>
        </div>

        <div class="kpi-alcance-card">
          <div class="kpi-alc-label">Calibrados</div>
          <div class="kpi-alc-value" id="kpi-calibrados">‚Äì</div>
          <div class="kpi-alk-note" id="kpi-calibrados-note"></div>
        </div>

        <div class="kpi-alcance-card">
          <div class="kpi-alc-label">Pr√≥ximos (&lt; 30 d√≠as)</div>
          <div class="kpi-alc-value" id="kpi-prox">‚Äì</div>
          <div class="kpi-alk-note" id="kpi-prox-note"></div>
        </div>

        <div class="kpi-alcance-card">
          <div class="kpi-alc-label">Fuera de calibraci√≥n</div>
          <div class="kpi-alc-value" id="kpi-fuera">‚Äì</div>
          <div class="kpi-alk-note" id="kpi-fuera-note"></div>
        </div>
      </div>

      <div class="legend-grid">
        <div class="legend-item">
          <span class="legend-dot estado"></span>
          <span>Distribuci√≥n de estados (calibrado, fuera, pendiente) mostrada en el gr√°fico inferior.</span>
        </div>
        <div class="legend-item">
          <span class="legend-dot ubic"></span>
          <span>Balance entre equipos en laboratorio y equipos trabajando en taller.</span>
        </div>
        <div class="legend-item">
          <span class="legend-dot venc"></span>
          <span>Control de vencimientos: pr√≥ximos (&lt;30 d√≠as) y fuera de plazo.</span>
        </div>
      </div>
    </article>

  </section>

  <!-- BLOQUE GR√ÅFICOS -->
  <section class="card">
    <div class="card-header-row">
      <div class="card-title">
        üìà Visualizaci√≥n de la salud metrol√≥gica
        <span class="pill">Datos en tiempo real desde <code>instrumentos</code></span>
      </div>
    </div>
    <p class="card-sub">
      Estos gr√°ficos ayudan a tener, de un vistazo, la fotograf√≠a global del sistema metrol√≥gico:
      estado de calibraci√≥n de la flota de equipos y reparto de instrumentos entre laboratorio y producci√≥n.
    </p>

    <div class="charts-grid">
      <div class="chart-box">
        <div class="chart-title">Distribuci√≥n por estado de calibraci√≥n</div>
        <canvas id="chartEstados"></canvas>
      </div>
      <div class="chart-box">
        <div class="chart-title">Reparto por ubicaci√≥n (Laboratorio vs resto)</div>
        <canvas id="chartUbicacion"></canvas>
      </div>
    </div>
  </section>

  <!-- BLOQUE INFERIOR: TRAZABILIDAD + OBJETIVOS -->
  <section class="layout-bottom">

    <article class="card">
      <div class="card-header-row">
        <div class="card-title">
          üîó Trazabilidad metrol√≥gica y patrones
        </div>
      </div>
      <p class="card-sub">
        La trazabilidad metrol√≥gica se apoya en patrones internos y externos, controlados mediante el
        m√≥dulo de patrones de TMP y las calibraciones realizadas en laboratorios externos acreditados.
      </p>

      <ul class="list">
        <li><strong>Patrones internos:</strong> bloques patr√≥n, tampones y anillos roscados, patrones de longitud
          y dispositivos de referencia asociados a cada familia de instrumentos.</li>
        <li><strong>Patrones externos:</strong> equipos calibrados en laboratorios acreditados, siguiendo ISO/IEC 17025
          y gu√≠as como ILAC-G8 para evaluaci√≥n de conformidad.</li>
        <li><strong>Registro digital:</strong> toda la informaci√≥n de calibraciones, movimientos y estados se registra
          en Supabase, permitiendo trazabilidad electr√≥nica y consultas en tiempo real.</li>
        <li><strong>Integraci√≥n con producci√≥n:</strong> los equipos ‚Äúen uso‚Äù est√°n controlados para asegurar que ning√∫n
          instrumento cr√≠tico permanezca fuera de calibraci√≥n.</li>
      </ul>

      <div class="callout">
        <strong>Uso en auditor√≠a:</strong> esta pantalla, junto con el panel principal, permite explicar de forma clara
        el alcance interno del laboratorio, el control de vencimientos y el encadenamiento de trazabilidad desde los
        instrumentos de taller hasta los patrones externos acreditados.
      </div>
    </article>

    <article class="card">
      <div class="card-header-row">
        <div class="card-title">
          üéØ Objetivos del laboratorio TMP
        </div>
      </div>
      <p class="card-sub">
        Estos objetivos se apoyan directamente en los KPIs y gr√°ficos de esta pantalla. Pueden utilizarse
        como referencia en auditor√≠a y para el seguimiento interno del sistema metrol√≥gico.
      </p>

      <ul class="list">
        <li>
          <strong>Equipos fuera de calibraci√≥n:</strong> objetivo estructural de
          <strong>0 equipos cr√≠ticos vencidos</strong> y, en global, mantener
          <strong>&lt; 2&nbsp;%</strong> del total de instrumentos fuera de plazo.
        </li>
        <li>
          <strong>Equipos pr√≥ximos (&lt; 30 d√≠as):</strong> mantener el porcentaje de equipos ‚Äúpr√≥ximos‚Äù
          por debajo de <strong>15&nbsp;%</strong> del total, planificando las calibraciones para evitar picos.
        </li>
        <li>
          <strong>Instrumentos calibrados (en vigor):</strong> mantener al menos un
          <strong>90&nbsp;%</strong> de los equipos en estado metrol√≥gico ‚Äúen regla‚Äù (no vencidos).
        </li>
        <li>
          <strong>Ubicaci√≥n controlada:</strong> asegurar que el <strong>100&nbsp;%</strong> de los
          instrumentos tienen ubicaci√≥n conocida y actualizada (laboratorio / en uso / externo).
        </li>
        <li>
          <strong>Rotaci√≥n del laboratorio:</strong> evitar acumulaciones prolongadas de equipos en laboratorio
          por motivos de calibraci√≥n, equilibrando el n√∫mero de equipos en uso y en laboratorio seg√∫n la carga real.
        </li>
        <li>
          <strong>Trazabilidad de patrones:</strong> mantener el <strong>100&nbsp;%</strong> de los patrones
          internos con calibraci√≥n vigente y certificados externos disponibles para consulta durante auditor√≠as.
        </li>
      </ul>

      <div class="callout">
        <strong>C√≥mo utilizar estos objetivos:</strong> en una auditor√≠a, se puede mostrar esta pantalla y explicar
        que los objetivos del laboratorio se revisan con los KPIs de Supabase. Si alg√∫n indicador se sale de rango
        (por ejemplo, aumenta el n√∫mero de equipos vencidos), se genera un plan de acci√≥n sobre los equipos
        afectados hasta volver a la ‚Äúzona verde‚Äù.
      </div>
    </article>

  </section>

</main>

<footer>
  Talleres Mec√°nicos Paramio ¬∑ Laboratorio TMP ¬∑ Alcance, KPIs y Objetivos ¬∑ 2025
</footer>

<!-- Cliente Supabase (mismo que usas en home) -->
<script type="module" src="config.mjs"></script>

<script type="module">
  const supabase = window.supabase;
  const chipText = document.getElementById("chip-online-text");

  // KPIs DOM
  const badgeInsTotal  = document.getElementById("badge-ins-total");
  const badgeHealth    = document.getElementById("badge-salud-global");

  const kActivos       = document.getElementById("kpi-activos");
  const kLab           = document.getElementById("kpi-lab");
  const kUso           = document.getElementById("kpi-uso");
  const kCal           = document.getElementById("kpi-calibrados");
  const kProx          = document.getElementById("kpi-prox");
  const kFuera         = document.getElementById("kpi-fuera");

  const kActivosNote   = document.getElementById("kpi-activos-note");
  const kLabNote       = document.getElementById("kpi-lab-note");
  const kUsoNote       = document.getElementById("kpi-uso-note");
  const kCalNote       = document.getElementById("kpi-calibrados-note");
  const kProxNote      = document.getElementById("kpi-prox-note");
  const kFueraNote     = document.getElementById("kpi-fuera-note");

  let chartEstados = null;
  let chartUbic    = null;

  // Igual que en home: admite YYYY_MM_DD
  function parseDate(str){
    if (!str) return null;
    const norm = String(str).replace(/_/g,"-");
    const d = new Date(norm);
    return isNaN(d) ? null : d;
  }

  function pct(p, t){
    if (!t) return "0%";
    return `${Math.round((p/t)*100)}%`;
  }

  async function cargarAlcanceKPIs(){
    if (!supabase){
      chipText.textContent = "Modo offline: Supabase no disponible";
      return;
    }

    try{
      const { data: instrumentos, error } = await supabase
        .from("instrumentos")
        // usamos ambas columnas de fecha por compatibilidad
        .select("codigo, estado, ubicacion_actual, fecha_proxima_calibracion, proxima_calibracion");

      if (error){
        console.error("Error cargando instrumentos para alcance_kpi:", error);
        chipText.textContent = "Error al conectar con Supabase";
        return;
      }

      chipText.textContent = "Conectado a Supabase ¬∑ " + instrumentos.length + " registros";

      const total = instrumentos.length;
      badgeInsTotal.textContent = `Instrumentos: ${total || 0}`;

      const hoy = new Date();
      const mas30 = new Date(hoy.getTime() + 30*86400000);

      let enLab = 0;
      let enUso = 0;
      let calibrados = 0; // EN VIGOR (no vencidos)
      let fuera = 0;
      let prox  = 0;

      const estadosMap = {}; // estado -> count (para el gr√°fico)

      instrumentos.forEach(inst => {
        const estado = (inst.estado || "Sin estado").trim();
        estadosMap[estado] = (estadosMap[estado] || 0) + 1;

        const ubic = (inst.ubicacion_actual || "").trim().toLowerCase();
        if (ubic === "laboratorio") enLab++;
        else enUso++;

        // Fecha pr√≥xima: nueva + antigua
        const dProx = parseDate(inst.fecha_proxima_calibracion) || parseDate(inst.proxima_calibracion);
        if (dProx){
          if (dProx < hoy){
            // fuera de calibraci√≥n
            fuera++;
          } else {
            // en vigor (calibrado)
            calibrados++;
            // y adem√°s pr√≥ximos si est√°n dentro de 30 d√≠as
            if (dProx <= mas30){
              prox++;
            }
          }
        }
      });

      // KPIs num√©ricos
      kActivos.textContent = total;
      kLab.textContent     = enLab;
      kUso.textContent     = enUso;
      kCal.textContent     = calibrados;
      kProx.textContent    = prox;
      kFuera.textContent   = fuera;

      kActivosNote.textContent = total ? "100% de la flota controlada en Supabase" : "";
      kLabNote.textContent     = total ? `${pct(enLab,total)} en laboratorio` : "";
      kUsoNote.textContent     = total ? `${pct(enUso,total)} en uso (taller / otras √°reas)` : "";
      kCalNote.textContent     = total ? `${pct(calibrados,total)} en vigor (no vencidos)` : "";

      if (total){
        kProxNote.textContent  = prox ? `${pct(prox,total)} vencen en menos de 30 d√≠as` : "Sin vencimientos en 30 d√≠as";
        kFueraNote.textContent = fuera ? `${pct(fuera,total)} ya fuera de plazo` : "Objetivo: 0 equipos vencidos (actualmente alcanzado)";
      } else {
        kProxNote.textContent  = "";
        kFueraNote.textContent = "";
      }

      // Salud global del sistema (badge)
      if (!total){
        badgeHealth.textContent = "Salud global: sin datos";
        badgeHealth.classList.remove("badge-ok","badge-warn");
      } else if (fuera === 0 && prox <= total*0.15){
        badgeHealth.textContent = "Salud global: √ìPTIMA";
        badgeHealth.classList.add("badge-ok");
        badgeHealth.classList.remove("badge-warn");
      } else if (fuera <= total*0.05 && prox <= total*0.3){
        badgeHealth.textContent = "Salud global: ACEPTABLE";
        badgeHealth.classList.remove("badge-ok");
        badgeHealth.classList.add("badge-warn");
      } else {
        badgeHealth.textContent = "Salud global: CR√çTICA";
        badgeHealth.classList.remove("badge-ok");
        badgeHealth.classList.add("badge-warn");
      }

      // -------- Gr√°fico estados --------
      const estados = Object.keys(estadosMap);
      const valores = estados.map(e => estadosMap[e]);

      const ctxEstados = document.getElementById("chartEstados").getContext("2d");
      if (chartEstados) chartEstados.destroy();
      chartEstados = new Chart(ctxEstados, {
        type:"doughnut",
        data:{
          labels:estados,
          datasets:[{
            data:valores
          }]
        },
        options:{
          responsive:true,
          plugins:{
            legend:{
              position:"bottom",
              labels:{ color:"#e5e7eb" }
            }
          }
        }
      });

      // -------- Gr√°fico ubicaci√≥n --------
      const ctxUbic = document.getElementById("chartUbicacion").getContext("2d");
      if (chartUbic) chartUbic.destroy();
      chartUbic = new Chart(ctxUbic, {
        type:"bar",
        data:{
          labels:["En laboratorio","En uso / resto"],
          datasets:[{
            label:"Instrumentos",
            data:[enLab, enUso]
          }]
        },
        options:{
          responsive:true,
          plugins:{
            legend:{ display:false }
          },
          scales:{
            x:{ ticks:{ color:"#e5e7eb" } },
            y:{ ticks:{ color:"#e5e7eb" }, beginAtZero:true, precision:0 }
          }
        }
      });

    } catch(e){
      console.error("Error inesperado en alcance_kpi:", e);
      chipText.textContent = "Error inesperado al cargar datos";
    }
  }

  cargarAlcanceKPIs();
  // refresco opcional cada 60 s
  setInterval(cargarAlcanceKPIs, 60000);
</script>

</body>
</html>

