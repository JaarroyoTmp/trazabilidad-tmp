<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TMP · Buscar Instrumento (Robusto + Test)</title>

  <style>
    :root{
      --bg:#0d1117;
      --panel:#161b22;
      --panel2:#0f172a;
      --border:#30363d;
      --border2:#21262d;
      --text:#f0f6fc;
      --muted:#8b949e;
      --blue:#58a6ff;
      --ok:#238636;
      --warn:#d29922;
      --bad:#e53935;
      --info:#3b82f6;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,"Segoe UI",sans-serif;
      background:var(--bg);
      color:var(--text);
    }
    header{
      padding:14px 18px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      background:var(--panel);
      border-bottom:1px solid var(--border);
      gap:14px;
    }
    .brand{display:flex;align-items:center;gap:12px;min-width:240px}
    .brand img{height:40px}
    .brand h1{font-size:18px;margin:0;line-height:1.2;}
    .brand span{font-size:12px;color:var(--muted);}

    .btn-back{
      border-radius:10px;
      padding:8px 14px;
      border:1px solid var(--border);
      background:transparent;
      color:var(--text);
      cursor:pointer;
      white-space:nowrap;
    }
    .btn-back:hover{background:#1f2937;}

    .wrap{
      max-width:1100px;
      margin:22px auto;
      padding:0 16px;
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap:16px;
    }

    @media(min-width: 980px){
      .grid{grid-template-columns: 380px 1fr; align-items:start;}
    }

    .card{
      background:var(--panel);
      padding:18px;
      border-radius:16px;
      border:1px solid var(--border);
    }

    h2{margin:0 0 10px;font-size:17px;color:var(--blue)}

    input, select{
      width:100%;
      padding:12px;
      border-radius:10px;
      border:1px solid var(--border);
      background:var(--bg);
      color:var(--text);
      font-size:14px;
      outline:none;
    }
    input:focus, select:focus{border-color:var(--blue);}

    label{display:block;font-size:12px;color:var(--muted);margin:10px 0 6px;}

    .row{display:flex;gap:10px;align-items:center}
    .row > *{flex:1}

    .hint{font-size:12px;color:var(--muted);margin-top:8px;line-height:1.35}

    .btn{
      border-radius:10px;
      padding:10px 12px;
      border:1px solid var(--border);
      background:transparent;
      color:var(--text);
      cursor:pointer;
      font-size:13px;
    }
    .btn:hover{background:#1f2937;}
    .btn.primary{border-color:rgba(88,166,255,.55)}

    .resultsCard{padding:0;overflow:hidden}
    .resultsHeader{
      padding:14px 16px;
      border-bottom:1px solid var(--border);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .meta{font-size:12px;color:var(--muted)}

    .result{
      padding:14px 16px;
      border-bottom:1px solid var(--border2);
      cursor:pointer;
    }
    .result:hover{background:var(--panel2);}

    .topline{display:flex;align-items:flex-start;justify-content:space-between;gap:12px}
    .r-code{font-size:16px;font-weight:700;letter-spacing:.2px}
    .r-desc{font-size:13px;color:var(--muted);margin-top:4px}

    .tag{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:3px 8px;
      border-radius:999px;
      font-size:11px;
      color:white;
      white-space:nowrap;
      height:20px;
    }
    .ok{background:var(--ok);}
    .warn{background:var(--warn);}
    .bad{background:var(--bad);}
    .info{background:var(--info);}

    .chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
    .chip{font-size:11px;color:var(--text);padding:3px 8px;border:1px solid var(--border);border-radius:999px;background:transparent}

    .empty{
      padding:16px;
      font-size:14px;
      color:var(--muted);
      text-align:center;
    }
    .loading{
      padding:16px;
      display:flex;
      align-items:center;
      gap:10px;
      color:var(--muted);
      font-size:13px;
    }
    .spinner{
      width:14px;height:14px;border:2px solid rgba(255,255,255,.18);
      border-top-color:rgba(88,166,255,.9);border-radius:999px;
      animation:spin .9s linear infinite;
    }
    @keyframes spin{to{transform:rotate(360deg)}}

    .pager{
      padding:12px 16px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }
    .pager .btn{min-width:120px}
    .pager .btn:disabled{opacity:.45;cursor:not-allowed}

    .kv{display:grid;grid-template-columns: 140px 1fr;gap:6px 12px;margin-top:10px}
    .k{font-size:12px;color:var(--muted)}
    .v{font-size:12px;color:var(--text)}
  </style>
</head>

<body>
<header>
  <div class="brand">
    <img src="img/tmp-quality.png" alt="TMP" />
    <div>
      <h1>Buscar instrumento</h1>
      <span>Consulta avanzada · Base de datos TMP</span>
    </div>
  </div>
  <button class="btn-back" onclick="window.location.href='home.html'">← Volver</button>
</header>

<div class="wrap">
  <div class="grid">

    <!-- Filters -->
    <div class="card">
      <h2>Filtros</h2>

      <div class="hint" style="margin-top:-2px;">
        Este buscador está pensado para <b>inventario</b>. Carga la lista inicial y puedes filtrar por <b>Descripción</b> + <b>Rango</b>.
      </div>

      <label for="q">Búsqueda global</label>
      <input id="q" type="text" placeholder="Código, descripción, rango..." autocomplete="off" />

      <label for="codigo">Código (contiene)</label>
      <input id="codigo" type="text" placeholder="Ej: METMP001, 3D-001..." autocomplete="off" />

      <label for="descripcion">Descripción (contiene)</label>
      <input id="descripcion" type="text" placeholder="Ej: Tampones Rosca P/NP" autocomplete="off" />

      <label for="rango">Rango (contiene)</label>
      <input id="rango" type="text" placeholder="Ej: M12, M14x1, 6H..." autocomplete="off" />

      <label for="ubicacion">Ubicación (ID exacto)</label>
      <input id="ubicacion" type="text" placeholder="Ej: 12" autocomplete="off" />
      <div class="hint">Filtra por <b>ubicacion_id</b> (numérico). Ej: 12.</div>

      <label for="estado">Estado calibración</label>
      <select id="estado">
        <option value="">(Todos)</option>
        <option value="ok">En regla</option>
        <option value="warn">Próxima (≤ 30 días)</option>
        <option value="bad">Fuera de calibración</option>
        <option value="nodata">Sin datos</option>
      </select>

      <label for="orden">Orden</label>
      <select id="orden">
        <option value="codigo_asc">Código (A→Z)</option>
        <option value="codigo_desc">Código (Z→A)</option>
        <option value="rango_asc">Rango (A→Z)</option>
        <option value="rango_desc">Rango (Z→A)</option>
        <option value="prox_asc">Próxima calibración (antes)</option>
        <option value="prox_desc">Próxima calibración (después)</option>
      </select>

      <label for="limit">Resultados por página</label>
      <select id="limit">
        <option value="25">25</option>
        <option value="50" selected>50</option>
        <option value="100">100</option>
      </select>

      <div class="row" style="margin-top:14px;">
        <button class="btn primary" id="btnBuscar">Buscar</button>
        <button class="btn" id="btnReset">Limpiar</button>
      </div>
    </div>

    <!-- Results -->
    <div class="card resultsCard">
      <div class="resultsHeader">
        <div style="flex:1;">
          <div style="font-weight:700;">Resultados</div>
          <div class="meta" id="meta">Iniciando…</div>
        </div>
        <div class="row" style="max-width:320px;">
          <button class="btn" id="btnCopy">Copiar lista (CSV)</button>
        </div>
      </div>

      <div id="resultados"></div>

      <div class="pager" id="pager" style="display:none;">
        <button class="btn" id="prev" disabled>← Anterior</button>
        <div class="meta" id="pageInfo">Página 1</div>
        <button class="btn" id="next" disabled>Siguiente →</button>
      </div>
    </div>

  </div>
</div>

<!-- IMPORTANTE: config.mjs debe definir window.supabase -->
<script type="module" src="./config.mjs"></script>

<script type="module">
  // ============
  // DIAGNÓSTICO + BUSCADOR
  // ============

  const supabase = window.supabase;

  // DOM
  const el = (id) => document.getElementById(id);
  const q = el('q');
  const codigo = el('codigo');
  const descripcion = el('descripcion');
  const rango = el('rango');
  const ubicacion = el('ubicacion');
  const estado = el('estado');
  const orden = el('orden');
  const limit = el('limit');

  const box = el('resultados');
  const meta = el('meta');

  const pager = el('pager');
  const prevBtn = el('prev');
  const nextBtn = el('next');
  const pageInfo = el('pageInfo');

  const btnBuscar = el('btnBuscar');
  const btnReset = el('btnReset');
  const btnCopy = el('btnCopy');

  // State
  let page = 0;
  let total = 0;
  let lastData = [];
  let debounceTimer = null;

  // UI helpers
  function empty(msg){
    box.innerHTML = '<div class="empty">' + msg + '</div>';
  }
  function loading(){
    box.innerHTML = '<div class="loading"><span class="spinner"></span> Buscando…</div>';
  }
  function escapeHTML(str){
    return (str ?? '').toString()
      .replaceAll('&','&amp;')
      .replaceAll('<','&lt;')
      .replaceAll('>','&gt;')
      .replaceAll('"','&quot;')
      .replaceAll("'",'&#039;');
  }
  function formatDate(d){
    if(!d) return '-';
    const dt = new Date(d);
    if(Number.isNaN(dt.getTime())) return '-';
    return dt.toLocaleDateString('es-ES');
  }

  // Estado calibración
  function estadoKey(inst){
    if(!inst.proxima_calibracion) return 'nodata';
    const hoy = new Date();
    const prox = new Date(inst.proxima_calibracion);
    const diff = (prox - hoy) / (1000*60*60*24);
    if(diff < 0) return 'bad';
    if(diff <= 30) return 'warn';
    return 'ok';
  }
  function estadoTag(inst){
    const k = estadoKey(inst);
    if(k === 'nodata') return "<span class='tag info'>Sin datos</span>";
    if(k === 'bad') return "<span class='tag bad'>Fuera de calibración</span>";
    if(k === 'warn') return "<span class='tag warn'>Próxima calibración</span>";
    return "<span class='tag ok'>En regla</span>";
  }

  function getOrder(){
    const v = orden.value;
    if(v === 'codigo_desc') return {col:'codigo', asc:false};
    if(v === 'rango_asc') return {col:'rango', asc:true};
    if(v === 'rango_desc') return {col:'rango', asc:false};
    if(v === 'prox_asc') return {col:'proxima_calibracion', asc:true};
    if(v === 'prox_desc') return {col:'proxima_calibracion', asc:false};
    return {col:'codigo', asc:true};
  }

  function updatePager(){
    const perPage = Number(limit.value);
    const totalPages = Math.max(1, Math.ceil(total / perPage));
    pager.style.display = total > 0 ? 'flex' : 'none';
    prevBtn.disabled = page <= 0;
    nextBtn.disabled = page >= totalPages - 1;
    pageInfo.textContent = 'Página ' + (page + 1) + ' de ' + totalPages;
  }

  function updateMeta(){
    if(total === 0){
      meta.textContent = '0 instrumentos';
      return;
    }
    const perPage = Number(limit.value);
    const start = page * perPage + 1;
    const end = Math.min(total, (page + 1) * perPage);
    meta.textContent = total + ' instrumentos · mostrando ' + start + '-' + end;
  }

  function render(data){
    if(!data || !data.length){
      empty("No se encontraron instrumentos");
      return;
    }

    box.innerHTML = data.map(inst => {
      const url = 'qr/qr.info_instrumentos.html?codigo=' + encodeURIComponent(inst.codigo);
      return `
        <div class="result" onclick="window.location.href='${url}'">
          <div class="topline">
            <div>
              <div class="r-code">${escapeHTML(inst.codigo)}</div>
              <div class="r-desc">${escapeHTML(inst.descripcion || '-')}</div>
            </div>
            ${estadoTag(inst)}
          </div>
          <div class="chips">
            <span class="chip">Rango: ${escapeHTML(inst.rango || '-')}</span>
            <span class="chip">Ubicación ID: ${escapeHTML(inst.ubicacion_id ?? '-')}</span>
            <span class="chip">Próx. calib.: ${formatDate(inst.proxima_calibracion)}</span>
          </div>
        </div>
      `;
    }).join('');
  }

  function applyEstadoFilter(data){
    const s = estado.value;
    if(!s) return data;
    return (data || []).filter(inst => estadoKey(inst) === s);
  }

  // ============
  // TEST CONEXIÓN SUPABASE (VISUAL)
  // ============
  async function testSupabase(){
    console.log("window.supabase =", window.supabase);

    if(!supabase){
      empty("❌ Supabase NO está cargado (window.supabase undefined). Revisa config.mjs y la ruta ./config.mjs");
      meta.textContent = "❌ Supabase no cargado";
      throw new Error("Supabase undefined");
    }

    meta.textContent = "✅ Supabase cargado. Probando lectura de instrumentos…";

    const { data, error } = await supabase
      .from("instrumentos")
      .select("codigo, descripcion, rango, ubicacion_id, proxima_calibracion")
      .limit(3);

    if(error){
      console.error("Error leyendo instrumentos:", error);
      empty("❌ Error leyendo instrumentos: " + (error.message || JSON.stringify(error)));
      meta.textContent = "❌ Error leyendo instrumentos";
      return false;
    }

    console.log("TEST OK instrumentos:", data);
    meta.textContent = "✅ Conexión OK. Cargando listado…";
    return true;
  }

  // ============
  // BUSCAR
  // ============
  async function buscar({resetPage=false}={}){
    if(resetPage) page = 0;

    const perPage = Number(limit.value);
    const from = page * perPage;
    const to = from + perPage - 1;

    loading();

    let req = supabase
      .from("instrumentos")
      .select("codigo, descripcion, rango, ubicacion_id, proxima_calibracion", { count: "exact" });

    // Global
    const gt = q.value.trim();
    if(gt){
      const like = "%" + gt + "%";
      req = req.or(
        "codigo.ilike." + like +
        ",descripcion.ilike." + like +
        ",rango.ilike." + like
      );
    }

    // filtros
    const c = codigo.value.trim();
    const d = descripcion.value.trim();
    const r = rango.value.trim();
    const u = ubicacion.value.trim();

    if(c) req = req.ilike("codigo", "%" + c + "%");
    if(d) req = req.ilike("descripcion", "%" + d + "%");
    if(r) req = req.ilike("rango", "%" + r + "%");

    // ubicación id numérico
    if(u){
      const n = Number(u);
      if(!Number.isNaN(n)) req = req.eq("ubicacion_id", n);
    }

    const { col, asc } = getOrder();
    req = req.order(col, { ascending: asc, nullsFirst: false });
    req = req.range(from, to);

    const { data, error, count } = await req;

    if(error){
      console.error("Error query buscar:", error);
      empty("❌ Error en la búsqueda: " + (error.message || JSON.stringify(error)));
      meta.textContent = "❌ Error en búsqueda";
      pager.style.display = "none";
      return;
    }

    total = count ?? 0;

    const filtered = applyEstadoFilter(data || []);
    lastData = filtered;

    updateMeta();

    if(!filtered.length){
      empty("No se encontraron instrumentos con los filtros actuales");
      updatePager();
      return;
    }

    render(filtered);
    updatePager();
  }

  function debouncedBuscar(resetPage=false){
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(() => buscar({resetPage}), 250);
  }

  function reset(){
    q.value = "";
    codigo.value = "";
    descripcion.value = "";
    rango.value = "";
    ubicacion.value = "";
    estado.value = "";
    orden.value = "codigo_asc";
    limit.value = "50";

    page = 0;
    total = 0;
    lastData = [];

    buscar({resetPage:true});
  }

  function toCSV(data){
    const headers = ["codigo","descripcion","rango","ubicacion_id","proxima_calibracion"];
    const esc = (v) => {
      const s = (v ?? "").toString().replaceAll('"','""');
      return '"' + s + '"';
    };
    const lines = [headers.join(",")];
    (data || []).forEach(r => {
      lines.push(headers.map(h => esc(r[h])).join(","));
    });
    return lines.join("\n");
  }

  async function copyCSV(){
    if(!lastData || !lastData.length){
      alert("No hay resultados para copiar.");
      return;
    }
    const csv = toCSV(lastData);
    await navigator.clipboard.writeText(csv);
    alert("Copiado al portapapeles (CSV).");
  }

  // Events
  btnBuscar.addEventListener("click", () => buscar({resetPage:true}));
  btnReset.addEventListener("click", reset);
  btnCopy.addEventListener("click", copyCSV);

  [q, codigo, descripcion, rango, ubicacion].forEach(inp => {
    inp.addEventListener("input", () => debouncedBuscar(true));
  });

  [estado, orden, limit].forEach(sel => {
    sel.addEventListener("change", () => buscar({resetPage:true}));
  });

  prevBtn.addEventListener("click", () => {
    page = Math.max(0, page - 1);
    buscar({resetPage:false});
  });

  nextBtn.addEventListener("click", () => {
    page = page + 1;
    buscar({resetPage:false});
  });

  document.addEventListener("keydown", (e) => {
    if(e.key === "Enter") buscar({resetPage:true});
  });

  // INIT
  // 1) test supabase
  // 2) si ok => cargar listado inicial
  const ok = await testSupabase();
  if(ok) buscar({resetPage:true});
</script>

</body>
</html>
