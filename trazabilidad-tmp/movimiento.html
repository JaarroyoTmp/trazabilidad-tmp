<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>TMP ¬∑ Gesti√≥n de Movimientos de Instrumentos</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <link rel="icon" href="img/tmp-quality.png" />

  <style>
    :root{
      --bg0:#050b16;
      --bg1:#071324;
      --card:#0f1f33;
      --card-soft:#14253c;
      --border:#203552;
      --txt:#f2f6fb;
      --muted:#9fb3ca;
      --accent:#3ea8ff;
      --accent-soft:#163857;
      --ok:#28c989;
      --warn:#ffce52;
      --bad:#ff6b6b;
    }

    * { box-sizing:border-box; margin:0; padding:0; }

    body {
      font-family: "Inter", sans-serif;
      background:
        radial-gradient(circle at 0% 0%, #182f55 0, transparent 55%),
        radial-gradient(circle at 100% 0%, #1a3b64 0, transparent 55%),
        linear-gradient(180deg, var(--bg1), var(--bg0));
      color: var(--txt);
      -webkit-font-smoothing: antialiased;
    }

    .app {
      max-width: 1100px;
      margin: 16px auto 32px;
      padding: 0 14px 40px;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 18px;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .brand-logo {
      height: 34px;
      width: auto;
    }

    .brand-text-title {
      font-size: 17px;
      font-weight: 700;
      letter-spacing: .03em;
    }

    .brand-text-sub {
      font-size: 12px;
      color: var(--muted);
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.06);
      background: rgba(9,22,40,.9);
      color: var(--muted);
    }

    .badge-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: #4ade80;
    }
    .badge.offline .badge-dot { background: #f97373; }

    .btn {
      border: none;
      border-radius: 999px;
      padding: 10px 16px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      background: var(--accent);
      color: #031321;
      box-shadow: 0 8px 18px rgba(0,0,0,.35);
      transition: transform .12s ease, box-shadow .12s ease, background .12s ease;
    }

    .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 12px 24px rgba(0,0,0,.5);
    }

    .btn.secondary {
      background: transparent;
      color: var(--muted);
      border: 1px solid var(--border);
      box-shadow: none;
    }

    .btn.secondary:hover {
      background: rgba(17,35,58,.9);
      border-color: #31639f;
    }

    .btn.sm { padding: 7px 12px; font-size: 12px; }

    .btn[disabled] {
      opacity: .45;
      cursor: not-allowed;
      box-shadow: none;
      transform: none;
    }

    main { display:flex; flex-direction:column; gap:16px; }

    .card {
      border-radius:16px;
      background:linear-gradient(135deg,#0f1f33,#0a1625);
      border:1px solid rgba(43,78,122,.75);
      box-shadow:0 18px 40px rgba(0,0,0,.50);
      padding:16px 16px 14px;
    }

    .card-header {
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:10px;
    }

    .card-title { font-size:15px; font-weight:600; }

    .card-sub {
      font-size:12px;
      color:var(--muted);
      margin-top:2px;
    }

    label {
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.08em;
      color:var(--muted);
      margin-bottom:4px;
      display:block;
    }

    input,select,textarea {
      background:#050d1a;
      border:1px solid #253954;
      border-radius:10px;
      padding:9px 11px;
      color:var(--txt);
      width:100%;
      font-size:13px;
      outline:none;
    }

    input[readonly] { opacity:.8; }

    textarea { min-height:70px; resize:vertical; }

  </style>
</head>

<body>
<div class="app">

<header>
  <div class="brand">
    <img src="img/tmp-quality.png" class="brand-logo">
    <div>
      <div class="brand-text-title">TMP ¬∑ Movimientos de Instrumentos</div>
      <div class="brand-text-sub">Trazabilidad ‚Äî Entradas / Salidas / Estados</div>
    </div>
  </div>
  <div class="row-right">
    <button class="btn secondary" onclick="window.location.href='home.html'">‚Üê Volver</button>
    <div id="onlineBadge" class="badge offline">
      <span class="badge-dot"></span>
      <span id="onlineText">Offline (sin conexi√≥n Supabase)</span>
    </div>
  </div>
</header>

<main>

<!-- ‚óè‚óè‚óè INSTRUMENTO ‚óè‚óè‚óè -->
<section class="card">
  <div class="card-header">
    <div>
      <div class="card-title">Instrumento</div>
      <div class="card-sub">Introduce el c√≥digo o usa QR.</div>
    </div>

    <div id="estadoChip" class="pill neutral">Esperando instrumento</div>
  </div>

  <div class="grid">
    <div style="grid-column:1/-1">
      <label>C√≥digo del instrumento</label>
      <div class="row">
        <input id="codigoInput" placeholder="Ej. 11217">
        <button id="btnCargarInstrumento" class="btn sm">Cargar</button>
      </div>
    </div>

    <div><label>Descripci√≥n</label><input id="descInstrumento" readonly></div>
    <div><label>Fabricante</label><input id="fabInstrumento" readonly></div>
    <div><label>Rango</label><input id="rangoInstrumento" readonly></div>

    <div><label>Unidad</label><input id="unidadInstrumento" readonly></div>
    <div><label>Precisi√≥n</label><input id="precisionInstrumento" readonly></div>
    <div><label>Ubicaci√≥n actual</label><input id="ubicacionInstrumento" readonly></div>

    <div><label>√öltima calibraci√≥n</label><input id="ultimaCal" readonly></div>
    <div><label>Pr√≥xima calibraci√≥n</label><input id="proximaCal" readonly></div>
    <div><label>Tipo calibraci√≥n</label><input id="tipoCal" readonly></div>
  </div>

  <div class="stats">
    <div id="statEstado" class="stat-badge">Estado: ‚Äî</div>
    <div id="statDias" class="stat-badge">D√≠as hasta pr√≥xima: ‚Äî</div>
    <div id="statUso" class="stat-badge">Movimientos: ‚Äî</div>
  </div>

  <div id="alertInstrumento" class="alert hidden"></div>
</section>
<!-- ‚óè‚óè‚óè REGISTRAR MOVIMIENTO ‚óè‚óè‚óè -->
<section class="card">
  <div class="card-header">
    <div>
      <div class="card-title">Registrar movimiento</div>
      <div class="card-sub">El registro se a√±adir√° autom√°ticamente.</div>
    </div>
  </div>

  <!-- ALERTA CR√çTICA (fuera calibraci√≥n) -->
  <div id="alertaCritica" class="alert-critical hidden">
    <h3>‚ö† INSTRUMENTO FUERA DE CALIBRACI√ìN</h3>
    <p>Para continuar debes calibrar o registrar un uso bajo responsabilidad.</p>

    <label>Responsable autorizado</label>
    <input id="responsableAutorizacion" placeholder="Nombre de quien autoriza">

    <div class="row" style="justify-content:flex-end;margin-top:8px;">
      <button class="btn secondary" id="btnCalibrarAhora">Calibrar ahora</button>
      <button class="btn" id="btnForzarUso">Usar bajo responsabilidad</button>
    </div>
  </div>

  <div class="grid" style="margin-top:10px;">

    <div>
      <label>Tipo de movimiento</label>
      <select id="tipoMovimiento">
        <option value="">Selecciona...</option>
        <option value="Entrada">Entrada</option>
        <option value="Salida">Salida</option>
        <option value="Pr√©stamo externo">Pr√©stamo externo</option>
        <option value="Revisi√≥n / reparaci√≥n">Revisi√≥n / reparaci√≥n</option>
        <option value="Env√≠o a calibraci√≥n externa">Env√≠o a calibraci√≥n externa</option>
      </select>
    </div>

    <div>
      <label>Responsable</label>
      <input id="responsable" placeholder="Responsable del movimiento">
    </div>

    <!-- NUEVOS CAMPOS -->
    <div>
      <label>Operario 1 (obligatorio)</label>
      <input id="operario1" placeholder="Nombre del operario principal">
    </div>

    <div>
      <label>Operario 2 (opcional)</label>
      <input id="operario2" placeholder="Segundo operario (si existe)">
    </div>

    <div>
      <label>Destino</label>
      <input id="destino" placeholder="Ej: Laboratorio, l√≠nea 2...">
    </div>

    <div style="grid-column:1/-1">
      <label>Observaciones</label>
      <textarea id="observaciones" placeholder="Opcional"></textarea>
      <p class="helper-text">El estado de calibraci√≥n se anexa autom√°ticamente.</p>
    </div>

  </div>

  <div class="row" style="justify-content:flex-end;margin-top:10px;">
    <button class="btn secondary" id="btnLimpiar">Limpiar</button>
    <button class="btn" id="btnRegistrar">Registrar</button>
  </div>

  <div id="alertMovimiento" class="alert hidden"></div>
</section>
<!-- ‚óè‚óè‚óè HIST√ìRICO ‚óè‚óè‚óè -->
<section class="card">
  <div class="card-header">
    <div>
      <div class="card-title">Hist√≥rico reciente</div>
      <div class="card-sub">√öltimos 20 movimientos</div>
    </div>
  </div>

  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>Fecha</th>
          <th>Tipo</th>
          <th>Responsable</th>
          <th>Operario 1</th>
          <th>Operario 2</th>
          <th>Destino</th>
          <th>Observaciones</th>
        </tr>
      </thead>

      <tbody id="tablaMovimientos">
        <tr><td colspan="7">Introduce un c√≥digo para ver movimientos</td></tr>
      </tbody>
    </table>
  </div>
</section>

</main>
</div>

<!-- MODAL QR -->
<div id="qrModal" class="qr-modal hidden">
  <div class="qr-modal-backdrop"></div>
  <div class="qr-modal-inner">
    <h2>Escanear c√≥digo QR</h2>
    <p class="helper-text">Apunta la c√°mara al QR del instrumento.</p>
    <div id="qrReader"></div>
    <div class="row" style="justify-content:end;margin-top:10px;">
      <button class="btn secondary" id="btnCerrarQR">Cancelar</button>
    </div>
  </div>
</div>

<!-- FAB -->
<button class="qr-fab" id="btnFabQR">üì∑</button>

<script src="https://unpkg.com/html5-qrcode"></script>
<script type="module" src="config.mjs"></script>

<script type="module">
import { supabase } from "./config.mjs";
window.supabase = supabase;
const sb = window.supabase;

function $(s){return document.querySelector(s);}

function fmtDate(iso){
  const d=new Date(iso); 
  return d.toISOString().replace("T"," ").slice(0,16)+" UTC";
}

function daysDiff(date){
  const d=new Date(date+"T00:00:00");
  return Math.round((d - new Date())/86400000);
}

function computeEstado(prox){
  const dias=daysDiff(prox);
  if(dias<0) return {estado:"FUERA DE CALIBRACI√ìN", clase:"bad"};
  if(dias<=30) return {estado:"PR√ìXIMA CALIBRACI√ìN", clase:"warn"};
  return {estado:"EN CALIBRACI√ìN", clase:"ok"};
}

let instrumentoActual=null;
let estadoActualInstrumento=null;
let movimientosCount=0;

async function cargarInstrumento(){
  const codigo=$("#codigoInput").value.trim();
  const alert=$("#alertInstrumento");
  alert.classList.add("hidden");

  if(!codigo){
    alert.textContent="Introduce un c√≥digo";
    alert.classList.remove("hidden");
    return;
  }

  const {data,error} = await sb.from("instrumentos")
    .select("*")
    .eq("codigo",codigo)
    .maybeSingle();

  if(error || !data){
    alert.textContent="Instrumento no encontrado";
    alert.classList.remove("hidden");
    return;
  }

  instrumentoActual=data;

  $("#descInstrumento").value=data.descripcion||"";
  $("#fabInstrumento").value=data.fabricante||"";
  $("#rangoInstrumento").value=data.rango||"";
  $("#unidadInstrumento").value=data.unidad_base||"";
  $("#precisionInstrumento").value=data.precision||"";
  $("#ubicacionInstrumento").value=data.ubicacion_actual||"";

  $("#ultimaCal").value=data.fecha_ultima_calibracion||"";
  $("#proximaCal").value=data.fecha_proxima_calibracion||"";
  $("#tipoCal").value=data.tipo_calibracion||"";

  const est=computeEstado(data.fecha_proxima_calibracion);
  estadoActualInstrumento=est;

  $("#estadoChip").textContent = est.estado;
  $("#estadoChip").className = "pill " + est.clase;

  await cargarMovimientos(data.codigo);
}

async function cargarMovimientos(codigo){
  const tbody=$("#tablaMovimientos");

  const {data,error}=await sb.from("movimientos")
    .select("*")
    .eq("codigo_instrumento",codigo)
    .order("fecha",{ascending:false})
    .limit(20);

  if(error || !data.length){
    tbody.innerHTML=`<tr><td colspan="7">No hay movimientos</td></tr>`;
    return;
  }

  tbody.innerHTML = data.map(m => `
    <tr>
      <td>${fmtDate(m.fecha)}</td>
      <td>${m.tipo_movimiento}</td>
      <td>${m.responsable || ""}</td>
      <td>${m.operario1 || ""}</td>
      <td>${m.operario2 || ""}</td>
      <td>${m.destino || ""}</td>
      <td style="white-space:normal;max-width:260px;">${(m.observaciones||"").replace(/\n/g,"<br>")}</td>
    </tr>
  `).join("");
}

async function registrarMovimiento(){
  const alert=$("#alertMovimiento");
  alert.classList.add("hidden");

  if(!instrumentoActual){
    alert.textContent="Primero carga un instrumento";
    alert.classList.remove("hidden");
    return;
  }

  const tipo=$("#tipoMovimiento").value;
  const responsable=$("#responsable").value.trim();
  const operario1=$("#operario1").value.trim();
  const operario2=$("#operario2").value.trim();
  const destino=$("#destino").value.trim();
  const obsUser=$("#observaciones").value.trim();

  if(!tipo){ alert.textContent="Selecciona un tipo"; alert.classList.remove("hidden"); return; }
  if(!responsable){ alert.textContent="Introduce un responsable"; alert.classList.remove("hidden"); return; }
  if(!operario1){ alert.textContent="Introduce Operario 1"; alert.classList.remove("hidden"); return; }

  const est=computeEstado(instrumentoActual.fecha_proxima_calibracion);
  let obsFinal=(obsUser?obsUser+"\n":"") + `Estado calibraci√≥n: ${est.estado}`;

  let nuevaUbicacion = (tipo==="Entrada") ? "Laboratorio" : (destino || instrumentoActual.ubicacion_actual);

  const {error:errorMov}=await sb.from("movimientos").insert({
    codigo_instrumento: instrumentoActual.codigo,
    fecha:new Date().toISOString(),
    tipo_movimiento:tipo,
    responsable,
    operario1,
    operario2: operario2 || null,
    destino,
    observaciones:obsFinal
  });

  if(errorMov){
    alert.textContent="Error al registrar";
    alert.classList.remove("hidden");
    return;
  }

  await sb.from("instrumentos")
    .update({ubicacion_actual:nuevaUbicacion})
    .eq("codigo",instrumentoActual.codigo);

  alert.textContent="Movimiento registrado con √©xito";
  alert.style.background="rgba(22,101,52,.5)";
  alert.style.borderColor="#4ade80";
  alert.style.color="#dcfce7";
  alert.classList.remove("hidden");

  $("#tipoMovimiento").value="";
  $("#responsable").value="";
  $("#operario1").value="";
  $("#operario2").value="";
  $("#destino").value="";
  $("#observaciones").value="";

  await cargarMovimientos(instrumentoActual.codigo);
}

$("#btnRegistrar").onclick=registrarMovimiento;
$("#btnCargarInstrumento").onclick=cargarInstrumento;
$("#btnLimpiar").onclick=()=> {
  $("#tipoMovimiento").value="";
  $("#responsable").value="";
  $("#operario1").value="";
  $("#operario2").value="";
  $("#destino").value="";
  $("#observaciones").value="";
};

</script>
</body>
</html>
