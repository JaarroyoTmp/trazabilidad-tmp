<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>TMP · Gestión de Movimientos de Instrumentos</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="icon" href="img/tmp-quality.png" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg0:#050b16;
      --bg1:#071324;
      --card:#0f1f33;
      --card-soft:#14253c;
      --border:#203552;
      --txt:#f2f6fb;
      --muted:#9fb3ca;
      --accent:#3ea8ff;
      --accent-soft:#163857;
      --ok:#28c989;
      --warn:#ffce52;
      --bad:#ff6b6b;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%}
    body{
      font-family:"Inter",system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
      background:
        radial-gradient(circle at 0% 0%, #182f55 0, transparent 55%),
        radial-gradient(circle at 100% 0%, #1a3b64 0, transparent 55%),
        linear-gradient(180deg,var(--bg1),var(--bg0));
      color:var(--txt);
      -webkit-font-smoothing:antialiased;
    }
    .app{
      max-width:1100px;
      margin:16px auto 32px;
      padding:0 14px 40px;
    }
    header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:18px;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .brand-logo{
      height:34px;
      width:auto;
    }
    .brand-text-title{
      font-size:17px;
      font-weight:700;
      letter-spacing:.03em;
    }
    .brand-text-sub{
      font-size:12px;
      color:var(--muted);
    }
    .badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      font-size:11px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.06);
      background:rgba(9,22,40,.9);
      color:var(--muted);
    }
    .badge-dot{
      width:7px;height:7px;border-radius:999px;background:#4ade80;
    }
    .badge.offline .badge-dot{background:#f97373;}

    .btn{
      border:none;
      border-radius:999px;
      padding:10px 16px;
      font-size:13px;
      font-weight:600;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      background:var(--accent);
      color:#031321;
      box-shadow:0 8px 18px rgba(0,0,0,.35);
      transition:transform .12s ease,box-shadow .12s ease,background .12s ease;
    }
    .btn:hover{transform:translateY(-1px);box-shadow:0 12px 24px rgba(0,0,0,.5);}
    .btn.secondary{
      background:transparent;
      color:var(--muted);
      border:1px solid var(--border);
      box-shadow:none;
    }

    main{
      display:flex;
      flex-direction:column;
      gap:16px;
    }

    .card{
      border-radius:16px;
      background:linear-gradient(135deg,#0f1f33,#0a1625);
      border:1px solid rgba(43,78,122,.75);
      padding:16px;
    }

    .card-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:10px;
    }

    .card-title{font-size:15px;font-weight:600;}
    .card-sub{font-size:12px;color:var(--muted);margin-top:2px;}

    .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      border-radius:999px;
      padding:3px 9px;
      font-size:11px;
    }
    .pill.ok{background:#07281a;border:1px solid #18a46d;}
    .pill.warn{background:#392a09;border:1px solid #f9d567;}
    .pill.bad{background:#3b1010;border:1px solid #ff7b7b;}
    .pill.neutral{background:#101827;border:1px solid #404b63;}

    .grid{
      display:grid;
      grid-template-columns:repeat(3,minmax(0,1fr));
      gap:10px 14px;
    }

    label{font-size:11px;color:var(--muted);margin-bottom:4px;display:block;}
    input,select,textarea{
      width:100%;
      color:var(--txt);
      background:#050d1a;
      border-radius:10px;
      border:1px solid #253954;
      padding:9px 11px;
      font-size:13px;
    }

    table{
      width:100%;
      border-collapse:collapse;
      margin-top:8px;
      font-size:12px;
    }
    th,td{
      padding:6px 6px;
      border-bottom:1px solid #1f3046;
    }
    .table-wrap{
      border-radius:12px;
      overflow:auto;
      border:1px solid #203552;
      max-height:260px;
    }

    .alert{
      font-size:11px;
      color:#fecaca;
      background:rgba(127,29,29,.4);
      border-radius:9px;
      padding:6px 9px;
      border:1px solid rgba(248,113,113,.7);
      margin-top:8px;
    }
    .hidden{display:none !important;}
  </style>
</head>

<body>

<div class="app">
  <header>
    <div class="brand">
      <img src="img/tmp-quality.png" class="brand-logo">
      <div>
        <div class="brand-text-title">TMP · Movimientos de Instrumentos</div>
        <div class="brand-text-sub">Control diario de entrada / salida</div>
      </div>
    </div>

    <div class="row-right">
      <button class="btn secondary" onclick="window.location.href='home.html'">← Volver al panel principal</button>

      <div id="onlineBadge" class="badge offline">
        <span class="badge-dot"></span>
        <span id="onlineText">Offline (sin conexión Supabase)</span>
      </div>
    </div>
  </header>

  <main>

    <!-- === INSTRUMENTO === -->
    <section class="card">
      <div class="card-header">
        <div>
          <div class="card-title">Instrumento</div>
          <div class="card-sub">Introduce el código exacto del instrumento.</div>
        </div>
        <div id="estadoChip" class="pill neutral">Esperando selección</div>
      </div>

      <div class="grid">
        <div style="grid-column:1/-1;display:flex;gap:8px;align-items:flex-end;">
          <div style="flex:1">
            <label for="codigoInput">Código</label>
            <input id="codigoInput" autocomplete="off" />
          </div>
          <button id="btnCargarInstrumento" class="btn">Cargar</button>
        </div>

        <div><label>Descripción</label><input id="descInstrumento" readonly></div>
        <div><label>Fabricante</label><input id="fabInstrumento" readonly></div>
        <div><label>Rango</label><input id="rangoInstrumento" readonly></div>

        <div><label>Unidad</label><input id="unidadInstrumento" readonly></div>
        <div><label>Precisión</label><input id="precisionInstrumento" readonly></div>
        <div><label>Ubicación</label><input id="ubicacionInstrumento" readonly></div>

        <div><label>Última cal.</label><input id="ultimaCal" readonly></div>
        <div><label>Próxima cal.</label><input id="proximaCal" readonly></div>
        <div><label>Tipo cal.</label><input id="tipoCal" readonly></div>
      </div>

      <div class="alert hidden" id="alertInstrumento"></div>
    </section>

    <!-- === REGISTRAR MOVIMIENTO === -->
    <section class="card">
      <div class="card-header">
        <div class="card-title">Registrar movimiento</div>
      </div>

      <div class="grid">
        <div>
          <label for="tipoMovimiento">Tipo</label>
          <select id="tipoMovimiento">
            <option value="">Selecciona…</option>
            <option value="Entrada / Salida">Entrada / Salida</option>
            <option value="Préstamo interno">Préstamo interno</option>
            <option value="Revisión / reparación">Revisión / reparación</option>
            <option value="Envío a calibración externa">Envío a calibración externa</option>
          </select>
        </div>

        <div>
          <label for="responsable">Responsable</label>
          <input id="responsable" placeholder="Operario">
        </div>

        <div>
          <label for="destino">Destino</label>
          <input id="destino" placeholder="Ubicación / área">
        </div>

        <div style="grid-column:1/-1">
          <label for="observaciones">Observaciones</label>
          <textarea id="observaciones"></textarea>
        </div>
      </div>

      <div class="row-right" style="margin-top:10px">
        <button id="btnLimpiar" class="btn secondary">Limpiar</button>
        <button id="btnRegistrar" class="btn">Registrar</button>
      </div>

      <div class="alert hidden" id="alertMovimiento"></div>
    </section>

    <!-- === HISTÓRICO === -->
    <section class="card">
      <div class="card-header">
        <div class="card-title">Histórico reciente</div>
      </div>

      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Fecha</th>
              <th>Tipo</th>
              <th>Resp.</th>
              <th>Destino</th>
              <th>Obs.</th>
            </tr>
          </thead>
          <tbody id="tablaMovimientos">
            <tr><td colspan="5">Selecciona un instrumento…</td></tr>
          </tbody>
        </table>
      </div>
    </section>

  </main>
</div>

<!-- CONFIG SUPABASE -->
<script type="module" src="config.js"></script>

<script type="module">

/* === ACCESO A SUPABASE === */
const supabase = window.supabase;

/* === UTILIDADES === */
const $ = (s)=>document.querySelector(s);
const fmt = (iso)=> iso ? iso.replace("T"," ").slice(0,16) : "—";
const fmtShort = (iso)=>{
  if(!iso) return "—";
  const d = new Date(iso);
  return `${String(d.getUTCDate()).padStart(2,"0")}/${String(d.getUTCMonth()+1).padStart(2,"0")}/${d.getUTCFullYear()}`;
};
const hoy = ()=> new Date();

/* === ONLINE/OFFLINE === */
function setOnline(ok){
  const b = $("#onlineBadge");
  const t = $("#onlineText");
  b.classList.toggle("offline", !ok);
  t.textContent = ok ? "Online (Supabase conectado)" : "Offline (sin Supabase)";
}

setOnline(!!supabase);

/* === ESTADO INSTRUMENTO === */
function estadoCal(proxima){
  if(!proxima) return {txt:"Sin fecha",clase:"warn"};
  const d = (new Date(proxima)) - hoy();
  const ds = Math.round(d / 86400000);
  if(ds < 0) return {txt:"Fuera de calibración",clase:"bad"};
  if(ds <= 30) return {txt:`Próxima (${ds} días)`,clase:"warn"};
  return {txt:`En plazo (${ds} días)`,clase:"ok"};
}

/* === VARIABLES === */
let instrumento = null;
let movimientos = 0;

/* === CARGAR INSTRUMENTO === */
async function cargarInstrumento(){
  const codigo = $("#codigoInput").value.trim();
  const alert = $("#alertInstrumento");
  alert.classList.add("hidden");

  if(!codigo){
    alert.textContent = "Introduce un código.";
    alert.classList.remove("hidden");
    return;
  }

  const {data, error} = await supabase
    .from("instrumentos")
    .select("*")
    .eq("codigo", codigo)
    .maybeSingle();

  if(error){
    alert.textContent = "Error cargando instrumento.";
    alert.classList.remove("hidden");
    return;
  }

  if(!data){
    alert.textContent = "No existe ese instrumento.";
    alert.classList.remove("hidden");
    instrumento = null;
    pintarInstrumento(null);
    pintarHist(null);
    return;
  }

  instrumento = data;
  pintarInstrumento(data);
  cargarHist(data.codigo);
}

/* === PINTAR INSTRUMENTO === */
function pintarInstrumento(inst){
  if(!inst){
    $("#descInstrumento").value =
    $("#fabInstrumento").value =
    $("#rangoInstrumento").value =
    $("#unidadInstrumento").value =
    $("#precisionInstrumento").value =
    $("#ubicacionInstrumento").value =
    $("#ultimaCal").value =
    $("#proximaCal").value =
    $("#tipoCal").value = "";
    $("#estadoChip").className = "pill neutral";
    $("#estadoChip").textContent = "Esperando";
    return;
  }

  $("#descInstrumento").value = inst.descripcion || inst.descripcion_equipo || "";
  $("#fabInstrumento").value = inst.fabricante || inst.marca || "";
  $("#rangoInstrumento").value = inst.rango || "";
  $("#unidadInstrumento").value = inst.unidad_base || "";
  $("#precisionInstrumento").value = inst.precision || "";
  $("#ubicacionInstrumento").value = inst.ubicacion_actual || "";
  $("#ultimaCal").value = fmtShort(inst.ultima_calibracion);
  $("#proximaCal").value = fmtShort(inst.proxima_calibracion);
  $("#tipoCal").value = inst.tipo_calibracion || "";

  const e = estadoCal(inst.proxima_calibracion);
  $("#estadoChip").className = "pill " + e.clase;
  $("#estadoChip").textContent = e.txt;
}

/* === HISTÓRICO === */
async function cargarHist(cod){
  const tbl = $("#tablaMovimientos");

  const {data,error} = await supabase
    .from("movimientos")
    .select("*")
    .eq("codigo_instrumento", cod)
    .order("fecha",{ascending:false})
    .limit(20);

  if(error || !data){
    tbl.innerHTML = `<tr><td colspan="5">Error cargando histórico.</td></tr>`;
    return;
  }

  movimientos = data.length;

  tbl.innerHTML = data.map(m=>`
    <tr>
      <td>${fmt(m.fecha)}</td>
      <td>${m.tipo_movimiento || ""}</td>
      <td>${m.responsable || ""}</td>
      <td>${m.destino || ""}</td>
      <td>${(m.observaciones||"").replace(/\n/g,"<br>")}</td>
    </tr>
  `).join("");
}

function pintarHist() {
  $("#tablaMovimientos").innerHTML =
    `<tr><td colspan="5">No hay movimientos.</td></tr>`;
}

/* === REGISTRAR MOVIMIENTO === */
async function registrar(){
  const alert = $("#alertMovimiento");
  alert.classList.add("hidden");
  alert.textContent = "";

  if(!instrumento){
    alert.textContent = "Primero carga un instrumento.";
    alert.classList.remove("hidden");
    return;
  }

  const tipo = $("#tipoMovimiento").value.trim();
  const resp = $("#responsable").value.trim();
  const dest = $("#destino").value.trim();
  const obs  = $("#observaciones").value.trim();

  if(!tipo){
    alert.textContent = "Elige un tipo.";
    alert.classList.remove("hidden");
    return;
  }
  if(!resp){
    alert.textContent = "Indica responsable.";
    alert.classList.remove("hidden");
    return;
  }

  const e = estadoCal(instrumento.proxima_calibracion);
  const obsFinal = obs + `\nEstado: ${e.txt}`;

  const payload = {
    codigo_instrumento: instrumento.codigo,
    fecha: new Date().toISOString(),
    tipo_movimiento: tipo,
    responsable: resp,
    destino: dest,
    observaciones: obsFinal
  };

  const {error} = await supabase.from("movimientos").insert(payload);

  if(error){
    console.error(error);
    alert.textContent = "Error registrando movimiento.";
    alert.classList.remove("hidden");
    return;
  }

  alert.textContent = "Movimiento registrado.";
  alert.style.background = "rgba(22,101,52,.5)";
  alert.style.borderColor = "#4ade80";
  alert.style.color = "#dcfce7";
  alert.classList.remove("hidden");

  cargarHist(instrumento.codigo);
}

/* === EVENTOS === */
$("#btnCargarInstrumento").addEventListener("click", cargarInstrumento);
$("#btnRegistrar").addEventListener("click", registrar);
$("#btnLimpiar").addEventListener("click", ()=>{
  $("#tipoMovimiento").value="";
  $("#responsable").value="";
  $("#destino").value="";
  $("#observaciones").value="";
});
$("#codigoInput").addEventListener("keydown",(e)=>{
  if(e.key==="Enter"){
    e.preventDefault();
    cargarInstrumento();
  }
});

</script>

</body>
</html>

