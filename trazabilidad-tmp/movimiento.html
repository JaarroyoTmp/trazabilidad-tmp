<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>TMP ¬∑ Gesti√≥n de Movimientos de Instrumentos</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <link rel="icon" href="img/tmp-quality.png" />

  <style>
    :root{
      --bg0:#050b16;
      --bg1:#071324;
      --card:#0f1f33;
      --card-soft:#14253c;
      --border:#203552;
      --txt:#f2f6fb;
      --muted:#9fb3ca;
      --accent:#3ea8ff;
      --accent-soft:#163857;
      --ok:#28c989;
      --warn:#ffce52;
      --bad:#ff6b6b;
    }

    * { box-sizing:border-box; margin:0; padding:0; }

    body {
      font-family: "Inter", sans-serif;
      background:
        radial-gradient(circle at 0% 0%, #182f55 0, transparent 55%),
        radial-gradient(circle at 100% 0%, #1a3b64 0, transparent 55%),
        linear-gradient(180deg, var(--bg1), var(--bg0));
      color: var(--txt);
      -webkit-font-smoothing: antialiased;
    }

    .app {
      max-width: 1100px;
      margin: 16px auto 32px;
      padding: 0 14px 40px;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 18px;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .brand-logo {
      height: 34px;
      width: auto;
    }

    .brand-text-title {
      font-size: 17px;
      font-weight: 700;
      letter-spacing: .03em;
    }

    .brand-text-sub {
      font-size: 12px;
      color: var(--muted);
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.06);
      background: rgba(9,22,40,.9);
      color: var(--muted);
    }

    .badge-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: #4ade80;
    }

    .badge.offline .badge-dot {
      background: #f97373;
    }

    .btn {
      border: none;
      border-radius: 999px;
      padding: 10px 16px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      background: var(--accent);
      color: #031321;
      box-shadow: 0 8px 18px rgba(0,0,0,.35);
      transition: transform .12s ease, box-shadow .12s ease, background .12s ease;
    }

    .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 12px 24px rgba(0,0,0,.5);
    }

    .btn.secondary {
      background: transparent;
      color: var(--muted);
      border: 1px solid var(--border);
      box-shadow: none;
    }

    .btn.secondary:hover {
      background: rgba(17,35,58,.9);
      border-color: #31639f;
    }

    .btn.sm {
      padding: 7px 12px;
      font-size: 12px;
    }

    .btn[disabled] {
      opacity: .45;
      cursor: not-allowed;
      box-shadow: none;
      transform: none;
    }

    main {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .card {
      border-radius: 16px;
      background: linear-gradient(135deg, #0f1f33, #0a1625);
      border: 1px solid rgba(43,78,122,.75);
      box-shadow: 0 18px 40px rgba(0,0,0,.50);
      padding: 16px 16px 14px;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .card-title {
      font-size: 15px;
      font-weight: 600;
    }

    .card-sub {
      font-size: 12px;
      color: var(--muted);
      margin-top: 2px;
    }

    .pill {
      padding: 3px 9px;
      border-radius: 999px;
      font-size: 11px;
      border: 1px solid rgba(52,94,145,.9);
      background: rgba(15,36,66,.9);
      color: var(--muted);
    }

    .pill.ok { background:#07281a; border-color:#18a46d; color:#c9ffe5; }
    .pill.warn { background:#392a09; border-color:#f9d567; color:#fff2c2; }
    .pill.bad { background:#3b1010; border-color:#ff7b7b; color:#ffe2e2; }

    .grid { display:grid; grid-template-columns:repeat(3,minmax(0,1fr)); gap:10px 14px;}
    @media(max-width:900px){ .grid{grid-template-columns:repeat(2,minmax(0,1fr));}}
    @media(max-width:640px){ .grid{grid-template-columns:1fr;} .btn{width:100%;}}

    .row {
      display:flex;
      align-items:center;
      gap:8px;
    }

    label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: .08em;
      color: var(--muted);
      margin-bottom: 4px;
      display: block;
    }

    input,select,textarea {
      background:#050d1a;
      border:1px solid #253954;
      border-radius:10px;
      padding:9px 11px;
      color:var(--txt);
      width:100%;
      font-size:13px;
      outline:none;
    }

    input[readonly] {
      opacity:.85;
      background:#060d19;
    }

    textarea { min-height:70px; resize:vertical; }

    .alert {
      font-size:11px;
      padding:6px 9px;
      border-radius:9px;
      border:1px solid rgba(248,113,113,.7);
      color:#fecaca;
      background:rgba(127,29,29,.4);
      margin-top:8px;
    }

    .alert-critical {
      font-size:12px;
      margin-top:10px;
      padding:10px 12px;
      border-radius:12px;
      background:rgba(127,29,29,.7);
      border:1px solid #f97373;
      color:#fee2e2;
      box-shadow:0 0 22px rgba(248,113,113,.7);
    }

    .alert-critical h3 {
      margin:0 0 4px;
      font-size:13px;
      text-transform:uppercase;
      letter-spacing:.08em;
    }

    .helper-text {
      font-size: 11px;
      color: var(--muted);
      margin-top:4px;
    }

    .hidden { display:none !important; }

    .stats{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin-top:10px;
    }

    .stat-badge{
      font-size:11px;
      padding:4px 8px;
      border-radius:999px;
      background:#050d1a;
      border:1px solid #253954;
      color:var(--muted);
    }

    .table-wrap {
      border-radius:12px;
      overflow:auto;
      border:1px solid #203552;
      max-height:260px;
    }

    table { width:100%; border-collapse:collapse; font-size:12px; }
    th,td { padding:6px; border-bottom:1px solid #1f3046; white-space:nowrap; }
    th { background:#0c1929; text-transform:uppercase; color:var(--muted); font-size:11px; position:sticky; top:0; }

    /* ========= FAB QR MET√ÅLICO / T√âCNICO ========= */
    .qr-fab {
      position: fixed;
      right: 18px;
      bottom: 22px;
      width: 56px;
      height: 56px;
      border-radius: 999px;
      border: 1px solid #38bdf8;
      background:
        radial-gradient(circle at 30% 20%, #1f2937 0, #020617 60%);
      box-shadow:
        0 0 18px rgba(56,189,248,.55),
        0 10px 22px rgba(0,0,0,.75);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
      cursor: pointer;
      color: #e5f2ff;
      z-index: 60;
      transition: transform .12s ease, box-shadow .12s ease, border-color .12s ease;
    }

    .qr-fab:hover {
      transform: translateY(-2px);
      box-shadow:
        0 0 26px rgba(56,189,248,.85),
        0 14px 30px rgba(0,0,0,.9);
      border-color: #7dd3fc;
    }

    /* ========= MODAL QR ========= */
    .qr-modal {
      position: fixed;
      inset: 0;
      z-index: 50;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .qr-modal-backdrop {
      position:absolute;
      inset:0;
      background:rgba(15,23,42,.88);
      backdrop-filter: blur(6px);
    }

    .qr-modal-inner {
      position: relative;
      z-index: 51;
      width: min(440px, 92%);
      border-radius: 16px;
      padding: 14px 16px 16px;
      background:
        radial-gradient(circle at 0% 0%, rgba(59,130,246,.22) 0, transparent 60%),
        radial-gradient(circle at 100% 0%, rgba(45,212,191,.18) 0, transparent 60%),
        linear-gradient(135deg,#020617,#02081a);
      border:1px solid rgba(37,99,235,.75);
      box-shadow:
        0 20px 50px rgba(0,0,0,.9),
        0 0 28px rgba(56,189,248,.4);
    }

    .qr-modal-inner h2 {
      margin: 0 0 4px;
      font-size: 15px;
    }

    #qrReader {
      margin-top: 10px;
      width: 100%;
      min-height: 260px;
      border-radius: 12px;
      overflow: hidden;
      border: 1px solid #1f2937;
      background:#020617;
    }

    #qrReader video {
      border-radius: 10px;
    }
  </style>
</head>

<body>
<div class="app">

  <header>
    <div class="brand">
      <img src="img/tmp-quality.png" class="brand-logo">
      <div>
        <div class="brand-text-title">TMP ¬∑ Movimientos de Instrumentos</div>
        <div class="brand-text-sub">Trazabilidad ‚Äî Entradas / Salidas / Estados</div>
      </div>
    </div>

    <div class="row-right">
      <button class="btn secondary" onclick="window.location.href='home.html'">‚Üê Volver al panel principal</button>

      <div id="onlineBadge" class="badge offline">
        <span class="badge-dot"></span>
        <span id="onlineText">Offline (sin conexi√≥n Supabase)</span>
      </div>
    </div>
  </header>

  <main>

    <!-- ‚óè‚óè‚óè INSTRUMENTO ‚óè‚óè‚óè -->
    <section class="card">
      <div class="card-header">
        <div>
          <div class="card-title">Instrumento</div>
          <div class="card-sub">
            Introduce el <b>c√≥digo exacto</b> para cargar sus datos o usa el lector QR.
          </div>
        </div>
        <div id="estadoChip" class="pill neutral">Esperando instrumento</div>
      </div>

      <div class="grid">
        <div style="grid-column:1/-1">
          <label>C√≥digo del instrumento</label>
          <div class="row">
            <input id="codigoInput" placeholder="Ej. 11217">
            <button id="btnCargarInstrumento" class="btn sm">Cargar</button>
          </div>
        </div>

        <div>
          <label>Descripci√≥n</label>
          <input id="descInstrumento" readonly>
        </div>
        <div>
          <label>Fabricante</label>
          <input id="fabInstrumento" readonly>
        </div>
        <div>
          <label>Rango</label>
          <input id="rangoInstrumento" readonly>
        </div>

        <div>
          <label>Unidad</label>
          <input id="unidadInstrumento" readonly>
        </div>
        <div>
          <label>Precisi√≥n</label>
          <input id="precisionInstrumento" readonly>
        </div>
        <div>
          <label>Ubicaci√≥n actual</label>
          <input id="ubicacionInstrumento" readonly>
        </div>

        <div>
          <label>√öltima calibraci√≥n</label>
          <input id="ultimaCal" readonly>
        </div>
        <div>
          <label>Pr√≥xima calibraci√≥n</label>
          <input id="proximaCal" readonly>
        </div>
        <div>
          <label>Tipo calibraci√≥n</label>
          <input id="tipoCal" readonly>
        </div>
      </div>

      <div class="stats">
        <div id="statEstado" class="stat-badge">Estado: ‚Äî</div>
        <div id="statDias" class="stat-badge">D√≠as hasta pr√≥xima: ‚Äî</div>
        <div id="statUso" class="stat-badge">Movimientos: ‚Äî</div>
      </div>

      <div id="alertInstrumento" class="alert hidden"></div>
    </section>

    <!-- ‚óè‚óè‚óè REGISTRAR MOVIMIENTO ‚óè‚óè‚óè -->
    <section class="card">
      <div class="card-header">
        <div>
          <div class="card-title">Registrar movimiento</div>
          <div class="card-sub">El registro se a√±adir√° autom√°ticamente.</div>
        </div>
      </div>

      <!-- ALERTA CR√çTICA: FUERA DE CALIBRACI√ìN -->
      <div id="alertaCritica" class="alert-critical hidden">
        <h3>‚ö† INSTRUMENTO FUERA DE CALIBRACI√ìN</h3>
        <p>Este instrumento est√° <b>fuera de calibraci√≥n</b>. No debe utilizarse ni salir al taller en condiciones normales.</p>
        <p style="margin-top:4px;">Para registrar un movimiento debes elegir una de estas opciones:</p>
        <ul style="margin:6px 0 8px 18px; font-size:12px;">
          <li><b>Calibrar ahora</b> (recomendado)</li>
          <li><b>Usar bajo responsabilidad</b> (requiere responsable autorizado)</li>
        </ul>

        <div style="margin-top:6px;">
          <label style="margin-bottom:4px; text-transform:none; letter-spacing:0; font-size:12px; color:#fecaca;">
            Responsable autorizado para uso bajo responsabilidad
          </label>
          <input id="responsableAutorizacion" placeholder="Nombre y cargo de quien autoriza el uso">
        </div>

        <div class="row" style="margin-top:10px; justify-content:flex-end;">
          <button class="btn secondary" type="button" id="btnCalibrarAhora">Calibrar ahora</button>
          <button class="btn" type="button" id="btnForzarUso">Usar bajo responsabilidad</button>
        </div>
      </div>

      <div class="grid" style="margin-top:10px;">
        <div>
          <label>Tipo de movimiento</label>
          <select id="tipoMovimiento">
            <option value="">Selecciona...</option>
            <option value="Entrada">Entrada</option>
            <option value="Salida">Salida</option>
            <option value="Pr√©stamo externo">Pr√©stamo externo</option>
            <option value="Revisi√≥n / reparaci√≥n">Revisi√≥n / reparaci√≥n</option>
            <option value="Env√≠o a calibraci√≥n externa">Env√≠o a calibraci√≥n externa</option>
          </select>
        </div>

        <div>
          <label>Responsable</label>
          <input id="responsable" placeholder="Nombre del responsable del movimiento">
        </div>

        <!-- NUEVOS CAMPOS -->
        <div>
          <label>Operario 1</label>
          <input id="operario1" placeholder="Nombre del operario principal (solo en salidas)">
        </div>

        <div>
          <label>Operario 2</label>
          <input id="operario2" placeholder="Segundo operario (si existe)">
        </div>

        <div>
          <label>Destino</label>
          <input id="destino" placeholder="Ej: Laboratorio, l√≠nea 2...">
        </div>

        <div style="grid-column:1/-1">
          <label>Observaciones</label>
          <textarea id="observaciones" placeholder="Opcional"></textarea>
          <p class="helper-text">
            El estado de calibraci√≥n y el posible uso bajo responsabilidad se a√±adir√°n autom√°ticamente.
          </p>
        </div>
      </div>

      <div class="row" style="justify-content:flex-end; margin-top:10px;">
        <button class="btn secondary" id="btnLimpiar">Limpiar</button>
        <button class="btn" id="btnRegistrar">Registrar</button>
      </div>

      <div id="alertMovimiento" class="alert hidden"></div>
    </section>

    <!-- ‚óè‚óè‚óè HIST√ìRICO ‚óè‚óè‚óè -->
    <section class="card">
      <div class="card-header">
        <div>
          <div class="card-title">Hist√≥rico reciente</div>
          <div class="card-sub">√öltimos 20 movimientos</div>
        </div>
      </div>

      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Fecha (UTC)</th>
              <th>Tipo</th>
              <th>Responsable</th>
              <th>Operario 1</th>
              <th>Operario 2</th>
              <th>Destino</th>
              <th>Observaciones</th>
            </tr>
          </thead>

          <tbody id="tablaMovimientos">
            <tr><td colspan="7">Introduce un c√≥digo para ver movimientos</td></tr>
          </tbody>
        </table>
      </div>
    </section>

  </main>
</div>

<!-- MODAL LECTOR QR -->
<div id="qrModal" class="qr-modal hidden">
  <div class="qr-modal-backdrop"></div>
  <div class="qr-modal-inner">
    <h2>Escanear c√≥digo QR</h2>
    <p class="helper-text">Apunta la c√°mara al c√≥digo QR del instrumento para cargarlo autom√°ticamente.</p>
    <div id="qrReader"></div>
    <div class="row" style="justify-content:flex-end; margin-top:10px;">
      <button class="btn secondary" type="button" id="btnCerrarQR">Cancelar</button>
    </div>
  </div>
</div>

<!-- FAB QR -->
<button class="qr-fab" id="btnFabQR" title="Escanear c√≥digo QR del instrumento">
  üì∑
</button>

<!-- üî• SUPABASE CORRECTO: config.mjs -->
<script type="module" src="config.mjs"></script>

<!-- Librer√≠a lector QR -->
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

<script type="module">
  import { supabase } from "./config.mjs";
  window.supabase = supabase;
</script>

<!-- üî• L√ìGICA MOVIMIENTO + QR -->
<script type="module">
const sb = window.supabase;

/* Si Supabase no carg√≥ ‚Üí Modo Offline */
function setOnlineStatus(ok) {
  const badge = document.getElementById("onlineBadge");
  const dot = badge.querySelector(".badge-dot");
  const txt = document.getElementById("onlineText");

  if (ok) {
    badge.classList.remove("offline");
    dot.style.background = "#4ade80";
    txt.textContent = "Online (Supabase conectado)";
  } else {
    badge.classList.add("offline");
    dot.style.background = "#f97373";
    txt.textContent = "Offline (sin conexi√≥n)";
  }
}

if (!sb) {
  console.error("Supabase no carg√≥. Revisa config.mjs");
  setOnlineStatus(false);
} else {
  setOnlineStatus(true);
}

/* ===========================================================
   UTILIDADES
=========================================================== */
const $ = sel => document.querySelector(sel);

const fmtDate = iso => {
  if (!iso) return "‚Äî";
  const d = new Date(iso);
  if (isNaN(d)) return "‚Äî";
  return d.toISOString().replace("T"," ").slice(0,16) + " UTC";
};

const fmtISOshort = iso => {
  if (!iso) return "‚Äî";
  const d = new Date(iso);
  if (isNaN(d)) return "‚Äî";
  return `${String(d.getUTCDate()).padStart(2,"0")}/${
          String(d.getUTCMonth()+1).padStart(2,"0")}/${
          d.getUTCFullYear()}`;
};

const daysDiff = dateStr => {
  if (!dateStr) return null;
  const d = new Date(dateStr + "T00:00:00");
  if (isNaN(d)) return null;
  const now = new Date();
  return Math.round((d-now)/(86400000));
};

function computeEstado(prox) {
  const dias = daysDiff(prox);
  if (dias === null) return {estado:"SIN FECHA", clase:"warn"};

  if (dias < 0) return {estado:"FUERA DE CALIBRACI√ìN", clase:"bad"};

  if (dias <= 30) return {estado:"PR√ìXIMA CALIBRACI√ìN", clase:"warn"};

  return {estado:"EN CALIBRACI√ìN", clase:"ok"};
}

/* ===========================================================
   ESTADO GLOBAL
=========================================================== */
let instrumentoActual = null;
let movimientosCount = 0;
let estadoActualInstrumento = null;
let usoBajoResponsabilidad = false;
let responsableAutorizado = "";

// QR
let html5QrCodeInstance = null;
let qrEnMarcha = false;

/* ===========================================================
   HABILITAR / DESHABILITAR BOT√ìN REGISTRAR
=========================================================== */
function actualizarBotonRegistrar() {
  const btn = $("#btnRegistrar");
  if (!btn) return;

  if (!instrumentoActual) {
    btn.disabled = true;
    return;
  }

  if (estadoActualInstrumento &&
      estadoActualInstrumento.estado === "FUERA DE CALIBRACI√ìN" &&
      !usoBajoResponsabilidad) {
    btn.disabled = true;
  } else {
    btn.disabled = false;
  }
}

/* ===========================================================
   CARGAR INSTRUMENTO
=========================================================== */
async function cargarInstrumento() {
  const codigo = $("#codigoInput").value.trim();
  const alertBox = $("#alertInstrumento");
  alertBox.classList.add("hidden");

  if (!codigo) {
    alertBox.textContent = "Introduce un c√≥digo";
    alertBox.classList.remove("hidden");
    instrumentoActual = null;
    actualizarBotonRegistrar();
    return;
  }

  if (!sb) {
    alertBox.textContent = "Sin conexi√≥n con Supabase";
    alertBox.classList.remove("hidden");
    instrumentoActual = null;
    actualizarBotonRegistrar();
    return;
  }

  try {
    const { data, error } = await sb
      .from("instrumentos")
      .select("*")
      .eq("codigo", codigo)
      .maybeSingle();

    if (error) {
      console.error(error);
      alertBox.textContent = "Error consultando Supabase";
      alertBox.classList.remove("hidden");
      instrumentoActual = null;
      actualizarBotonRegistrar();
      return;
    }

    if (!data) {
      alertBox.textContent = `No existe instrumento con c√≥digo "${codigo}"`;
      alertBox.classList.remove("hidden");
      instrumentoActual = null;
      pintarInstrumento(null);
      const tbody = $("#tablaMovimientos");
      if (tbody) {
        tbody.innerHTML = `<tr><td colspan="7">Introduce un c√≥digo para ver movimientos</td></tr>`;
      }
      movimientosCount = 0;
      actualizarBotonRegistrar();
      return;
    }

    instrumentoActual = data;
    pintarInstrumento(data);

    await cargarMovimientos(codigo);

  } catch (e) {
    console.error(e);
    alertBox.textContent = "Error inesperado";
    alertBox.classList.remove("hidden");
    instrumentoActual = null;
    actualizarBotonRegistrar();
  }
}

/* ===========================================================
   PINTAR INSTRUMENTO
=========================================================== */
function pintarInstrumento(inst) {
  const alertaCritica = $("#alertaCritica");
  const inputRespAuto = $("#responsableAutorizacion");

  if (!inst) {
    $("#descInstrumento").value = "";
    $("#fabInstrumento").value = "";
    $("#rangoInstrumento").value = "";
    $("#unidadInstrumento").value = "";
    $("#precisionInstrumento").value = "";
    $("#ubicacionInstrumento").value = "";
    $("#ultimaCal").value = "";
    $("#proximaCal").value = "";
    $("#tipoCal").value = "";
    estadoActualInstrumento = null;
    usoBajoResponsabilidad = false;
    responsableAutorizado = "";
    if (alertaCritica) alertaCritica.classList.add("hidden");
    if (inputRespAuto) inputRespAuto.value = "";
    actualizarBotonRegistrar();
    return;
  }

  $("#descInstrumento").value = inst.descripcion || "";
  $("#fabInstrumento").value = inst.fabricante || "";
  $("#rangoInstrumento").value = inst.rango || "";
  $("#unidadInstrumento").value = inst.unidad_base || "";
  $("#precisionInstrumento").value = inst.precision || "";
  $("#ubicacionInstrumento").value = inst.ubicacion_actual || "";

  $("#ultimaCal").value = fmtISOshort(inst.fecha_ultima_calibracion);
  $("#proximaCal").value = fmtISOshort(inst.fecha_proxima_calibracion);
  $("#tipoCal").value = inst.tipo_calibracion || "";

  const estado = computeEstado(inst.fecha_proxima_calibracion);
  estadoActualInstrumento = estado;

  $("#estadoChip").textContent = estado.estado;
  $("#estadoChip").className = "pill " + estado.clase;

  $("#statEstado").textContent = "Estado: " + estado.estado;

  const dias = daysDiff(inst.fecha_proxima_calibracion);
  $("#statDias").textContent = "D√≠as hasta pr√≥xima: " + (dias ?? "‚Äî");

  $("#statUso").textContent = "Movimientos: " + movimientosCount;

  usoBajoResponsabilidad = false;
  responsableAutorizado = "";
  if (inputRespAuto) inputRespAuto.value = "";

  if (alertaCritica) {
    if (estado.estado === "FUERA DE CALIBRACI√ìN") {
      alertaCritica.classList.remove("hidden");
      alertaCritica.style.borderColor = "#f97373";
    } else {
      alertaCritica.classList.add("hidden");
    }
  }

  actualizarBotonRegistrar();
}

/* ===========================================================
   CARGAR HISTORIAL
=========================================================== */
async function cargarMovimientos(codigo) {
  const tbody = $("#tablaMovimientos");

  try {
    const { data, error } = await sb
      .from("movimientos")
      .select("*")
      .eq("codigo_instrumento", codigo)
      .order("fecha", { ascending:false })
      .limit(20);

    if (error) {
      console.error(error);
      tbody.innerHTML = `<tr><td colspan="7">Error al cargar hist√≥rico</td></tr>`;
      movimientosCount = 0;
      return;
    }

    if (!data || data.length === 0) {
      tbody.innerHTML = `<tr><td colspan="7">No hay movimientos</td></tr>`;
      movimientosCount = 0;
      return;
    }

    movimientosCount = data.length;

    tbody.innerHTML = data.map(m => `
      <tr>
        <td>${fmtDate(m.fecha)}</td>
        <td>${m.tipo_movimiento}</td>
        <td>${m.responsable || ""}</td>
        <td>${m.operario1 || ""}</td>
        <td>${m.operario2 || ""}</td>
        <td>${m.destino || ""}</td>
        <td style="white-space:normal;max-width:320px;">${(m.observaciones||"").replace(/\n/g,"<br>")}</td>
      </tr>
    `).join("");

    pintarInstrumento(instrumentoActual);

  } catch (e) {
    console.error(e);
    tbody.innerHTML = `<tr><td colspan="7">Error inesperado</td></tr>`;
  }
}

/* ===========================================================
   REGISTRAR MOVIMIENTO
=========================================================== */
async function registrarMovimiento() {
  const alertBox = $("#alertMovimiento");
  alertBox.classList.add("hidden");

  if (!instrumentoActual) {
    alertBox.textContent = "Primero carga un instrumento";
    alertBox.classList.remove("hidden");
    return;
  }

  const tipo = $("#tipoMovimiento").value;
  const responsable = $("#responsable").value.trim();
  const operario1 = $("#operario1").value.trim();
  const operario2 = $("#operario2").value.trim();
  const destino = $("#destino").value.trim();
  const obsUser = $("#observaciones").value.trim();

  if (!tipo) {
    alertBox.textContent = "Selecciona un tipo de movimiento";
    alertBox.classList.remove("hidden");
    return;
  }
  if (!responsable) {
    alertBox.textContent = "Introduce un responsable del movimiento";
    alertBox.classList.remove("hidden");
    return;
  }

  const estado = computeEstado(instrumentoActual.fecha_proxima_calibracion);

  if (estado.estado === "FUERA DE CALIBRACI√ìN" && !usoBajoResponsabilidad) {
    alertBox.textContent = "Instrumento fuera de calibraci√≥n. Debes calibrar ahora o usar bajo responsabilidad.";
    alertBox.classList.remove("hidden");
    return;
  }

  let obsFinal = obsUser ? obsUser + "\n" : "";

  if (estado.estado === "FUERA DE CALIBRACI√ìN" && usoBajoResponsabilidad && responsableAutorizado) {
    obsFinal += `USO BAJO RESPONSABILIDAD: ${responsableAutorizado}\n`;
  }

  obsFinal += `Estado calibraci√≥n: ${estado.estado}`;

  let nuevaUbicacion = instrumentoActual.ubicacion_actual || "";

  if (tipo === "Entrada") {
    nuevaUbicacion = "Laboratorio";
  } else if (destino) {
    nuevaUbicacion = destino;
  }

  const esSalida = (tipo === "Salida");

  const datosMovimiento = {
    codigo_instrumento: instrumentoActual.codigo,
    fecha: new Date().toISOString(),
    tipo_movimiento: tipo,
    responsable,
    destino,
    observaciones: obsFinal,
    operario1: null,
    operario2: null
  };

  if (esSalida) {
    if (operario1) datosMovimiento.operario1 = operario1;
    if (operario2) datosMovimiento.operario2 = operario2;
  }

  try {
    const { error: errorMov } = await sb.from("movimientos").insert(datosMovimiento);

    if (errorMov) {
      console.error(errorMov);
      alertBox.textContent = "Error al guardar movimiento";
      alertBox.classList.remove("hidden");
      return;
    }

    const { error: errorUpd } = await sb
      .from("instrumentos")
      .update({ ubicacion_actual: nuevaUbicacion })
      .eq("codigo", instrumentoActual.codigo);

    if (errorUpd) {
      console.error(errorUpd);
      alertBox.textContent = "Movimiento guardado, pero ha fallado la actualizaci√≥n de la ubicaci√≥n.";
      alertBox.classList.remove("hidden");
    } else {
      alertBox.textContent = "Movimiento registrado con √©xito";
      alertBox.style.background = "rgba(22,101,52,.5)";
      alertBox.style.borderColor = "#4ade80";
      alertBox.style.color = "#dcfce7";
      alertBox.classList.remove("hidden");
    }

    instrumentoActual.ubicacion_actual = nuevaUbicacion;

    await cargarMovimientos(instrumentoActual.codigo);

    $("#tipoMovimiento").value = "";
    $("#responsable").value = "";
    $("#operario1").value = "";
    $("#operario2").value = "";
    $("#destino").value = "";
    $("#observaciones").value = "";

    usoBajoResponsabilidad = false;
    responsableAutorizado = "";
    const inputRespAuto = $("#responsableAutorizacion");
    if (inputRespAuto) inputRespAuto.value = "";
    actualizarBotonRegistrar();

  } catch (e) {
    console.error(e);
    alertBox.textContent = "Error inesperado";
    alertBox.classList.remove("hidden");
  }
}

/* ===========================================================
   L√ìGICA QR
=========================================================== */
function extraerCodigoDesdeQR(textoCrudo) {
  if (!textoCrudo) return "";
  const raw = textoCrudo.trim();

  try {
    const url = new URL(raw);
    const codParam = url.searchParams.get("codigo");
    if (codParam) return codParam;

    const partes = url.pathname.split("/").filter(Boolean);
    const last = partes[partes.length - 1];
    if (last && !last.includes(".html")) {
      return decodeURIComponent(last);
    }
    return raw;
  } catch {
    return raw;
  }
}

async function abrirQR() {
  const modal = $("#qrModal");
  if (!modal) return;

  if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
    alert("Este dispositivo no permite acceso a la c√°mara para leer QR.");
    return;
  }

  if (!window.Html5Qrcode) {
    alert("Lector QR no disponible en esta p√°gina.");
    return;
  }

  modal.classList.remove("hidden");

  const contenedor = "qrReader";

  if (html5QrCodeInstance) {
    try { await html5QrCodeInstance.stop(); } catch {}
    try { await html5QrCodeInstance.clear(); } catch {}
  }

  html5QrCodeInstance = new Html5Qrcode(contenedor);
  qrEnMarcha = true;

  html5QrCodeInstance.start(
    { facingMode: "environment" },
    {
      fps: 10,
      qrbox: { width: 250, height: 250 }
    },
    decodedText => {
      const codigo = extraerCodigoDesdeQR(decodedText);
      if (codigo) {
        $("#codigoInput").value = codigo;
        cargarInstrumento();
        cerrarQR();
      }
    },
    () => {}
  ).catch(err => {
    console.error("No se pudo iniciar el lector QR:", err);
    alert("No se pudo iniciar la c√°mara para el lector QR.");
    cerrarQR();
  });
}

function cerrarQR() {
  const modal = $("#qrModal");
  if (modal) modal.classList.add("hidden");

  if (html5QrCodeInstance && qrEnMarcha) {
    html5QrCodeInstance.stop()
      .then(() => html5QrCodeInstance.clear())
      .catch(() => {})
      .finally(() => { qrEnMarcha = false; });
  }
}

/* ===========================================================
   EVENTOS
=========================================================== */
$("#btnCargarInstrumento").onclick = cargarInstrumento;
$("#btnRegistrar").onclick = registrarMovimiento;
$("#btnLimpiar").onclick = () => {
  $("#tipoMovimiento").value = "";
  $("#responsable").value = "";
  $("#operario1").value = "";
  $("#operario2").value = "";
  $("#destino").value = "";
  $("#observaciones").value = "";
};

$("#codigoInput").onkeydown = e => {
  if (e.key === "Enter") {
    e.preventDefault();
    cargarInstrumento();
  }
};

$("#btnForzarUso").onclick = () => {
  if (!instrumentoActual) return;
  if (!estadoActualInstrumento || estadoActualInstrumento.estado !== "FUERA DE CALIBRACI√ìN") return;

  const val = ($("#responsableAutorizacion").value || "").trim();
  if (!val) {
    alert("Introduce el responsable autorizado para el uso bajo responsabilidad.");
    return;
  }

  usoBajoResponsabilidad = true;
  responsableAutorizado = val;

  const alertaCritica = $("#alertaCritica");
  if (alertaCritica) {
    alertaCritica.style.borderColor = "#4ade80";
  }

  actualizarBotonRegistrar();
};

$("#btnCalibrarAhora").onclick = () => {
  if (!instrumentoActual) return;
  window.location.href = `calibraciones.html?codigo=${encodeURIComponent(instrumentoActual.codigo)}`;
};

$("#btnFabQR").onclick = () => {
  abrirQR();
};

$("#btnCerrarQR").onclick = () => {
  cerrarQR();
};

actualizarBotonRegistrar();
</script>

</body>
</html>
