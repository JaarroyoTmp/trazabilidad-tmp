<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>TMP · Gestión de Movimientos de Instrumentos</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <link rel="icon" href="img/tmp-quality.png" />

  <style>
    :root{
      --bg0:#050b16;
      --bg1:#071324;
      --card:#0f1f33;
      --card-soft:#14253c;
      --border:#203552;
      --txt:#f2f6fb;
      --muted:#9fb3ca;
      --accent:#3ea8ff;
      --accent-soft:#163857;
      --ok:#28c989;
      --warn:#ffce52;
      --bad:#ff6b6b;
    }

    * { box-sizing:border-box; margin:0; padding:0; }

    body {
      font-family: "Inter", sans-serif;
      background:
        radial-gradient(circle at 0% 0%, #182f55 0, transparent 55%),
        radial-gradient(circle at 100% 0%, #1a3b64 0, transparent 55%),
        linear-gradient(180deg, var(--bg1), var(--bg0));
      color: var(--txt);
      -webkit-font-smoothing: antialiased;
    }

    .app {
      max-width: 1100px;
      margin: 16px auto 32px;
      padding: 0 14px 40px;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 18px;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .brand-logo {
      height: 34px;
      width: auto;
    }

    .brand-text-title {
      font-size: 17px;
      font-weight: 700;
      letter-spacing: .03em;
    }

    .brand-text-sub {
      font-size: 12px;
      color: var(--muted);
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.06);
      background: rgba(9,22,40,.9);
      color: var(--muted);
    }

    .badge-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: #4ade80;
    }

    .badge.offline .badge-dot {
      background: #f97373;
    }

    .btn {
      border: none;
      border-radius: 999px;
      padding: 10px 16px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      background: var(--accent);
      color: #031321;
      box-shadow: 0 8px 18px rgba(0,0,0,.35);
      transition: transform .12s ease, box-shadow .12s ease, background .12s ease;
    }

    .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 12px 24px rgba(0,0,0,.5);
    }

    .btn.secondary {
      background: transparent;
      color: var(--muted);
      border: 1px solid var(--border);
      box-shadow: none;
    }

    .btn.secondary:hover {
      background: rgba(17,35,58,.9);
      border-color: #31639f;
    }

    .btn.sm {
      padding: 7px 12px;
      font-size: 12px;
    }

    main {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .card {
      border-radius: 16px;
      background: linear-gradient(135deg, #0f1f33, #0a1625);
      border: 1px solid rgba(43,78,122,.75);
      box-shadow: 0 18px 40px rgba(0,0,0,.50);
      padding: 16px 16px 14px;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .card-title {
      font-size: 15px;
      font-weight: 600;
    }

    .card-sub {
      font-size: 12px;
      color: var(--muted);
      margin-top: 2px;
    }

    .pill {
      padding: 3px 9px;
      border-radius: 999px;
      font-size: 11px;
      border: 1px solid rgba(52,94,145,.9);
      background: rgba(15,36,66,.9);
      color: var(--muted);
    }

    .pill.ok { background:#07281a; border-color:#18a46d; color:#c9ffe5; }
    .pill.warn { background:#392a09; border-color:#f9d567; color:#fff2c2; }
    .pill.bad { background:#3b1010; border-color:#ff7b7b; color:#ffe2e2; }

    .grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0,1fr));
      gap: 10px 14px;
    }

    @media (max-width:900px) {
      .grid { grid-template-columns: repeat(2, minmax(0,1fr)); }
    }

    @media (max-width:640px) {
      header { flex-direction: column; align-items: flex-start; }
      .grid { grid-template-columns: 1fr; }
      .btn { width: 100%; }
    }

    /* Inputs */
    label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: .08em;
      color: var(--muted);
      margin-bottom: 4px;
      display: block;
    }

    input,select,textarea {
      background:#050d1a;
      border:1px solid #253954;
      border-radius:10px;
      padding:9px 11px;
      color:var(--txt);
      width:100%;
      font-size:13px;
      outline:none;
    }

    input[readonly] {
      opacity:.85;
      background:#060d19;
    }

    textarea { min-height:70px; resize:vertical; }

    .alert {
      font-size:11px;
      padding:6px 9px;
      border-radius:9px;
      border:1px solid rgba(248,113,113,.7);
      color:#fecaca;
      background:rgba(127,29,29,.4);
      margin-top:8px;
    }

    .hidden { display:none !important; }

    .table-wrap {
      border-radius:12px;
      overflow:auto;
      border:1px solid #203552;
      max-height:260px;
    }

    table {
      width:100%;
      border-collapse:collapse;
      font-size:12px;
    }

    th,td {
      padding:6px;
      border-bottom:1px solid #1f3046;
      white-space:nowrap;
    }

    th {
      background:#0c1929;
      text-transform:uppercase;
      color:var(--muted);
      font-size:11px;
      position:sticky;
      top:0;
    }
  </style>
</head>

<body>
<div class="app">

  <header>
    <div class="brand">
      <img src="img/tmp-quality.png" class="brand-logo">
      <div>
        <div class="brand-text-title">TMP · Movimientos de Instrumentos</div>
        <div class="brand-text-sub">Trazabilidad — Entradas / Salidas / Estados</div>
      </div>
    </div>

    <div class="row-right">
      <button class="btn secondary" onclick="window.location.href='home.html'">
        ← Volver al panel principal
      </button>

      <div id="onlineBadge" class="badge offline">
        <span class="badge-dot"></span>
        <span id="onlineText">Offline (sin conexión Supabase)</span>
      </div>
    </div>
  </header>

  <main>

    <!-- ●●● INSTRUMENTO ●●● -->
    <section class="card">
      <div class="card-header">
        <div>
          <div class="card-title">Instrumento</div>
          <div class="card-sub">
            Introduce el <b>código exacto</b> para cargar sus datos.
          </div>
        </div>
        <div id="estadoChip" class="pill neutral">Esperando instrumento</div>
      </div>

      <div class="grid">
        <div style="grid-column:1/-1">
          <label>Código del instrumento</label>
          <div class="row">
            <input id="codigoInput" placeholder="Ej. 11217">
            <button id="btnCargarInstrumento" class="btn sm">Cargar</button>
          </div>
        </div>

        <div>
          <label>Descripción</label>
          <input id="descInstrumento" readonly>
        </div>
        <div>
          <label>Fabricante</label>
          <input id="fabInstrumento" readonly>
        </div>
        <div>
          <label>Rango</label>
          <input id="rangoInstrumento" readonly>
        </div>

        <div>
          <label>Unidad</label>
          <input id="unidadInstrumento" readonly>
        </div>
        <div>
          <label>Precisión</label>
          <input id="precisionInstrumento" readonly>
        </div>
        <div>
          <label>Ubicación actual</label>
          <input id="ubicacionInstrumento" readonly>
        </div>

        <div>
          <label>Última calibración</label>
          <input id="ultimaCal" readonly>
        </div>
        <div>
          <label>Próxima calibración</label>
          <input id="proximaCal" readonly>
        </div>
        <div>
          <label>Tipo calibración</label>
          <input id="tipoCal" readonly>
        </div>
      </div>

      <div class="stats">
        <div id="statEstado" class="stat-badge">Estado: —</div>
        <div id="statDias" class="stat-badge">Días hasta próxima: —</div>
        <div id="statUso" class="stat-badge">Movimientos: —</div>
      </div>

      <div id="alertInstrumento" class="alert hidden"></div>
    </section>

    <!-- ●●● REGISTRAR MOVIMIENTO ●●● -->
    <section class="card">
      <div class="card-header">
        <div>
          <div class="card-title">Registrar movimiento</div>
          <div class="card-sub">El registro se añadirá automáticamente.</div>
        </div>
      </div>

      <div class="grid">
        <div>
          <label>Tipo de movimiento</label>
          <select id="tipoMovimiento">
            <option value="">Selecciona...</option>
            <option value="Entrada">Entrada</option>
            <option value="Salida">Salida</option>
            <option value="Préstamo externo">Préstamo externo</option>
            <option value="Revisión / reparación">Revisión / reparación</option>
            <option value="Envío a calibración externa">Envío a calibración externa</option>
          </select>
        </div>

        <div>
          <label>Responsable</label>
          <input id="responsable" placeholder="Nombre del responsable">
        </div>

        <div>
          <label>Destino</label>
          <input id="destino" placeholder="Ej: Laboratorio, línea 2...">
        </div>

        <div style="grid-column:1/-1">
          <label>Observaciones</label>
          <textarea id="observaciones" placeholder="Opcional"></textarea>
          <p class="helper-text">
            El estado de calibración se añadirá automáticamente.
          </p>
        </div>
      </div>

      <div class="row" style="justify-content:flex-end; margin-top:10px;">
        <button class="btn secondary" id="btnLimpiar">Limpiar</button>
        <button class="btn" id="btnRegistrar">Registrar</button>
      </div>

      <div id="alertMovimiento" class="alert hidden"></div>
    </section>

    <!-- ●●● HISTORIAL ●●● -->
    <section class="card">
      <div class="card-header">
        <div>
          <div class="card-title">Histórico reciente</div>
          <div class="card-sub">Últimos 20 movimientos</div>
        </div>
      </div>

      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Fecha (UTC)</th>
              <th>Tipo</th>
              <th>Responsable</th>
              <th>Destino</th>
              <th>Observaciones</th>
            </tr>
          </thead>

          <tbody id="tablaMovimientos">
            <tr><td colspan="5">Introduce un código para ver movimientos</td></tr>
          </tbody>
        </table>
      </div>
    </section>

  </main>
</div>

<script type="module" src="config.js"></script>

<script type="module">
/* ===========================================================
   CLIENTE SUPABASE DESDE config.js
=========================================================== */
const sb = window.supabase;

/* Si Supabase no cargó → Modo Offline */
function setOnlineStatus(ok) {
  const badge = document.getElementById("onlineBadge");
  const dot = badge.querySelector(".badge-dot");
  const txt = document.getElementById("onlineText");

  if (ok) {
    badge.classList.remove("offline");
    dot.style.background = "#4ade80";
    txt.textContent = "Online (Supabase conectado)";
  } else {
    badge.classList.add("offline");
    dot.style.background = "#f97373";
    txt.textContent = "Offline (sin conexión)";
  }
}

if (!sb) {
  console.error("Supabase no cargó. Revisa config.js");
  setOnlineStatus(false);
} else {
  setOnlineStatus(true);
}

/* ===========================================================
   UTILIDADES
=========================================================== */
const $ = sel => document.querySelector(sel);

const fmtDate = iso => {
  if (!iso) return "—";
  const d = new Date(iso);
  if (isNaN(d)) return "—";
  return d.toISOString().replace("T"," ").slice(0,16) + " UTC";
};

const fmtISOshort = iso => {
  if (!iso) return "—";
  const d = new Date(iso);
  if (isNaN(d)) return "—";
  return `${String(d.getUTCDate()).padStart(2,"0")}/${
          String(d.getUTCMonth()+1).padStart(2,"0")}/${
          d.getUTCFullYear()}`;
};

const daysDiff = dateStr => {
  if (!dateStr) return null;
  const d = new Date(dateStr + "T00:00:00");
  if (isNaN(d)) return null;
  const now = new Date();
  return Math.round((d-now)/(86400000));
};

function computeEstado(prox) {
  const dias = daysDiff(prox);
  if (dias === null) return {estado:"SIN FECHA", clase:"warn"};

  if (dias < 0) return {estado:"FUERA DE CALIBRACIÓN", clase:"bad"};

  if (dias <= 30) return {estado:"PRÓXIMA CALIBRACIÓN", clase:"warn"};

  return {estado:"EN CALIBRACIÓN", clase:"ok"};
}

/* ===========================================================
   ESTADO GLOBAL
=========================================================== */
let instrumentoActual = null;
let movimientosCount = 0;

/* ===========================================================
   CARGAR INSTRUMENTO
=========================================================== */
async function cargarInstrumento() {
  const codigo = $("#codigoInput").value.trim();
  const alertBox = $("#alertInstrumento");
  alertBox.classList.add("hidden");

  if (!codigo) {
    alertBox.textContent = "Introduce un código";
    alertBox.classList.remove("hidden");
    return;
  }

  if (!sb) {
    alertBox.textContent = "Sin conexión con Supabase";
    alertBox.classList.remove("hidden");
    return;
  }

  try {
    const { data, error } = await sb
      .from("instrumentos")
      .select("*")
      .eq("codigo", codigo)
      .maybeSingle();

    if (error) {
      console.error(error);
      alertBox.textContent = "Error consultando Supabase";
      alertBox.classList.remove("hidden");
      return;
    }

    if (!data) {
      alertBox.textContent = `No existe instrumento con código "${codigo}"`;
      alertBox.classList.remove("hidden");
      instrumentoActual = null;
      pintarInstrumento(null);
      pintarMovimientos([]);
      return;
    }

    instrumentoActual = data;
    pintarInstrumento(data);

    await cargarMovimientos(codigo);

  } catch (e) {
    console.error(e);
    alertBox.textContent = "Error inesperado";
    alertBox.classList.remove("hidden");
  }
}

/* ===========================================================
   PINTAR DATOS DE INSTRUMENTO
=========================================================== */
function pintarInstrumento(inst) {
  if (!inst) {
    $("#descInstrumento").value = "";
    $("#fabInstrumento").value = "";
    $("#rangoInstrumento").value = "";
    $("#unidadInstrumento").value = "";
    $("#precisionInstrumento").value = "";
    $("#ubicacionInstrumento").value = "";
    $("#ultimaCal").value = "";
    $("#proximaCal").value = "";
    $("#tipoCal").value = "";
    return;
  }

  $("#descInstrumento").value = inst.descripcion || "";
  $("#fabInstrumento").value = inst.fabricante || "";
  $("#rangoInstrumento").value = inst.rango || "";
  $("#unidadInstrumento").value = inst.unidad_base || "";
  $("#precisionInstrumento").value = inst.precision || "";
  $("#ubicacionInstrumento").value = inst.ubicacion_actual || "";

  $("#ultimaCal").value = fmtISOshort(inst.ultima_calibracion);
  $("#proximaCal").value = fmtISOshort(inst.proxima_calibracion);
  $("#tipoCal").value = inst.tipo_calibracion || "";

  const estado = computeEstado(inst.proxima_calibracion);
  $("#estadoChip").textContent = estado.estado;
  $("#estadoChip").className = "pill " + estado.clase;

  $("#statEstado").textContent = "Estado: " + estado.estado;

  const dias = daysDiff(inst.proxima_calibracion);
  $("#statDias").textContent = "Días hasta próxima: " + (dias ?? "—");

  $("#statUso").textContent = "Movimientos: " + movimientosCount;
}

/* ===========================================================
   CARGAR HISTORIAL
=========================================================== */
async function cargarMovimientos(codigo) {
  const tbody = $("#tablaMovimientos");

  try {
    const { data, error } = await sb
      .from("movimientos")
      .select("*")
      .eq("codigo_instrumento", codigo)
      .order("fecha", { ascending:false })
      .limit(20);

    if (error) {
      console.error(error);
      tbody.innerHTML = `<tr><td colspan="5">Error al cargar histórico</td></tr>`;
      return;
    }

    if (!data || data.length === 0) {
      tbody.innerHTML = `<tr><td colspan="5">No hay movimientos</td></tr>`;
      movimientosCount = 0;
      return;
    }

    movimientosCount = data.length;

    tbody.innerHTML = data.map(m => `
      <tr>
        <td>${fmtDate(m.fecha)}</td>
        <td>${m.tipo_movimiento}</td>
        <td>${m.responsable}</td>
        <td>${m.destino}</td>
        <td style="white-space:normal;max-width:320px;">${(m.observaciones||"").replace(/\n/g,"<br>")}</td>
      </tr>
    `).join("");

    pintarInstrumento(instrumentoActual);

  } catch (e) {
    console.error(e);
    tbody.innerHTML = `<tr><td colspan="5">Error inesperado</td></tr>`;
  }
}

/* ===========================================================
   REGISTRAR MOVIMIENTO
=========================================================== */
async function registrarMovimiento() {
  const alertBox = $("#alertMovimiento");
  alertBox.classList.add("hidden");

  if (!instrumentoActual) {
    alertBox.textContent = "Primero carga un instrumento";
    alertBox.classList.remove("hidden");
    return;
  }

  const tipo = $("#tipoMovimiento").value;
  const responsable = $("#responsable").value.trim();
  const destino = $("#destino").value.trim();
  const obsUser = $("#observaciones").value.trim();

  if (!tipo) {
    alertBox.textContent = "Selecciona un tipo de movimiento";
    alertBox.classList.remove("hidden");
    return;
  }
  if (!responsable) {
    alertBox.textContent = "Introduce un responsable";
    alertBox.classList.remove("hidden");
    return;
  }

  const estado = computeEstado(instrumentoActual.proxima_calibracion);
  const obsFinal = (obsUser ? obsUser + "\n" : "") +
                   `Estado calibración: ${estado.estado}`;

  try {
    const { error } = await sb.from("movimientos").insert({
      codigo_instrumento: instrumentoActual.codigo,
      fecha: new Date().toISOString(),
      tipo_movimiento: tipo,
      responsable,
      destino,
      observaciones: obsFinal
    });

    if (error) {
      console.error(error);
      alertBox.textContent = "Error al guardar movimiento";
      alertBox.classList.remove("hidden");
      return;
    }

    alertBox.textContent = "Movimiento registrado con éxito";
    alertBox.style.background = "rgba(22,101,52,.5)";
    alertBox.style.borderColor = "#4ade80";
    alertBox.style.color = "#dcfce7";
    alertBox.classList.remove("hidden");

    await cargarMovimientos(instrumentoActual.codigo);

    $("#tipoMovimiento").value = "";
    $("#responsable").value = "";
    $("#destino").value = "";
    $("#observaciones").value = "";

  } catch (e) {
    console.error(e);
    alertBox.textContent = "Error inesperado";
    alertBox.classList.remove("hidden");
  }
}

/* ===========================================================
   EVENTOS
=========================================================== */
$("#btnCargarInstrumento").onclick = cargarInstrumento;
$("#btnRegistrar").onclick = registrarMovimiento;
$("#btnLimpiar").onclick = () => {
  $("#tipoMovimiento").value = "";
  $("#responsable").value = "";
  $("#destino").value = "";
  $("#observaciones").value = "";
};
$("#codigoInput").onkeydown = e => {
  if (e.key === "Enter") {
    e.preventDefault();
    cargarInstrumento();
  }
};
</script>

</body>
</html>
