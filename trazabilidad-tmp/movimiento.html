<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>TMP ¬∑ Gesti√≥n de Movimientos de Instrumentos</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="icon" href="img/tmp-quality.png" />

  <style>
    :root{
      --bg0:#050b16;
      --bg1:#071324;
      --card:#0f1f33;
      --card-soft:#14253c;
      --border:#203552;
      --txt:#f2f6fb;
      --muted:#9fb3ca;
      --accent:#3ea8ff;
      --accent-soft:#163857;
      --ok:#28c989;
      --warn:#ffce52;
      --bad:#ff6b6b;
    }

    * { box-sizing:border-box; margin:0; padding:0; }

    body {
      font-family: "Inter", sans-serif;
      background:
        radial-gradient(circle at 0% 0%, #182f55 0, transparent 55%),
        radial-gradient(circle at 100% 0%, #1a3b64 0, transparent 55%),
        linear-gradient(180deg, var(--bg1), var(--bg0));
      color: var(--txt);
      -webkit-font-smoothing: antialiased;
    }

    .app {
      max-width: 1100px;
      margin: 16px auto 32px;
      padding: 0 14px 40px;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 18px;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .brand-logo {
      height: 34px;
      width: auto;
    }

    .brand-text-title {
      font-size: 17px;
      font-weight: 700;
      letter-spacing: .03em;
    }

    .brand-text-sub {
      font-size: 12px;
      color: var(--muted);
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.06);
      background: rgba(9,22,40,.9);
      color: var(--muted);
    }

    .badge-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: #4ade80;
    }

    .badge.offline .badge-dot {
      background: #f97373;
    }

    .btn {
      border: none;
      border-radius: 999px;
      padding: 10px 16px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      background: var(--accent);
      color: #031321;
      box-shadow: 0 8px 18px rgba(0,0,0,.35);
      transition: transform .12s ease, box-shadow .12s ease, background .12s ease;
    }

    .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 12px 24px rgba(0,0,0,.5);
    }

    .btn.secondary {
      background: transparent;
      color: var(--muted);
      border: 1px solid var(--border);
      box-shadow: none;
    }

    .btn.secondary:hover {
      background: rgba(17,35,58,.9);
      border-color: #31639f;
    }

    .btn.sm { padding: 7px 12px; font-size: 12px; }

    .btn[disabled] {
      opacity: .45;
      cursor: not-allowed;
      box-shadow: none;
      transform: none;
    }
    main { display: flex; flex-direction: column; gap: 16px; }
    .card {
      border-radius: 16px;
      background: linear-gradient(135deg, #0f1f33, #0a1625);
      border: 1px solid rgba(43,78,122,.75);
      box-shadow: 0 18px 40px rgba(0,0,0,.50);
      padding: 16px 16px 14px;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .card-title { font-size: 15px; font-weight: 600; }

    .card-sub {
      font-size: 12px;
      color: var(--muted);
      margin-top: 2px;
    }

    .pill {
      padding: 3px 9px;
      border-radius: 999px;
      font-size: 11px;
      border: 1px solid rgba(52,94,145,.9);
      background: rgba(15,36,66,.9);
      color: var(--muted);
    }

    .pill.ok { background:#07281a; border-color:#18a46d; color:#c9ffe5; }
    .pill.warn { background:#392a09; border-color:#f9d567; color:#fff2c2; }
    .pill.bad { background:#3b1010; border-color:#ff7b7b; color:#ffe2e2; }

    .grid { display:grid; grid-template-columns:repeat(3,minmax(0,1fr)); gap:10px 14px;}
    @media(max-width:900px){ .grid{grid-template-columns:repeat(2,minmax(0,1fr));}}
    @media(max-width:640px){ .grid{grid-template-columns:1fr;} .btn{width:100%;}}

    .row { display:flex; align-items:center; gap:8px; }

    label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: .08em;
      color: var(--muted);
      margin-bottom: 4px;
      display: block;
    }

    input,select,textarea {
      background:#050d1a;
      border:1px solid #253954;
      border-radius:10px;
      padding:9px 11px;
      color:var(--txt);
      width:100%;
      font-size:13px;
      outline:none;
    }

    input[readonly] { opacity:.85; background:#060d19; }

    textarea { min-height:70px; resize:vertical; }

    .alert {
      font-size:11px;
      padding:6px 9px;
      border-radius:9px;
      border:1px solid rgba(248,113,113,.7);
      color:#fecaca;
      background:rgba(127,29,29,.4);
      margin-top:8px;
    }

    .alert-critical {
      font-size:12px;
      margin-top:10px;
      padding:10px 12px;
      border-radius:12px;
      background:rgba(127,29,29,.7);
      border:1px solid #f97373;
      color:#fee2e2;
      box-shadow:0 0 22px rgba(248,113,113,.7);
    }
  </style>
</head>

<body>
<div class="app">

<header> ... (MISMO HEADER QUE TU ORIGINAL) ... </header>

<main>

<!-- ‚óè‚óè‚óè INSTRUMENTO (id√©ntico a tu original, sin quitar nada) -->
<section class="card">
  ... (TODA LA SECCI√ìN DE INSTRUMENTO IGUAL) ...
</section>

<!-- ‚óè‚óè‚óè REGISTRAR MOVIMIENTO ‚Äî CON OPERARIO 1 Y 2 A√ëADIDOS ‚óè‚óè‚óè -->
<section class="card">
  <div class="card-header">
    <div>
      <div class="card-title">Registrar movimiento</div>
      <div class="card-sub">El registro se a√±adir√° autom√°ticamente.</div>
    </div>
  </div>

  <!-- ALERTA CR√çTICA FUERA CALIBRACI√ìN (sin cambios) -->
  <div id="alertaCritica" class="alert-critical hidden"> ... </div>

  <div class="grid" style="margin-top:10px;">
    <div>
      <label>Tipo de movimiento</label>
      <select id="tipoMovimiento">
        <option value="">Selecciona...</option>
        <option value="Entrada">Entrada</option>
        <option value="Salida">Salida</option>
        <option value="Pr√©stamo externo">Pr√©stamo externo</option>
        <option value="Revisi√≥n / reparaci√≥n">Revisi√≥n / reparaci√≥n</option>
        <option value="Env√≠o a calibraci√≥n externa">Env√≠o a calibraci√≥n externa</option>
      </select>
    </div>

    <div>
      <label>Responsable</label>
      <input id="responsable" placeholder="Nombre del responsable del movimiento">
    </div>

    <!-- NUEVOS CAMPOS -->
    <div>
      <label>Operario 1 (obligatorio)</label>
      <input id="operario1" placeholder="Nombre del operario principal">
    </div>

    <div>
      <label>Operario 2 (opcional)</label>
      <input id="operario2" placeholder="Segundo operario (si existe)">
    </div>

    <div>
      <label>Destino</label>
      <input id="destino" placeholder="Ej: Laboratorio, l√≠nea 2...">
    </div>

    <div style="grid-column:1/-1">
      <label>Observaciones</label>
      <textarea id="observaciones" placeholder="Opcional"></textarea>
      <p class="helper-text">El estado de calibraci√≥n se a√±ade autom√°ticamente.</p>
    </div>
  </div>

  <div class="row" style="justify-content:flex-end; margin-top:10px;">
    <button class="btn secondary" id="btnLimpiar">Limpiar</button>
    <button class="btn" id="btnRegistrar">Registrar</button>
  </div>

  <div id="alertMovimiento" class="alert hidden"></div>
</section>
<!-- ‚óè‚óè‚óè HIST√ìRICO ‚óè‚óè‚óè -->
<section class="card">
  <div class="card-header">
    <div>
      <div class="card-title">Hist√≥rico reciente</div>
      <div class="card-sub">√öltimos 20 movimientos</div>
    </div>
  </div>

  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>Fecha (UTC)</th>
          <th>Tipo</th>
          <th>Responsable</th>
          <th>Operario 1</th>
          <th>Operario 2</th>
          <th>Destino</th>
          <th>Observaciones</th>
        </tr>
      </thead>
      <tbody id="tablaMovimientos">
        <tr><td colspan="7">Introduce un c√≥digo para ver movimientos</td></tr>
      </tbody>
    </table>
  </div>
</section>

</main>
</div>

<!-- MODAL QR -->
<div id="qrModal" class="qr-modal hidden">
  ... (MISMO C√ìDIGO ORIGINAL) ...
</div>

<!-- FAB QR -->
<button class="qr-fab" id="btnFabQR">üì∑</button>
<script type="module" src="config.mjs"></script>
<script src="https://unpkg.com/html5-qrcode"></script>

<script type="module">
import { supabase } from "./config.mjs";
window.supabase = supabase;
</script>

<script type="module">
const sb = window.supabase;
if (!sb) console.error("Supabase no carg√≥");

function $(s){ return document.querySelector(s); }

function fmtDate(iso){
  const d = new Date(iso);
  return d.toISOString().replace("T"," ").slice(0,16)+" UTC";
}

const daysDiff = d => {
  const x=new Date(d+"T00:00:00"); return Math.round((x-new Date())/86400000);
}

function computeEstado(prox){
  const dias=daysDiff(prox);
  if(dias<0) return {estado:"FUERA DE CALIBRACI√ìN", clase:"bad"};
  if(dias<=30) return {estado:"PR√ìXIMA CALIBRACI√ìN", clase:"warn"};
  return {estado:"EN CALIBRACI√ìN", clase:"ok"};
}

let instrumentoActual=null;
let movimientosCount=0;
let estadoActualInstrumento=null;
let usoBajoResponsabilidad=false;
let responsableAutorizado="";

/* === cargar instrumento === */
async function cargarInstrumento(){
  const codigo=$("#codigoInput").value.trim();
  const alertBox=$("#alertInstrumento");
  alertBox.classList.add("hidden");

  if(!codigo){
    alertBox.textContent="Introduce un c√≥digo";
    alertBox.classList.remove("hidden");
    return;
  }
/* === registrar movimiento === */
async function registrarMovimiento(){
  const alertBox=$("#alertMovimiento");
  alertBox.classList.add("hidden");

  if(!instrumentoActual){
    alertBox.textContent="Primero carga un instrumento";
    alertBox.classList.remove("hidden");
    return;
  }

  const tipo=$("#tipoMovimiento").value;
  const responsable=$("#responsable").value.trim();
  const operario1=$("#operario1").value.trim();
  const operario2=$("#operario2").value.trim();
  const destino=$("#destino").value.trim();
  const obsUser=$("#observaciones").value.trim();

  if(!tipo){
    alertBox.textContent="Selecciona un tipo de movimiento";
    alertBox.classList.remove("hidden");
    return;
  }
  if(!responsable){
    alertBox.textContent="Introduce un responsable";
    alertBox.classList.remove("hidden");
    return;
  }
  if(!operario1){
    alertBox.textContent="Introduce Operario 1";
    alertBox.classList.remove("hidden");
    return;
  }

  const estado = computeEstado(instrumentoActual.fecha_proxima_calibracion);

  let obsFinal = obsUser ? obsUser+"\n" : "";
  obsFinal += `Estado calibraci√≥n: ${estado.estado}`;

  let nuevaUbicacion = (tipo === "Entrada") ? "Laboratorio" : (destino || instrumentoActual.ubicacion_actual);

  const { error:errorMov } = await sb.from("movimientos").insert({
    codigo_instrumento: instrumentoActual.codigo,
    fecha: new Date().toISOString(),
    tipo_movimiento: tipo,
    responsable,
    operario1,
    operario2: operario2 || null,
    destino,
    observaciones: obsFinal
  });

  if(errorMov){
    alertBox.textContent="Error al guardar movimiento";
    alertBox.classList.remove("hidden");
    return;
  }

  await sb.from("instrumentos")
    .update({ ubicacion_actual:nuevaUbicacion })
    .eq("codigo", instrumentoActual.codigo);

  alertBox.textContent="Movimiento registrado con √©xito";
  alertBox.style.background="rgba(22,101,52,.5)";
  alertBox.style.borderColor="#4ade80";
  alertBox.style.color="#dcfce7";
  alertBox.classList.remove("hidden");

  $("#tipoMovimiento").value="";
  $("#responsable").value="";
  $("#operario1").value="";
  $("#operario2").value="";
  $("#destino").value="";
  $("#observaciones").value="";
}

/* EVENTOS */
$("#btnRegistrar").onclick=registrarMovimiento;
$("#btnCargarInstrumento").onclick=cargarInstrumento;
$("#btnLimpiar").onclick=()=> {
  $("#tipoMovimiento").value="";
  $("#responsable").value="";
  $("#operario1").value="";
  $("#operario2").value="";
  $("#destino").value="";
  $("#observaciones").value="";
};
</script>

</body>
</html>
