<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>TMP ¬∑ Informe de Equipos por Referencia</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="icon" href="img/tmp-quality.png">

  <style>
    :root {
      --bg0:#050b16;
      --bg1:#071324;
      --card:#0f1f33;
      --border:#203552;
      --txt:#f2f6fb;
      --muted:#9fb3ca;
      --accent:#3ea8ff;
    }

    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family: "Inter", sans-serif;
      background:
        radial-gradient(circle at 0% 0%, #182f55 0, transparent 55%),
        radial-gradient(circle at 100% 0%, #1a3b64 0, transparent 55%),
        linear-gradient(180deg, var(--bg1), var(--bg0));
      color: var(--txt);
      padding: 20px;
    }

    .app {
      max-width: 1100px;
      margin: 0 auto;
    }

    header {
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:20px;
    }

    .brand {
      display:flex;
      align-items:center;
      gap:10px;
    }
    .brand-logo { width:40px; }
    .brand-title { font-size:18px; font-weight:700; }
    .brand-sub { font-size:12px; color:var(--muted); }

    .btn {
      padding:10px 16px;
      border:none;
      border-radius:8px;
      background:var(--accent);
      font-weight:600;
      cursor:pointer;
      color:#031321;
    }
    .btn.secondary {
      background:transparent;
      color:var(--muted);
      border:1px solid var(--border);
    }

    section.card {
      background:linear-gradient(135deg,#0f1f33,#0a1625);
      border:1px solid rgba(62,168,255,.35);
      border-radius:14px;
      padding:18px;
      margin-bottom:20px;
      box-shadow:0 18px 40px rgba(0,0,0,.4);
    }

    .card-title { font-size:16px; font-weight:700; margin-bottom:4px; }
    .card-sub { font-size:12px; color:var(--muted); margin-bottom:12px; }

    label {
      font-size:11px;
      color:var(--muted);
      text-transform:uppercase;
      letter-spacing:.08em;
      margin-bottom:4px;
      display:block;
    }

    input {
      width:100%;
      padding:9px;
      border-radius:8px;
      background:#050d1a;
      border:1px solid #253954;
      color:var(--txt);
    }

    .grid {
      display:grid;
      grid-template-columns:repeat(3,1fr);
      gap:12px;
    }
    @media(max-width:800px){
      .grid { grid-template-columns:repeat(2,1fr); }
    }
    @media(max-width:600px){
      .grid { grid-template-columns:1fr; }
    }

    textarea {
      width:100%;
      background:#050d1a;
      border:1px solid #253954;
      border-radius:10px;
      padding:10px;
      color:var(--txt);
      min-height:70px;
    }

    .table-wrap {
      border-radius:10px;
      overflow:auto;
      border:1px solid var(--border);
      max-height:400px;
    }

    table {
      width:100%;
      border-collapse:collapse;
      font-size:12px;
    }

    th, td {
      padding:6px 8px;
      border-bottom:1px solid #1f3046;
      white-space:nowrap;
    }

    th {
      background:#0c1929;
      font-size:11px;
      color:var(--muted);
      position:sticky;
      top:0;
    }

    /* --------- MODO IMPRESI√ìN --------- */
    @media print {
      body {
        background:white;
        color:black;
      }
      header, .no-print { display:none !important; }
      section.card {
        background:white;
        color:black;
        box-shadow:none;
        border:1px solid #ccc;
      }
      input, textarea {
        background:white;
        color:black;
        border:1px solid #aaa;
      }
      table, th, td {
        border:1px solid black !important;
      }
    }
  </style>
</head>

<body>
<div class="app">

<header>
  <div class="brand">
    <img src="img/tmp-quality.png" class="brand-logo">
    <div>
      <div class="brand-title">TMP ¬∑ Informe de Equipos</div>
      <div class="brand-sub">Visualizaci√≥n e impresi√≥n</div>
    </div>
  </div>

  <button class="btn secondary" onclick="location.href='home.html'">‚Üê Volver</button>
</header>

<!-- B√öSQUEDA -->
<section class="card no-print">
  <div class="card-title">Buscar referencia</div>
  <div class="card-sub">Introduce la referencia para ver la tabla completa</div>

  <label>Referencia</label>
  <div style="display:flex; gap:8px;">
    <input id="refInput" placeholder="Ej: REF-001">
    <button class="btn" id="btnBuscar">Buscar</button>
  </div>

  <p id="msg" style="margin-top:10px; color:#ff7b7b; display:none;"></p>
</section>

<!-- INFORMACI√ìN -->
<section class="card">
  <div class="card-title">Datos de la referencia</div>

  <div class="grid">
    <div>
      <label>Referencia</label>
      <input id="refDetalle" readonly>
    </div>
    <div>
      <label>Pieza</label>
      <input id="piezaDetalle" readonly>
    </div>
    <div>
      <label>Cliente</label>
      <input id="clienteDetalle" readonly>
    </div>
    <div>
      <label>Responsable</label>
      <input id="responsableDetalle" readonly>
    </div>
    <div>
      <label>Fecha</label>
      <input id="fechaDetalle" readonly>
    </div>
    <div>
      <label>Versi√≥n</label>
      <input id="versionDetalle" readonly>
    </div>
  </div>

  <label style="margin-top:14px;">Observaciones</label>
  <textarea id="observacionesDetalle" readonly></textarea>
</section>

<!-- TABLA EQUIPOS -->
<section class="card">
  <div class="card-title">Equipos necesarios</div>

  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>C√≥digo</th>
          <th>Descripci√≥n</th>
          <th>Cantidad</th>
          <th>Tipo medida</th>
        </tr>
      </thead>
      <tbody id="tablaEquipos">
        <tr><td colspan="5">Sin datos</td></tr>
      </tbody>
    </table>
  </div>
</section>

<!-- BOT√ìN IMPRIMIR -->
<section class="card no-print">
  <button class="btn" style="width:100%;" onclick="window.print()">
    üñ® Imprimir informe
  </button>
</section>

</div>

<!-- SUPABASE -->
<script type="module" src="config.mjs"></script>
<script type="module">
const sb = window.supabase;
const $ = s => document.querySelector(s);

function msg(text) {
  const m = $("#msg");
  m.textContent = text;
  m.style.display = "block";
}

async function buscar() {
  const ref = $("#refInput").value.trim();
  if (!ref) return msg("Introduce una referencia.");

  const { data, error } = await sb
    .from("control_metrologico")
    .select("*")
    .eq("referencia", ref)
    .order("fecha", { ascending:false })
    .limit(1);

  if (error) return msg("Error consultando Supabase.");
  if (!data || data.length === 0) return msg("No se encontr√≥ esa referencia.");

  const rec = data[0];

  $("#refDetalle").value = rec.referencia || "";
  $("#piezaDetalle").value = rec.pieza || "";
  $("#clienteDetalle").value = rec.cliente || "";
  $("#responsableDetalle").value = rec.responsable || "";
  $("#fechaDetalle").value = rec.fecha || "";
  $("#versionDetalle").value = rec.version || "";
  $("#observacionesDetalle").value = rec.observaciones || "";

  const equipos = Array.isArray(rec.equipos) ? rec.equipos : [];
  const tbody = $("#tablaEquipos");

  if (equipos.length === 0) {
    tbody.innerHTML = `<tr><td colspan="5">No hay equipos registrados.</td></tr>`;
    return;
  }

  tbody.innerHTML = equipos.map((eq, i) => `
    <tr>
      <td>${i+1}</td>
      <td>${eq.codigo_equipo || ""}</td>
      <td>${eq.descripcion_equipo || ""}</td>
      <td>${eq.cantidad || ""}</td>
      <td>${eq.tipo_medida || ""}</td>
    </tr>
  `).join("");

  $("#msg").style.display = "none";
}

$("#btnBuscar").onclick = buscar;
$("#refInput").onkeydown = e => { if (e.key === "Enter") buscar(); };

</script>

</body>
</html>
