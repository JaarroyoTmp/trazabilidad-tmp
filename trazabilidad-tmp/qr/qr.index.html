<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TMP ¬∑ QR Label Studio (LAB PRO)</title>

  <!-- Librer√≠a QR -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <style>
    :root{
      --bg0:#070b12;
      --bg1:#0b1220;
      --panel:#0f172a;
      --panel2:#111c33;
      --border:rgba(255,255,255,.10);
      --border2:rgba(88,166,255,.25);
      --txt:#eaf2ff;
      --muted:#a0b3cc;
      --accent:#58a6ff;
      --accent2:#27d3ff;
      --ok:#22c55e;
      --warn:#f59e0b;
      --bad:#ff6b6b;
      --shadow:0 18px 42px rgba(0,0,0,.60);
    }

    *{box-sizing:border-box;margin:0;padding:0}

    body{
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      color:var(--txt);
      background:
        radial-gradient(900px 700px at 10% 0%, rgba(88,166,255,.22), transparent 55%),
        radial-gradient(900px 700px at 100% 10%, rgba(39,211,255,.14), transparent 55%),
        linear-gradient(180deg, var(--bg1), var(--bg0));
      min-height:100vh;
    }

    /* ===== APP SHELL ===== */
    .topbar{
      position:sticky;
      top:0;
      z-index:50;
      backdrop-filter:blur(12px);
      background:rgba(15,23,42,.70);
      border-bottom:1px solid var(--border);
      box-shadow:0 12px 30px rgba(0,0,0,.35);
    }

    .topbar-inner{
      max-width:1200px;
      margin:0 auto;
      padding:14px 18px;
      display:flex;
      align-items:center;
      gap:14px;
    }

    .brand{
      display:flex;
      align-items:center;
      gap:12px;
    }

    .brand img{
      height:38px;
      width:auto;
      filter:drop-shadow(0 6px 16px rgba(0,0,0,.55));
    }

    .brand h1{
      font-size:15px;
      letter-spacing:.08em;
      text-transform:uppercase;
      font-weight:900;
      margin:0;
      line-height:1;
    }

    .brand .sub{
      font-size:12px;
      color:var(--muted);
      margin-top:4px;
      line-height:1.2;
    }

    .pill{
      margin-left:auto;
      display:inline-flex;
      align-items:center;
      gap:8px;
      font-size:12px;
      padding:8px 12px;
      border-radius:999px;
      background:linear-gradient(135deg, rgba(88,166,255,.14), rgba(39,211,255,.08));
      border:1px solid var(--border2);
      color:#d5e9ff;
    }

    .pill .dot{
      width:9px;height:9px;border-radius:50%;
      background:var(--ok);
      box-shadow:0 0 18px rgba(34,197,94,.55);
    }

    .pill.offline .dot{
      background:var(--bad);
      box-shadow:0 0 18px rgba(255,107,107,.55);
    }

    .btn-top{
      margin-left:12px;
      border:none;
      border-radius:12px;
      padding:10px 14px;
      font-weight:800;
      cursor:pointer;
      background:linear-gradient(135deg, #1fae64, #22c55e);
      color:#04120a;
      box-shadow:0 14px 30px rgba(0,0,0,.45);
      transition:.15s transform,.15s filter;
    }
    .btn-top:hover{transform:translateY(-1px);filter:brightness(1.06)}

    .wrap{
      max-width:1200px;
      margin:22px auto;
      padding:0 18px 40px;
      display:grid;
      grid-template-columns: minmax(0,480px) minmax(0,1fr);
      gap:18px;
    }

    @media (max-width:980px){
      .wrap{grid-template-columns:1fr;}
      .pill{display:none;}
    }

    /* ===== CARDS ===== */
    .card{
      background:linear-gradient(180deg, rgba(17,28,51,.92), rgba(11,18,32,.88));
      border:1px solid rgba(88,166,255,.16);
      border-radius:18px;
      box-shadow:var(--shadow);
      padding:18px 16px 16px;
    }

    .card h2{
      font-size:14px;
      font-weight:900;
      letter-spacing:.08em;
      text-transform:uppercase;
      margin-bottom:12px;
      color:#dff0ff;
    }

    label{
      font-size:12px;
      color:var(--muted);
      display:block;
      margin-bottom:6px;
      letter-spacing:.04em;
    }

    input,select{
      width:100%;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.10);
      background:#070b12;
      color:var(--txt);
      outline:none;
      transition:.15s border-color,.15s transform;
      font-size:14px;
    }

    input:focus,select:focus{
      border-color:var(--accent);
      box-shadow:0 0 0 3px rgba(88,166,255,.12);
    }

    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      margin-top:10px;
    }

    .btn{
      border:none;
      border-radius:999px;
      padding:10px 16px;
      font-size:13px;
      cursor:pointer;
      font-weight:900;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      transition:.15s transform,.15s filter,.15s box-shadow;
      box-shadow:0 12px 26px rgba(0,0,0,.35);
    }
    .btn:hover{transform:translateY(-1px);filter:brightness(1.06)}

    .btn.main{
      background:linear-gradient(135deg, #1fae64, #22c55e);
      color:#04120a;
    }

    .btn.ghost{
      background:rgba(255,255,255,.04);
      color:#d7ebff;
      border:1px solid rgba(255,255,255,.10);
      box-shadow:none;
    }
    .btn.ghost:hover{border-color:rgba(88,166,255,.35)}

    .sizes{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-top:12px;
    }

    .sizes button{
      padding:8px 12px;
      font-size:12px;
      border-radius:999px;
      cursor:pointer;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.04);
      color:#d7ebff;
      font-weight:900;
    }

    .sizes button.active{
      background:linear-gradient(135deg, rgba(88,166,255,.85), rgba(39,211,255,.55));
      color:#041324;
      border-color:transparent;
    }

    .box{
      margin-top:12px;
      padding:14px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.10);
      background:linear-gradient(135deg, rgba(7,11,18,.75), rgba(15,23,42,.45));
    }

    .hint{
      font-size:12px;
      color:var(--muted);
      margin-top:10px;
      line-height:1.35;
    }

    /* ===== PREVIEW LABEL (ON SCREEN) ===== */
    .preview{
      margin-top:14px;
      display:flex;
      justify-content:center;
      align-items:center;
      min-height:190px;
      gap:10px;
      flex-direction:column;
    }

    .label-preview{
      background:#fff;
      border:1px solid #111;
      border-radius:12px;
      padding:10px;
      box-shadow:0 18px 30px rgba(0,0,0,.25);
      display:inline-flex;
      flex-direction:column;
      align-items:center;
      justify-content:flex-start;
      position:relative;
    }

    .label-preview .tmp{
      font-size:11px;
      font-weight:900;
      letter-spacing:.24em;
      text-transform:uppercase;
      color:#0b1220;
      margin-bottom:4px;
    }

    .label-preview .qr-box canvas{
      background:#fff;
      border-radius:10px;
    }

    .label-preview .code{
      margin-top:6px;
      padding:4px 10px;
      border-radius:999px;
      border:1px solid #111;
      background:#f2f2f2;
      font-weight:900;
      font-size:13px;
      letter-spacing:.12em;
      color:#111;
      line-height:1;
    }

    .label-preview .micro{
      margin-top:3px;
      font-size:9px;
      letter-spacing:.06em;
      color:#222;
    }

    /* TALADRO / ANILLO 4mm - PEQUE√ëO Y LATERAL IZQUIERDO */
    .hole{
      position:absolute;
      top:8px;
      left:8px;
      width:10px;
      height:10px;
      border-radius:50%;
      border:1px solid rgba(0,0,0,.9);
      background:rgba(0,0,0,.04);
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .hole::after{
      content:"";
      width:6px;height:6px;border-radius:50%;
      border:1px solid rgba(0,0,0,.45);
      background:transparent;
    }
    .hole::before{
      content:"+";
      position:absolute;
      font-size:9px;
      font-weight:900;
      color:rgba(0,0,0,.55);
      line-height:1;
      transform:translateY(-0.2px);
    }

    /* ===== PANEL DERECHA ===== */
    .badge{
      display:inline-flex;
      align-items:center;
      gap:8px;
      font-size:12px;
      padding:8px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.04);
      color:#cfe6ff;
      margin-bottom:12px;
    }

    .list{
      margin-top:12px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.10);
      overflow:auto;
      background:rgba(0,0,0,.18);
      max-height:320px;
    }

    .inst-row{
      display:flex;
      gap:10px;
      padding:10px 12px;
      border-bottom:1px solid rgba(255,255,255,.06);
      cursor:pointer;
      transition:.12s background;
      align-items:flex-start;
    }

    .inst-row:hover{background:rgba(88,166,255,.08)}
    .inst-row:last-child{border-bottom:none;}

    .inst-row input[type="checkbox"]{margin-top:2px}

    .inst-code{
      font-weight:900;
      letter-spacing:.08em;
      min-width:70px;
    }
    .inst-desc{
      font-size:12px;
      color:var(--muted);
      line-height:1.25;
    }

    .footer{
      margin-top:12px;
      color:var(--muted);
      font-size:12px;
      display:flex;
      flex-direction:column;
      gap:6px;
    }

    .footer strong{color:#e9f4ff}

    .preview-grid{
      display:grid;
      grid-template-columns:repeat(3,1fr);
      gap:5px;
      margin-top:10px;
      background:rgba(0,0,0,.25);
      border:1px dashed rgba(255,255,255,.10);
      border-radius:12px;
      padding:10px;
    }

    .preview-cell{
      height:18px;
      border-radius:4px;
      background:#1f2937;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:10px;
      color:#9ca3af;
    }

    .preview-cell.filled{
      background:#22c55e;
      color:#022c22;
      font-weight:900;
    }
  </style>
</head>

<body>

<!-- TOPBAR -->
<div class="topbar">
  <div class="topbar-inner">
    <div class="brand">
      <img src="../img/tmp-quality.png" alt="TMP">
      <div>
        <h1>QR Label Studio</h1>
        <div class="sub">Editor profesional de etiquetas ¬∑ Laboratorio TMP</div>
      </div>
    </div>

    <div id="badgeOnline" class="pill offline">
      <span class="dot"></span>
      <span id="badgeOnlineTxt">Offline / verificando Supabase‚Ä¶</span>
    </div>

    <button class="btn-top" onclick="window.location.href='../home.html'">üè† Volver</button>
  </div>
</div>

<div class="wrap">

  <!-- IZQUIERDA -->
  <div class="card">
    <h2>Etiqueta individual</h2>

    <label>C√≥digo del instrumento</label>
    <input id="codigo" type="text" placeholder="Ej: 11217">

    <div class="row">
      <button class="btn main" id="btnGenerar">Generar</button>
      <button class="btn ghost" id="btnImprimirUno">Imprimir etiqueta</button>
    </div>

    <div class="sizes">
      <button class="size-btn active" data-mm="10">10 mm</button>
      <button class="size-btn" data-mm="13">13 mm</button>
      <button class="size-btn" data-mm="15">15 mm</button>
    </div>

    <div class="box">
      <label>Plantilla</label>
      <select id="tplEtiqueta">
        <option value="minimal">Minimal (QR + C√≥digo)</option>
        <option value="lab" selected>LAB PRO (TMP + QR + C√≥digo + corte + agujero)</option>
        <option value="full">FULL (incluye microtexto)</option>
      </select>

      <div class="hint">
        ‚úÖ Las <b>l√≠neas de corte</b> se imprimen siempre. <br>
        ‚úÖ El c√≠rculo lateral es la <b>gu√≠a para taladro 4mm</b> (anillo acero).
      </div>
    </div>

    <div class="preview" id="qrResult"></div>
  </div>

  <!-- DERECHA -->
  <div class="card">
    <h2>Hoja A4 (3√ó4 etiquetas)</h2>

    <div class="badge" id="badgeEstado">Cargando instrumentos desde Supabase‚Ä¶</div>

    <div style="margin-top:6px">
      <label>Buscar instrumentos</label>
      <input id="buscador" type="text" placeholder="Ej: 112, micr√≥metro‚Ä¶">
    </div>

    <div class="list" id="listaInstrumentos"></div>

    <div class="footer">
      <span><strong>Tama√±o:</strong> <span id="lblTamano">10 mm</span></span>
      <span><strong>Plantilla:</strong> <span id="lblTpl">LAB PRO</span></span>
      <span><strong>Capacidad:</strong> 12 etiquetas</span>
      <span><strong>Seleccionados:</strong> <span id="lblSeleccionados">0</span></span>
    </div>

    <div class="row" style="margin-top:12px;justify-content:flex-end">
      <button class="btn main" id="btnImprimirHoja">Imprimir hoja A4</button>
      <button class="btn ghost" id="btnLimpiarSeleccion">Limpiar</button>
      <button class="btn ghost" id="btnRefrescarLista">Recargar</button>
    </div>

    <div class="hint" style="margin-top:10px">
      Vista previa (ocupaci√≥n de hoja):
    </div>
    <div class="preview-grid" id="previewGrid"></div>
  </div>

</div>

<!-- SUPABASE -->
<script type="module" src="../config.mjs"></script>

<script>
/* ==================================
   CONFIG
================================== */
const BASE_URL = "https://trazabilidad-tmp.vercel.app/qr/qr.info_instrumentos.html?codigo=";
const MAX_PER_PAGE = 12;

let etiquetaMM = 10;
let allInstrumentos = [];
const selectedCodigos = new Set();

const codigoInput = document.getElementById("codigo");
const qrResult = document.getElementById("qrResult");

const badgeOnline = document.getElementById("badgeOnline");
const badgeOnlineTxt = document.getElementById("badgeOnlineTxt");

const badgeEstado = document.getElementById("badgeEstado");
const listaInstrumentos = document.getElementById("listaInstrumentos");
const buscadorInput = document.getElementById("buscador");

const lblTamano = document.getElementById("lblTamano");
const lblTpl = document.getElementById("lblTpl");
const lblSeleccionados = document.getElementById("lblSeleccionados");
const previewGrid = document.getElementById("previewGrid");

const sizeButtons = document.querySelectorAll(".size-btn");
const tplSelect = document.getElementById("tplEtiqueta");

function plantillaNombre(v){
  if (v==="minimal") return "MINIMAL";
  if (v==="lab") return "LAB PRO";
  if (v==="full") return "FULL";
  return "LAB PRO";
}
function esc(text){
  return String(text).replace(/[&<>"']/g, m => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
  }[m]));
}

/* ==================================
   PREVIEW GRID
================================== */
function actualizarPreview(){
  lblTamano.textContent = etiquetaMM + " mm";
  lblTpl.textContent = plantillaNombre(tplSelect.value);
  lblSeleccionados.textContent = selectedCodigos.size;

  previewGrid.innerHTML = "";
  for(let i=0;i<MAX_PER_PAGE;i++){
    const div=document.createElement("div");
    div.className="preview-cell";
    if(i<selectedCodigos.size){
      div.classList.add("filled");
      div.textContent=i+1;
    }
    previewGrid.appendChild(div);
  }
}

/* ==================================
   RENDER PREVIEW LABEL (SCREEN)
================================== */
function renderEtiquetaPreview(codigo, url, mm, tpl){
  const showHeader = (tpl !== "minimal");
  const showMicro = (tpl === "full");

  qrResult.innerHTML = `
    <div class="label-preview">
      <div class="hole" title="Gu√≠a de taladro 4mm (anillo acero)"></div>
      ${showHeader ? `<div class="tmp">TMP</div>` : ``}
      <div class="qr-box"></div>
      <div class="code">${esc(codigo)}</div>
      ${showMicro ? `<div class="micro">Trazabilidad ¬∑ Laboratorio TMP</div>` : ``}
    </div>
    <div class="hint">URL: ${esc(url)}</div>
  `;

  const qrBox = qrResult.querySelector(".qr-box");
  qrBox.innerHTML = "";

  new QRCode(qrBox, {
    text: url,
    width: mm * 8,
    height: mm * 8
  });
}

/* ==================================
   GENERAR
================================== */
function generar(){
  const codigo = codigoInput.value.trim();
  if(!codigo){ alert("Introduce el c√≥digo"); return; }
  const url = BASE_URL + encodeURIComponent(codigo);

  renderEtiquetaPreview(codigo, url, etiquetaMM, tplSelect.value);
}

/* ==================================
   BUILD LABEL HTML (PRINT)
   - CUT LINES ALWAYS
   - HOLE: lateral izquierdo peque√±o
================================== */
function buildLabelHTML(codigo, url, mm, tpl){
  const extra = (tpl==="minimal") ? 4 : (tpl==="lab") ? 8 : 10;
  return `
    <div class="cell">
      <div class="cut-top"></div>
      <div class="cut-right"></div>
      <div class="cut-bottom"></div>
      <div class="cut-left"></div>

      <div class="label">
        <div class="hole">
          <div class="hole-outer"></div>
          <div class="hole-inner"></div>
          <div class="hole-cross">+</div>
        </div>

        ${tpl==="minimal" ? "" : `<div class="tmp">TMP</div>`}

        <img class="qr"
          src="https://api.qrserver.com/v1/create-qr-code/?size=400x400&data=${encodeURIComponent(url)}">

        <div class="code">${esc(codigo)}</div>

        ${tpl==="full" ? `<div class="micro">Trazabilidad ¬∑ Laboratorio TMP</div>` : ""}
      </div>
    </div>
  `;
}

function buildPrintHTML(labelsHTML, mm, tpl, single=false){
  const extra = (tpl==="minimal") ? 4 : (tpl==="lab") ? 8 : 10;

  return `
<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Etiquetas TMP</title>
<style>
  @page { size: ${single ? "auto" : "A4"}; margin: 10mm; }
  body{ margin:0; font-family: Arial, sans-serif; }

  .sheet{
    display:${single ? "flex" : "grid"};
    ${single ? "justify-content:center;align-items:center;height:100vh;" : ""}
    grid-template-columns: repeat(3, auto);
    grid-template-rows: repeat(4, auto);
    justify-content:center;
    align-items:center;
    gap: 10mm;
    margin-top: 5mm;
  }

  .cell{
    position:relative;
    width:${mm}mm;
    height:${mm + extra}mm;
    display:flex;
    align-items:center;
    justify-content:center;
  }

  .label{
    width:${mm}mm;
    height:${mm + extra}mm;
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:flex-start;
    background:#fff;
    border:0.25mm solid #111;
    border-radius:2mm;
    padding:1.4mm;
    position:relative;
  }

  .tmp{
    font-size:${mm<=10?2.6:2.8}mm;
    font-weight:900;
    letter-spacing:0.35mm;
    margin-top:0.2mm;
    text-transform:uppercase;
  }

  .qr{
    width:${mm}mm;
    height:${mm}mm;
    margin-top:0.6mm;
  }

  .code{
    margin-top:0.7mm;
    font-size:${mm<=10?2.6:2.8}mm;
    font-weight:900;
    letter-spacing:0.25mm;
    padding:0.5mm 1.3mm;
    border:0.2mm solid #111;
    border-radius:999px;
    background:#f2f2f2;
    line-height:1;
  }

  .micro{
    margin-top:0.4mm;
    font-size:${mm<=10?1.7:1.8}mm;
    letter-spacing:0.1mm;
    line-height:1;
  }

  /* CUT LINES ALWAYS */
  .cut-top{
    position:absolute; top:-4mm; left:0; right:0;
    border-top:0.35mm dashed rgba(0,0,0,.55);
  }
  .cut-bottom{
    position:absolute; bottom:-4mm; left:0; right:0;
    border-bottom:0.35mm dashed rgba(0,0,0,.55);
  }
  .cut-left{
    position:absolute; top:0; bottom:0; left:-4mm;
    border-left:0.35mm dashed rgba(0,0,0,.55);
  }
  .cut-right{
    position:absolute; top:0; bottom:0; right:-4mm;
    border-right:0.35mm dashed rgba(0,0,0,.55);
  }

  /* HOLE GUIDE LATERAL IZQUIERDO (peque√±o) */
  .hole{
    position:absolute;
    top:1.4mm;
    left:1.4mm;
    width:5mm;
    height:5mm;
    display:flex;
    align-items:center;
    justify-content:center;
  }
  .hole-outer{
    position:absolute;
    width:5mm; height:5mm;
    border-radius:50%;
    border:0.25mm solid rgba(0,0,0,.60);
  }
  .hole-inner{
    position:absolute;
    width:3.5mm; height:3.5mm;
    border-radius:50%;
    border:0.25mm solid rgba(0,0,0,.95);
    background:transparent;
  }
  .hole-cross{
    position:absolute;
    font-size:2.6mm;
    font-weight:900;
    color:rgba(0,0,0,.55);
    line-height:1;
    transform:translateY(-0.1mm);
  }
</style>
</head>
<body>
  <div class="sheet">${labelsHTML}</div>
<script>
  window.onload = () => setTimeout(() => window.print(), 250);
<\/script>
</body>
</html>`;
}

/* ==================================
   PRINT SINGLE
================================== */
function imprimirEtiqueta(){
  const codigo = codigoInput.value.trim();
  if(!codigo){ alert("Introduce el c√≥digo"); return; }
  const url = BASE_URL + encodeURIComponent(codigo);

  const labelHTML = buildLabelHTML(codigo, url, etiquetaMM, tplSelect.value);
  const html = buildPrintHTML(labelHTML, etiquetaMM, tplSelect.value, true);

  const w = window.open("", "_blank");
  w.document.write(html);
  w.document.close();
}

/* ==================================
   PRINT A4
================================== */
function imprimirHoja(){
  if (!selectedCodigos.size){
    alert("Selecciona al menos un instrumento.");
    return;
  }

  const tpl = tplSelect.value;
  const mm = etiquetaMM;

  const codigos = Array.from(selectedCodigos).slice(0, 12);
  let htmlLabels = "";

  codigos.forEach(codigo=>{
    const url = BASE_URL + encodeURIComponent(codigo);
    htmlLabels += buildLabelHTML(codigo, url, mm, tpl);
  });

  const html = buildPrintHTML(htmlLabels, mm, tpl, false);
  const w = window.open("", "_blank");
  w.document.write(html);
  w.document.close();
}

/* ==================================
   SIZE + TEMPLATE EVENTS
================================== */
sizeButtons.forEach(btn=>{
  btn.addEventListener("click",()=>{
    sizeButtons.forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    etiquetaMM = parseInt(btn.dataset.mm,10);
    actualizarPreview();
    if(codigoInput.value.trim()) generar();
  });
});

tplSelect.addEventListener("change",()=>{
  actualizarPreview();
  if(codigoInput.value.trim()) generar();
});

document.getElementById("btnGenerar").addEventListener("click", generar);
document.getElementById("btnImprimirUno").addEventListener("click", imprimirEtiqueta);

codigoInput.addEventListener("keydown", e=>{
  if(e.key==="Enter"){ e.preventDefault(); generar(); }
});

/* ==================================
   SUPABASE LOAD
================================== */
async function checkSupabase(){
  const sb = window.supabase;
  if(sb){
    badgeOnline.classList.remove("offline");
    badgeOnlineTxt.textContent="Online (Supabase conectado)";
  } else {
    badgeOnline.classList.add("offline");
    badgeOnlineTxt.textContent="Offline (Supabase no disponible)";
  }
}

async function cargarInstrumentos(){
  const supabase = window.supabase;
  if(!supabase){
    badgeEstado.textContent="Supabase no disponible.";
    return;
  }

  badgeEstado.textContent="Cargando instrumentos‚Ä¶";

  const { data, error } = await supabase
    .from("instrumentos")
    .select("codigo, descripcion")
    .order("codigo", { ascending:true });

  if(error){
    badgeEstado.textContent="Error al cargar.";
    return;
  }

  allInstrumentos=data||[];
  badgeEstado.textContent=`Instrumentos cargados: ${allInstrumentos.length}`;
  renderInstrumentList();
}

function renderInstrumentList(filtro=""){
  const term=filtro.toLowerCase();
  const filtrados = term
    ? allInstrumentos.filter(i =>
        String(i.codigo).toLowerCase().includes(term) ||
        (i.descripcion||"").toLowerCase().includes(term)
      )
    : allInstrumentos;

  listaInstrumentos.innerHTML="";

  if(!filtrados.length){
    listaInstrumentos.innerHTML=`<div style="padding:10px;font-size:13px;color:#777;">Sin resultados</div>`;
    return;
  }

  filtrados.forEach(inst=>{
    const row=document.createElement("label");
    row.className="inst-row";

    const chk=document.createElement("input");
    chk.type="checkbox";
    chk.checked = selectedCodigos.has(inst.codigo);

    chk.addEventListener("change",()=>{
      if(chk.checked) selectedCodigos.add(inst.codigo);
      else selectedCodigos.delete(inst.codigo);
      actualizarPreview();
    });

    const code=document.createElement("div");
    code.className="inst-code";
    code.textContent=inst.codigo;

    const desc=document.createElement("div");
    desc.className="inst-desc";
    desc.textContent=inst.descripcion || "";

    row.appendChild(chk);
    row.appendChild(code);
    row.appendChild(desc);
    listaInstrumentos.appendChild(row);
  });

  actualizarPreview();
}

buscadorInput.addEventListener("input",()=>renderInstrumentList(buscadorInput.value));
document.getElementById("btnRefrescarLista").addEventListener("click", cargarInstrumentos);
document.getElementById("btnLimpiarSeleccion").addEventListener("click",()=>{
  selectedCodigos.clear();
  renderInstrumentList(buscadorInput.value);
});
document.getElementById("btnImprimirHoja").addEventListener("click", imprimirHoja);

/* ==================================
   INIT
================================== */
window.addEventListener("load", ()=>{
  actualizarPreview();
  checkSupabase();
  setTimeout(cargarInstrumentos, 350);
});
</script>

</body>
</html>



