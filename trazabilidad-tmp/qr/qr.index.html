<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TMP ¬∑ Generador de C√≥digos QR</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://esm.sh/@supabase/supabase-js@2"></script>

<style>
  body{
    margin:0;
    font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
    background:#0d1117;
    color:#f0f6fc;
  }
  header{
    display:flex;
    align-items:center;
    gap:14px;
    padding:14px 16px;
    background:#161b22;
    border-bottom:1px solid #30363d;
  }
  header img.logo{height:40px}
  header h1{margin:0;font-size:18px}
  header span.sub{font-size:12px;color:#8b949e}

  .wrap{
    max-width:800px;
    margin:22px auto;
    padding:0 16px 32px;
  }

  .card{
    background:#161b22;
    border-radius:16px;
    border:1px solid #30363d;
    padding:20px 16px;
    margin-bottom:20px;
  }

  h2{margin:0 0 10px;font-size:16px}
  label{display:block;font-size:13px;color:#8b949e;margin-bottom:4px}

  input{
    width:100%;
    padding:10px 12px;
    border-radius:10px;
    border:1px solid #30363d;
    background:#0d1117;
    color:#f0f6fc;
    font-size:14px;
    outline:none;
  }

  input:focus{border-color:#58a6ff;}

  button{
    border:none;
    border-radius:999px;
    padding:9px 16px;
    font-size:14px;
    cursor:pointer;
    font-weight:600;
  }

  .btn-main{background:#238636;color:#fff;}
  .btn-main:hover{background:#2ea043;}

  .btn-ghost{
    background:transparent;
    color:#58a6ff;
    border:1px solid #30363d;
  }
  .btn-ghost:hover{border-color:#58a6ff;}

  .list{
    background:#0f172a;
    border:1px solid #30363d;
    border-radius:12px;
    max-height:260px;
    overflow:auto;
    margin-top:10px;
  }

  .item{
    padding:10px;
    border-bottom:1px solid #1e293b;
    cursor:pointer;
  }
  .item:hover{
    background:#1e293b;
  }

  .sizes{
    display:flex;
    gap:8px;
    flex-wrap:wrap;
    margin-top:8px
  }

  .sizes button{
    font-size:12px;
    padding:7px 12px
  }

  #qrResult{
    margin-top:20px;
    display:flex;
    flex-direction:column;
    align-items:center;
  }

  #qrResult canvas{
    background:#ffffff;
    padding:10px;
    border-radius:12px;
  }

  #volverHome{
    position:fixed;
    bottom:18px;
    right:18px;
    background:#238636;
    padding:12px 18px;
    font-size:14px;
    border-radius:12px;
    border:1px solid #2ea043;
    cursor:pointer;
    color:white;
    box-shadow:0 0 10px rgba(0,0,0,.4);
  }
</style>
</head>


<body>

<button id="volverHome" onclick="window.location.href='../home.html'">üè† Volver</button>

<header>
  <img src="../img/tmp-quality.png" alt="TMP" class="logo">
  <div>
    <h1>Generador de c√≥digos QR</h1>
    <span class="sub">Trazabilidad de instrumentos ¬∑ TMP</span>
  </div>
</header>

<div class="wrap">

  <!-- BUSCADOR -->
  <div class="card">
    <h2>Buscar instrumentos</h2>
    <input id="buscador" placeholder="Buscar por c√≥digo, descripci√≥n o fabricante..." oninput="filtrarLista()">

    <div class="list" id="listaInstrumentos"></div>
  </div>

  <!-- GENERADOR -->
  <div class="card">
    <h2>Etiquetas seleccionadas</h2>

    <div id="seleccionados" style="margin-bottom:10px;font-size:14px;color:#8b949e;">
      Ning√∫n instrumento seleccionado.
    </div>

    <h3>Tama√±o de etiqueta</h3>
    <div class="sizes">
      <button class="btn-ghost" onclick="setSize(10)">10 mm</button>
      <button class="btn-ghost" onclick="setSize(13)">13 mm</button>
      <button class="btn-ghost" onclick="setSize(15)">15 mm</button>
    </div>

    <button class="btn-main" onclick="imprimirHoja()" style="margin-top:20px;width:100%;">
      üñ® Imprimir hoja A4 optimizada
    </button>

    <div id="qrResult"></div>
  </div>

</div>


<script>
// =======================
// SUPABASE
// =======================
const SUPABASE_URL = "https://uukxdslfmxesufuxjzvt.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV1a3hkc2xmbXhlc3VmdXhqenZ0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjExMjg5MjksImV4cCI6MjA3NjcwNDkyOX0.7bmDUEQTfl6Y5jdzORyFZUFtOs7GM0dNdfp1zsURkWw";

const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let INSTRUMENTOS = [];
let selectedCodigos = new Set();

const BASE_URL = "https://trazabilidad-tmp.vercel.app/qr/qr.info_instrumentos.html?codigo=";

let etiquetaMM = 10;


// =======================
// CARGAR LISTA
// =======================
async function cargarInstrumentos(){
  const { data, error } = await supabase
    .from("instrumentos")
    .select("codigo, descripcion, fabricante")
    .order("codigo", { ascending: true });

  if(error){ alert("Error cargando instrumentos"); return; }

  INSTRUMENTOS = data;
  renderLista(data);
}
cargarInstrumentos();


// =======================
// MOSTRAR LISTA
// =======================
function renderLista(arr){
  const div = document.getElementById("listaInstrumentos");
  div.innerHTML = arr.map(i => `
    <div class="item" onclick="toggleSelect('${i.codigo}')">
      <b>${i.codigo}</b> ‚Äî ${i.descripcion || ""}  
      <br><span style="color:#758195">${i.fabricante || ""}</span>
    </div>
  `).join("");
}


// =======================
// FILTRAR
// =======================
function filtrarLista(){
  const t = document.getElementById("buscador").value.toLowerCase();
  const f = INSTRUMENTOS.filter(i =>
    i.codigo.toLowerCase().includes(t) ||
    (i.descripcion || "").toLowerCase().includes(t) ||
    (i.fabricante || "").toLowerCase().includes(t)
  );
  renderLista(f);
}


// =======================
// SELECCIONAR INSTRUMENTO
// =======================
function toggleSelect(codigo){
  if(selectedCodigos.has(codigo)) selectedCodigos.delete(codigo);
  else selectedCodigos.add(codigo);

  actualizarSeleccion();
}


// =======================
function actualizarSeleccion(){
  const div = document.getElementById("seleccionados");

  if(selectedCodigos.size === 0){
    div.textContent = "Ning√∫n instrumento seleccionado.";
    return;
  }

  div.innerHTML = "<b>Seleccionados:</b> " + 
    Array.from(selectedCodigos).join(", ");
}


// =======================
// TAMA√ëO ETIQUETA
// =======================
function setSize(mm){
  etiquetaMM = mm;
  alert("Tama√±o de etiqueta ajustado a " + mm + " mm.");
}


// =======================
// CALCULAR DISTRIBUCI√ìN A4
// =======================
function computeLayout(mm){
  const pageW = 210 - 2*15;
  const pageH = 297 - 2*15;

  const cols = Math.floor((pageW + 2) / (mm + 2));
  const rows = Math.floor((pageH + 2) / (mm + 2));

  return { cols, rows, perPage: cols*rows };
}


// =======================
// IMPRESI√ìN EN 2 HOJAS
// =======================
function imprimirHoja(){
  if (!selectedCodigos.size){
    alert("Selecciona al menos un instrumento.");
    return;
  }

  const {cols, rows, perPage} = computeLayout(etiquetaMM);
  const codigos = Array.from(selectedCodigos);
  const usable = codigos.slice(0, perPage);

  imprimirEtiquetas(usable, cols);
  imprimirCroquis(usable, cols);
}


// =======================
// HOJA 1 ‚Äî ETIQUETAS
// =======================
function imprimirEtiquetas(codigos, cols){
  const w = etiquetaMM;

  let html = "";
  codigos.forEach(c => {
    const url = BASE_URL + encodeURIComponent(c);
    html += `
      <div class="label">
        <img src="https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(url)}">
      </div>`;
  });

  const win = window.open("", "_blank");
  win.document.write(`
    <html><head>
    <meta charset="utf-8">
    <style>
      @page { size:A4; margin:15mm; }
      body{ margin:0; font-family:sans-serif; }
      .sheet{
        display:grid;
        grid-template-columns:repeat(${cols}, ${w}mm);
        grid-auto-rows:${w}mm;
        gap:2mm;
        justify-content:center;
      }
      img{ width:${w}mm;height:${w}mm; }
    </style>
    </head><body>
      <div class="sheet">${html}</div>
      <script>window.onload = ()=>setTimeout(()=>window.print(),400);<\/script>
    </body></html>
  `);
  win.document.close();
}


// =======================
// HOJA 2 ‚Äî CROQUIS
// =======================
function imprimirCroquis(codigos, cols){
  let rows = [];

  codigos.forEach((c, i)=>{
    const fila = Math.floor(i/cols)+1;
    const col = (i%cols)+1;
    rows.push(`<tr><td>${i+1}</td><td>${fila}</td><td>${col}</td><td>${c}</td></tr>`);
  });

  const win = window.open("", "_blank");
  win.document.write(`
    <html><head>
    <meta charset="utf-8">
    <style>
      @page { size:A4; margin:15mm; }
      body{ font-family:sans-serif; }
      table{
        width:100%;
        border-collapse:collapse;
        font-size:13px;
      }
      td,th{
        border:1px solid #aaa;
        padding:6px;
      }
      th{ background:#eee; }
    </style>
    </head><body>
      <h2>Esquema de colocaci√≥n de etiquetas</h2>
      <table>
        <thead>
          <tr><th>#</th><th>Fila</th><th>Columna</th><th>C√≥digo</th></tr>
        </thead>
        <tbody>${rows.join("")}</tbody>
      </table>
      <script>window.onload = ()=>setTimeout(()=>window.print(),400);<\/script>
    </body></html>
  `);
  win.document.close();
}

</script>

</body>
</html>

