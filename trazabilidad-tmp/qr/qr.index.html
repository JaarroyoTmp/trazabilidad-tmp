<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TMP ¬∑ QR Label Studio (LAB PRO)</title>

  <!-- Librer√≠a QR -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <style>
    :root{
      --bg0:#070b12;
      --bg1:#0b1220;
      --panel:#0f172a;
      --panel2:#111c33;
      --border:rgba(255,255,255,.10);
      --border2:rgba(88,166,255,.25);
      --txt:#eaf2ff;
      --muted:#a0b3cc;
      --accent:#58a6ff;
      --accent2:#27d3ff;
      --ok:#22c55e;
      --bad:#ff6b6b;
      --shadow:0 18px 42px rgba(0,0,0,.60);
    }

    *{box-sizing:border-box;margin:0;padding:0}

    body{
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      color:var(--txt);
      background:
        radial-gradient(900px 700px at 10% 0%, rgba(88,166,255,.22), transparent 55%),
        radial-gradient(900px 700px at 100% 10%, rgba(39,211,255,.14), transparent 55%),
        linear-gradient(180deg, var(--bg1), var(--bg0));
      min-height:100vh;
    }

    .topbar{
      position:sticky;
      top:0;
      z-index:50;
      backdrop-filter:blur(12px);
      background:rgba(15,23,42,.70);
      border-bottom:1px solid var(--border);
      box-shadow:0 12px 30px rgba(0,0,0,.35);
    }

    .topbar-inner{
      max-width:1200px;
      margin:0 auto;
      padding:14px 18px;
      display:flex;
      align-items:center;
      gap:14px;
    }

    .brand{display:flex;align-items:center;gap:12px;}
    .brand img{
      height:38px;width:auto;
      filter:drop-shadow(0 6px 16px rgba(0,0,0,.55));
    }
    .brand h1{
      font-size:15px;
      letter-spacing:.08em;
      text-transform:uppercase;
      font-weight:900;
      margin:0;line-height:1;
    }
    .brand .sub{
      font-size:12px;color:var(--muted);
      margin-top:4px;line-height:1.2;
    }

    .pill{
      margin-left:auto;
      display:inline-flex;
      align-items:center;
      gap:8px;
      font-size:12px;
      padding:8px 12px;
      border-radius:999px;
      background:linear-gradient(135deg, rgba(88,166,255,.14), rgba(39,211,255,.08));
      border:1px solid var(--border2);
      color:#d5e9ff;
    }
    .pill .dot{
      width:9px;height:9px;border-radius:50%;
      background:var(--ok);
      box-shadow:0 0 18px rgba(34,197,94,.55);
    }
    .pill.offline .dot{
      background:var(--bad);
      box-shadow:0 0 18px rgba(255,107,107,.55);
    }

    .btn-top{
      margin-left:12px;border:none;border-radius:12px;
      padding:10px 14px;font-weight:800;cursor:pointer;
      background:linear-gradient(135deg, #1fae64, #22c55e);
      color:#04120a;
      box-shadow:0 14px 30px rgba(0,0,0,.45);
      transition:.15s transform,.15s filter;
    }
    .btn-top:hover{transform:translateY(-1px);filter:brightness(1.06)}

    .wrap{
      max-width:1200px;
      margin:22px auto;
      padding:0 18px 40px;
      display:grid;
      grid-template-columns: minmax(0,480px) minmax(0,1fr);
      gap:18px;
    }
    @media (max-width:980px){
      .wrap{grid-template-columns:1fr;}
      .pill{display:none;}
    }

    .card{
      background:linear-gradient(180deg, rgba(17,28,51,.92), rgba(11,18,32,.88));
      border:1px solid rgba(88,166,255,.16);
      border-radius:18px;
      box-shadow:var(--shadow);
      padding:18px 16px 16px;
    }
    .card h2{
      font-size:14px;
      font-weight:900;
      letter-spacing:.08em;
      text-transform:uppercase;
      margin-bottom:12px;
      color:#dff0ff;
    }

    label{
      font-size:12px;color:var(--muted);
      display:block;margin-bottom:6px;letter-spacing:.04em;
    }

    input,select{
      width:100%;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.10);
      background:#070b12;
      color:var(--txt);
      outline:none;
      transition:.15s border-color,.15s transform;
      font-size:14px;
    }
    input:focus,select:focus{
      border-color:var(--accent);
      box-shadow:0 0 0 3px rgba(88,166,255,.12);
    }

    .row{
      display:flex;gap:10px;flex-wrap:wrap;
      align-items:center;margin-top:10px;
    }

    .btn{
      border:none;border-radius:999px;
      padding:10px 16px;font-size:13px;
      cursor:pointer;font-weight:900;
      display:inline-flex;align-items:center;justify-content:center;gap:8px;
      transition:.15s transform,.15s filter,.15s box-shadow;
      box-shadow:0 12px 26px rgba(0,0,0,.35);
    }
    .btn:hover{transform:translateY(-1px);filter:brightness(1.06)}
    .btn.main{
      background:linear-gradient(135deg, #1fae64, #22c55e);
      color:#04120a;
    }
    .btn.ghost{
      background:rgba(255,255,255,.04);
      color:#d7ebff;
      border:1px solid rgba(255,255,255,.10);
      box-shadow:none;
    }
    .btn.ghost:hover{border-color:rgba(88,166,255,.35)}

    .sizes{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px;}
    .sizes button{
      padding:8px 12px;font-size:12px;border-radius:999px;
      cursor:pointer;border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.04);
      color:#d7ebff;font-weight:900;
    }
    .sizes button.active{
      background:linear-gradient(135deg, rgba(88,166,255,.85), rgba(39,211,255,.55));
      color:#041324;border-color:transparent;
    }

    .box{
      margin-top:12px;padding:14px;border-radius:16px;
      border:1px solid rgba(255,255,255,.10);
      background:linear-gradient(135deg, rgba(7,11,18,.75), rgba(15,23,42,.45));
    }

    .hint{font-size:12px;color:var(--muted);margin-top:10px;line-height:1.35;}

    /* ===== PREVIEW LABEL ===== */
    .preview{
      margin-top:14px;
      display:flex;
      justify-content:center;
      align-items:center;
      min-height:220px;
      gap:10px;
      flex-direction:column;
    }

    .label-preview{
      background:#fff;border:1px solid #111;border-radius:12px;
      padding:10px;box-shadow:0 18px 30px rgba(0,0,0,.25);
      display:inline-flex;flex-direction:column;align-items:center;justify-content:flex-start;
      position:relative;
      padding-top:18px;
    }

    .hole{
      position:absolute;top:6px;left:6px;
      width:10px;height:10px;border-radius:50%;
      border:1px solid rgba(0,0,0,.9);
      background:rgba(0,0,0,.04);
      display:flex;align-items:center;justify-content:center;
      z-index:5;pointer-events:none;
    }
    .hole::after{
      content:"";width:6px;height:6px;border-radius:50%;
      border:1px solid rgba(0,0,0,.45);
      background:transparent;
    }
    .hole::before{
      content:"+";position:absolute;font-size:9px;font-weight:900;
      color:rgba(0,0,0,.55);line-height:1;transform:translateY(-0.2px);
    }

    .label-preview .tmp{
      font-size:11px;font-weight:900;letter-spacing:.24em;text-transform:uppercase;
      color:#0b1220;margin-bottom:4px;
    }

    .label-preview .qr-box canvas{background:#fff;border-radius:10px;}

    .label-preview .code{
      margin-top:6px;padding:4px 10px;border-radius:999px;border:1px solid #111;
      background:#f2f2f2;font-weight:900;font-size:13px;letter-spacing:.12em;color:#111;line-height:1;
    }

    /* ===== PANEL DERECHA ===== */
    .badge{
      display:inline-flex;align-items:center;gap:8px;
      font-size:12px;padding:8px 12px;border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.04);
      color:#cfe6ff;margin-bottom:12px;
    }

    .list{
      margin-top:12px;border-radius:16px;border:1px solid rgba(255,255,255,.10);
      overflow:auto;background:rgba(0,0,0,.18);max-height:320px;
    }

    .inst-row{
      display:flex;gap:10px;padding:10px 12px;
      border-bottom:1px solid rgba(255,255,255,.06);
      cursor:pointer;transition:.12s background,.12s outline;
      align-items:flex-start;
    }
    .inst-row:hover{background:rgba(88,166,255,.08)}
    .inst-row:last-child{border-bottom:none;}
    .inst-row.selected{
      background:rgba(88,166,255,.14);
      outline:1px solid rgba(88,166,255,.40);
    }
    .inst-row input[type="checkbox"]{
      margin-top:2px;
      width:18px;height:18px;
      accent-color: var(--accent);
      cursor:pointer;
    }

    .inst-code{font-weight:900;letter-spacing:.08em;min-width:70px;}
    .inst-desc{font-size:12px;color:var(--muted);line-height:1.25;}

    .footer{
      margin-top:12px;color:var(--muted);font-size:12px;
      display:flex;flex-direction:column;gap:6px;
    }
    .footer strong{color:#e9f4ff}

    .preview-grid{
      display:grid;
      gap:5px;
      margin-top:10px;
      background:rgba(0,0,0,.25);
      border:1px dashed rgba(255,255,255,.10);
      border-radius:12px;
      padding:10px;
    }

    .preview-cell{
      height:18px;border-radius:4px;background:#1f2937;
      display:flex;align-items:center;justify-content:center;
      font-size:10px;color:#9ca3af;
    }
    .preview-cell.filled{
      background:#22c55e;color:#022c22;font-weight:900;
    }

    /* =======================
       IMPRESI√ìN SIN POPUP
       ======================= */
    #printArea{display:none;}
    @media print{
      body > *:not(#printArea){display:none !important;}
      #printArea{display:block !important;}
    }
  </style>
</head>

<body>

<div class="topbar">
  <div class="topbar-inner">
    <div class="brand">
      <img src="../img/tmp-quality.png" alt="TMP">
      <div>
        <h1>QR Label Studio</h1>
        <div class="sub">Editor profesional de etiquetas ¬∑ Laboratorio TMP</div>
      </div>
    </div>

    <div id="badgeOnline" class="pill offline">
      <span class="dot"></span>
      <span id="badgeOnlineTxt">Offline / verificando Supabase‚Ä¶</span>
    </div>

    <button class="btn-top" onclick="window.location.href='../home.html'">üè† Volver</button>
  </div>
</div>

<div class="wrap">

  <!-- IZQUIERDA -->
  <div class="card">
    <h2>Etiqueta individual</h2>

    <label>C√≥digo del instrumento</label>
    <input id="codigo" type="text" placeholder="Ej: METMP001">

    <div class="row">
      <button class="btn main" id="btnGenerar">Generar</button>
      <button class="btn ghost" id="btnImprimirUno">Imprimir etiqueta</button>
    </div>

    <div class="sizes">
      <button class="size-btn active" data-mm="10">10 mm</button>
      <button class="size-btn" data-mm="13">13 mm</button>
      <button class="size-btn" data-mm="15">15 mm</button>
    </div>

    <div class="box">
      <label>Plantilla</label>
      <select id="tplEtiqueta">
        <option value="minimal">Minimal (QR + C√≥digo)</option>
        <option value="lab" selected>LAB PRO (TMP + QR + C√≥digo + corte + agujero)</option>
        <option value="full">FULL (incluye microtexto)</option>
      </select>

      <div class="hint">
        ‚úÖ L√≠neas de corte siempre.<br>
        ‚úÖ Agujero gu√≠a <b>ARRIBA IZQUIERDA</b> para anillo acero 4mm (sin tocar QR).
      </div>
    </div>

    <div class="preview" id="qrResult"></div>
  </div>

  <!-- DERECHA -->
  <div class="card">
    <h2>Hoja A4</h2>

    <div class="badge" id="badgeEstado">Cargando instrumentos desde Supabase‚Ä¶</div>

    <div style="margin-top:6px">
      <label>Formato hoja</label>
      <select id="sheetPreset">
        <option value="sticker_70x36" selected>Pegatina 70√ó36 mm (3√ó8)</option>
        <option value="generic_3x4">Gen√©rico (3√ó4)</option>
      </select>
      <div class="hint" style="margin-top:6px">
        Para que cuadre perfecto: en el di√°logo de imprimir usa <b>Escala 100%</b> y desmarca <b>encabezados/pies</b>.
      </div>
    </div>

    <div style="margin-top:10px">
      <label>Buscar instrumentos</label>
      <input id="buscador" type="text" placeholder="Ej: MET, micr√≥metro, M14‚Ä¶">
    </div>

    <div class="list" id="listaInstrumentos"></div>

    <div class="footer">
      <span><strong>Tama√±o:</strong> <span id="lblTamano">10 mm</span></span>
      <span><strong>Plantilla:</strong> <span id="lblTpl">LAB PRO</span></span>
      <span><strong>Capacidad:</strong> <span id="lblCapacidad">24</span> etiquetas</span>
      <span><strong>Seleccionados:</strong> <span id="lblSeleccionados">0</span></span>
    </div>

    <div class="row" style="margin-top:12px;justify-content:flex-end">
      <button class="btn main" id="btnImprimirHoja">Imprimir hoja A4</button>
      <button class="btn ghost" id="btnLimpiarSeleccion">Limpiar</button>
      <button class="btn ghost" id="btnRefrescarLista">Recargar</button>
    </div>

    <div class="hint" style="margin-top:10px">
      Vista previa (ocupaci√≥n de hoja):
    </div>
    <div class="preview-grid" id="previewGrid"></div>
  </div>

</div>

<!-- √Årea oculta para imprimir -->
<div id="printArea"></div>

<!-- SUPABASE -->
<script type="module" src="../config.mjs"></script>

<script type="module">
  const BASE_URL = "https://trazabilidad-tmp.vercel.app/qr/qr.info_instrumentos.html?codigo=";

  // ====== PRESETS DE HOJA A4 ======
  // sticker_70x36: 3 columnas x 8 filas, etiqueta 70x36 mm (24)
  // generic_3x4: 3x4 (12) por si lo necesitas
  const SHEETS = {
    sticker_70x36: {
      name: "Pegatina 70√ó36",
      cols: 3, rows: 8,
      labelWmm: 70, labelHmm: 36,
      gapXmm: 0, gapYmm: 0,
      marginTopMm: 0, marginLeftMm: 0,
      pageMarginMm: 0
    },
    generic_3x4: {
      name: "Gen√©rico 3√ó4",
      cols: 3, rows: 4,
      labelWmm: 60, labelHmm: 35,
      gapXmm: 6, gapYmm: 6,
      marginTopMm: 6, marginLeftMm: 6,
      pageMarginMm: 6
    }
  };

  let etiquetaMM = 10;              // para etiqueta individual (10/13/15)
  let allInstrumentos = [];
  const selectedCodigos = new Set();

  const codigoInput = document.getElementById("codigo");
  const qrResult = document.getElementById("qrResult");

  const badgeOnline = document.getElementById("badgeOnline");
  const badgeOnlineTxt = document.getElementById("badgeOnlineTxt");

  const badgeEstado = document.getElementById("badgeEstado");
  const listaInstrumentos = document.getElementById("listaInstrumentos");
  const buscadorInput = document.getElementById("buscador");

  const lblTamano = document.getElementById("lblTamano");
  const lblTpl = document.getElementById("lblTpl");
  const lblSeleccionados = document.getElementById("lblSeleccionados");
  const lblCapacidad = document.getElementById("lblCapacidad");
  const previewGrid = document.getElementById("previewGrid");

  const sizeButtons = document.querySelectorAll(".size-btn");
  const tplSelect = document.getElementById("tplEtiqueta");

  const sheetPreset = document.getElementById("sheetPreset");
  const printArea = document.getElementById("printArea");

  function getSheet(){
    return SHEETS[sheetPreset.value] || SHEETS.sticker_70x36;
  }
  function getCapacity(){
    const s = getSheet();
    return s.cols * s.rows;
  }

  function plantillaNombre(v){
    if (v==="minimal") return "MINIMAL";
    if (v==="lab") return "LAB PRO";
    if (v==="full") return "FULL";
    return "LAB PRO";
  }

  function esc(text){
    return String(text ?? "").replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[m]));
  }

  function normalize(s){
    return (s ?? "")
      .toString()
      .toLowerCase()
      .normalize("NFD")
      .replace(/[\u0300-\u036f]/g, "");
  }

  function actualizarPreview(){
    lblTamano.textContent = etiquetaMM + " mm";
    lblTpl.textContent = plantillaNombre(tplSelect.value);
    lblSeleccionados.textContent = selectedCodigos.size;

    const cap = getCapacity();
    lblCapacidad.textContent = cap;

    // preview grid acorde a hoja
    const s = getSheet();
    previewGrid.style.gridTemplateColumns = `repeat(${s.cols}, 1fr)`;

    previewGrid.innerHTML = "";
    for(let i=0;i<cap;i++){
      const div=document.createElement("div");
      div.className="preview-cell";
      if(i<selectedCodigos.size){
        div.classList.add("filled");
        div.textContent=i+1;
      }
      previewGrid.appendChild(div);
    }
  }

  function renderEtiquetaPreview(codigo, url, mm, tpl){
    const showHeader = (tpl !== "minimal");
    qrResult.innerHTML =
      "<div class='label-preview'>" +
        "<div class='hole'></div>" +
        (showHeader ? "<div class='tmp'>TMP</div>" : "") +
        "<div class='qr-box'></div>" +
        "<div class='code'>" + esc(codigo) + "</div>" +
      "</div>" +
      "<div class='hint'>URL: " + esc(url) + "</div>";

    const qrBox = qrResult.querySelector(".qr-box");
    qrBox.innerHTML = "";
    new QRCode(qrBox, {
      text: url,
      width: mm * 8,
      height: mm * 8
    });
  }

  function generar(){
    const codigo = codigoInput.value.trim();
    if(!codigo){ alert("Introduce el c√≥digo"); return; }
    const url = BASE_URL + encodeURIComponent(codigo);
    renderEtiquetaPreview(codigo, url, etiquetaMM, tplSelect.value);
  }

  // Tama√±os
  sizeButtons.forEach(btn=>{
    btn.addEventListener("click",()=>{
      sizeButtons.forEach(b=>b.classList.remove("active"));
      btn.classList.add("active");
      etiquetaMM = parseInt(btn.dataset.mm,10);
      actualizarPreview();
      if(codigoInput.value.trim()) generar();
    });
  });

  // Plantilla
  tplSelect.addEventListener("change",()=>{
    actualizarPreview();
    if(codigoInput.value.trim()) generar();
  });

  document.getElementById("btnGenerar").addEventListener("click", generar);
  codigoInput.addEventListener("keydown", e=>{
    if(e.key==="Enter"){ e.preventDefault(); generar(); }
  });

  // Supabase wait
  async function waitForSupabase(ms=3500){
    const start = Date.now();
    while(Date.now() - start < ms){
      if(window.supabase) return window.supabase;
      await new Promise(r => setTimeout(r, 50));
    }
    return null;
  }

  async function checkSupabase(){
    const sb = await waitForSupabase();
    if(sb){
      badgeOnline.classList.remove("offline");
      badgeOnlineTxt.textContent="Online (Supabase conectado)";
      return sb;
    } else {
      badgeOnline.classList.add("offline");
      badgeOnlineTxt.textContent="Offline (Supabase no disponible)";
      return null;
    }
  }

  // Carga instrumentos
  async function cargarInstrumentos(){
    const sb = await checkSupabase();
    if(!sb){
      badgeEstado.textContent = "‚ùå No hay conexi√≥n con Supabase";
      listaInstrumentos.innerHTML = "";
      return;
    }

    badgeEstado.textContent = "Cargando instrumentos desde Supabase‚Ä¶";

    const { data, error } = await sb
      .from("instrumentos")
      .select("codigo, descripcion, rango")
      .order("codigo", { ascending: true })
      .limit(5000);

    if(error){
      console.error(error);
      badgeEstado.textContent = "‚ùå Error cargando instrumentos: " + (error.message || "desconocido");
      listaInstrumentos.innerHTML = "";
      return;
    }

    allInstrumentos = (data || []).map(x => ({
      codigo: x.codigo,
      descripcion: x.descripcion || "",
      rango: x.rango || ""
    }));

    badgeEstado.textContent = "‚úÖ Instrumentos cargados: " + allInstrumentos.length;
    renderLista();
  }

  function renderLista(){
    const q = normalize(buscadorInput.value.trim());
    const filtered = !q ? allInstrumentos : allInstrumentos.filter(it => {
      const hay = normalize(it.codigo) + " " + normalize(it.descripcion) + " " + normalize(it.rango);
      return hay.includes(q);
    });

    if(!filtered.length){
      listaInstrumentos.innerHTML = "<div style='padding:12px;color:var(--muted);font-size:12px;'>No hay resultados</div>";
      return;
    }

    const view = filtered.slice(0, 500);

    let html = "";
    for(const it of view){
      const checked = selectedCodigos.has(it.codigo);
      html +=
        "<div class='inst-row " + (checked ? "selected" : "") + "' data-codigo='" + esc(it.codigo) + "'>" +
          "<input type='checkbox' " + (checked ? "checked" : "") + " />" +
          "<div>" +
            "<div class='inst-code'>" + esc(it.codigo) + "</div>" +
            "<div class='inst-desc'>" + esc(it.descripcion || "-") + "</div>" +
            "<div class='inst-desc' style='margin-top:4px;'>Rango: <b>" + esc(it.rango || "-") + "</b></div>" +
          "</div>" +
        "</div>";
    }
    listaInstrumentos.innerHTML = html;

    listaInstrumentos.querySelectorAll(".inst-row").forEach(row => {
      row.addEventListener("click", (e) => {
        const codigo = row.getAttribute("data-codigo");
        toggleSeleccion(codigo);
        renderLista();
        e.preventDefault();
      });
    });

    listaInstrumentos.querySelectorAll(".inst-row input[type='checkbox']").forEach(cb => {
      cb.addEventListener("click", (e) => {
        e.stopPropagation();
        const row = cb.closest(".inst-row");
        const codigo = row.getAttribute("data-codigo");
        toggleSeleccion(codigo);
        renderLista();
      });
    });
  }

  function toggleSeleccion(codigo){
    const cap = getCapacity();
    if(selectedCodigos.has(codigo)){
      selectedCodigos.delete(codigo);
    } else {
      if(selectedCodigos.size >= cap){
        alert("M√°ximo " + cap + " etiquetas para este formato de hoja.");
        return;
      }
      selectedCodigos.add(codigo);
    }
    actualizarPreview();
  }

  function limpiarSeleccion(){
    selectedCodigos.clear();
    actualizarPreview();
    renderLista();
  }

  // ==========================
  // IMPRESI√ìN SIN POPUPS (A4)
  // ==========================
  function mmToPx(v){ return Math.round(v * 96 / 25.4); }

  function buildPrintCSS(sheet, tpl){
    const showHeader = (tpl !== "minimal");

    // Ajustes de dise√±o dentro de la etiqueta (mm)
    const padX = 2.0;
    const padY = 2.0;
    const holeMm = 3.2;
    const headerMm = showHeader ? 3.2 : 0;  // altura zona TMP
    const codeMm = 4.5;                     // altura zona c√≥digo

    return (
      "<style>" +
        "@page{size:A4;margin:"+sheet.pageMarginMm+"mm;}" +
        "html,body{margin:0;padding:0;}" +
        "body{font-family:Arial,sans-serif;}" +

        /* Contenedor con offset (por si tu hoja tiene margen f√≠sico) */
        ".sheet{padding-top:"+sheet.marginTopMm+"mm;padding-left:"+sheet.marginLeftMm+"mm;}" +

        /* Grid exacta para la hoja de pegatina */
        ".grid{display:grid;" +
          "grid-template-columns:repeat("+sheet.cols+","+sheet.labelWmm+"mm);" +
          "grid-auto-rows:"+sheet.labelHmm+"mm;" +
          "column-gap:"+sheet.gapXmm+"mm;row-gap:"+sheet.gapYmm+"mm;" +
          "align-content:start;}" +

        /* Etiqueta */
        ".label{width:"+sheet.labelWmm+"mm;height:"+sheet.labelHmm+"mm;" +
          "position:relative;display:flex;flex-direction:column;align-items:center;justify-content:flex-start;" +
          "padding:"+padY+"mm "+padX+"mm;overflow:hidden;}" +

        /* Agujero (solo gu√≠a visual; si no lo quieres, puedes ocultarlo aqu√≠) */
        ".hole{position:absolute;top:2mm;left:2mm;width:"+holeMm+"mm;height:"+holeMm+"mm;border:0.25mm solid #000;border-radius:50%;}" +

        ".tmp{margin-top:0mm;font-size:3mm;font-weight:700;letter-spacing:0.8mm;line-height:1;}" +
        ".qr{margin-top:"+ (showHeader ? 1.2 : 0) +"mm;display:flex;align-items:center;justify-content:center;}" +
        ".code{margin-top:1mm;font-size:3.2mm;font-weight:700;border:0.25mm solid #000;border-radius:10mm;padding:0.5mm 2mm;line-height:1;white-space:nowrap;}" +

      "</style>"
    );
  }

  function makePrintLabelHTML(codigo, tpl){
    const showHeader = (tpl !== "minimal");
    const safe = codigo.replace(/[^a-zA-Z0-9]/g,"_");
    return (
      "<div class='label'>" +
        "<div class='hole'></div>" +
        (showHeader ? "<div class='tmp'>TMP</div>" : "") +
        "<div class='qr' id='pqr_" + safe + "'></div>" +
        "<div class='code'>" + esc(codigo) + "</div>" +
      "</div>"
    );
  }

  function openPrintSamePage(codigos){
    if(!codigos || !codigos.length){
      alert("No hay instrumentos para imprimir.");
      return;
    }
    if(!window.QRCode){
      alert("No est√° cargada la librer√≠a QRCode (qrcodejs).");
      return;
    }

    const tpl = tplSelect.value;
    const sheet = getSheet();

    // Monta HTML imprimible
    let html = buildPrintCSS(sheet, tpl);
    html += "<div class='sheet'><div class='grid' id='pgrid'>";
    for(const c of codigos){
      html += makePrintLabelHTML(c, tpl);
    }
    html += "</div></div>";
    printArea.innerHTML = html;

    // Tama√±o del QR: para 70√ó36 conviene grande pero dejando c√≥digo
    // Aproximaci√≥n buena:
    // - lado QR = min(labelH - zona texto, labelW) * 0.70
    const showHeader = (tpl !== "minimal");
    const headerMm = showHeader ? 3.2 : 0;
    const codeMm = 4.5;
    const usableH = Math.max(10, sheet.labelHmm - headerMm - codeMm - 6); // deja aire
    const usableW = Math.max(10, sheet.labelWmm - 8);
    const qrSideMm = Math.max(10, Math.min(usableW, usableH) * 0.95); // casi todo el alto √∫til
    const qrSidePx = mmToPx(qrSideMm);

    for(const c of codigos){
      const safe = c.replace(/[^a-zA-Z0-9]/g,"_");
      const el = document.getElementById("pqr_" + safe);
      const url = BASE_URL + encodeURIComponent(c);
      el.innerHTML = "";
      new QRCode(el, { text: url, width: qrSidePx, height: qrSidePx });
    }

    // Espera render canvas
    setTimeout(() => {
      window.print();
      setTimeout(() => { printArea.innerHTML = ""; }, 500);
    }, 700);
  }

  function imprimirEtiquetaIndividual(){
    const codigo = codigoInput.value.trim();
    if(!codigo){ alert("Introduce el c√≥digo"); return; }
    openPrintSamePage([codigo]);
  }

  function imprimirHojaA4(){
    openPrintSamePage(Array.from(selectedCodigos));
  }

  // Eventos
  buscadorInput.addEventListener("input", () => renderLista());
  document.getElementById("btnRefrescarLista").addEventListener("click", cargarInstrumentos);
  document.getElementById("btnLimpiarSeleccion").addEventListener("click", limpiarSeleccion);
  document.getElementById("btnImprimirHoja").addEventListener("click", imprimirHojaA4);
  document.getElementById("btnImprimirUno").addEventListener("click", imprimirEtiquetaIndividual);

  sheetPreset.addEventListener("change", () => {
    // Si cambia la hoja y hay m√°s seleccionados de los permitidos, recorta
    const cap = getCapacity();
    if(selectedCodigos.size > cap){
      const keep = Array.from(selectedCodigos).slice(0, cap);
      selectedCodigos.clear();
      keep.forEach(x => selectedCodigos.add(x));
    }
    actualizarPreview();
    renderLista();
  });

  // Init
  window.addEventListener("load", async () => {
    actualizarPreview();
    await cargarInstrumentos();
  });
</script>

</body>
</html>

