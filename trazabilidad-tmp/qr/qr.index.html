<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TMP 路 Generador de C贸digos QR</title>

<!-- Librer铆a QR -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<style>
  body{
    margin:0;
    font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
    background:#0d1117;
    color:#f0f6fc;
  }
  header{
    display:flex;
    align-items:center;
    gap:14px;
    padding:14px 16px;
    background:#161b22;
    border-bottom:1px solid #30363d;
  }
  header img.logo{height:40px}
  header h1{margin:0;font-size:18px}
  header span.sub{font-size:12px;color:#8b949e}

  .wrap{
    max-width:520px;
    margin:22px auto;
    padding:0 16px 32px;
  }

  .card{
    background:#161b22;
    border-radius:16px;
    border:1px solid #30363d;
    padding:20px 16px;
  }

  h2{margin:0 0 10px;font-size:16px}
  label{display:block;font-size:13px;color:#8b949e;margin-bottom:4px}

  input{
    width:100%;
    padding:10px 12px;
    border-radius:10px;
    border:1px solid #30363d;
    background:#0d1117;
    color:#f0f6fc;
    font-size:14px;
    outline:none;
  }

  input:focus{border-color:#58a6ff;}

  .row{
    display:flex;
    flex-wrap:wrap;
    gap:10px;
    margin-top:12px
  }

  button{
    border:none;
    border-radius:999px;
    padding:9px 16px;
    font-size:14px;
    cursor:pointer;
    font-weight:600;
  }

  .btn-main{background:#238636;color:#fff;}
  .btn-main:hover{background:#2ea043;}

  .btn-ghost{
    background:transparent;
    color:#58a6ff;
    border:1px solid #30363d;
  }
  .btn-ghost:hover{border-color:#58a6ff;}

  .sizes{
    display:flex;
    gap:8px;
    flex-wrap:wrap;
    margin-top:8px
  }

  .sizes button{
    font-size:12px;
    padding:7px 12px
  }

  #qrResult{
    margin-top:20px;
    display:flex;
    flex-direction:column;
    align-items:center;
  }

  #qrResult canvas{
    background:#ffffff;
    padding:10px;
    border-radius:12px;
  }

  .hint{
    font-size:12px;
    color:#8b949e;
    margin-top:8px
  }

  #volverHome{
    position:fixed;
    bottom:18px;
    right:18px;
    background:#238636;
    padding:12px 18px;
    font-size:14px;
    border-radius:12px;
    border:1px solid #2ea043;
    cursor:pointer;
    color:white;
    box-shadow:0 0 10px rgba(0,0,0,.4);
  }
  #volverHome:hover{
    background:#2ea043;
  }

  /* Buscador de instrumentos */
  .search-box{
    margin-top:18px;
    padding-top:14px;
    border-top:1px solid #30363d;
  }

  .search-row{
    display:flex;
    flex-wrap:wrap;
    gap:8px;
    margin-top:6px;
  }

  .search-row input{
    flex:1;
    min-width:0;
  }

  .results{
    margin-top:10px;
    max-height:220px;
    overflow:auto;
    border-radius:10px;
    border:1px solid #30363d;
  }

  .result-item{
    padding:7px 10px;
    border-bottom:1px solid #21262d;
    cursor:pointer;
    display:flex;
    flex-direction:column;
    gap:2px;
  }
  .result-item:last-child{
    border-bottom:none;
  }
  .result-item:hover{
    background:#0d1117;
  }
  .res-code{
    font-size:13px;
    font-weight:600;
    color:#f0f6fc;
  }
  .res-desc{
    font-size:12px;
    color:#8b949e;
  }

  .msg{
    font-size:12px;
    margin-top:6px;
    color:#8b949e;
  }
  .msg.error{color:#f85149;}
  .msg.ok{color:#3fb950;}
</style>
</head>


<body>

<button id="volverHome" onclick="window.location.href='../home.html'"> Volver</button>

<header>
  <img src="../img/tmp-quality.png" alt="TMP" class="logo">
  <div>
    <h1>Generador de c贸digos QR</h1>
    <span class="sub">Trazabilidad de instrumentos 路 TMP</span>
  </div>
</header>

<div class="wrap">
  <div class="card">
    <h2>Instrumento</h2>

    <label for="codigo">C贸digo del instrumento</label>
    <input id="codigo" type="text" placeholder="Ejemplo: 11217">

    <div class="row">
      <button class="btn-main" onclick="generarQR()">Generar QR</button>
    </div>

    <div class="sizes">
      <button class="btn-ghost" onclick="setSize(10)">Etiqueta 10 mm</button>
      <button class="btn-ghost" onclick="setSize(13)">Etiqueta 13 mm</button>
      <button class="btn-ghost" onclick="setSize(15)">Etiqueta 15 mm</button>
    </div>

    <div id="qrResult"></div>

    <p class="hint">
      El QR generado apunta a la ficha del instrumento en el sistema TMP.
    </p>

    <!-- BUSCADOR DE INSTRUMENTOS (SUPABASE) -->
    <div class="search-box">
      <label for="busqueda">Buscar instrumento (c贸digo, descripci贸n o fabricante)</label>
      <div class="search-row">
        <input id="busqueda" type="text" placeholder="Ej: 11217, pie de rey, Mitutoyo...">
        <button class="btn-ghost" onclick="buscarInstrumentos()">Buscar</button>
      </div>
      <div id="msgBusqueda" class="msg"></div>
      <div id="resultados" class="results" style="display:none;"></div>
    </div>

  </div>
</div>

<!-- CONFIG SUPABASE GLOBAL -->
<script type="module" src="../config.mjs"></script>

<!-- SCRIPT QR + BUSCADOR -->
<script>
let qrSize = 200;

// URL a la ficha QR
const BASE_URL = "https://trazabilidad-tmp.vercel.app/qr/qr.info_instrumentos.html?codigo=";

// Cliente Supabase expuesto por config.mjs
const supabase = window.supabase;

/* =============================
   VALIDAR QUE EL CDIGO EXISTE
============================= */
async function validarCodigoExiste(codigo){
  if (!supabase){
    alert("No hay conexi贸n con Supabase.");
    return false;
  }
  try{
    const { data, error } = await supabase
      .from("instrumentos")
      .select("codigo")
      .eq("codigo", codigo)
      .maybeSingle();

    if (error){
      console.error(error);
      alert("Error comprobando el c贸digo en Supabase.");
      return false;
    }
    if (!data){
      alert("No existe ning煤n instrumento con ese c贸digo en la base de datos.");
      return false;
    }
    return true;
  }catch(e){
    console.error(e);
    alert("Error inesperado validando el c贸digo.");
    return false;
  }
}

/* =============================
   FUNCIN PARA IMPRIMIR ETIQUETA
   (SOLO QR, SIN NMERO)
============================= */
function imprimirEtiqueta(url, sizePx){
  const win = window.open("", "_blank", "width=400,height=400");

  win.document.write(`
    <html>
    <head>
    <style>
      body{
        margin:0;
        display:flex;
        align-items:center;
        justify-content:center;
        background:white;
        font-family:sans-serif;
      }
      img{width:${sizePx}px;height:${sizePx}px;}
    </style>
    </head>

    <body>
      <img src="https://api.qrserver.com/v1/create-qr-code/?size=${sizePx}x${sizePx}&data=${encodeURIComponent(url)}">

      <script>
        window.onload = function(){
          setTimeout(()=>{ window.print(); }, 300);
        }
      <\/script>
    </body>
    </html>
  `);

  win.document.close();
}

/* =============================
   CAMBIO DE TAMAO + IMPRESIN
   (10, 13, 15 mm)
============================= */
async function setSize(mm){
  const codigo = document.getElementById("codigo").value.trim();
  if (!codigo){
    alert("Introduce primero el c贸digo del instrumento.");
    return;
  }

  // Validar que el c贸digo existe en Supabase
  const ok = await validarCodigoExiste(codigo);
  if (!ok) return;

  // Aproximaci贸n: 1 mm ~ 8 px
  const sizePx = mm * 8;
  qrSize = sizePx;

  const url = BASE_URL + encodeURIComponent(codigo);

  // Muestra QR en pantalla
  await generarQR(true);   // true: ya est谩 validado

  // Imprime etiqueta
  imprimirEtiqueta(url, sizePx);
}

/* =============================
   GENERAR QR EN LA WEB
============================= */
async function generarQR(yaValidado){
  const codigo = document.getElementById("codigo").value.trim();
  if (!codigo){
    alert("Introduce el c贸digo del instrumento.");
    return;
  }

  // Si no viene validado desde setSize, comprobamos aqu铆
  if (!yaValidado){
    const ok = await validarCodigoExiste(codigo);
    if (!ok) return;
  }

  const url = BASE_URL + encodeURIComponent(codigo);

  const cont = document.getElementById("qrResult");
  cont.innerHTML = "";

  const qrDiv = document.createElement("div");
  cont.appendChild(qrDiv);

  new QRCode(qrDiv, {
    text: url,
    width: qrSize,
    height: qrSize
  });

  const p = document.createElement("p");
  p.className = "hint";
  p.textContent = "URL codificada: " + url;
  cont.appendChild(p);
}

/* =============================
   BUSCADOR DE INSTRUMENTOS
============================= */
async function buscarInstrumentos(){
  const term = document.getElementById("busqueda").value.trim();
  const msg = document.getElementById("msgBusqueda");
  const cont = document.getElementById("resultados");

  msg.textContent = "";
  msg.className = "msg";
  cont.style.display = "none";
  cont.innerHTML = "";

  if (!term){
    msg.textContent = "Introduce un t茅rmino de b煤squeda.";
    msg.classList.add("error");
    return;
  }

  if (!supabase){
    msg.textContent = "Supabase no est谩 disponible.";
    msg.classList.add("error");
    return;
  }

  try{
    const { data, error } = await supabase
      .from("instrumentos")
      .select("codigo, descripcion, fabricante")
      .or(
        `codigo.ilike.%${term}%,descripcion.ilike.%${term}%,fabricante.ilike.%${term}%`
      )
      .limit(30);

    if (error){
      console.error(error);
      msg.textContent = "Error al buscar instrumentos.";
      msg.classList.add("error");
      return;
    }

    if (!data || data.length === 0){
      msg.textContent = "No se han encontrado instrumentos que coincidan.";
      msg.classList.add("error");
      return;
    }

    cont.style.display = "block";
    cont.innerHTML = data.map(inst => `
      <div class="result-item" onclick="seleccionarInstrumento('${String(inst.codigo).replace(/'/g,"\\'")}')">
        <div class="res-code">${inst.codigo || ""}</div>
        <div class="res-desc">
          ${(inst.descripcion || "").slice(0,70)}${(inst.descripcion && inst.descripcion.length>70)?"...":""}
          ${inst.fabricante ? " 路 " + inst.fabricante : ""}
        </div>
      </div>
    `).join("");

    msg.textContent = `Encontrados ${data.length} instrumentos. Pulsa sobre uno para usar su c贸digo.`;
    msg.classList.add("ok");

  }catch(e){
    console.error(e);
    msg.textContent = "Error inesperado al buscar.";
    msg.classList.add("error");
  }
}

function seleccionarInstrumento(codigo){
  document.getElementById("codigo").value = codigo;
  document.getElementById("msgBusqueda").textContent =
    "C贸digo seleccionado: " + codigo + ". Ahora puedes generar el QR o elegir tama帽o de etiqueta.";
  document.getElementById("msgBusqueda").className = "msg ok";
}
</script>

</body>
</html>
