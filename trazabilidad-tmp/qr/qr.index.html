<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TMP ¬∑ Generador de C√≥digos QR</title>

  <!-- Librer√≠a QR -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <style>
    :root{
      --bg:#0d1117;
      --panel:#161b22;
      --border:#30363d;
      --txt:#f0f6fc;
      --muted:#8b949e;
      --accent:#58a6ff;
      --ok:#238636;
    }

    *{box-sizing:border-box;}

    body{
      margin:0;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:var(--bg);
      color:var(--txt);
    }

    header{
      display:flex;
      align-items:center;
      gap:14px;
      padding:14px 16px;
      background:var(--panel);
      border-bottom:1px solid var(--border);
    }
    header img.logo{height:40px}
    header h1{margin:0;font-size:18px}
    header span.sub{font-size:12px;color:var(--muted)}

    .wrap{
      max-width:980px;
      margin:22px auto;
      padding:0 16px 32px;
      display:grid;
      grid-template-columns: minmax(0,420px) minmax(0,1fr);
      gap:18px;
    }

    @media (max-width:900px){
      .wrap{
        grid-template-columns:1fr;
      }
    }

    .card{
      background:var(--panel);
      border-radius:16px;
      border:1px solid var(--border);
      padding:18px 16px 16px;
    }

    h2{margin:0 0 8px;font-size:16px}
    label{display:block;font-size:13px;color:var(--muted);margin-bottom:4px}

    input{
      width:100%;
      padding:9px 11px;
      border-radius:10px;
      border:1px solid var(--border);
      background:#0d1117;
      color:var(--txt);
      font-size:14px;
      outline:none;
    }

    input:focus{border-color:var(--accent);}

    .row{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin-top:8px;
      align-items:center;
    }

    button{
      border:none;
      border-radius:999px;
      padding:9px 16px;
      font-size:13px;
      cursor:pointer;
      font-weight:600;
      display:inline-flex;
      align-items:center;
      gap:6px;
    }

    .btn-main{
      background:var(--ok);
      color:#fff;
    }
    .btn-main:hover{background:#2ea043;}

    .btn-ghost{
      background:transparent;
      color:var(--accent);
      border:1px solid var(--border);
    }
    .btn-ghost:hover{border-color:var(--accent);}

    .sizes{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-top:10px
    }

    .sizes button{
      font-size:12px;
      padding:7px 12px
    }

    .sizes button.active{
      background:var(--accent);
      color:#0d1117;
      border-color:var(--accent);
    }

    #qrResult{
      margin-top:20px;
      display:flex;
      flex-direction:column;
      align-items:center;
      min-height:120px;
    }

    #qrResult canvas{
      background:#ffffff;
      padding:10px;
      border-radius:12px;
    }

    .hint{
      font-size:12px;
      color:var(--muted);
      margin-top:8px
    }

    /* Lateral derecho: selector de instrumentos */
    .badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      font-size:11px;
      padding:4px 9px;
      border-radius:999px;
      border:1px solid var(--border);
      background:#0d1117;
      color:var(--muted);
    }

    .search-box{
      margin-top:4px;
    }

    .search-box input{
      font-size:13px;
    }

    .list-instrumentos{
      margin-top:10px;
      max-height:260px;
      border-radius:12px;
      border:1px solid var(--border);
      overflow:auto;
      background:#0d1117;
    }

    .inst-row{
      display:flex;
      align-items:flex-start;
      gap:8px;
      padding:6px 8px;
      border-bottom:1px solid #21262d;
      font-size:13px;
      cursor:pointer;
    }

    .inst-row:last-child{border-bottom:none;}

    .inst-row:hover{
      background:#111827;
    }

    .inst-row input[type="checkbox"]{
      margin-top:2px;
    }

    .inst-code{
      font-weight:600;
      margin-right:4px;
    }

    .inst-desc{
      color:var(--muted);
      font-size:12px;
    }

    .panel-footer{
      margin-top:10px;
      font-size:12px;
      color:var(--muted);
      display:flex;
      flex-direction:column;
      gap:4px;
    }

    .panel-footer strong{
      color:#e5e7eb;
    }

    .btn-row{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:10px;
    }

    /* Bot√≥n volver */
    #volverHome{
      position:fixed;
      bottom:18px;
      right:18px;
      background:#238636;
      padding:12px 18px;
      font-size:14px;
      border-radius:12px;
      border:1px solid #2ea043;
      cursor:pointer;
      color:white;
      box-shadow:0 0 10px rgba(0,0,0,.4);
      z-index:50;
    }
    #volverHome:hover{
      background:#2ea043;
    }

    /* Vista previa de hoja A4 (s√≥lo esquema, no escala real exacta) */
    .preview-sheet{
      margin-top:10px;
      border-radius:12px;
      border:1px solid var(--border);
      background:#0d1117;
      padding:10px;
    }

    .preview-grid{
      display:grid;
      gap:3px;
      justify-content:flex-start;
      align-content:flex-start;
      max-height:260px;
      overflow:auto;
      background:#02040a;
      padding:6px;
    }

    .preview-cell{
      width:16px;
      height:16px;
      border-radius:3px;
      background:#1f2937;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:9px;
      color:#9ca3af;
    }

    .preview-cell.filled{
      background:#22c55e;
      color:#022c22;
      font-weight:700;
    }
  </style>
</head>

<body>

<button id="volverHome" onclick="window.location.href='../home.html'">üè† Volver</button>

<header>
  <img src="../img/tmp-quality.png" alt="TMP" class="logo">
  <div>
    <h1>Generador de c√≥digos QR</h1>
    <span class="sub">Trazabilidad de instrumentos ¬∑ TMP</span>
  </div>
</header>

<div class="wrap">

  <!-- PANEL IZQUIERDO: UN INSTRUMENTO / PRUEBA R√ÅPIDA -->
  <div class="card">
    <h2>Generar QR individual</h2>

    <label for="codigo">C√≥digo del instrumento</label>
    <input id="codigo" type="text" placeholder="Ejemplo: 11217">

    <div class="row">
      <button class="btn-main" id="btnGenerar">Generar QR</button>
    </div>

    <div class="sizes">
      <button class="btn-ghost size-btn active" data-mm="10">Etiqueta 10 mm</button>
      <button class="btn-ghost size-btn" data-mm="13">Etiqueta 13 mm</button>
      <button class="btn-ghost size-btn" data-mm="15">Etiqueta 15 mm</button>
    </div>

    <div id="qrResult"></div>

    <p class="hint">
      El QR generado apunta a la ficha del instrumento (qr.info_instrumentos) en el sistema TMP.
      La etiqueta <b>s√≥lo contiene el c√≥digo QR</b>, sin texto visible.
    </p>
  </div>

  <!-- PANEL DERECHO: SELECCI√ìN M√öLTIPLE + HOJA A4 -->
  <div class="card">
    <h2>Imprimir hoja A4 de etiquetas</h2>
    <div class="badge" id="badgeEstado">Cargando instrumentos desde Supabase‚Ä¶</div>

    <div class="search-box">
      <label for="buscador">Buscar instrumentos (c√≥digo o descripci√≥n)</label>
      <input id="buscador" type="text" placeholder="Ej: 112, micr√≥metro, tamp√≥n‚Ä¶">
    </div>

    <div class="list-instrumentos" id="listaInstrumentos">
      <!-- Aqu√≠ se cargan los instrumentos desde Supabase -->
    </div>

    <div class="panel-footer" id="infoCapacidad">
      <span><strong>Tama√±o actual:</strong> <span id="lblTamano">10 mm</span></span>
      <span><strong>Capacidad estimada hoja A4:</strong> <span id="lblCapacidad">‚Äì</span> etiquetas</span>
      <span><strong>Seleccionados:</strong> <span id="lblSeleccionados">0</span></span>
      <span class="hint">
        Consejos: selecciona s√≥lo los equipos que vayas a etiquetar ahora. Si escoges menos de la capacidad,
        el resto de la hoja quedar√° en blanco.
      </span>
    </div>

    <div class="btn-row">
      <button class="btn-main" id="btnImprimirHoja">Imprimir hoja A4</button>
      <button class="btn-ghost" id="btnLimpiarSeleccion">Limpiar selecci√≥n</button>
      <button class="btn-ghost" id="btnRefrescarLista">Recargar lista desde Supabase</button>
    </div>

    <div class="preview-sheet">
      <div class="hint">Esquema aproximado de ocupaci√≥n de la hoja (no escala real):</div>
      <div id="previewGrid" class="preview-grid"></div>
    </div>
  </div>

</div>

<!-- Cargar Supabase config (expone window.supabase) -->
<script type="module" src="../config.mjs"></script>

<!-- L√ìGICA PRINCIPAL -->
<script>
  // ==========================
  // CONFIGURACI√ìN GENERAL
  // ==========================
  const BASE_URL = "https://trazabilidad-tmp.vercel.app/qr/qr.info_instrumentos.html?codigo=";

  const PAGE_WIDTH_MM  = 210;
  const PAGE_HEIGHT_MM = 297;
  const PAGE_MARGIN_MM = 5;   // asumimos 5 mm en todos los lados
  const GAP_MM         = 2;   // separaci√≥n entre etiquetas en mm

  let etiquetaMM = 10;        // tama√±o por defecto
  let allInstrumentos = [];
  const selectedCodigos = new Set();

  const qrResult   = document.getElementById("qrResult");
  const codigoInput = document.getElementById("codigo");
  const sizeButtons = document.querySelectorAll(".size-btn");

  const badgeEstado = document.getElementById("badgeEstado");
  const listaInstrumentos = document.getElementById("listaInstrumentos");
  const buscadorInput = document.getElementById("buscador");

  const lblTamano = document.getElementById("lblTamano");
  const lblCapacidad = document.getElementById("lblCapacidad");
  const lblSeleccionados = document.getElementById("lblSeleccionados");
  const previewGrid = document.getElementById("previewGrid");

  // ==========================
  // C√ÅLCULO DE CAPACIDAD A4
  // ==========================
  function computeLayout(labelMM){
    const usableW = PAGE_WIDTH_MM  - 2*PAGE_MARGIN_MM;
    const usableH = PAGE_HEIGHT_MM - 2*PAGE_MARGIN_MM;
    const cellW = labelMM + GAP_MM;
    const cellH = labelMM + GAP_MM;

    const cols = Math.max(1, Math.floor(usableW / cellW));
    const rows = Math.max(1, Math.floor(usableH / cellH));
    const perPage = cols * rows;
    return {cols, rows, perPage};
  }

  function actualizarCapacidad(){
    const {cols, rows, perPage} = computeLayout(etiquetaMM);
    lblTamano.textContent = etiquetaMM + " mm";
    lblCapacidad.textContent = perPage + ` ( ${cols} columnas x ${rows} filas )`;
    lblSeleccionados.textContent = selectedCodigos.size;

    // Previsualizaci√≥n simple (m√°ximo 16x10 celdas para que no se desmadre)
    const maxColsPreview = Math.min(cols, 16);
    const maxRowsPreview = Math.min(rows, 10);
    const totalPreviewCells = maxColsPreview * maxRowsPreview;

    previewGrid.style.gridTemplateColumns = `repeat(${maxColsPreview}, 1fr)`;
    previewGrid.innerHTML = "";

    const selArray = Array.from(selectedCodigos);
    const maxFilled = Math.min(selArray.length, totalPreviewCells);

    for(let i = 0; i < totalPreviewCells; i++){
      const cell = document.createElement("div");
      cell.className = "preview-cell";
      if (i < maxFilled){
        cell.classList.add("filled");
        cell.textContent = i+1;
      }
      previewGrid.appendChild(cell);
    }
  }

  // ==========================
  // GENERAR QR INDIVIDUAL (PANTALLA)
  // ==========================
  function generarQR(){
    const codigo = codigoInput.value.trim();
    if (!codigo){
      alert("Introduce el c√≥digo del instrumento.");
      return;
    }

    const url = BASE_URL + encodeURIComponent(codigo);

    qrResult.innerHTML = "";

    const qrDiv = document.createElement("div");
    qrResult.appendChild(qrDiv);

    new QRCode(qrDiv, {
      text: url,
      width: etiquetaMM * 8,   // aproximaci√≥n en px
      height: etiquetaMM * 8
    });

    const p = document.createElement("p");
    p.className = "hint";
    p.textContent = "URL codificada: " + url;
    qrResult.appendChild(p);
  }

  // ==========================
  // GESTI√ìN DE TAMA√ëO
  // ==========================
  sizeButtons.forEach(btn => {
    btn.addEventListener("click", () => {
      sizeButtons.forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
      etiquetaMM = parseInt(btn.getAttribute("data-mm"), 10) || 10;
      actualizarCapacidad();

      // si hay un c√≥digo ya puesto, regenerar QR de pantalla
      if (codigoInput.value.trim()){
        generarQR();
      }
    });
  });

  document.getElementById("btnGenerar").addEventListener("click", generarQR);
  codigoInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter"){
      e.preventDefault();
      generarQR();
    }
  });

  // ==========================
  // CARGAR INSTRUMENTOS DESDE SUPABASE
  // ==========================
  async function cargarInstrumentos(){
    const supabase = window.supabase;
    if (!supabase){
      badgeEstado.textContent = "Supabase no disponible. Revisa config.mjs.";
      return;
    }

    badgeEstado.textContent = "Cargando instrumentos desde Supabase‚Ä¶";

    try{
      const { data, error } = await supabase
        .from("instrumentos")
        .select("codigo, descripcion")
        .order("codigo", { ascending:true });

      if (error){
        console.error(error);
        badgeEstado.textContent = "Error al cargar instrumentos.";
        return;
      }

      allInstrumentos = data || [];
      badgeEstado.textContent = `Instrumentos cargados: ${allInstrumentos.length}`;
      renderInstrumentList();
    } catch(e){
      console.error(e);
      badgeEstado.textContent = "Error inesperado al cargar instrumentos.";
    }
  }

  function renderInstrumentList(filtroTexto=""){
    const term = filtroTexto.trim().toLowerCase();
    const filtrados = !term
      ? allInstrumentos
      : allInstrumentos.filter(inst => {
          const cod = (inst.codigo || "").toString().toLowerCase();
          const desc = (inst.descripcion || "").toLowerCase();
          return cod.includes(term) || desc.includes(term);
        });

    listaInstrumentos.innerHTML = "";

    if (!filtrados.length){
      listaInstrumentos.innerHTML = `<div style="padding:8px;font-size:13px;color:var(--muted);">No se han encontrado instrumentos con ese filtro.</div>`;
      return;
    }

    filtrados.forEach(inst => {
      const row = document.createElement("label");
      row.className = "inst-row";

      const check = document.createElement("input");
      check.type = "checkbox";
      check.dataset.codigo = inst.codigo;
      check.checked = selectedCodigos.has(inst.codigo);

      check.addEventListener("change", () => {
        if (check.checked) selectedCodigos.add(inst.codigo);
        else selectedCodigos.delete(inst.codigo);
        actualizarCapacidad();
      });

      const codeSpan = document.createElement("span");
      codeSpan.className = "inst-code";
      codeSpan.textContent = inst.codigo;

      const descSpan = document.createElement("span");
      descSpan.className = "inst-desc";
      descSpan.textContent = inst.descripcion || "";

      row.appendChild(check);
      row.appendChild(codeSpan);
      row.appendChild(descSpan);

      listaInstrumentos.appendChild(row);
    });

    actualizarCapacidad();
  }

  buscadorInput.addEventListener("input", () => {
    renderInstrumentList(buscadorInput.value);
  });

  document.getElementById("btnRefrescarLista").addEventListener("click", () => {
    cargarInstrumentos();
  });

  document.getElementById("btnLimpiarSeleccion").addEventListener("click", () => {
    selectedCodigos.clear();
    renderInstrumentList(buscadorInput.value);
  });

  // ==========================
  // IMPRESI√ìN DE HOJA A4
  // ==========================
  function imprimirHoja(){
    if (!selectedCodigos.size){
      alert("Selecciona al menos un instrumento para imprimir etiquetas.");
      return;
    }

    const {cols, rows, perPage} = computeLayout(etiquetaMM);
    const codigos = Array.from(selectedCodigos);
    const usableCount = Math.min(codigos.length, perPage);

    if (codigos.length > perPage){
      const extra = codigos.length - perPage;
      const ok = confirm(
        `Para el tama√±o ${etiquetaMM} mm caben ${perPage} etiquetas por hoja.\n\n` +
        `Has seleccionado ${codigos.length} instrumentos.\n` +
        `S√≥lo se imprimir√°n los primeros ${perPage}. (${extra} se quedar√°n fuera)\n\n` +
        `¬øQuieres continuar igualmente?`
      );
      if (!ok) return;
    }

    const codigosAPintar = codigos.slice(0, usableCount);

    // Construimos HTML de impresi√≥n
    let celdasHTML = "";
    codigosAPintar.forEach((codigo, idx) => {
      const url = BASE_URL + encodeURIComponent(codigo);
      celdasHTML += `
        <div class="label">
          <img src="https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(url)}" />
        </div>
      `;
    });

    // Croquis
    let croquisRows = "";
    codigosAPintar.forEach((codigo, idx) => {
      const fila = Math.floor(idx / cols) + 1;
      const col  = (idx % cols) + 1;
      croquisRows += `
        <tr>
          <td>${idx+1}</td>
          <td>Fila ${fila}</td>
          <td>Columna ${col}</td>
          <td>${codigo}</td>
        </tr>
      `;
    });

    const html = `
<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<title>Impresi√≥n etiquetas TMP</title>
<style>
  @page {
    size: A4;
    margin: ${PAGE_MARGIN_MM}mm;
  }
  body{
    margin:0;
    font-family:system-ui,-apple-system,"Segoe UI",sans-serif;
  }
  .sheet{
    display:grid;
    grid-template-columns: repeat(${cols}, ${etiquetaMM}mm);
    grid-auto-rows: ${etiquetaMM}mm;
    gap:${GAP_MM}mm;
    justify-content:center;
    align-content:flex-start;
    width:100%;
    box-sizing:border-box;
  }
  .label{
    display:flex;
    align-items:center;
    justify-content:center;
  }
  .label img{
    width:${etiquetaMM}mm;
    height:${etiquetaMM}mm;
  }
  .croquis{
    page-break-before:always;
    padding:10mm;
  }
  h3{
    margin:0 0 8px;
    font-size:16px;
  }
  p{
    margin:0 0 8px;
    font-size:12px;
  }
  table{
    border-collapse:collapse;
    width:100%;
    font-size:11px;
  }
  th,td{
    border:1px solid #ccc;
    padding:4px 6px;
    text-align:left;
  }
  th{
    background:#eee;
  }
</style>
</head>
<body>
  <div class="sheet">
    ${celdasHTML}
  </div>

  <div class="croquis">
    <h3>Esquema de colocaci√≥n de etiquetas</h3>
    <p>Lectura por defecto: filas de arriba a abajo, columnas de izquierda a derecha.</p>
    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>Fila</th>
          <th>Columna</th>
          <th>C√≥digo instrumento</th>
        </tr>
      </thead>
      <tbody>
        ${croquisRows}
      </tbody>
    </table>
  </div>

  <script>
    window.onload = function(){
      setTimeout(function(){ window.print(); }, 400);
    };
  <\/script>
</body>
</html>
    `;

    const win = window.open("", "_blank");
    win.document.write(html);
    win.document.close();
  }

  document.getElementById("btnImprimirHoja").addEventListener("click", imprimirHoja);

  // ==========================
  // INICIALIZACI√ìN
  // ==========================
  window.addEventListener("load", () => {
    actualizarCapacidad();
    // damos un peque√±o margen a que cargue config.mjs y luego intentamos
    setTimeout(cargarInstrumentos, 300);
  });
</script>

</body>
</html>
