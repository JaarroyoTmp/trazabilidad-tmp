<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TMP ¬∑ Generador de C√≥digos QR</title>

  <!-- Librer√≠a QR -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <style>
    :root{
      --bg:#0d1117;
      --panel:#161b22;
      --border:#30363d;
      --txt:#f0f6fc;
      --muted:#8b949e;
      --accent:#58a6ff;
      --ok:#238636;
    }

    *{box-sizing:border-box;}

    body{
      margin:0;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:var(--bg);
      color:var(--txt);
    }

    header{
      display:flex;
      align-items:center;
      gap:14px;
      padding:14px 16px;
      background:var(--panel);
      border-bottom:1px solid var(--border);
    }
    header img.logo{height:40px}
    header h1{margin:0;font-size:18px}
    header span.sub{font-size:12px;color:var(--muted)}

    .wrap{
      max-width:980px;
      margin:22px auto;
      padding:0 16px 32px;
      display:grid;
      grid-template-columns: minmax(0,420px) minmax(0,1fr);
      gap:18px;
    }

    @media (max-width:900px){
      .wrap{grid-template-columns:1fr;}
    }

    .card{
      background:var(--panel);
      border-radius:16px;
      border:1px solid var(--border);
      padding:18px 16px 16px;
    }

    h2{margin:0 0 8px;font-size:16px}
    label{display:block;font-size:13px;color:var(--muted);margin-bottom:4px}

    input{
      width:100%;
      padding:9px 11px;
      border-radius:10px;
      border:1px solid var(--border);
      background:#0d1117;
      color:var(--txt);
      font-size:14px;
      outline:none;
    }

    input:focus{border-color:var(--accent);}

    .row{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin-top:8px;
      align-items:center;
    }

    button{
      border:none;
      border-radius:999px;
      padding:9px 16px;
      font-size:13px;
      cursor:pointer;
      font-weight:600;
      display:inline-flex;
      align-items:center;
      gap:6px;
    }

    .btn-main{
      background:var(--ok);
      color:#fff;
    }
    .btn-main:hover{background:#2ea043;}

    .btn-ghost{
      background:transparent;
      color:var(--accent);
      border:1px solid var(--border);
    }
    .btn-ghost:hover{border-color:var(--accent);}

    .sizes{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-top:10px
    }

    .sizes button{
      font-size:12px;
      padding:7px 12px
    }

    .sizes button.active{
      background:var(--accent);
      color:#0d1117;
      border-color:var(--accent);
    }

    #qrResult{
      margin-top:20px;
      display:flex;
      flex-direction:column;
      align-items:center;
      min-height:120px;
    }

    #qrResult canvas{
      background:#ffffff;
      padding:10px;
      border-radius:12px;
    }

    .hint{
      font-size:12px;
      color:var(--muted);
      margin-top:8px
    }

    .badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      font-size:11px;
      padding:4px 9px;
      border-radius:999px;
      border:1px solid var(--border);
      background:#0d1117;
      color:var(--muted);
    }

    .search-box{margin-top:4px;}
    .search-box input{font-size:13px;}

    .list-instrumentos{
      margin-top:10px;
      max-height:260px;
      border-radius:12px;
      border:1px solid var(--border);
      overflow:auto;
      background:#0d1117;
    }

    .inst-row{
      display:flex;
      align-items:flex-start;
      gap:8px;
      padding:6px 8px;
      border-bottom:1px solid #21262d;
      font-size:13px;
      cursor:pointer;
    }
    .inst-row:last-child{border-bottom:none;}
    .inst-row:hover{background:#111827;}

    .inst-row input[type="checkbox"]{margin-top:2px;}
    .inst-code{font-weight:600;margin-right:4px;}
    .inst-desc{color:var(--muted);font-size:12px;}

    .panel-footer{
      margin-top:10px;
      font-size:12px;
      color:var(--muted);
      display:flex;
      flex-direction:column;
      gap:4px;
    }

    .panel-footer strong{color:#e5e7eb;}

    .btn-row{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:10px;
    }

    #volverHome{
      position:fixed;
      bottom:18px;
      right:18px;
      background:#238636;
      padding:12px 18px;
      font-size:14px;
      border-radius:12px;
      border:1px solid #2ea043;
      cursor:pointer;
      color:white;
      box-shadow:0 0 10px rgba(0,0,0,.4);
      z-index:50;
    }
    #volverHome:hover{background:#2ea043;}

    .preview-sheet{
      margin-top:10px;
      border-radius:12px;
      border:1px solid var(--border);
      background:#0d1117;
      padding:10px;
    }

    .preview-grid{
      display:grid;
      gap:3px;
      justify-content:flex-start;
      align-content:flex-start;
      max-height:260px;
      overflow:auto;
      background:#02040a;
      padding:6px;
    }

    .preview-cell{
      width:16px;
      height:16px;
      border-radius:3px;
      background:#1f2937;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:9px;
      color:#9ca3af;
    }

    .preview-cell.filled{
      background:#22c55e;
      color:#022c22;
      font-weight:700;
    }
  </style>
</head>

<body>

<button id="volverHome" onclick="window.location.href='../home.html'">üè† Volver</button>

<header>
  <img src="../img/tmp-quality.png" alt="TMP" class="logo">
  <div>
    <h1>Generador de c√≥digos QR</h1>
    <span class="sub">Trazabilidad de instrumentos ¬∑ TMP</span>
  </div>
</header>

<div class="wrap">

  <!-- PANEL IZQUIERDO -->
  <div class="card">
    <h2>Generar QR individual</h2>

    <label for="codigo">C√≥digo del instrumento</label>
    <input id="codigo" type="text" placeholder="Ejemplo: 11217">

    <div class="row">
      <button class="btn-main" id="btnGenerar">Generar QR</button>
    </div>

    <div class="sizes">
      <button class="btn-ghost size-btn active" data-mm="10">Etiqueta 10 mm</button>
      <button class="btn-ghost size-btn" data-mm="13">Etiqueta 13 mm</button>
      <button class="btn-ghost size-btn" data-mm="15">Etiqueta 15 mm</button>
    </div>

    <div id="qrResult"></div>

    <p class="hint">El QR generado apunta a la ficha del instrumento en el sistema TMP.</p>
  </div>

  <!-- PANEL DERECHO -->
  <div class="card">
    <h2>Imprimir hoja A4 de etiquetas</h2>
    <div class="badge" id="badgeEstado">Cargando instrumentos desde Supabase‚Ä¶</div>

    <div class="search-box">
      <label for="buscador">Buscar instrumentos</label>
      <input id="buscador" type="text" placeholder="Ej: 112, micr√≥metro‚Ä¶">
    </div>

    <div class="list-instrumentos" id="listaInstrumentos"></div>

    <div class="panel-footer">
      <span><strong>Tama√±o actual QR:</strong> <span id="lblTamano">10 mm</span></span>
      <span><strong>Capacidad fija hoja A4:</strong> 12 etiquetas</span>
      <span><strong>Seleccionados:</strong> <span id="lblSeleccionados">0</span></span>
    </div>

    <div class="btn-row">
      <button class="btn-main" id="btnImprimirHoja">Imprimir hoja A4</button>
      <button class="btn-ghost" id="btnLimpiarSeleccion">Limpiar selecci√≥n</button>
      <button class="btn-ghost" id="btnRefrescarLista">Recargar lista</button>
    </div>

    <div class="preview-sheet">
      <div class="hint">Esquema (3x4):</div>
      <div id="previewGrid" class="preview-grid"></div>
    </div>

  </div>
</div>
<!-- =========================
      CARGA SUPABASE
========================= -->
<script type="module" src="../config.mjs"></script>

<script>
// ==================================
// CONFIGURACI√ìN GENERAL
// ==================================
const BASE_URL = "https://trazabilidad-tmp.vercel.app/qr/qr.info_instrumentos.html?codigo=";

const PRINT_COLS = 3;
const PRINT_ROWS = 4;
const MAX_PER_PAGE = 12;

let etiquetaMM = 10;
let allInstrumentos = [];
const selectedCodigos = new Set();

const qrResult = document.getElementById("qrResult");
const codigoInput = document.getElementById("codigo");
const sizeButtons = document.querySelectorAll(".size-btn");

const badgeEstado = document.getElementById("badgeEstado");
const listaInstrumentos = document.getElementById("listaInstrumentos");
const buscadorInput = document.getElementById("buscador");

const lblTamano = document.getElementById("lblTamano");
const lblSeleccionados = document.getElementById("lblSeleccionados");
const previewGrid = document.getElementById("previewGrid");


// ==================================
// PREVIEW 3√ó4
// ==================================
function actualizarCapacidad(){
  lblTamano.textContent = etiquetaMM + " mm";
  lblSeleccionados.textContent = selectedCodigos.size;

  previewGrid.style.gridTemplateColumns = "repeat(3, 1fr)";
  previewGrid.innerHTML = "";

  for(let i = 0; i < MAX_PER_PAGE; i++){
    const div = document.createElement("div");
    div.className = "preview-cell";
    if (i < selectedCodigos.size) {
      div.classList.add("filled");
      div.textContent = i+1;
    }
    previewGrid.appendChild(div);
  }
}


// ==================================
// GENERAR QR INDIVIDUAL
// ==================================
function generarQR(){
  const codigo = codigoInput.value.trim();
  if (!codigo){
    alert("Introduce el c√≥digo del instrumento");
    return;
  }

  const url = BASE_URL + encodeURIComponent(codigo);

  qrResult.innerHTML = "";
  const qrDiv = document.createElement("div");
  qrResult.appendChild(qrDiv);

  new QRCode(qrDiv, {
    text: url,
    width: etiquetaMM * 8,
    height: etiquetaMM * 8
  });

  const p = document.createElement("p");
  p.className = "hint";
  p.textContent = "URL: " + url;
  qrResult.appendChild(p);
}

sizeButtons.forEach(btn => {
  btn.addEventListener("click", () => {
    sizeButtons.forEach(b => b.classList.remove("active"));
    btn.classList.add("active");

    etiquetaMM = parseInt(btn.dataset.mm, 10);
    actualizarCapacidad();

    if (codigoInput.value.trim()) generarQR();
  });
});

document.getElementById("btnGenerar").addEventListener("click", generarQR);

codigoInput.addEventListener("keydown", e => {
  if (e.key === "Enter"){
    e.preventDefault();
    generarQR();
  }
});


// ==================================
// CARGAR INSTRUMENTOS DESDE SUPABASE
// ==================================
async function cargarInstrumentos(){
  const supabase = window.supabase;

  if (!supabase){
    badgeEstado.textContent = "Supabase no disponible.";
    return;
  }

  badgeEstado.textContent = "Cargando instrumentos‚Ä¶";

  const { data, error } = await supabase
    .from("instrumentos")
    .select("codigo, descripcion")
    .order("codigo", { ascending:true });

  if (error){
    badgeEstado.textContent = "Error al cargar.";
    return;
  }

  allInstrumentos = data;
  badgeEstado.textContent = `Instrumentos cargados: ${allInstrumentos.length}`;

  renderInstrumentList();
}


function renderInstrumentList(filtro = ""){
  const term = filtro.toLowerCase();

  const filtrados = term
    ? allInstrumentos.filter(i =>
        String(i.codigo).toLowerCase().includes(term) ||
        (i.descripcion || "").toLowerCase().includes(term)
      )
    : allInstrumentos;

  listaInstrumentos.innerHTML = "";

  if (!filtrados.length){
    listaInstrumentos.innerHTML =
      `<div style="padding:8px;font-size:13px;color:#777;">Sin resultados</div>`;
    return;
  }

  filtrados.forEach(inst => {
    const row = document.createElement("label");
    row.className = "inst-row";

    const check = document.createElement("input");
    check.type = "checkbox";
    check.dataset.codigo = inst.codigo;
    check.checked = selectedCodigos.has(inst.codigo);

    check.addEventListener("change", () => {
      if (check.checked) selectedCodigos.add(inst.codigo);
      else selectedCodigos.delete(inst.codigo);
      actualizarCapacidad();
    });

    const codeSpan = document.createElement("span");
    codeSpan.className = "inst-code";
    codeSpan.textContent = inst.codigo;

    const descSpan = document.createElement("span");
    descSpan.className = "inst-desc";
    descSpan.textContent = inst.descripcion || "";

    row.appendChild(check);
    row.appendChild(codeSpan);
    row.appendChild(descSpan);
    listaInstrumentos.appendChild(row);
  });

  actualizarCapacidad();
}

buscadorInput.addEventListener("input", () => {
  renderInstrumentList(buscadorInput.value);
});

document.getElementById("btnRefrescarLista").addEventListener("click", cargarInstrumentos);

document.getElementById("btnLimpiarSeleccion").addEventListener("click", () => {
  selectedCodigos.clear();
  renderInstrumentList(buscadorInput.value);
});


// ==================================
// IMPRESI√ìN A4 (3x4) CON L√çNEAS DE CORTE
// ==================================
function imprimirHoja(){
  if (!selectedCodigos.size){
    alert("Selecciona al menos un instrumento.");
    return;
  }

  const codigos = Array.from(selectedCodigos).slice(0, 12);
  const etiqueta = etiquetaMM;

  let etiquetasHTML = "";
  let index = 0;

  for (let fila = 0; fila < 4; fila++){
    for (let col = 0; col < 3; col++){
      const codigo = codigos[index++];
      if (!codigo) break;

      const url = BASE_URL + encodeURIComponent(codigo);

      etiquetasHTML += `
        <div class="cell">
          <div class="cut-top"></div>
          <div class="cut-right"></div>
          <div class="cut-bottom"></div>
          <div class="cut-left"></div>

          <img src="https://api.qrserver.com/v1/create-qr-code/?size=400x400&data=${encodeURIComponent(url)}"
               class="qr">
        </div>
      `;
    }
  }

  const html = `
<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Etiquetas TMP ‚Äì A4</title>

<style>
  @page { size: A4; margin: 10mm; }
  body{ margin:0; padding:0; font-family:sans-serif; }

  .sheet{
    display:grid;
    grid-template-columns: repeat(3, auto);
    grid-template-rows: repeat(4, auto);
    justify-content:center;
    align-items:center;
    gap: 10mm;
    margin-top: 5mm;
  }

  .cell{
    position:relative;
    width:${etiqueta}mm;
    height:${etiqueta}mm;
    display:flex;
    align-items:center;
    justify-content:center;
  }

  .qr{
    width:${etiqueta}mm;
    height:${etiqueta}mm;
  }

  .cut-top{
    position:absolute;
    top:-4mm;
    left:0;
    right:0;
    border-top:0.4mm dashed #444;
  }

  .cut-bottom{
    position:absolute;
    bottom:-4mm;
    left:0;
    right:0;
    border-bottom:0.4mm dashed #444;
  }

  .cut-left{
    position:absolute;
    top:0;
    bottom:0;
    left:-4mm;
    border-left:0.4mm dashed #444;
  }

  .cut-right{
    position:absolute;
    top:0;
    bottom:0;
    right:-4mm;
    border-right:0.4mm dashed #444;
  }
</style>
</head>

<body>

  <div class="sheet">${etiquetasHTML}</div>

<script>
  window.onload = () => setTimeout(() => window.print(), 300);
<\/script>

</body>
</html>
  `;

  const win = window.open("", "_blank");
  win.document.write(html);
  win.document.close();
}

document.getElementById("btnImprimirHoja").addEventListener("click", imprimirHoja);


// ==================================
// INICIALIZACI√ìN
// ==================================
window.addEventListener("load", () => {
  actualizarCapacidad();
  setTimeout(cargarInstrumentos, 350);
});
</script>

</body>
</html>


