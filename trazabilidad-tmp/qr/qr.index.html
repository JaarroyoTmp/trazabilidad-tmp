<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TMP · QR Label Studio</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<style>
body{
  margin:0;
  font-family:system-ui,-apple-system,"Segoe UI",sans-serif;
  background:#0d1117;
  color:#eaf2ff;
}
header{
  padding:14px 18px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  background:#161b22;
  border-bottom:1px solid #30363d;
}
header h1{margin:0;font-size:16px;}
.wrap{
  max-width:1200px;
  margin:20px auto;
  padding:0 16px;
  display:grid;
  grid-template-columns:420px 1fr;
  gap:16px;
}
.card{
  background:#161b22;
  border:1px solid #30363d;
  border-radius:14px;
  padding:16px;
}
label{font-size:12px;color:#8b949e;}
input,select{
  width:100%;
  margin-top:4px;
  padding:10px;
  border-radius:10px;
  border:1px solid #30363d;
  background:#0d1117;
  color:#eaf2ff;
}
button{
  border-radius:999px;
  padding:10px 16px;
  border:none;
  cursor:pointer;
  font-weight:700;
}
.btn-main{background:#22c55e;color:#04120a;}
.btn-ghost{background:#1f2937;color:#eaf2ff;border:1px solid #30363d;}

.list{
  margin-top:10px;
  max-height:320px;
  overflow:auto;
  border:1px solid #30363d;
  border-radius:12px;
}
.row-inst{
  padding:10px;
  border-bottom:1px solid #21262d;
  cursor:pointer;
}
.row-inst:hover{background:#1f2937;}
.code{font-weight:800;}
.range{font-size:12px;color:#8b949e;}

.preview{
  margin-top:14px;
  display:flex;
  justify-content:center;
}
.label{
  background:#fff;
  border:1px solid #000;
  border-radius:10px;
  padding:10px;
  text-align:center;
}
.hole{
  width:8px;height:8px;border-radius:50%;
  border:1px solid #000;
  position:absolute;
  top:6px;left:6px;
}
</style>
</head>

<body>

<header>
  <h1>QR Label Studio</h1>
  <div id="estado">Verificando Supabase…</div>
</header>

<div class="wrap">

<!-- IZQUIERDA -->
<div class="card">
  <h3>Etiqueta individual</h3>

  <label>Código</label>
  <input id="codigo">

  <div style="margin-top:10px;display:flex;gap:8px;">
    <button class="btn-main" id="btnGen">Generar</button>
    <button class="btn-ghost" id="btnPrintOne">Imprimir</button>
  </div>

  <div class="preview" id="preview"></div>
</div>

<!-- DERECHA -->
<div class="card">
  <h3>Hoja A4 (3×4)</h3>

  <label>Buscar instrumentos</label>
  <input id="buscar" placeholder="MET, micrómetro, M14…">

  <div class="list" id="lista"></div>

  <div style="margin-top:10px;display:flex;gap:8px;justify-content:flex-end;">
    <button class="btn-main" id="btnPrintA4">Imprimir hoja</button>
    <button class="btn-ghost" id="btnClear">Limpiar</button>
  </div>
</div>

</div>

<!-- SUPABASE -->
<script type="module" src="../config.mjs"></script>

<script type="module">
const BASE_URL = "https://trazabilidad-tmp.vercel.app/qr/qr.info_instrumentos.html?codigo=";

const estado = document.getElementById("estado");
const lista = document.getElementById("lista");
const buscar = document.getElementById("buscar");
const preview = document.getElementById("preview");
const codigoInput = document.getElementById("codigo");

const selected = new Set();
let instrumentos = [];

function norm(s){
  return (s||"").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"");
}

function renderList(){
  const q = norm(buscar.value);
  const f = instrumentos.filter(i =>
    norm(i.codigo+" "+i.descripcion+" "+i.rango).includes(q)
  );
  lista.innerHTML = f.map(i => `
    <div class="row-inst" data-c="${i.codigo}">
      <div class="code">${i.codigo}</div>
      <div class="range">${i.descripcion} · ${i.rango}</div>
    </div>
  `).join("");

  document.querySelectorAll(".row-inst").forEach(r=>{
    r.onclick=()=>{
      const c=r.dataset.c;
      selected.has(c)?selected.delete(c):selected.add(c);
      r.style.background=selected.has(c)?"#22c55e33":"";
    };
  });
}

async function cargar(){
  if(!window.supabase){
    estado.textContent="❌ Supabase no disponible";
    return;
  }
  estado.textContent="Cargando instrumentos…";

  const {data,error}=await window.supabase
    .from("instrumentos")
    .select("codigo,descripcion,rango")
    .order("codigo",{ascending:true})
    .limit(5000);

  if(error){
    estado.textContent="❌ Error Supabase";
    console.error(error);
    return;
  }

  instrumentos=data||[];
  estado.textContent="✅ Online · "+instrumentos.length+" instrumentos";
  renderList();
}

function generarQR(c){
  preview.innerHTML="";
  const box=document.createElement("div");
  box.className="label";
  const qr=document.createElement("div");
  box.appendChild(qr);
  preview.appendChild(box);
  new QRCode(qr,{
    text:BASE_URL+encodeURIComponent(c),
    width:80,
    height:80
  });
}

function imprimir(codigos){
  if(!codigos.length){alert("Nada seleccionado");return;}
  const w=window.open("","_blank");
  let html="<html><head><title>Print</title>";
  html+="<script src='https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js'><\/script>";
  html+="</head><body><div style='display:grid;grid-template-columns:repeat(3,1fr);gap:10px'>";
  codigos.forEach(c=>{
    html+=`<div id="q_${c}" style="border:1px solid #000;padding:6px"></div>`;
  });
  html+="</div><script>";
  codigos.forEach(c=>{
    html+=`new QRCode(document.getElementById("q_${c}"),{text:"${BASE_URL+c}",width:80,height:80});`;
  });
  html+="setTimeout(()=>window.print(),500);<\/script></body></html>";
  w.document.write(html);
  w.document.close();
}

buscar.oninput=renderList;

document.getElementById("btnGen").onclick=()=>{
  if(codigoInput.value) generarQR(codigoInput.value);
};
document.getElementById("btnPrintOne").onclick=()=>{
  if(codigoInput.value) imprimir([codigoInput.value]);
};
document.getElementById("btnPrintA4").onclick=()=>{
  imprimir([...selected]);
};
document.getElementById("btnClear").onclick=()=>{
  selected.clear();
  renderList();
};

window.addEventListener("load",cargar);
</script>

</body>
</html>
