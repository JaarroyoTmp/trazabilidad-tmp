<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TMP ¬∑ Generador de C√≥digos QR</title>

  <!-- Librer√≠a QR -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <style>
    :root{
      --bg:#0d1117;
      --panel:#161b22;
      --border:#30363d;
      --txt:#f0f6fc;
      --muted:#8b949e;
      --accent:#58a6ff;
      --ok:#238636;
    }

    *{box-sizing:border-box;}

    body{
      margin:0;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:var(--bg);
      color:var(--txt);
    }

    header{
      display:flex;
      align-items:center;
      gap:14px;
      padding:14px 16px;
      background:var(--panel);
      border-bottom:1px solid var(--border);
    }
    header img.logo{height:40px}
    header h1{margin:0;font-size:18px}
    header span.sub{font-size:12px;color:var(--muted)}

    .wrap{
      max-width:980px;
      margin:22px auto;
      padding:0 16px 32px;
      display:grid;
      grid-template-columns: minmax(0,420px) minmax(0,1fr);
      gap:18px;
    }

    @media (max-width:900px){
      .wrap{
        grid-template-columns:1fr;
      }
    }

    .card{
      background:var(--panel);
      border-radius:16px;
      border:1px solid var(--border);
      padding:18px 16px 16px;
    }

    h2{margin:0 0 8px;font-size:16px}
    label{display:block;font-size:13px;color:var(--muted);margin-bottom:4px}

    input{
      width:100%;
      padding:9px 11px;
      border-radius:10px;
      border:1px solid var(--border);
      background:#0d1117;
      color:var(--txt);
      font-size:14px;
      outline:none;
    }

    input:focus{border-color:var(--accent);}

    .row{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin-top:8px;
      align-items:center;
    }

    button{
      border:none;
      border-radius:999px;
      padding:9px 16px;
      font-size:13px;
      cursor:pointer;
      font-weight:600;
      display:inline-flex;
      align-items:center;
      gap:6px;
    }

    .btn-main{
      background:var(--ok);
      color:#fff;
    }
    .btn-main:hover{background:#2ea043;}

    .btn-ghost{
      background:transparent;
      color:var(--accent);
      border:1px solid var(--border);
    }
    .btn-ghost:hover{border-color:var(--accent);}

    .sizes{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-top:10px
    }

    .sizes button{
      font-size:12px;
      padding:7px 12px
    }

    .sizes button.active{
      background:var(--accent);
      color:#0d1117;
      border-color:var(--accent);
    }

    #qrResult{
      margin-top:20px;
      display:flex;
      flex-direction:column;
      align-items:center;
      min-height:120px;
    }

    #qrResult canvas{
      background:#ffffff;
      padding:10px;
      border-radius:12px;
    }

    .hint{
      font-size:12px;
      color:var(--muted);
      margin-top:8px
    }

    .badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      font-size:11px;
      padding:4px 9px;
      border-radius:999px;
      border:1px solid var(--border);
      background:#0d1117;
      color:var(--muted);
    }

    .search-box{
      margin-top:4px;
    }

    .search-box input{
      font-size:13px;
    }

    .list-instrumentos{
      margin-top:10px;
      max-height:260px;
      border-radius:12px;
      border:1px solid var(--border);
      overflow:auto;
      background:#0d1117;
    }

    .inst-row{
      display:flex;
      align-items:flex-start;
      gap:8px;
      padding:6px 8px;
      border-bottom:1px solid #21262d;
      font-size:13px;
      cursor:pointer;
    }

    .inst-row:last-child{border-bottom:none;}

    .inst-row:hover{
      background:#111827;
    }

    .inst-row input[type="checkbox"]{
      margin-top:2px;
    }

    .inst-code{
      font-weight:600;
      margin-right:4px;
    }

    .inst-desc{
      color:var(--muted);
      font-size:12px;
    }

    .panel-footer{
      margin-top:10px;
      font-size:12px;
      color:var(--muted);
      display:flex;
      flex-direction:column;
      gap:4px;
    }

    .panel-footer strong{
      color:#e5e7eb;
    }

    .btn-row{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:10px;
    }

    #volverHome{
      position:fixed;
      bottom:18px;
      right:18px;
      background:#238636;
      padding:12px 18px;
      font-size:14px;
      border-radius:12px;
      border:1px solid #2ea043;
      cursor:pointer;
      color:white;
      box-shadow:0 0 10px rgba(0,0,0,.4);
      z-index:50;
    }
    #volverHome:hover{
      background:#2ea043;
    }

    .preview-sheet{
      margin-top:10px;
      border-radius:12px;
      border:1px solid var(--border);
      background:#0d1117;
      padding:10px;
    }

    .preview-grid{
      display:grid;
      gap:3px;
      justify-content:flex-start;
      align-content:flex-start;
      max-height:260px;
      overflow:auto;
      background:#02040a;
      padding:6px;
    }

    .preview-cell{
      width:16px;
      height:16px;
      border-radius:3px;
      background:#1f2937;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:9px;
      color:#9ca3af;
    }

    .preview-cell.filled{
      background:#22c55e;
      color:#022c22;
      font-weight:700;
    }
  </style>
</head>

<body>

<button id="volverHome" onclick="window.location.href='../home.html'">üè† Volver</button>

<header>
  <img src="../img/tmp-quality.png" alt="TMP" class="logo">
  <div>
    <h1>Generar c√≥digos QR</h1>
    <span class="sub">Trazabilidad instrumentos TMP</span>
  </div>
</header>

<div class="wrap">
  <!-- PANEL IZQUIERDO -->
  <div class="card">
    <h2>Generar QR individual</h2>

    <label for="codigo">C√≥digo del instrumento</label>
    <input id="codigo" type="text" placeholder="Ejemplo: 11217">

    <div class="row">
      <button class="btn-main" id="btnGenerar">Generar QR</button>
    </div>

    <div class="sizes">
      <button class="btn-ghost size-btn active" data-mm="10">Etiqueta 10 mm</button>
      <button class="btn-ghost size-btn" data-mm="13">Etiqueta 13 mm</button>
      <button class="btn-ghost size-btn" data-mm="15">Etiqueta 15 mm</button>
    </div>

    <div id="qrResult"></div>
  </div>

  <!-- PANEL DERECHO -->
  <div class="card">
    <h2>Imprimir hoja A5</h2>
    <div class="badge" id="badgeEstado">Cargando instrumentos‚Ä¶</div>

    <div class="search-box">
      <label for="buscador">Buscar instrumentos</label>
      <input id="buscador" type="text">
    </div>

    <div class="list-instrumentos" id="listaInstrumentos"></div>

    <div class="panel-footer">
      <span><strong>Tama√±o:</strong> <span id="lblTamano">10 mm</span></span>
      <span><strong>Capacidad A5:</strong> <span id="lblCapacidad">‚Äì</span></span>
      <span><strong>Seleccionados:</strong> <span id="lblSeleccionados">0</span></span>
    </div>

    <div class="btn-row">
      <button class="btn-main" id="btnImprimirHoja">Imprimir hoja A5</button>
      <button class="btn-ghost" id="btnLimpiarSeleccion">Limpiar selecci√≥n</button>
      <button class="btn-ghost" id="btnRefrescarLista">Refrescar</button>
    </div>

    <div class="preview-sheet">
      <div class="hint">Esquema aproximado:</div>
      <div id="previewGrid" class="preview-grid"></div>
    </div>
  </div>
</div>

<script type="module" src="../config.mjs"></script>

<script>
  const BASE_URL = "https://trazabilidad-tmp.vercel.app/qr/qr.info_instrumentos.html?codigo=";

  let etiquetaMM = 10;
  let allInstrumentos = [];
  const selectedCodigos = new Set();

  const PAGE_A5_W = 148;
  const PAGE_A5_H = 210;
  const PAGE_MARGIN = 8;
  const GAP_MM = 3;

  const qrResult   = document.getElementById("qrResult");
  const codigoInput = document.getElementById("codigo");
  const sizeButtons = document.querySelectorAll(".size-btn");

  const badgeEstado = document.getElementById("badgeEstado");
  const listaInstrumentos = document.getElementById("listaInstrumentos");
  const buscadorInput = document.getElementById("buscador");

  const lblTamano = document.getElementById("lblTamano");
  const lblCapacidad = document.getElementById("lblCapacidad");
  const lblSeleccionados = document.getElementById("lblSeleccionados");
  const previewGrid = document.getElementById("previewGrid");

  // ==========================
  // LAYOUT A5
  // ==========================
  function computeLayout(labelMM){
    const usableW = PAGE_A5_W - (2 * PAGE_MARGIN);
    const usableH = PAGE_A5_H - (2 * PAGE_MARGIN);

    const cellW = labelMM + GAP_MM;
    const cellH = labelMM + GAP_MM;

    const cols = Math.max(1, Math.floor(usableW / cellW));
    const rows = Math.max(1, Math.floor(usableH / cellH));

    return { cols, rows, perPage: cols * rows };
  }

  function actualizarCapacidad(){
    const {cols, rows, perPage} = computeLayout(etiquetaMM);

    lblTamano.textContent = etiquetaMM + " mm";
    lblCapacidad.textContent = `${perPage} (${cols}x${rows})`;
    lblSeleccionados.textContent = selectedCodigos.size;

    previewGrid.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
    previewGrid.innerHTML = "";

    for(let i = 0; i < cols * rows; i++){
      const div = document.createElement("div");
      div.className = "preview-cell";
      if(i < selectedCodigos.size){
        div.classList.add("filled");
        div.textContent = i+1;
      }
      previewGrid.appendChild(div);
    }
  }

  // ==========================
  // QR individual
  // ==========================
  function generarQR(){
    const codigo = codigoInput.value.trim();
    if (!codigo){
      alert("Introduce un c√≥digo");
      return;
    }

    const url = BASE_URL + encodeURIComponent(codigo);

    qrResult.innerHTML = "";
    const qrDiv = document.createElement("div");
    qrResult.appendChild(qrDiv);

    new QRCode(qrDiv, {
      text: url,
      width: etiquetaMM * 8,
      height: etiquetaMM * 8
    });
  }

  sizeButtons.forEach(btn => {
    btn.addEventListener("click", () => {
      sizeButtons.forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
      etiquetaMM = parseInt(btn.dataset.mm);
      actualizarCapacidad();
    });
  });

  document.getElementById("btnGenerar").addEventListener("click", generarQR);

  // ==========================
  // Cargar instrumentos
  // ==========================
  async function cargarInstrumentos(){
    const supabase = window.supabase;
    const { data } = await supabase
      .from("instrumentos")
      .select("codigo, descripcion")
      .order("codigo");

    allInstrumentos = data || [];
    badgeEstado.textContent = `Instrumentos: ${allInstrumentos.length}`;

    renderInstrumentList();
  }

  function renderInstrumentList(filter=""){
    const term = filter.toLowerCase();

    const filtrados = term
      ? allInstrumentos.filter(i =>
          String(i.codigo).toLowerCase().includes(term) ||
          (i.descripcion || "").toLowerCase().includes(term)
        )
      : allInstrumentos;

    listaInstrumentos.innerHTML = "";

    filtrados.forEach(inst => {
      const row = document.createElement("label");
      row.className = "inst-row";

      const check = document.createElement("input");
      check.type = "checkbox";
      check.dataset.codigo = inst.codigo;

      check.addEventListener("change", () => {
        if(check.checked) selectedCodigos.add(inst.codigo);
        else selectedCodigos.delete(inst.codigo);
        actualizarCapacidad();
      });

      const code = document.createElement("span");
      code.className = "inst-code";
      code.textContent = inst.codigo;

      const desc = document.createElement("span");
      desc.className = "inst-desc";
      desc.textContent = inst.descripcion || "";

      row.appendChild(check);
      row.appendChild(code);
      row.appendChild(desc);
      listaInstrumentos.appendChild(row);
    });

    actualizarCapacidad();
  }

  buscadorInput.addEventListener("input", () => {
    renderInstrumentList(buscadorInput.value);
  });

  document.getElementById("btnRefrescarLista").addEventListener("click", cargarInstrumentos);
  document.getElementById("btnLimpiarSeleccion").addEventListener("click", () => {
    selectedCodigos.clear();
    renderInstrumentList(buscadorInput.value);
  });

  // ==========================
  // IMPRESI√ìN A5
  // ==========================
  function imprimirHoja(){
    if(!selectedCodigos.size){
      alert("Selecciona al menos 1 instrumento");
      return;
    }

    const {cols, rows, perPage} = computeLayout(etiquetaMM);
    const codigos = Array.from(selectedCodigos);
    const usable = Math.min(codigos.length, perPage);

    const lista = codigos.slice(0, usable);

    let etiquetasHTML = "";
    lista.forEach(codigo => {
      const url = BASE_URL + encodeURIComponent(codigo);
      etiquetasHTML += `
      <div class="label">
        <img src="https://api.qrserver.com/v1/create-qr-code/?size=400x400&data=${encodeURIComponent(url)}">
      </div>`;
    });

    const html = `
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Etiquetas A5</title>
<style>
  @page{
    size: A5 portrait;
    margin: ${PAGE_MARGIN}mm;
  }
  body{
    margin:0;
  }
  .sheet{
    display:grid;
    justify-content:center;
    align-content:start;
    grid-template-columns:repeat(${cols}, ${etiquetaMM}mm);
    grid-auto-rows:${etiquetaMM}mm;
    gap:${GAP_MM}mm;
    width:100%;
    height:100%;
  }
  .label{
    border:0.35mm dashed #444;
    border-radius:3px;
    display:flex;
    justify-content:center;
    align-items:center;
    background:white;
  }
  .label img{
    width:${etiquetaMM}mm;
    height:${etiquetaMM}mm;
  }
</style>
</head>

<body>
<div class="sheet">${etiquetasHTML}</div>
<script>window.onload=()=>setTimeout(()=>window.print(),300)<\/script>
</body>
</html>`;

    const win = window.open("", "_blank");
    win.document.write(html);
    win.document.close();
  }

  document.getElementById("btnImprimirHoja").addEventListener("click", imprimirHoja);

  // ==========================
  // INIT
  // ==========================
  window.onload = () => {
    cargarInstrumentos();
    actualizarCapacidad();
  };
</script>

</body>
</html>

