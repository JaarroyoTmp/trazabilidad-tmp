<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>TMP ¬∑ Ficha del instrumento</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    :root{
      --bg:#020617;
      --bg-grad1:#0f172a;
      --bg-grad2:#020617;
      --card:#020617;
      --card-soft:#02081a;
      --border:#1f2937;
      --txt:#e5e7eb;
      --muted:#9ca3af;
      --accent:#22d3ee;
      --accent-soft:#0ea5e9;
      --danger:#fb7185;
      --warn:#facc15;
      --ok:#4ade80;
    }

    *{ box-sizing:border-box; }

    body{
      margin:0;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:
        radial-gradient(circle at 0% 0%, #0f172a 0, transparent 55%),
        radial-gradient(circle at 100% 0%, #0b1120 0, transparent 55%),
        radial-gradient(circle at 50% 110%, #0f172a 0, transparent 60%),
        linear-gradient(180deg,var(--bg-grad1),var(--bg-grad2));
      color:var(--txt);
      -webkit-font-smoothing:antialiased;
    }

    /* Bot√≥n volver */
    #volverHome{
      position:fixed;
      right:14px;
      bottom:16px;
      z-index:40;
      border:none;
      border-radius:999px;
      padding:8px 16px;
      font-size:14px;
      cursor:pointer;
      background:#0f172a;
      color:#e5e7eb;
      border:1px solid rgba(148,163,184,.4);
      box-shadow:0 10px 25px rgba(15,23,42,.9);
    }
    #volverHome:hover{
      background:#111827;
    }

    header{
      display:flex;
      align-items:center;
      gap:12px;
      padding:14px 16px;
      border-bottom:1px solid rgba(148,163,184,.25);
      background:
        radial-gradient(circle at 0% 0%, rgba(56,189,248,.22) 0, transparent 60%),
        radial-gradient(circle at 100% 0%, rgba(59,130,246,.25) 0, transparent 60%),
        linear-gradient(135deg,#020617,#020617f0);
      position:sticky;
      top:0;
      z-index:20;
      backdrop-filter:blur(18px);
    }

    .logo{
      height:40px;
      width:auto;
      filter:drop-shadow(0 0 8px rgba(56,189,248,.45));
    }

    .h-titles{
      display:flex;
      flex-direction:column;
    }

    .h-titles h1{
      margin:0;
      font-size:18px;
      letter-spacing:.04em;
    }

    .h-titles span{
      font-size:12px;
      color:var(--muted);
    }

    .wrap{
      max-width:760px;
      margin:18px auto 32px;
      padding:0 16px 40px;
      display:flex;
      flex-direction:column;
      gap:14px;
    }

    /* HERO NE√ìN PRINCIPAL */
    .hero-card{
      position:relative;
      border-radius:18px;
      padding:14px 14px 12px;
      background:
        radial-gradient(circle at 0% 0%, rgba(56,189,248,.18) 0, transparent 55%),
        radial-gradient(circle at 100% 0%, rgba(59,130,246,.20) 0, transparent 60%),
        linear-gradient(135deg,#020617,#020617);
      border:1px solid rgba(148,163,184,.35);
      box-shadow:
        0 18px 45px rgba(15,23,42,.95),
        0 0 40px rgba(56,189,248,.18);
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
    }

    .hero-main{
      max-width:70%;
    }

    .hero-code{
      font-size:12px;
      text-transform:uppercase;
      letter-spacing:.18em;
      color:var(--muted);
      margin-bottom:2px;
    }

    .hero-title{
      font-size:17px;
      font-weight:700;
    }

    .hero-sub{
      font-size:13px;
      color:var(--muted);
      margin-top:4px;
      line-height:1.45;
    }

    .hero-status{
      display:flex;
      flex-direction:column;
      align-items:flex-end;
      gap:4px;
      font-size:12px;
    }

    .status-pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 12px;
      border-radius:999px;
      font-size:11px;
      font-weight:700;
      border:1px solid rgba(148,163,184,.5);
      background:rgba(15,23,42,.9);
      text-transform:uppercase;
      letter-spacing:.12em;
    }

    .status-pill .dot{
      width:8px;
      height:8px;
      border-radius:50%;
    }

    .status-ok{
      border-color:rgba(74,222,128,.4);
      color:#bbf7d0;
      box-shadow:0 0 14px rgba(74,222,128,.55);
    }
    .status-ok .dot{background:var(--ok);}

    .status-warn{
      border-color:rgba(250,204,21,.5);
      color:#fef3c7;
      box-shadow:0 0 14px rgba(250,204,21,.55);
    }
    .status-warn .dot{background:var(--warn);}

    .status-bad{
      border-color:rgba(248,113,113,.7);
      color:#fee2e2;
      box-shadow:0 0 18px rgba(248,113,113,.85);
    }
    .status-bad .dot{background:var(--danger);}

    .status-info{
      border-color:rgba(56,189,248,.6);
      color:#e0f2fe;
      box-shadow:0 0 14px rgba(56,189,248,.6);
    }
    .status-info .dot{background:#38bdf8;}

    .status-caption{
      font-size:11px;
      color:var(--muted);
      max-width:200px;
      text-align:right;
    }

    /* Observaciones bajo HERO */
    .hero-observ{
      margin-top:6px;
      border-radius:12px;
      padding:8px 10px;
      background:rgba(15,23,42,.9);
      border:1px solid rgba(148,163,184,.25);
      font-size:12px;
      color:#e5e7eb;
    }
    .hero-observ span.label{
      color:#a5b4fc;
      font-weight:600;
      margin-right:4px;
    }

    /* Tarjetas generales */
    .card{
      border-radius:16px;
      padding:14px 14px 12px;
      background:
        radial-gradient(circle at 0% 0%, rgba(15,118,110,.15) 0, transparent 55%),
        linear-gradient(135deg,#020617,#02081a);
      border:1px solid rgba(31,41,55,.9);
      box-shadow:0 16px 35px rgba(15,23,42,.95);
    }

    h2{
      margin:0 0 6px;
      font-size:16px;
    }

    .card-sub{
      font-size:12px;
      color:var(--muted);
      margin-bottom:10px;
    }

    .item{
      display:flex;
      flex-direction:column;
      margin-bottom:6px;
      font-size:13px;
    }
    .item .label{
      font-size:11px;
      color:var(--muted);
      text-transform:uppercase;
      letter-spacing:.08em;
      margin-bottom:2px;
    }
    .item .value{
      font-size:13px;
    }

    .muted{
      color:var(--muted);
      font-size:12px;
    }

    /* Error box */
    .error-box{
      border-radius:14px;
      padding:12px 14px;
      background:#3f1d1d;
      border:1px solid #7f1d1d;
      color:#fee2e2;
      box-shadow:0 12px 30px rgba(0,0,0,.65);
      font-size:14px;
    }
    .error-box h2{
      margin-top:0;
      margin-bottom:6px;
      font-size:16px;
    }

    /* Movimientos */
    .mov-item{
      border-radius:12px;
      padding:10px 11px;
      background:#020617;
      border:1px solid rgba(31,41,55,.8);
      margin-bottom:8px;
      font-size:12px;
    }
    .mov-header{
      display:flex;
      justify-content:space-between;
      gap:8px;
      margin-bottom:4px;
    }
    .mov-type{
      font-weight:600;
      color:#e5e7eb;
    }
    .mov-date{
      color:var(--muted);
      font-size:11px;
    }
    .mov-body-line{
      display:flex;
      justify-content:space-between;
      gap:8px;
      font-size:12px;
    }
    .mov-body-label{
      color:var(--muted);
      min-width:70px;
    }
  </style>
</head>

<body>

<button id="volverHome" onclick="window.location.href='../home.html'">
  üè† Volver al panel
</button>

<header>
  <img src="../img/tmp-quality.png" alt="TMP" class="logo">
  <div class="h-titles">
    <h1>Ficha del instrumento</h1>
    <span id="subTitle">Cargando c√≥digo‚Ä¶</span>
  </div>
</header>

<div class="wrap">

  <!-- Caja de error -->
  <div id="errorBox" class="error-box" style="display:none"></div>

  <!-- HERO NE√ìN -->
  <section id="hero" class="hero-card" style="display:none">
    <div class="hero-main">
      <div class="hero-code" id="heroCode">C√ìDIGO ‚Äî</div>
      <div class="hero-title" id="heroTitle">Instrumento</div>
      <div class="hero-sub" id="heroSub">‚Äî</div>
    </div>

    <div class="hero-status">
      <div id="heroStatusPill" class="status-pill">
        <span class="dot"></span>
        <span id="heroStatusLabel">‚Äî</span>
      </div>
      <div class="status-caption" id="heroStatusCaption">Estado de calibraci√≥n</div>
    </div>
  </section>

  <!-- Observaciones destacadas (pero secundarias) -->
  <section id="heroObserv" class="hero-observ" style="display:none"></section>

  <!-- Informaci√≥n b√°sica -->
  <section id="infoCard" class="card" style="display:none">
    <h2>Informaci√≥n b√°sica</h2>
    <div class="card-sub">Datos principales del instrumento le√≠do por QR.</div>
    <div id="infoBody"></div>
  </section>

  <!-- Estado de calibraci√≥n -->
  <section id="calCard" class="card" style="display:none">
    <h2>Estado de calibraci√≥n</h2>
    <div class="card-sub">Situaci√≥n actual frente a su plan de calibraci√≥n.</div>
    <div id="calBody"></div>
  </section>

  <!-- Historial de movimientos -->
  <section id="movCard" class="card" style="display:none">
    <h2>√öltimos movimientos</h2>
    <div class="card-sub">Trazabilidad b√°sica de uso y ubicaci√≥n reciente.</div>
    <div id="movBody"></div>
    <p class="muted" id="movHint"></p>
  </section>

</div>

<!-- Cliente Supabase global -->
<script type="module" src="../config.mjs"></script>

<script type="module">
  const supa = window.supabase;

  // ---------------------------
  //   OBTENER C√ìDIGO DESDE URL
  // ---------------------------
  let codigo = new URLSearchParams(window.location.search).get("codigo");

  // Permite URLs tipo /qr/12345
  if (!codigo) {
    const parts = window.location.pathname.split("/").filter(Boolean);
    const last = parts[parts.length - 1];
    if (last && !last.includes(".html")) {
      codigo = decodeURIComponent(last);
    }
  }

  const subTitle = document.getElementById("subTitle");
  subTitle.textContent = codigo ? `C√≥digo: ${codigo}` : "C√≥digo no especificado";

  // ---------------------------
  //   HELPERS
  // ---------------------------
  function showError(msg){
    const box = document.getElementById("errorBox");
    box.style.display = "block";
    box.innerHTML = `
      <h2>Error</h2>
      <p>${msg}</p>
      <p class="muted">Verifica el c√≥digo o contacta con Metrolog√≠a.</p>
    `;
  }

  function formatDateShort(iso){
    if (!iso) return "‚Äî";
    const d = new Date(iso);
    if (isNaN(d)) return "‚Äî";
    const dd = String(d.getDate()).padStart(2,"0");
    const mm = String(d.getMonth()+1).padStart(2,"0");
    const yy = d.getFullYear();
    return `${dd}/${mm}/${yy}`;
  }

  function formatDateTime(iso){
    if (!iso) return "‚Äî";
    const d = new Date(iso);
    if (isNaN(d)) return "‚Äî";
    const dd = String(d.getDate()).padStart(2,"0");
    const mm = String(d.getMonth()+1).padStart(2,"0");
    const yy = d.getFullYear();
    const hh = String(d.getHours()).padStart(2,"0");
    const mi = String(d.getMinutes()).padStart(2,"0");
    return `${dd}/${mm}/${yy} ${hh}:${mi}`;
  }

  function daysDiffToToday(iso){
    if (!iso) return null;
    const target = new Date(iso);
    if (isNaN(target)) return null;
    const today = new Date();
    const MS = 86400000;
    return Math.round((target - today)/MS);
  }

  function computeEstado(proxISO){
    const dias = daysDiffToToday(proxISO);

    if (dias === null){
      return {
        clase: "status-info",
        texto: "Sin pr√≥xima calibraci√≥n",
        detalle: "Este instrumento no tiene fecha futura asignada.",
        dias: null,
        icono: "üõà"
      };
    }

    if (dias < 0){
      return {
        clase: "status-bad",
        texto: "Fuera de calibraci√≥n",
        detalle: "El equipo debe inmovilizarse hasta nueva calibraci√≥n.",
        dias,
        icono: "‚õî"
      };
    }

    if (dias <= 30){
      return {
        clase: "status-warn",
        texto: "Pr√≥xima a vencer",
        detalle: "Planificar calibraci√≥n en breve.",
        dias,
        icono: "‚ö†"
      };
    }

    return {
      clase: "status-ok",
      texto: "En regla",
      detalle: "Instrumento dentro del plazo de calibraci√≥n.",
      dias,
      icono: "‚úî"
    };
  }

  // ---------------------------
  //   FUNCI√ìN PRINCIPAL
  // ---------------------------
  async function main(){
    if (!codigo){
      showError("No se ha indicado un c√≥digo en la URL.");
      return;
    }

    if (!supa){
      showError("Supabase no est√° disponible en esta p√°gina.");
      return;
    }

    // Obtener instrumento desde Supabase
    const { data: inst, error: e1 } = await supa
      .from("instrumentos")
      .select("*")
      .eq("codigo", codigo)
      .maybeSingle();

    if (e1){
      console.error(e1);
      showError("Error consultando la base de datos.");
      return;
    }

    if (!inst){
      showError(`No existe ning√∫n instrumento con c√≥digo <b>${codigo}</b>.`);
      return;
    }

    // ---------------------------
    //   HERO CON DATOS ESENCIALES
    // ---------------------------
    const hero = document.getElementById("hero");
    const heroCode = document.getElementById("heroCode");
    const heroTitle = document.getElementById("heroTitle");
    const heroSub = document.getElementById("heroSub");
    const heroStatusPill = document.getElementById("heroStatusPill");
    const heroStatusLabel = document.getElementById("heroStatusLabel");
    const heroStatusCaption = document.getElementById("heroStatusCaption");
    const heroObserv = document.getElementById("heroObserv");

    hero.style.display = "flex";

    heroCode.textContent = `C√ìDIGO ¬∑ ${codigo}`;
    heroTitle.textContent = inst.descripcion || "Instrumento sin descripci√≥n";

    // Texto principal: fabricante + ubicaci√≥n actual muy visible
    const fabricanteTxt = inst.fabricante || "Fabricante N/D";
    const ubicActual = inst.ubicacion_actual || "No especificada";

    heroSub.innerHTML =
      `<strong>${fabricanteTxt}</strong><br>` +
      `<span style="color:#7dd3fc">üìç Ubicaci√≥n actual:</span> ${ubicActual}`;

    // Observaciones: siempre mostrar algo
    let obs = inst.observaciones;
    if (!obs || obs === "null" || (typeof obs === "string" && obs.trim() === "")) {
      obs = "Propiedad de Talleres Mec√°nicos Paramio";
    }

    heroObserv.style.display = "block";
    heroObserv.innerHTML =
      `<span class="label">üìù Observaciones</span>${obs}`;

    // Pr√≥xima calibraci√≥n: usar siempre fecha_proxima_calibracion primero
    const proxCalHero = inst.fecha_proxima_calibracion ?? inst.proxima_cal ?? null;
    const estadoHero = computeEstado(proxCalHero);

    heroStatusPill.className = "status-pill " + estadoHero.clase;
    heroStatusLabel.textContent = `${estadoHero.icono} ${estadoHero.texto}`;

    if (estadoHero.dias === null){
      heroStatusCaption.textContent = estadoHero.detalle;
    } else if (estadoHero.dias < 0){
      const abs = Math.abs(estadoHero.dias);
      heroStatusCaption.textContent =
        `${estadoHero.detalle} Vencida hace ${abs} d√≠a${abs===1?"":"s"}.`;
    } else {
      heroStatusCaption.textContent =
        `${estadoHero.detalle} Faltan ${estadoHero.dias} d√≠a${estadoHero.dias===1?"":"s"}.`;
    }

    // ---------------------------
    //   INFORMACI√ìN B√ÅSICA
    // ---------------------------
    const infoCard = document.getElementById("infoCard");
    const infoBody = document.getElementById("infoBody");
    infoCard.style.display = "block";

    infoBody.innerHTML = `
      <div class="item">
        <span class="label">Descripci√≥n</span>
        <span class="value">${inst.descripcion || "-"}</span>
      </div>
      <div class="item">
        <span class="label">Fabricante</span>
        <span class="value">${inst.fabricante || "-"}</span>
      </div>
      <div class="item">
        <span class="label">Rango / Especificaci√≥n</span>
        <span class="value">${inst.rango || "-"}</span>
      </div>
      <div class="item">
        <span class="label">Precisi√≥n</span>
        <span class="value">${inst.precision || "-"}</span>
      </div>
      <div class="item">
        <span class="label">Ubicaci√≥n nominal</span>
        <span class="value">${inst.ubicacion || "-"}</span>
      </div>
      <div class="item">
        <span class="label">Ubicaci√≥n actual</span>
        <span class="value">${inst.ubicacion_actual || "-"}</span>
      </div>
      <div class="item">
        <span class="label">Tipo de calibraci√≥n</span>
        <span class="value">${inst.tipo_calibracion || "-"}</span>
      </div>
      <div class="item">
        <span class="label">Observaciones (detalle)</span>
        <span class="value">${obs}</span>
      </div>
    `;

    // ---------------------------
    //   ESTADO DE CALIBRACI√ìN
    // ---------------------------
    const calCard = document.getElementById("calCard");
    const calBody = document.getElementById("calBody");
    calCard.style.display = "block";

    const ult = inst.fecha_ultima_cal ?? inst.fecha_calibracion ?? null;
    const prox = inst.fecha_proxima_calibracion ?? inst.proxima_cal ?? null;

    const est2 = computeEstado(prox);

    let detalleExtra = est2.detalle;
    if (est2.dias !== null){
      if (est2.dias < 0){
        const abs = Math.abs(est2.dias);
        detalleExtra += ` Vencida hace ${abs} d√≠a${abs===1?"":"s"}.`;
      } else {
        detalleExtra += ` Faltan ${est2.dias} d√≠a${est2.dias===1?"":"s"}.`;
      }
    }

    calBody.innerHTML = `
      <div class="item">
        <span class="label">√öltima calibraci√≥n</span>
        <span class="value">${ult ? formatDateShort(ult) : "-"}</span>
      </div>

      <div class="item">
        <span class="label">Pr√≥xima calibraci√≥n</span>
        <span class="value">${prox ? formatDateShort(prox) : "-"}</span>
      </div>

      <div class="item" style="margin-top:8px;">
        <span class="status-pill ${est2.clase}">
          <span class="dot"></span>
          ${est2.icono} ${est2.texto}
        </span>
      </div>

      <p class="muted">${detalleExtra}</p>
    `;

    // ---------------------------
    //   HIST√ìRICO DE MOVIMIENTOS
    // ---------------------------
    const movCard = document.getElementById("movCard");
    const movBody = document.getElementById("movBody");
    const movHint = document.getElementById("movHint");

    movCard.style.display = "block";

    const { data: movs, error: e2 } = await supa
      .from("movimientos")
      .select("*")
      .eq("codigo_instrumento", codigo)
      .order("fecha", { ascending:false })
      .limit(10);

    if (e2){
      console.error(e2);
      movBody.innerHTML = `<div class="muted">No se han podido cargar movimientos.</div>`;
      movHint.textContent = "";
      return;
    }

    if (!movs || movs.length === 0){
      movBody.innerHTML = `<div class="muted">No existen movimientos para este instrumento.</div>`;
      movHint.textContent = "";
    } else {
      movBody.innerHTML = movs.map(m => `
        <div class="mov-item">
          <div class="mov-header">
            <div class="mov-type">${m.tipo_movimiento || "Movimiento"}</div>
            <div class="mov-date">${formatDateTime(m.fecha)}</div>
          </div>

          <div class="mov-body-line">
            <span class="mov-body-label">Responsable</span>
            <span>${m.responsable || "-"}</span>
          </div>

          <div class="mov-body-line">
            <span class="mov-body-label">Destino</span>
            <span>${m.destino || "-"}</span>
          </div>

          ${m.observaciones ? `
            <div class="mov-body-line">
              <span class="mov-body-label">Obs.</span>
              <span>${m.observaciones.replace(/\n/g,"<br>")}</span>
            </div>` : ""
          }
        </div>
      `).join("");

      movHint.textContent =
        "Se muestran los 10 movimientos m√°s recientes registrados en la base de datos.";
    }
  }

  main();
</script>

</body>
</html>
