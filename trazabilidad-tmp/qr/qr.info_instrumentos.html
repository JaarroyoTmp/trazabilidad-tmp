<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>TMP ¬∑ QR Info (Instrumento)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    :root{
      --bg:#020617;
      --bg2:#0b1224;
      --card:#071022;
      --card2:#0a1530;
      --border: rgba(148,163,184,.18);
      --border2: rgba(148,163,184,.28);
      --txt:#e5e7eb;
      --muted:#9ca3af;

      --accent:#22d3ee;
      --accent2:#0ea5e9;
      --vio:#a78bfa;

      --ok:#4ade80;
      --warn:#facc15;
      --bad:#fb7185;
      --info:#38bdf8;

      --shadow: 0 18px 45px rgba(0,0,0,.65);
      --shadow2: 0 12px 28px rgba(0,0,0,.55);
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:
        radial-gradient(circle at 20% 0%, rgba(56,189,248,.18) 0, transparent 50%),
        radial-gradient(circle at 80% 0%, rgba(167,139,250,.14) 0, transparent 55%),
        radial-gradient(circle at 50% 120%, rgba(14,165,233,.13) 0, transparent 55%),
        linear-gradient(180deg, #020617, #020617);
      color:var(--txt);
      -webkit-font-smoothing: antialiased;
    }

    /* =========================================================
       HEADER FIXO (bloque premium)
    ========================================================= */
    .topbar{
      position:sticky;
      top:0;
      z-index:50;
      backdrop-filter: blur(18px);
      background: linear-gradient(135deg, rgba(2,6,23,.96), rgba(2,6,23,.82));
      border-bottom:1px solid rgba(148,163,184,.12);
      box-shadow: 0 12px 32px rgba(0,0,0,.55);
    }

    .topbar-inner{
      max-width:980px;
      margin:0 auto;
      padding:12px 14px 10px;
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
    }

    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      min-width: 220px;
    }

    .logo{
      height:38px;
      width:auto;
      filter: drop-shadow(0 0 12px rgba(56,189,248,.35));
    }

    .brand-title{
      display:flex;
      flex-direction:column;
      line-height:1.05;
    }
    .brand-title b{
      font-size:15px;
      letter-spacing:.03em;
    }
    .brand-title span{
      font-size:11px;
      color:var(--muted);
      letter-spacing:.06em;
      margin-top:2px;
    }

    .inst-mini{
      flex:1;
      display:flex;
      flex-direction:column;
      gap:6px;
      align-items:flex-start;
    }

    .inst-mini .code{
      font-size:11px;
      letter-spacing:.18em;
      color:rgba(229,231,235,.75);
      text-transform:uppercase;
    }
    .inst-mini .name{
      font-size:15px;
      font-weight:800;
      letter-spacing:.02em;
      text-shadow: 0 0 14px rgba(56,189,248,.18);
    }
    .inst-mini .loc{
      font-size:12px;
      color:#7dd3fc;
      display:flex;
      align-items:center;
      gap:7px;
    }
    .inst-mini .loc .pin{ font-size:16px; }

    .status-wrap{
      display:flex;
      flex-direction:column;
      align-items:flex-end;
      gap:6px;
      min-width: 170px;
    }

    .pill{
      padding:7px 14px;
      border-radius:999px;
      display:inline-flex;
      align-items:center;
      gap:8px;
      font-size:12px;
      border:1px solid rgba(148,163,184,.35);
      background: rgba(15,23,42,.85);
      font-weight:800;
      text-transform:uppercase;
      letter-spacing:.09em;
      box-shadow: 0 0 22px rgba(56,189,248,.12);
    }

    .pill .dot{
      width:9px; height:9px;
      border-radius:50%;
    }

    .ok{ border-color: rgba(74,222,128,.55); color:#bbf7d0;}
    .ok .dot{ background: var(--ok); box-shadow: 0 0 10px rgba(74,222,128,.9);}

    .warn{ border-color: rgba(250,204,21,.55); color:#fef3c7;}
    .warn .dot{ background: var(--warn); box-shadow: 0 0 10px rgba(250,204,21,.9);}

    .bad{ border-color: rgba(251,113,133,.7); color:#fee2e2;}
    .bad .dot{ background: var(--bad); box-shadow: 0 0 12px rgba(251,113,133,.95);}

    .info{ border-color: rgba(56,189,248,.55); color:#e0f2fe;}
    .info .dot{ background: var(--info); box-shadow: 0 0 12px rgba(56,189,248,.9);}

    .caption{
      font-size:11px;
      color: var(--muted);
      text-align:right;
      max-width:200px;
    }

    /* =========================================================
       CONTENIDO GENERAL
    ========================================================= */
    .wrap{
      max-width:980px;
      margin: 18px auto;
      padding: 0 14px 48px;
      display:flex;
      flex-direction:column;
      gap:16px;
    }

    .card{
      border-radius:18px;
      padding:16px;
      background:
        radial-gradient(circle at 0% 0%, rgba(56,189,248,.10) 0, transparent 55%),
        radial-gradient(circle at 100% 0%, rgba(167,139,250,.10) 0, transparent 55%),
        linear-gradient(135deg, rgba(7,16,34,.92), rgba(10,21,48,.85));
      border:1px solid var(--border);
      box-shadow: var(--shadow);
    }

    .title{
      font-size:16px;
      font-weight:900;
      margin:0;
      letter-spacing:.02em;
    }
    .sub{
      margin-top:6px;
      font-size:12px;
      color: var(--muted);
      line-height:1.45;
    }

    /* =========================================================
       PASO 1: SELECTOR DE ACCI√ìN (las preguntas)
    ========================================================= */
    .action-grid{
      margin-top:14px;
      display:grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap:12px;
    }
    @media(max-width:720px){ .action-grid{ grid-template-columns:1fr; } }

    .action{
      cursor:pointer;
      border-radius:16px;
      padding:14px 14px 12px;
      background:
        radial-gradient(circle at 10% 0%, rgba(56,189,248,.18) 0, transparent 55%),
        linear-gradient(135deg, rgba(2,6,23,.8), rgba(7,16,34,.9));
      border:1px solid var(--border2);
      box-shadow: var(--shadow2);
      transition: transform .12s ease, box-shadow .12s ease, border-color .12s ease;
      position:relative;
      overflow:hidden;
    }

    .action:hover{
      transform: translateY(-2px);
      border-color: rgba(56,189,248,.45);
      box-shadow: 0 18px 42px rgba(0,0,0,.65);
    }

    .action:active{ transform: translateY(0); }

    .action .icon{
      font-size:22px;
      margin-bottom:8px;
      filter: drop-shadow(0 0 14px rgba(56,189,248,.22));
    }

    .action b{
      display:block;
      font-size:14px;
      letter-spacing:.02em;
      margin-bottom:3px;
    }
    .action span{
      font-size:12px;
      color: var(--muted);
      line-height:1.35;
    }

    .action .tag{
      position:absolute;
      right:12px;
      top:12px;
      font-size:10px;
      padding:4px 9px;
      border-radius:999px;
      border:1px solid rgba(56,189,248,.25);
      background: rgba(2,6,23,.75);
      color:#7dd3fc;
      letter-spacing:.12em;
      text-transform:uppercase;
      font-weight:800;
    }

    /* =========================================================
       BOTONERA inferior
    ========================================================= */
    .btn-row{
      display:flex;
      gap:10px;
      justify-content:flex-end;
      margin-top:12px;
      flex-wrap:wrap;
    }

    .btn{
      border:none;
      border-radius:999px;
      padding:10px 16px;
      font-size:13px;
      font-weight:800;
      cursor:pointer;
      background: linear-gradient(135deg, var(--accent2), var(--accent));
      color:#02121f;
      box-shadow: 0 12px 30px rgba(14,165,233,.25);
      transition: transform .12s ease, box-shadow .12s ease;
    }
    .btn:hover{
      transform: translateY(-1px);
      box-shadow: 0 16px 40px rgba(14,165,233,.35);
    }

    .btn.secondary{
      background: transparent;
      color: var(--txt);
      border:1px solid rgba(148,163,184,.25);
      box-shadow:none;
    }
    .btn.secondary:hover{
      background: rgba(15,23,42,.75);
    }

    /* =========================================================
       FICHA (paso 2)
    ========================================================= */
    .item{ display:flex; flex-direction:column; margin-bottom:10px; }
    .item .label{
      font-size:11px;
      color: var(--muted);
      letter-spacing:.08em;
      text-transform:uppercase;
      margin-bottom:3px;
    }
    .item .value{ font-size:13px; }

    .mov-item{
      border-radius:14px;
      padding:12px;
      background: rgba(2,6,23,.85);
      border:1px solid rgba(31,41,55,.75);
      margin-bottom:10px;
      font-size:12px;
    }
    .mov-header{
      display:flex;
      justify-content:space-between;
      margin-bottom:6px;
      gap:10px;
    }
    .mov-type{ font-weight:900; letter-spacing:.02em; }
    .mov-date{ font-size:11px; color: var(--muted); }
    .mov-body-line{
      display:flex;
      justify-content:space-between;
      margin-top:4px;
      gap:10px;
    }
    .mov-body-label{ color: var(--muted); min-width:80px; }

    .error-box{
      border-radius:16px;
      padding:14px;
      background: rgba(127,29,29,.55);
      border:1px solid rgba(248,113,113,.75);
      color:#fee2e2;
      font-size:14px;
      box-shadow: 0 18px 45px rgba(0,0,0,.65);
    }

    /* Animaci√≥n suave */
    .fade-in{
      animation: fade .35s ease both;
    }
    @keyframes fade{
      from{ opacity:0; transform: translateY(10px); }
      to{ opacity:1; transform: translateY(0); }
    }

    /* =========================================================
       MODAL MOVIMIENTOS (ESPECTACULAR)
    ========================================================= */
    .modal{
      position:fixed;
      inset:0;
      z-index:90;
      display:none;
      align-items:center;
      justify-content:center;
    }

    .modal.show{ display:flex; }

    .modal-back{
      position:absolute;
      inset:0;
      background: rgba(2,6,23,.82);
      backdrop-filter: blur(10px);
    }

    .modal-box{
      position:relative;
      z-index:91;
      width:min(720px, 92vw);
      border-radius:18px;
      padding:18px;
      background:
        radial-gradient(circle at 0% 0%, rgba(56,189,248,.18) 0, transparent 55%),
        radial-gradient(circle at 100% 0%, rgba(167,139,250,.12) 0, transparent 55%),
        linear-gradient(135deg, rgba(7,16,34,.95), rgba(10,21,48,.90));
      border:1px solid rgba(148,163,184,.24);
      box-shadow: 0 25px 70px rgba(0,0,0,.75);
      animation: pop .22s ease both;
    }

    @keyframes pop{
      from{ transform: scale(.96); opacity:0; }
      to{ transform: scale(1); opacity:1; }
    }

    .modal-head{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:12px;
      margin-bottom:14px;
    }

    .modal-title{
      font-size:16px;
      font-weight:900;
      margin:0;
    }
    .modal-sub{
      margin-top:6px;
      font-size:12px;
      color:var(--muted);
      line-height:1.35;
    }

    .modal-close{
      border:none;
      cursor:pointer;
      border-radius:999px;
      padding:10px 12px;
      background: rgba(2,6,23,.6);
      border:1px solid rgba(148,163,184,.25);
      color: var(--txt);
      font-weight:900;
      transition: .12s transform ease, .12s background ease;
    }
    .modal-close:hover{
      transform: translateY(-1px);
      background: rgba(15,23,42,.75);
    }

    .mov-grid{
      display:grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap:12px;
    }
    @media(max-width:720px){ .mov-grid{ grid-template-columns:1fr; } }

    .mov-opt{
      cursor:pointer;
      border-radius:16px;
      padding:14px;
      border:1px solid rgba(148,163,184,.22);
      background:
        radial-gradient(circle at 10% 0%, rgba(56,189,248,.14) 0, transparent 55%),
        linear-gradient(135deg, rgba(2,6,23,.75), rgba(7,16,34,.88));
      box-shadow: 0 14px 35px rgba(0,0,0,.55);
      transition: transform .12s ease, border-color .12s ease, box-shadow .12s ease;
    }

    .mov-opt:hover{
      transform: translateY(-2px);
      border-color: rgba(56,189,248,.45);
      box-shadow: 0 20px 48px rgba(0,0,0,.65);
    }

    .mov-opt .i{
      font-size:22px;
      margin-bottom:8px;
    }
    .mov-opt b{
      display:block;
      font-size:14px;
      font-weight:900;
      margin-bottom:4px;
      letter-spacing:.02em;
    }
    .mov-opt span{
      font-size:12px;
      color:var(--muted);
      line-height:1.35;
    }

    .mov-opt.entry .i{ filter: drop-shadow(0 0 14px rgba(74,222,128,.25)); }
    .mov-opt.exit  .i{ filter: drop-shadow(0 0 14px rgba(251,113,133,.25)); }
    .mov-opt.other .i{ filter: drop-shadow(0 0 14px rgba(56,189,248,.22)); }

  </style>
</head>

<body>

<!-- HEADER FIJO -->
<div class="topbar">
  <div class="topbar-inner">
    <div class="brand">
      <img src="../img/tmp-quality.png" alt="TMP" class="logo">
      <div class="brand-title">
        <b>TMP ¬∑ QR INFO</b>
        <span>Ficha ¬∑ Movimientos ¬∑ Calibraci√≥n</span>
      </div>
    </div>

    <div class="inst-mini">
      <div class="code" id="heroCode">C√ìDIGO ¬∑ ‚Äî</div>
      <div class="name" id="heroTitle">Cargando instrumento‚Ä¶</div>
      <div class="loc"><span class="pin">üìç</span><span id="heroLoc">‚Äî</span></div>
    </div>

    <div class="status-wrap">
      <div id="heroStatusPill" class="pill info">
        <span class="dot"></span>
        <span id="heroStatusLabel">CARGANDO</span>
      </div>
      <div class="caption" id="heroStatusCaption">Estado de calibraci√≥n</div>
    </div>
  </div>
</div>

<div class="wrap">

  <div id="errorBox" class="error-box" style="display:none"></div>

  <!-- PASO 1: PREGUNTAS -->
  <section id="stepActions" class="card fade-in" style="display:none">
    <h2 class="title">¬øQu√© quieres hacer con este instrumento?</h2>
    <div class="sub">
      Selecciona una opci√≥n. Este panel est√° dise√±ado para usarlo continuamente en taller/laboratorio.
    </div>

    <div class="action-grid">

      <div class="action" id="actFicha">
        <div class="tag">INFO</div>
        <div class="icon">üìÑ</div>
        <b>Ver ficha completa</b>
        <span>Mostrar toda la informaci√≥n del instrumento, estado y plan de calibraci√≥n.</span>
      </div>

      <div class="action" id="actMovimiento">
        <div class="tag">MOV</div>
        <div class="icon">üßæ</div>
        <b>Registrar movimiento</b>
        <span>Entrada / Salida / Pr√©stamo / Reparaci√≥n / Env√≠o externo‚Ä¶</span>
      </div>

      <div class="action" id="actCalibrar">
        <div class="tag">CAL</div>
        <div class="icon">üß™</div>
        <b>Ir a calibraciones</b>
        <span>Acceder al plan, medici√≥n y certificado con el c√≥digo ya cargado.</span>
      </div>

      <div class="action" id="actTraza">
        <div class="tag">LOG</div>
        <div class="icon">üì¶</div>
        <b>Ver trazabilidad</b>
        <span>Mostrar los √∫ltimos movimientos registrados con responsables y destinos.</span>
      </div>

    </div>

    <div class="btn-row">
      <button class="btn secondary" onclick="window.location.href='../home.html'">üè† Volver al panel</button>
    </div>
  </section>

  <!-- PASO 2: FICHA -->
  <section id="stepFicha" class="card fade-in" style="display:none">
    <h2 class="title">Ficha completa del instrumento</h2>
    <div class="sub">Informaci√≥n detallada le√≠da desde Supabase a trav√©s del QR.</div>
    <div id="infoBody"></div>

    <div class="btn-row">
      <button class="btn secondary" id="btnBack1">‚Üê Volver</button>
      <button class="btn" id="btnGoMov1">üßæ Registrar movimiento</button>
      <button class="btn" id="btnGoCal1">üß™ Calibraciones</button>
    </div>
  </section>

  <!-- PASO 3: TRAZABILIDAD -->
  <section id="stepTraza" class="card fade-in" style="display:none">
    <h2 class="title">Trazabilidad reciente</h2>
    <div class="sub">√öltimos movimientos del instrumento (m√°ximo 10).</div>
    <div id="movBody"></div>

    <div class="btn-row">
      <button class="btn secondary" id="btnBack2">‚Üê Volver</button>
      <button class="btn" id="btnGoMov2">üßæ Registrar movimiento</button>
    </div>
  </section>

</div>

<!-- MODAL MOVIMIENTOS -->
<div id="movModal" class="modal">
  <div class="modal-back"></div>

  <div class="modal-box">
    <div class="modal-head">
      <div>
        <h2 class="modal-title">Selecciona el tipo de movimiento</h2>
        <div class="modal-sub">
          El c√≥digo del instrumento ya est√° cargado. Solo elige la operaci√≥n y se abrir√° autom√°ticamente movimiento.html.
        </div>
      </div>
      <button class="modal-close" id="movClose">‚úï</button>
    </div>

    <div class="mov-grid">

      <div class="mov-opt entry" data-tipo="Entrada">
        <div class="i">üì•</div>
        <b>Entrada</b>
        <span>El equipo vuelve al laboratorio o queda almacenado dentro de TMP.</span>
      </div>

      <div class="mov-opt exit" data-tipo="Salida">
        <div class="i">üì§</div>
        <b>Salida</b>
        <span>El equipo se entrega a taller, operario o zona externa para su uso.</span>
      </div>

      <div class="mov-opt other" data-tipo="Pr√©stamo externo">
        <div class="i">ü§ù</div>
        <b>Pr√©stamo externo</b>
        <span>El equipo sale prestado a un cliente o proveedor externo.</span>
      </div>

      <div class="mov-opt other" data-tipo="Revisi√≥n / reparaci√≥n">
        <div class="i">üõ†Ô∏è</div>
        <b>Revisi√≥n / reparaci√≥n</b>
        <span>Se env√≠a para revisi√≥n t√©cnica o reparaci√≥n interna/externa.</span>
      </div>

      <div class="mov-opt other" data-tipo="Env√≠o a calibraci√≥n externa">
        <div class="i">üì¶</div>
        <b>Env√≠o a calibraci√≥n externa</b>
        <span>Se env√≠a a laboratorio externo para recalibraci√≥n / certificaci√≥n.</span>
      </div>

    </div>

    <div class="btn-row" style="margin-top:14px;">
      <button class="btn secondary" id="movCancel">Cancelar</button>
    </div>

  </div>
</div>

<script type="module" src="../config.mjs"></script>

<script type="module">
  const supa = window.supabase;

  let codigo = new URLSearchParams(window.location.search).get("codigo");
  if (!codigo) {
    const parts = location.pathname.split("/").filter(Boolean);
    const last = parts[parts.length - 1];
    if (last && !last.includes(".html")) codigo = decodeURIComponent(last);
  }

  function showError(msg){
    const b = document.getElementById("errorBox");
    b.style.display = "block";
    b.innerHTML = `<h2 style="margin:0 0 6px;">Error</h2><p style="margin:0;opacity:.9">${msg}</p>`;
  }

  const fDateShort = iso => {
    if (!iso) return "‚Äî";
    const d = new Date(iso);
    if (isNaN(d)) return "‚Äî";
    return String(d.getDate()).padStart(2,"0")+"/"+String(d.getMonth()+1).padStart(2,"0")+"/"+d.getFullYear();
  };

  const fDateTime = iso => {
    if (!iso) return "‚Äî";
    const d = new Date(iso);
    return `${String(d.getDate()).padStart(2,"0")}/${String(d.getMonth()+1).padStart(2,"0")}/${d.getFullYear()} ${String(d.getHours()).padStart(2,"0")}:${String(d.getMinutes()).padStart(2,"0")}`;
  };

  const daysDiff = iso =>{
    if (!iso) return null;
    const d = new Date(iso);
    if (isNaN(d)) return null;
    return Math.round((d - new Date())/86400000);
  };

  function computeEstado(iso){
    const diff = daysDiff(iso);
    if (diff === null) return { clase:"info", texto:"Sin fecha", detalle:"Fecha no asignada", icono:"üõà", dias:null };
    if (diff < 0) return { clase:"bad", texto:"Fuera", detalle:"Vencida", icono:"‚õî", dias:diff };
    if (diff <= 30) return { clase:"warn", texto:"Pr√≥xima", detalle:"Planificar", icono:"‚ö†", dias:diff };
    return { clase:"ok", texto:"En regla", detalle:"Correcta", icono:"‚úî", dias:diff };
  }

  function showStep(stepId){
    ["stepActions","stepFicha","stepTraza"].forEach(id=>{
      const el = document.getElementById(id);
      if (el) el.style.display = (id===stepId ? "block" : "none");
    });
  }

  function openMovModal(){
    document.getElementById("movModal").classList.add("show");
  }

  function closeMovModal(){
    document.getElementById("movModal").classList.remove("show");
  }

  async function main(){
    if (!codigo) return showError("No se indic√≥ c√≥digo.");

    const { data: inst, error } = await supa
      .from("instrumentos")
      .select("*")
      .eq("codigo", codigo)
      .maybeSingle();

    if (error) return showError("Error consultando DB.");
    if (!inst) return showError(`No existe el c√≥digo ${codigo}`);

    // movimientos para ubicaci√≥n
    const { data: movs } = await supa
      .from("movimientos")
      .select("*")
      .eq("codigo_instrumento", codigo)
      .order("fecha", { ascending:false })
      .limit(1);

    let ubic = "Sin movimientos registrados";
    if (movs && movs.length>0){
      ubic = movs[0].destino || ubic;
    }

    // topbar
    document.getElementById("heroCode").textContent = `C√ìDIGO ¬∑ ${codigo}`;
    document.getElementById("heroTitle").textContent = inst.descripcion || "Instrumento";
    document.getElementById("heroLoc").textContent = ubic;

    // estado
    const prox = inst.fecha_proxima_calibracion || null;
    const est = computeEstado(prox);
    const pill = document.getElementById("heroStatusPill");
    pill.className = "pill " + est.clase;
    document.getElementById("heroStatusLabel").textContent = `${est.icono} ${est.texto}`;
    document.getElementById("heroStatusCaption").textContent =
      est.detalle +
      (est.dias!==null ? (est.dias<0 ? ` ¬∑ hace ${Math.abs(est.dias)} d√≠as` : ` ¬∑ en ${est.dias} d√≠as`) : "");

    // mostrar step 1
    document.getElementById("stepActions").style.display="block";
    showStep("stepActions");

    // ficha completa
    document.getElementById("infoBody").innerHTML = `
      <div class="item"><span class="label">Descripci√≥n</span><span class="value">${inst.descripcion || "-"}</span></div>
      <div class="item"><span class="label">Fabricante</span><span class="value">${inst.fabricante || "-"}</span></div>
      <div class="item"><span class="label">Rango / Especificaci√≥n</span><span class="value">${inst.rango || "-"}</span></div>
      <div class="item"><span class="label">Precisi√≥n</span><span class="value">${inst.precision || "-"}</span></div>
      <div class="item"><span class="label">Tipo calibraci√≥n</span><span class="value">${inst.tipo_calibracion || "-"}</span></div>
      <div class="item"><span class="label">√öltima calibraci√≥n</span><span class="value">${inst.fecha_ultima_calibracion ? fDateShort(inst.fecha_ultima_calibracion) : "-"}</span></div>
      <div class="item"><span class="label">Pr√≥xima calibraci√≥n</span><span class="value">${inst.fecha_proxima_calibracion ? fDateShort(inst.fecha_proxima_calibracion) : "-"}</span></div>
      <div class="item"><span class="label">Observaciones</span><span class="value">${(inst.observaciones && inst.observaciones.trim()) ? inst.observaciones : "Propiedad de Talleres Mec√°nicos Paramio"}</span></div>
    `;

    // trazabilidad
    const { data: movList } = await supa
      .from("movimientos")
      .select("*")
      .eq("codigo_instrumento", codigo)
      .order("fecha",{ascending:false})
      .limit(10);

    const movBody = document.getElementById("movBody");
    if (!movList || movList.length===0){
      movBody.innerHTML = `<div class="sub">No existen movimientos registrados.</div>`;
    } else {
      movBody.innerHTML = movList.map(m=>`
        <div class="mov-item">
          <div class="mov-header">
            <div class="mov-type">${m.tipo_movimiento}</div>
            <div class="mov-date">${fDateTime(m.fecha)}</div>
          </div>

          <div class="mov-body-line">
            <span class="mov-body-label">Responsable</span>
            <span>${m.responsable || "-"}</span>
          </div>

          ${m.operario1 ? `<div class="mov-body-line"><span class="mov-body-label">Operario 1</span><span style="color:#7dd3fc;font-weight:700">${m.operario1}</span></div>` : ""}
          ${m.operario2 ? `<div class="mov-body-line"><span class="mov-body-label">Operario 2</span><span style="color:#ff9f40;font-weight:700">${m.operario2}</span></div>` : ""}

          <div class="mov-body-line">
            <span class="mov-body-label">Destino</span>
            <span>${m.destino || "-"}</span>
          </div>

          ${m.observaciones ? `
          <div class="mov-body-line">
            <span class="mov-body-label">Obs.</span>
            <span>${m.observaciones.replace(/\n/g,"<br>")}</span>
          </div>` : ""}
        </div>
      `).join("");
    }

    // acciones
    document.getElementById("actFicha").onclick = ()=> showStep("stepFicha");
    document.getElementById("actTraza").onclick = ()=> showStep("stepTraza");

    document.getElementById("actMovimiento").onclick = openMovModal;

    document.getElementById("actCalibrar").onclick = ()=>{
      window.location.href = `../TMP_Calibraciones_Lab.html?codigo=${encodeURIComponent(codigo)}`;
    };

    // back buttons
    document.getElementById("btnBack1").onclick = ()=> showStep("stepActions");
    document.getElementById("btnBack2").onclick = ()=> showStep("stepActions");

    // CTA inside ficha/traza
    document.getElementById("btnGoMov1").onclick = openMovModal;
    document.getElementById("btnGoMov2").onclick = openMovModal;

    document.getElementById("btnGoCal1").onclick = ()=>{
      window.location.href = `../TMP_Calibraciones_Lab.html?codigo=${encodeURIComponent(codigo)}`;
    };

    // modal close
    document.getElementById("movClose").onclick = closeMovModal;
    document.getElementById("movCancel").onclick = closeMovModal;
    document.querySelector("#movModal .modal-back").onclick = closeMovModal;

    // opciones movimiento
    document.querySelectorAll(".mov-opt").forEach(opt=>{
      opt.onclick = ()=>{
        const tipo = opt.dataset.tipo || "";
        window.location.href = `../movimiento.html?codigo=${encodeURIComponent(codigo)}&tipo=${encodeURIComponent(tipo)}`;
      };
    });

    // ESC para cerrar modal
    window.addEventListener("keydown", (e)=>{
      if (e.key === "Escape") closeMovModal();
    });
  }

  main();
</script>

</body>
</html>

