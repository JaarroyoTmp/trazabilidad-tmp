<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>TMP ¬∑ Ficha del instrumento</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    :root{
      --bg:#020617;
      --bg-grad1:#0f172a;
      --bg-grad2:#020617;
      --card:#020617;
      --border:#1f2937;
      --txt:#e5e7eb;
      --muted:#9ca3af;
      --accent:#22d3ee;
      --danger:#fb7185;
      --warn:#facc15;
      --ok:#4ade80;

      --op1-bg: rgba(56,189,248,0.25);
      --op1-bd: rgba(56,189,248,.65);
      --op1-tx: #7dd3fc;

      --op2-bg: rgba(255,159,64,0.25);
      --op2-bd: rgba(255,159,64,.65);
      --op2-tx: #ff9f40;
    }

    *{ box-sizing:border-box; }

    body{
      margin:0;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:
        radial-gradient(circle at 0% 0%, #0f172a 0, transparent 55%),
        radial-gradient(circle at 100% 0%, #0b1120 0, transparent 55%),
        radial-gradient(circle at 50% 110%, #0f172a 0, transparent 60%),
        linear-gradient(180deg,var(--bg-grad1),var(--bg-grad2));
      color:var(--txt);
    }

    #volverHome{
      position:fixed;
      right:14px;
      bottom:16px;
      z-index:40;
      border:none;
      border-radius:999px;
      padding:8px 16px;
      font-size:14px;
      cursor:pointer;
      background:#0f172a;
      color:#e5e7eb;
      border:1px solid rgba(148,163,184,.4);
    }

    header{
      display:flex;
      align-items:center;
      gap:12px;
      padding:14px 16px;
      border-bottom:1px solid rgba(148,163,184,.25);
      background:linear-gradient(135deg,#020617,#020617f0);
      position:sticky;
      top:0;
      z-index:20;
      backdrop-filter:blur(18px);
    }

    .logo{
      height:40px;
      width:auto;
    }

    .wrap{
      max-width:760px;
      margin:18px auto;
      padding:0 16px 40px;
      display:flex;
      flex-direction:column;
      gap:14px;
    }

    .card{
      border-radius:16px;
      padding:14px;
      background:rgba(2,6,23,.65);
      border:1px solid rgba(31,41,55,.9);
      box-shadow:0 16px 35px rgba(15,23,42,.95);
    }

    h2{ margin:0 0 6px; font-size:16px; }
    .card-sub{ font-size:12px; color:var(--muted); margin-bottom:10px; }

    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      border:none;
      cursor:pointer;
      border-radius:12px;
      padding:10px 14px;
      font-weight:700;
      font-size:13px;
      background:rgba(34,211,238,.15);
      border:1px solid rgba(56,189,248,.35);
      color:#e0f2fe;
      text-decoration:none;
    }

    .cert-grid{
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      align-items:flex-start;
    }

    .qr-box{
      width:140px;
      padding:10px;
      border-radius:14px;
      background:rgba(15,23,42,.85);
      border:1px solid rgba(148,163,184,.25);
      text-align:center;
    }

    .qr-box canvas{
      max-width:120px;
      height:auto;
      margin:0 auto;
      border-radius:10px;
    }

    .muted{ color:var(--muted); font-size:12px; }

    .error-box{
      border-radius:14px;
      padding:12px;
      background:#3f1d1d;
      border:1px solid #7f1d1d;
      color:#fee2e2;
      font-size:14px;
    }
  </style>
</head>

<body>

<button id="volverHome" onclick="window.location.href='../home.html'">üè† Volver al panel</button>

<header>
  <img src="../img/tmp-quality.png" alt="TMP" class="logo">
  <div>
    <h1 style="margin:0;font-size:18px;">Ficha del instrumento</h1>
    <span id="subTitle" style="font-size:12px;color:#9ca3af;">Cargando c√≥digo‚Ä¶</span>
  </div>
</header>

<div class="wrap">

  <div id="errorBox" class="error-box" style="display:none"></div>

  <!-- ‚úÖ CERTIFICADO -->
  <section id="certCard" class="card" style="display:none">
    <h2>√öltima calibraci√≥n oficial</h2>
    <div class="card-sub">√öltimo certificado emitido para este instrumento.</div>
    <div id="certBody"></div>
  </section>

</div>

<script type="module" src="../config.mjs"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>

<script type="module">
  const supa = window.supabase;

  let codigo = new URLSearchParams(window.location.search).get("codigo");

  document.getElementById("subTitle").textContent =
    codigo ? `C√≥digo: ${codigo}` : "C√≥digo no especificado";

  function showError(msg){
    const b = document.getElementById("errorBox");
    b.style.display = "block";
    b.innerHTML = `<h2>Error</h2><p>${msg}</p>`;
  }

  function renderQR(containerId, url){
    const el = document.getElementById(containerId);
    if (!el || !url) return;
    el.innerHTML = "";
    new QRCode(el, { text:url, width:120, height:120 });
  }

  async function main(){
    if (!codigo) return showError("No se indic√≥ c√≥digo.");

    // ‚úÖ BUSCAR √öLTIMO CERTIFICADO POR JSON: datos.instrumento.codigo
    const { data: certs, error } = await supa
      .from("certificados")
      .select("numero, certificado_pdf_url, datos, created_at")
      .order("created_at", { ascending:false });

    if (error) return showError("Error buscando certificados.");

    // Filtrar en JS porque Supabase no filtra jsonb f√°cil en cliente
    const cert = (certs || []).find(c => {
      return c?.datos?.instrumento?.codigo == codigo;
    });

    if (!cert){
      document.getElementById("certCard").style.display = "block";
      document.getElementById("certBody").innerHTML = `
        <p class="muted">No existe ning√∫n certificado para este instrumento todav√≠a.</p>
      `;
      return;
    }

    const pdfURL = cert.certificado_pdf_url || null;
    const verifURL = cert?.datos?.qr?.url_verificacion || null;

    document.getElementById("certCard").style.display = "block";
    document.getElementById("certBody").innerHTML = `
      <div class="cert-grid">
        <div style="flex:1; min-width:240px;">
          <p><strong>N√∫mero:</strong> ${cert.numero}</p>
          <p><strong>Emitido:</strong> ${cert.created_at ? cert.created_at.slice(0,10) : "‚Äî"}</p>

          ${pdfURL ? `<a class="btn" href="${pdfURL}" target="_blank">üìÑ Abrir PDF</a>` : `<p class="muted">Sin PDF</p>`}
          ${verifURL ? `<a class="btn" href="${verifURL}" target="_blank" style="margin-left:8px;">‚úÖ Verificaci√≥n</a>` : ""}
        </div>

        <div class="qr-box">
          <div style="font-size:11px;color:#9ca3af;margin-bottom:8px;">QR ¬∑ PDF</div>
          <div id="qrPdf"></div>
        </div>

        <div class="qr-box">
          <div style="font-size:11px;color:#9ca3af;margin-bottom:8px;">QR ¬∑ Verificaci√≥n</div>
          <div id="qrVerif"></div>
        </div>
      </div>
    `;

    if (pdfURL) renderQR("qrPdf", pdfURL);
    if (verifURL) renderQR("qrVerif", verifURL);
  }

  main();
</script>

</body>
</html>
