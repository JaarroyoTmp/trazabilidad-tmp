<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>TMP ¬∑ Ficha del instrumento</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
  body{
    margin:0;
    font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
    background:#0d1117;
    color:#f0f6fc;
  }

  header{
    display:flex;
    align-items:center;
    gap:14px;
    padding:14px 16px;
    background:#161b22;
    border-bottom:1px solid #30363d;
  }
  .logo{height:40px}
  .h-titles{display:flex;flex-direction:column}
  .h-titles h1{margin:0;font-size:18px}
  .h-titles span{font-size:12px;color:#8b949e}

  .wrap{max-width:720px;margin:18px auto 32px;padding:0 16px}

  .card{
    background:#161b22;
    border-radius:16px;
    border:1px solid #30363d;
    padding:16px 14px;
    margin-bottom:14px;
  }

  .card h2{
    margin:0 0 10px;
    font-size:16px;
    color:#58a6ff;
  }

  .item{font-size:14px;margin:4px 0}
  .label{color:#8b949e;}

  .status-tag{
    display:inline-flex;
    align-items:center;
    gap:6px;
    padding:4px 10px;
    border-radius:999px;
    font-size:12px;
    font-weight:600;
  }
  .dot{
    width:8px;height:8px;border-radius:50%;
  }

  .ok{background:#12261a;color:#3fb950;}
  .ok .dot{background:#3fb950;}

  .warn{background:#2b2113;color:#d29922;}
  .warn .dot{background:#d29922;}

  .bad{background:#2b1517;color:#f85149;}
  .bad .dot{background:#f85149;}

  .muted{
    font-size:12px;
    color:#8b949e;
    margin-top:4px;
  }

  .mov-item{
    font-size:13px;
    margin:6px 0;
    padding-bottom:6px;
    border-bottom:1px dashed #30363d;
  }
  .mov-item:last-child{
    border-bottom:none;
  }

  .error-box{
    text-align:center;
    padding:24px 18px;
  }

  #volverHome{
    position:fixed;
    bottom:18px;
    right:18px;
    background:#238636;
    padding:12px 18px;
    font-size:14px;
    border-radius:12px;
    border:1px solid #2ea043;
    cursor:pointer;
    color:white;
    box-shadow:0 0 10px rgba(0,0,0,.4);
  }
  #volverHome:hover{
    background:#2ea043;
  }

</style>
</head>

<body>

<button id="volverHome" onclick="window.location.href='../home.html'">üè† Volver</button>

<header>
  <img src="../img/tmp-quality.png" alt="TMP" class="logo">
  <div class="h-titles">
    <h1>Ficha del instrumento</h1>
    <span id="subTitle">Cargando c√≥digo‚Ä¶</span>
  </div>
</header>

<div class="wrap">

  <div id="errorBox" class="card error-box" style="display:none"></div>

  <div id="infoCard" class="card" style="display:none">
    <h2>Informaci√≥n b√°sica</h2>
    <div id="infoBody"></div>
  </div>

  <div id="calCard" class="card" style="display:none">
    <h2>Estado de calibraci√≥n</h2>
    <div id="calBody"></div>
  </div>

  <div id="movCard" class="card" style="display:none">
    <h2>√öltimos movimientos</h2>
    <div id="movBody"></div>
    <p class="muted" id="movHint"></p>
  </div>

</div>

<script>
// ---------------------------
//   CONFIG SUPABASE
// ---------------------------
const SUPABASE_URL = "https://uukxdslfmxesufuxjzvt.supabase.co";
const SUPABASE_ANON_KEY =
"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV1a3hkc2xmbXhlc3VmdXhqenZ0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjExMjg5MjksImV4cCI6MjA3NjcwNDkyOX0.7bmDUEQTfl6Y5jdzORyFZUFtOs7GM0dNdfp1zsURkWw";

const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);


// ---------------------------
//   OBTENER C√ìDIGO DESDE URL
// ---------------------------
let codigo = new URLSearchParams(window.location.search).get("codigo");

// patr√≥n /qr/12345
if (!codigo) {
  const parts = window.location.pathname.split("/").filter(Boolean);
  const last = parts[parts.length - 1];

  if (last && !last.includes(".html")) {
    codigo = decodeURIComponent(last);
  }
}

document.getElementById("subTitle").textContent =
  codigo ? `C√≥digo: ${codigo}` : "C√≥digo no especificado";


// ---------------------------
//   FUNCI√ìN PRINCIPAL
// ---------------------------
async function main(){

  if (!codigo){
    showError("No se ha indicado un c√≥digo en la URL.");
    return;
  }

  // Buscar instrumento
  const { data: inst, error: e1 } = await supa
    .from("instrumentos")
    .select("*")
    .eq("codigo", codigo)
    .maybeSingle();

  if (e1){
    showError("Error consultando la base de datos.");
    return;
  }

  if (!inst){
    showError(`No existe ning√∫n instrumento con c√≥digo <b>${codigo}</b>`);
    return;
  }


  // ---------------------------
  //   INFORMACI√ìN B√ÅSICA
  // ---------------------------
  const infoCard = document.getElementById("infoCard");
  const infoBody = document.getElementById("infoBody");
  infoCard.style.display = "block";

  infoBody.innerHTML = `
    <div class="item"><span class="label">Descripci√≥n:</span> ${inst.descripcion || "-"}</div>
    <div class="item"><span class="label">Fabricante:</span> ${inst.fabricante || "-"}</div>
    <div class="item"><span class="label">Rango:</span> ${inst.rango || "-"}</div>
    <div class="item"><span class="label">Ubicaci√≥n actual:</span> ${inst.ubicacion_actual || "-"}</div>
    <div class="item"><span class="label">Tipo de calibraci√≥n:</span> ${inst.tipo_calibracion || "-"}</div>
  `;


  // ---------------------------
  //   ESTADO DE CALIBRACI√ìN
  // ---------------------------
  const calCard = document.getElementById("calCard");
  const calBody = document.getElementById("calBody");
  calCard.style.display = "block";

  const ult = inst.fecha_calibracion;
  const prox = inst.fecha_proxima_calibracion;

  let estadoClase = "";
  let estadoTexto = "";
  let detalle = "";

  if (!prox){
    estadoClase = "warn";
    estadoTexto = "Sin pr√≥xima calibraci√≥n";
    detalle = "Este instrumento no tiene fecha futura asignada.";
  } else {
    const hoy = new Date();
    const fProx = new Date(prox);
    const diff = (fProx - hoy) / (1000*60*60*24);

    if (diff < 0){
      estadoClase = "bad";
      estadoTexto = "FUERA DE CALIBRACI√ìN";
      detalle = "El equipo debe inmovilizarse hasta nueva calibraci√≥n.";
    } else if (diff <= 30){
      estadoClase = "warn";
      estadoTexto = "Pr√≥xima a vencer";
      detalle = "Planificar calibraci√≥n en breve.";
    } else {
      estadoClase = "ok";
      estadoTexto = "En regla";
      detalle = "Instrumento dentro del plazo de calibraci√≥n.";
    }
  }

  calBody.innerHTML = `
    <div class="item"><span class="label">√öltima calibraci√≥n:</span> ${ult || "-"}</div>
    <div class="item"><span class="label">Pr√≥xima calibraci√≥n:</span> ${prox || "-"}</div>
    <div class="item" style="margin-top:8px">
      <span class="status-tag ${estadoClase}">
        <span class="dot"></span>
        ${estadoTexto}
      </span>
    </div>
    <p class="muted">${detalle}</p>
  `;


  // ---------------------------
  //   HIST√ìRICO MOVIMIENTOS
  // ---------------------------
  const movCard = document.getElementById("movCard");
  const movBody = document.getElementById("movBody");
  const movHint = document.getElementById("movHint");

  movCard.style.display = "block";

  const { data: movs, error: e2 } = await supa
    .from("movimientos")
    .select("*")
    .eq("codigo_instrumento", codigo)
    .order("fecha", { ascending:false })
    .limit(10);

  if (e2){
    movBody.innerHTML = `<div class="muted">No se han podido cargar movimientos.</div>`;
    return;
  }

  if (!movs.length){
    movBody.innerHTML = `<div class="muted">No existen movimientos para este instrumento.</div>`;
  } else {

    movBody.innerHTML = movs.map(m => `
      <div class="mov-item">
        <div><span class="label">Fecha:</span> ${new Date(m.fecha).toLocaleString()}</div>
        <div><span class="label">Tipo:</span> ${m.tipo_movimiento || "-"}</div>
        <div><span class="label">Responsable:</span> ${m.responsable || "-"}</div>
        <div><span class="label">Destino:</span> ${m.destino || "-"}</div>
        ${m.observaciones ? `<div><span class="label">Obs.:</span> ${m.observaciones}</div>` : ""}
      </div>
    `).join("");
  }

  movHint.textContent = "Se muestran los 10 movimientos m√°s recientes.";

}


// ---------------------------
//   ERROR
// ---------------------------
function showError(msg){
  const box = document.getElementById("errorBox");
  box.style.display = "block";
  box.innerHTML = `
    <h2>Error</h2>
    <p>${msg}</p>
    <p class="muted">Verifica el c√≥digo o contacta con Metrolog√≠a.</p>
  `;
}

main();
</script>

</body>
</html>
