<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>TMP ¬∑ Ficha del instrumento</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    :root{
      --bg:#020617;
      --bg-grad1:#0f172a;
      --bg-grad2:#020617;
      --card:#020617;
      --card-soft:#02081a;
      --border:#1f2937;
      --txt:#e5e7eb;
      --muted:#9ca3af;
      --accent:#22d3ee;
      --accent-soft:#0ea5e9;
      --danger:#fb7185;
      --warn:#facc15;
      --ok:#4ade80;

      --op1-bg: rgba(56,189,248,0.25);
      --op1-bd: rgba(56,189,248,.65);
      --op1-tx: #7dd3fc;

      --op2-bg: rgba(255,159,64,0.25);
      --op2-bd: rgba(255,159,64,.65);
      --op2-tx: #ff9f40;
    }

    *{ box-sizing:border-box; }

    body{
      margin:0;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:
        radial-gradient(circle at 0% 0%, #0f172a 0, transparent 55%),
        radial-gradient(circle at 100% 0%, #0b1120 0, transparent 55%),
        radial-gradient(circle at 50% 110%, #0f172a 0, transparent 60%),
        linear-gradient(180deg,var(--bg-grad1),var(--bg-grad2));
      color:var(--txt);
      -webkit-font-smoothing:antialiased;
    }

    #volverHome{
      position:fixed;
      right:14px;
      bottom:16px;
      z-index:40;
      border:none;
      border-radius:999px;
      padding:8px 16px;
      font-size:14px;
      cursor:pointer;
      background:#0f172a;
      color:#e5e7eb;
      border:1px solid rgba(148,163,184,.4);
      box-shadow:0 10px 25px rgba(15,23,42,.9);
    }

    #volverHome:hover{ background:#111827; }

    header{
      display:flex;
      align-items:center;
      gap:12px;
      padding:14px 16px;
      border-bottom:1px solid rgba(148,163,184,.25);
      background:
        radial-gradient(circle at 0% 0%, rgba(56,189,248,.22) 0, transparent 60%),
        radial-gradient(circle at 100% 0%, rgba(59,130,246,.25) 0, transparent 60%),
        linear-gradient(135deg,#020617,#020617f0);
      position:sticky;
      top:0;
      z-index:20;
      backdrop-filter:blur(18px);
    }

    .logo{
      height:40px;
      width:auto;
      filter:drop-shadow(0 0 8px rgba(56,189,248,.45));
    }

    .h-titles{ display:flex; flex-direction:column; }

    .h-titles h1{
      margin:0;
      font-size:18px;
      letter-spacing:.04em;
    }

    .h-titles span{
      font-size:12px;
      color:var(--muted);
    }

    .wrap{
      max-width:760px;
      margin:18px auto;
      padding:0 16px 40px;
      display:flex;
      flex-direction:column;
      gap:14px;
    }

    .hero-card{
      position:relative;
      border-radius:18px;
      padding:14px;
      background:
        radial-gradient(circle at 0% 0%, rgba(56,189,248,.18) 0, transparent 55%),
        radial-gradient(circle at 100% 0%, rgba(59,130,246,.20) 0, transparent 60%),
        linear-gradient(135deg,#020617,#020617);
      border:1px solid rgba(148,163,184,.35);
      box-shadow:
        0 18px 45px rgba(15,23,42,.95),
        0 0 40px rgba(56,189,248,.18);
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
    }

    .hero-main{ max-width:70%; }

    .hero-code{
      font-size:12px;
      text-transform:uppercase;
      letter-spacing:.18em;
      color:var(--muted);
      margin-bottom:4px;
    }

    .hero-title{
      font-size:18px;
      font-weight:700;
      margin-bottom:4px;
    }

    .hero-location{
      margin-top:8px;
      font-size:16px;
      font-weight:700;
      color:#7dd3fc;
      display:flex;
      align-items:center;
      gap:8px;
      text-shadow:0 0 8px rgba(125,213,252,0.35);
    }
    .hero-location .pin{ font-size:20px; }

    .hero-status{
      display:flex;
      flex-direction:column;
      align-items:flex-end;
      gap:6px;
      font-size:12px;
    }

    .status-pill{
      padding:6px 14px;
      border-radius:999px;
      display:inline-flex;
      align-items:center;
      gap:6px;
      font-size:12px;
      border:1px solid rgba(148,163,184,.5);
      background:rgba(15,23,42,.9);
      font-weight:700;
      text-transform:uppercase;
      letter-spacing:.1em;
    }

    .status-pill .dot{ width:8px; height:8px; border-radius:50%; }

    .status-ok{ border-color:rgba(74,222,128,.6); color:#bbf7d0; box-shadow:0 0 14px rgba(74,222,128,.6);}
    .status-ok .dot{background:var(--ok);}

    .status-warn{ border-color:rgba(250,204,21,.6); color:#fef3c7; box-shadow:0 0 14px rgba(250,204,21,.6);}
    .status-warn .dot{background:var(--warn);}

    .status-bad{ border-color:rgba(248,113,113,.8); color:#fee2e2; box-shadow:0 0 18px rgba(248,113,113,.9);}
    .status-bad .dot{background:var(--danger);}

    .status-info{ border-color:rgba(56,189,248,.6); color:#e0f2fe; box-shadow:0 0 14px rgba(56,189,248,.6);}
    .status-info .dot{background:#38bdf8;}

    .status-caption{ font-size:11px; color:var(--muted); text-align:right; max-width:200px; }

    .hero-observ{
      margin-top:8px;
      padding:10px;
      border-radius:12px;
      background:rgba(15,23,42,.9);
      border:1px solid rgba(148,163,184,.25);
      font-size:12px;
      line-height:1.4;
    }
    .hero-observ .label{ font-weight:600; color:#a5b4fc; }

    .card{
      border-radius:16px;
      padding:14px;
      background:
        radial-gradient(circle at 0% 0%, rgba(15,118,110,.15) 0, transparent 55%),
        linear-gradient(135deg,#020617,#02081a);
      border:1px solid rgba(31,41,55,.9);
      box-shadow:0 16px 35px rgba(15,23,42,.95);
    }

    h2{ margin:0 0 6px; font-size:16px; }
    .card-sub{ font-size:12px; color:var(--muted); margin-bottom:10px; }

    .item{ display:flex; flex-direction:column; margin-bottom:8px; }
    .item .label{ font-size:11px; color:var(--muted); text-transform:uppercase; letter-spacing:.08em; margin-bottom:2px; }
    .item .value{ font-size:13px; }

    .muted{ color:var(--muted); font-size:12px; }

    .error-box{
      border-radius:14px;
      padding:12px;
      background:#3f1d1d;
      border:1px solid #7f1d1d;
      color:#fee2e2;
      font-size:14px;
      box-shadow:0 12px 30px rgba(0,0,0,.65);
    }

    /* Movimientos */
    .mov-item{
      border-radius:12px;
      padding:10px;
      background:#020617;
      border:1px solid rgba(31,41,55,.8);
      margin-bottom:10px;
      font-size:12px;
    }
    .mov-header{ display:flex; justify-content:space-between; margin-bottom:4px; }
    .mov-type{ font-weight:600; }
    .mov-date{ font-size:11px; color:var(--muted); }
    .mov-body-line{ display:flex; justify-content:space-between; margin-top:3px; }
    .mov-body-label{ color:var(--muted); min-width:70px; }

    /* Chips responsables */
    .chip{
      display:inline-flex;
      align-items:center;
      padding:5px 12px;
      border-radius:999px;
      font-size:12px;
      font-weight:600;
      margin-right:6px;
      margin-bottom:6px;
    }
    .chip-op1{
      background:var(--op1-bg);
      border:1px solid var(--op1-bd);
      color:var(--op1-tx);
      box-shadow:0 0 12px rgba(56,189,248,.35);
    }
    .chip-op2{
      background:var(--op2-bg);
      border:1px solid var(--op2-bd);
      color:var(--op2-tx);
      box-shadow:0 0 12px rgba(255,159,64,.35);
    }

    /* NUEVO: Botones PDF */
    .pdf-actions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-bottom:10px;
    }
    .btn{
      border:none;
      cursor:pointer;
      padding:10px 14px;
      border-radius:12px;
      font-weight:700;
      font-size:13px;
      background:rgba(56,189,248,.15);
      border:1px solid rgba(56,189,248,.45);
      color:#e0f2fe;
      box-shadow:0 0 16px rgba(56,189,248,.10);
      transition:.2s;
    }
    .btn:hover{ background:rgba(56,189,248,.24); }
    iframe{
      width:100%;
      height:520px;
      border-radius:12px;
      border:1px solid rgba(148,163,184,.25);
      background:#020617;
    }
  </style>
</head>

<body>

<button id="volverHome" onclick="window.location.href='../home.html'">üè† Volver al panel</button>

<header>
  <img src="../img/tmp-quality.png" alt="TMP" class="logo">
  <div class="h-titles">
    <h1>Ficha del instrumento</h1>
    <span id="subTitle">Cargando c√≥digo‚Ä¶</span>
  </div>
</header>

<div class="wrap">

  <div id="errorBox" class="error-box" style="display:none"></div>

  <!-- HERO -->
  <section id="hero" class="hero-card" style="display:none">
    <div class="hero-main">
      <div class="hero-code" id="heroCode">C√ìDIGO ‚Äî</div>
      <div class="hero-title" id="heroTitle">Instrumento</div>
      <div id="heroSub">‚Äî</div>
    </div>

    <div class="hero-status">
      <div id="heroStatusPill" class="status-pill"><span class="dot"></span><span id="heroStatusLabel">‚Äî</span></div>
      <div class="status-caption" id="heroStatusCaption">Estado</div>
    </div>
  </section>

  <section id="heroObserv" class="hero-observ" style="display:none"></section>

  <!-- Tarjeta de responsables actuales -->
  <section id="responsablesCard" class="card" style="display:none">
    <h2>Responsables actuales</h2>
    <div class="card-sub">Asignados en la √∫ltima salida del instrumento.</div>
    <div id="respBody"></div>
  </section>

  <!-- Informaci√≥n b√°sica -->
  <section id="infoCard" class="card" style="display:none">
    <h2>Informaci√≥n b√°sica</h2>
    <div class="card-sub">Datos generales del instrumento le√≠do por QR.</div>
    <div id="infoBody"></div>
  </section>

  <!-- Estado calibraci√≥n -->
  <section id="calCard" class="card" style="display:none">
    <h2>Estado de calibraci√≥n</h2>
    <div class="card-sub">Situaci√≥n frente al plan de calibraci√≥n.</div>
    <div id="calBody"></div>
  </section>

  <!-- ‚úÖ NUEVO: √öLTIMO CERTIFICADO -->
  <section id="certCard" class="card" style="display:none">
    <h2>√öltimo certificado emitido</h2>
    <div class="card-sub">Certificado oficial PDF guardado en Supabase Storage.</div>
    <div id="certBody"></div>
  </section>

  <!-- Movimientos -->
  <section id="movCard" class="card" style="display:none">
    <h2>√öltimos movimientos</h2>
    <div class="card-sub">Trazabilidad reciente.</div>
    <div id="movBody"></div>
    <p class="muted" id="movHint"></p>
  </section>

</div>

<script type="module" src="../config.mjs"></script>

<script type="module">
  const supa = window.supabase;

  let codigo = new URLSearchParams(window.location.search).get("codigo");

  if (!codigo) {
    const parts = location.pathname.split("/").filter(Boolean);
    const last = parts[parts.length - 1];
    if (last && !last.includes(".html")) codigo = decodeURIComponent(last);
  }

  document.getElementById("subTitle").textContent =
    codigo ? `C√≥digo: ${codigo}` : "C√≥digo no especificado";

  function showError(msg){
    const b = document.getElementById("errorBox");
    b.style.display = "block";
    b.innerHTML = `<h2>Error</h2><p>${msg}</p>`;
  }

  const fDateShort = iso => {
    if (!iso) return "‚Äî";
    const d = new Date(iso);
    if (isNaN(d)) return "‚Äî";
    return String(d.getDate()).padStart(2,"0")+"/"+String(d.getMonth()+1).padStart(2,"0")+"/"+d.getFullYear();
  };

  const fDateTime = iso => {
    if (!iso) return "‚Äî";
    const d = new Date(iso);
    return `${String(d.getDate()).padStart(2,"0")}/${String(d.getMonth()+1).padStart(2,"0")}/${d.getFullYear()} ${String(d.getHours()).padStart(2,"0")}:${String(d.getMinutes()).padStart(2,"0")}`;
  };

  const daysDiff = iso =>{
    if (!iso) return null;
    const d = new Date(iso);
    if (isNaN(d)) return null;
    return Math.round((d - new Date())/86400000);
  };

  function computeEstado(iso){
    const diff = daysDiff(iso);
    if (diff === null) return { clase:"status-info", texto:"Sin pr√≥xima calibraci√≥n", detalle:"Fecha no asignada", dias:null, icono:"üõà" };
    if (diff < 0) return { clase:"status-bad", texto:"Fuera de calibraci√≥n", detalle:"Vencida", dias:diff, icono:"‚õî" };
    if (diff <= 30) return { clase:"status-warn", texto:"Pr√≥xima a vencer", detalle:"Planificar calibraci√≥n", dias:diff, icono:"‚ö†" };
    return { clase:"status-ok", texto:"En regla", detalle:"Correcta", dias:diff, icono:"‚úî" };
  }

  async function main(){
    if (!codigo) return showError("No se indic√≥ c√≥digo.");

    const { data: inst, error } = await supa
      .from("instrumentos")
      .select("*")
      .eq("codigo", codigo)
      .maybeSingle();

    if (error) return showError("Error consultando DB.");
    if (!inst) return showError(`No existe el c√≥digo ${codigo}`);

    // MOVIMIENTOS ‚Üí √öltimo movimiento
    const { data: movs } = await supa
      .from("movimientos")
      .select("*")
      .eq("codigo_instrumento", codigo)
      .order("fecha", { ascending:false })
      .limit(1);

    let ubic = "Sin movimientos registrados";
    let ultimoMov = null;

    if (movs && movs.length>0){
      ultimoMov = movs[0];
      ubic = ultimoMov.destino || ubic;
    }

    // HERO
    document.getElementById("hero").style.display="flex";
    document.getElementById("heroCode").textContent = `C√ìDIGO ¬∑ ${codigo}`;
    document.getElementById("heroTitle").textContent = inst.descripcion || "Instrumento";

    const fabricante = inst.fabricante || "Fabricante N/D";

    document.getElementById("heroSub").innerHTML = `
      <strong>${fabricante}</strong>
      <div class="hero-location">
        <span class="pin">üìç</span>
        <span>${ubic}</span>
      </div>
    `;

    // ESTADO EN HERO
    const prox = inst.fecha_proxima_calibracion || null;
    const est = computeEstado(prox);

    const pill = document.getElementById("heroStatusPill");
    const lab = document.getElementById("heroStatusLabel");
    const cap = document.getElementById("heroStatusCaption");

    pill.className = "status-pill "+est.clase;
    lab.textContent = `${est.icono} ${est.texto}`;
    cap.textContent = est.detalle;

    // OBSERVACIONES
    let obs = inst.observaciones;
    if (!obs || obs==="null" || obs.trim()==="") obs = "Propiedad de Talleres Mec√°nicos Paramio";
    const obsBox = document.getElementById("heroObserv");
    obsBox.style.display="block";
    obsBox.innerHTML = `<span class="label">üìù Observaciones</span> ${obs}`;

    // RESPONSABLES
    if (ultimoMov && ultimoMov.tipo_movimiento === "Salida") {
      const resp = document.getElementById("responsablesCard");
      const body = document.getElementById("respBody");
      resp.style.display = "block";

      let html = "";

      if (ultimoMov.operario1) html += `<span class="chip chip-op1">üë§ ${ultimoMov.operario1}</span>`;
      if (ultimoMov.operario2) html += `<span class="chip chip-op2">üë• ${ultimoMov.operario2}</span>`;
      if (!html.trim()) html = `<span class="muted">No hay operarios asignados en esta salida.</span>`;

      body.innerHTML = html;
    }

    // INFO B√ÅSICA
    const info = document.getElementById("infoCard");
    info.style.display="block";
    document.getElementById("infoBody").innerHTML = `
      <div class="item"><span class="label">Descripci√≥n</span><span class="value">${inst.descripcion || "-"}</span></div>
      <div class="item"><span class="label">Fabricante</span><span class="value">${inst.fabricante || "-"}</span></div>
      <div class="item"><span class="label">Rango / Especificaci√≥n</span><span class="value">${inst.rango || "-"}</span></div>
      <div class="item"><span class="label">Precisi√≥n</span><span class="value">${inst.precision || "-"}</span></div>
      <div class="item"><span class="label">Tipo de calibraci√≥n</span><span class="value">${inst.tipo_calibracion || "-"}</span></div>
    `;

    // CALIBRACI√ìN
    document.getElementById("calCard").style.display="block";
    const ult = inst.fecha_ultima_calibracion;
    const prox2 = inst.fecha_proxima_calibracion;

    let detalle = est.detalle;
    if (est.dias!==null){
      if (est.dias<0) detalle += ` (hace ${Math.abs(est.dias)} d√≠as)`;
      else detalle += ` (en ${est.dias} d√≠as)`;
    }

    document.getElementById("calBody").innerHTML = `
      <div class="item"><span class="label">√öltima calibraci√≥n</span><span class="value">${ult ? fDateShort(ult):"-"}</span></div>
      <div class="item"><span class="label">Pr√≥xima calibraci√≥n</span><span class="value">${prox2 ? fDateShort(prox2):"-"}</span></div>
      <div class="item" style="margin-top:8px;">
        <span class="status-pill ${est.clase}"><span class="dot"></span>${est.icono} ${est.texto}</span>
      </div>
      <p class="muted">${detalle}</p>
    `;

    /* ============================================================
       ‚úÖ NUEVO: √öLTIMO CERTIFICADO OFICIAL (PDF)
       Busca el √∫ltimo certificado emitido para este instrumento
    ============================================================ */
    const { data: certs, error: certErr } = await supa
      .from("certificados")
      .select("numero, certificado_pdf_url, created_at, decision_global")
      .order("created_at", { ascending: false })
      .limit(25);

    if (!certErr && certs && certs.length > 0) {
      // filtramos los que coincidan con instrumento.codigo
      const { data: certFull } = await supa
        .from("certificados")
        .select("numero, certificado_pdf_url, created_at, decision_global, datos")
        .order("created_at", { ascending: false })
        .limit(50);

      const lastCert = (certFull || []).find(c => c?.datos?.instrumento?.codigo === codigo);

      if (lastCert?.certificado_pdf_url) {
        document.getElementById("certCard").style.display = "block";

        document.getElementById("certBody").innerHTML = `
          <div class="item">
            <span class="label">N√∫mero certificado</span>
            <span class="value"><strong>${lastCert.numero}</strong></span>
          </div>

          <div class="item">
            <span class="label">Fecha emisi√≥n</span>
            <span class="value">${lastCert.created_at ? fDateTime(lastCert.created_at) : "-"}</span>
          </div>

          <div class="item">
            <span class="label">Decisi√≥n global</span>
            <span class="value">${lastCert.decision_global || "-"}</span>
          </div>

          <div class="pdf-actions">
            <button class="btn" onclick="window.open('${lastCert.certificado_pdf_url}', '_blank')">üìÑ Abrir PDF</button>
            <a class="btn" href="${lastCert.certificado_pdf_url}" download>‚¨á Descargar</a>
          </div>

          <iframe src="${lastCert.certificado_pdf_url}"></iframe>
        `;
      }
    }

    // HISTORIAL MOVIMIENTOS
    document.getElementById("movCard").style.display="block";

    const { data: movList } = await supa
      .from("movimientos")
      .select("*")
      .eq("codigo_instrumento", codigo)
      .order("fecha",{ascending:false})
      .limit(10);

    const movBody = document.getElementById("movBody");

    if (!movList || movList.length===0){
      movBody.innerHTML = `<div class="muted">No existen movimientos.</div>`;
      return;
    }

    movBody.innerHTML = movList.map(m=>`
      <div class="mov-item">
        <div class="mov-header">
          <div class="mov-type">${m.tipo_movimiento}</div>
          <div class="mov-date">${fDateTime(m.fecha)}</div>
        </div>

        <div class="mov-body-line">
          <span class="mov-body-label">Responsable</span>
          <span>${m.responsable || "-"}</span>
        </div>

        ${m.operario1 ? `<div class="mov-body-line"><span class="mov-body-label">Operario 1</span><span style="color:#7dd3fc;font-weight:600">${m.operario1}</span></div>` : ""}

        ${m.operario2 ? `<div class="mov-body-line"><span class="mov-body-label">Operario 2</span><span style="color:#ff9f40;font-weight:600">${m.operario2}</span></div>` : ""}

        <div class="mov-body-line">
          <span class="mov-body-label">Destino</span>
          <span>${m.destino}</span>
        </div>

        ${m.observaciones ? `
        <div class="mov-body-line">
          <span class="mov-body-label">Obs.</span>
          <span>${m.observaciones.replace(/\n/g,"<br>")}</span>
        </div>` : ""}
      </div>
    `).join("");

    document.getElementById("movHint").textContent = "Se muestran los 10 movimientos m√°s recientes.";
  }

  main();
</script>

</body>
</html>
