<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Chat interno TMP</title>

<style>
:root{
  --bg:#0d1117;
  --panel:#161b22;
  --txt:#f0f6fc;
  --border:#30363d;
  --accent:#22c55e;
  --danger:#ef4444;
}

/* GENERAL */
body{
  margin:0;
  font-family:system-ui,-apple-system,"Segoe UI",Roboto;
  background:var(--bg);
  color:var(--txt);
  height:100vh;
  display:flex;
  flex-direction:column;
}

/* HEADER */
.chat-header{
  background:#020617;
  border-bottom:1px solid var(--border);
  padding:12px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.chat-title{
  font-size:18px;
  font-weight:700;
  color:var(--accent);
}
.chat-user{
  font-size:12px;
  color:var(--txt);
  opacity:.75;
}

/* MENSAJES */
#chat-messages{
  flex:1;
  padding:12px;
  overflow-y:auto;
}
.chat-empty{
  text-align:center;
  color:#aaa;
  margin-top:20px;
}

.msg-wrap{
  margin-bottom:10px;
}
.msg{
  padding:10px 12px;
  border-radius:10px;
  max-width:78%;
  background:var(--panel);
  border:1px solid var(--border);
  box-shadow:0 2px 6px rgba(0,0,0,.4);
}
.msg.mine{
  margin-left:auto;
  background:#06381e;
  border-color:#198754;
}

.msg-header{
  display:flex;
  justify-content:space-between;
  margin-bottom:4px;
  font-size:11px;
}
.msg-author{ font-weight:600; }
.msg-date{ opacity:.7; }

.msg-text{
  white-space:pre-wrap;
  font-size:13px;
}

.msg-tags{
  margin-top:6px;
  display:flex;
  gap:6px;
  flex-wrap:wrap;
  font-size:10px;
}

.tag{
  padding:3px 7px;
  border-radius:999px;
  border:1px solid var(--border);
  opacity:.8;
}
.tag-important{ border-color:var(--danger); color:var(--danger); }
.tag-dest{ border-color:var(--accent); color:var(--accent); }

.msg-done-btn{
  margin-left:auto;
  font-size:10px;
  padding:3px 8px;
  border-radius:999px;
  border:1px solid var(--border);
  background:#020617;
  cursor:pointer;
  color:#aaa;
}
.msg-done-btn:hover{
  background:#1b2534;
  color:#fff;
}

/* INPUT */
.chat-input-box{
  border-top:1px solid var(--border);
  padding:10px;
  background:#020617;
}
.chat-input{
  width:100%;
  background:#0a1320;
  border:1px solid var(--border);
  border-radius:8px;
  padding:8px;
  color:var(--txt);
  resize:none;
  min-height:60px;
  max-height:150px;
}
.chat-input:focus{
  border-color:var(--accent);
}

.chat-bottom{
  margin-top:6px;
  display:flex;
  align-items:center;
  gap:10px;
}

.chat-send{
  background:linear-gradient(135deg,#22c55e,#16a34a);
  border:none;
  padding:6px 14px;
  border-radius:999px;
  cursor:pointer;
  font-size:14px;
  color:white;
  font-weight:600;
}

.chat-important-box{
  display:flex;
  align-items:center;
  gap:4px;
  font-size:12px;
}
.chat-important-word{
  color:var(--danger);
  font-weight:700;
}

.chat-status{
  margin-top:3px;
  font-size:10px;
  opacity:.65;
  color:#aaa;
}
</style>
</head>
<body>

<!-- HEADER -->
<div class="chat-header">
  <div class="chat-title">Chat interno TMP</div>
  <div class="chat-user" id="chat-user-label">Cargando usuario...</div>
</div>

<!-- MENSAJES -->
<div id="chat-messages">
  <div class="chat-empty">Cargando mensajes...</div>
</div>

<!-- INPUT -->
<div class="chat-input-box">
  <textarea id="chat-input" class="chat-input" placeholder="Escribe un mensaje..."></textarea>

  <div class="chat-bottom">
    <label class="chat-important-box">
      <input type="checkbox" id="chat-important">
      <span>Marcar como <span class="chat-important-word">IMPORTANTE</span></span>
    </label>

    <button id="chat-send" class="chat-send">Enviar</button>
  </div>

  <div id="chat-status" class="chat-status"></div>
</div>

<script type="module" src="config.mjs"></script>

<script type="module">
const supabase = window.supabase;

let operario = null;
try { operario = JSON.parse(localStorage.getItem("operario")); }
catch { operario = null; }

const USER = operario?.username || "invitado";
const NOMBRE = operario?.nombre || USER;

document.getElementById("chat-user-label").textContent =
  `${NOMBRE} (${USER})`;

const chatMessagesEl = document.getElementById("chat-messages");
const chatInput = document.getElementById("chat-input");
const chatSend = document.getElementById("chat-send");
const chatImportant = document.getElementById("chat-important");
const chatStatus = document.getElementById("chat-status");

let mensajes = [];

/* ========== FORMATEAR FECHA ========== */
function fmt(ts){
  const d = new Date(ts);
  const dd = String(d.getDate()).padStart(2,"0");
  const mm = String(d.getMonth()+1).padStart(2,"0");
  const hh = String(d.getHours()).padStart(2,"0");
  const mi = String(d.getMinutes()).padStart(2,"0");
  return `${dd}/${mm} ${hh}:${mi}`;
}

/* ========== MOSTRAR MENSAJES ========== */
function render(){
  if (!mensajes.length){
    chatMessagesEl.innerHTML = `<div class="chat-empty">No hay mensajes.</div>`;
    return;
  }

  chatMessagesEl.innerHTML = mensajes.map(msg => {
    const mine = msg.autor === USER;
    const clase = mine ? "msg mine" : "msg";

    const leidos = Array.isArray(msg.leido_por) ? msg.leido_por : [];
    const yaLeido = leidos.includes(USER);

    let tags = "";
    if (msg.importante)
      tags += `<span class="tag tag-important">IMPORTANTE</span>`;

    const dest = msg.destinatarios;
    if (dest && dest.length)
      tags += `<span class="tag tag-dest">Para: ${dest.join(", ")}</span>`;

    let btnHecho = "";
    if (msg.importante && !yaLeido && !mine){
      btnHecho = `<button class="msg-done-btn" data-id="${msg.id}">Hecho</button>`;
    }

    return `
      <div class="msg-wrap">
        <div class="${clase}">
          <div class="msg-header">
            <span class="msg-author">${msg.autor}</span>
            <span class="msg-date">${fmt(msg.created_at)}</span>
          </div>
          <div class="msg-text">${(msg.mensaje || "").replace(/</g,"&lt;")}</div>

          <div class="msg-tags">
            ${tags}
            ${btnHecho}
          </div>
        </div>
      </div>
    `;
  }).join("");

  // eventos botones "hecho"
  document.querySelectorAll(".msg-done-btn").forEach(btn=>{
    btn.addEventListener("click", ()=> marcarHecho(btn.dataset.id));
  });

  chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight;
}

/* ========== CARGAR MENSAJES ========== */
async function cargar(){
  const { data, error } = await supabase
    .from("chat_mensajes")
    .select("*")
    .order("created_at",{ascending:true})
    .limit(300);

  if (!error) mensajes = data;
  render();
}
cargar();

/* ========== REALTIME ========== */
supabase
  .channel("chat-realtime")
  .on("postgres_changes",
      {event:"*",schema:"public",table:"chat_mensajes"},
      payload=>{
        const m = payload.new;
        const idx = mensajes.findIndex(x=>x.id===m.id);
        if(idx>=0) mensajes[idx]=m;
        else mensajes.push(m);
        render();
      }
  )
  .subscribe();

/* ========== ENVIAR ========== */
chatSend.addEventListener("click", enviar);

async function enviar(){
  const txt = chatInput.value.trim();
  if (!txt) return;

  chatSend.disabled = true;
  chatStatus.textContent = "Enviando...";

  const payload = {
    autor: USER,
    mensaje: txt,
    importante: chatImportant.checked,
    destinatarios: null
  };

  await supabase.from("chat_mensajes").insert(payload);

  chatInput.value = "";
  chatImportant.checked = false;
  chatStatus.textContent = "";
  chatSend.disabled = false;
}

/* ========== MARCAR HECHO ========== */
async function marcarHecho(id){
  const msg = mensajes.find(m=>m.id==id);
  if (!msg) return;

  const leidos = Array.isArray(msg.leido_por) ? [...msg.leido_por] : [];
  if (!leidos.includes(USER)) leidos.push(USER);

  await supabase
    .from("chat_mensajes")
    .update({ leido_por: leidos })
    .eq("id",id);

}
</script>
</body>
</html>
