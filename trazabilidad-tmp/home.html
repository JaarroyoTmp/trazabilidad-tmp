<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TMP ¬∑ Trazabilidad Metrol√≥gica</title>

  <style>
    :root{
      --bg:#0d1117;
      --panel:#161b22;
      --txt:#f0f6fc;
      --muted:#8b949e;
      --border:#30363d;
      --card-bg:#1c2431;
      --hover:#263041;
      --accent:#00b4d8;
      --danger:#b91c1c;
      --warning:#f59e0b;
      --success:#22c55e;
    }

    body{
      margin:0;
      font-family:system-ui,-apple-system,"Segoe UI",Roboto;
      background:var(--bg);
      color:var(--txt);
    }

    header{
      background:var(--panel);
      border-bottom:1px solid var(--border);
      padding:16px 20px;
      display:flex;
      align-items:center;
      justify-content:space-between;
    }

    .brand{
      display:flex;
      align-items:center;
      gap:12px;
    }
    .brand img{
      height:46px;
    }
    .brand h1{
      margin:0;
      font-size:20px;
    }
    .brand span{
      font-size:13px;
      color:var(--muted);
    }

    main{
      max-width:1100px;
      margin:26px auto;
      padding:0 18px;
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(260px,1fr));
      gap:18px;
    }

    /* Bloques de informaci√≥n (KPIs + alertas) ocupan todo el ancho de la grid */
    .kpi-section,
    .alerts-section{
      grid-column:1 / -1;
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:14px;
      padding:18px 18px 16px;
    }

    .section-title{
      margin:0 0 8px;
      font-size:18px;
      font-weight:600;
      color:var(--accent);
    }

    .muted{
      font-size:13px;
      color:var(--muted);
      margin:0 0 12px;
    }

    /* KPIs */
    .kpi-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(150px,1fr));
      gap:10px;
    }

    .kpi-card{
      position:relative;
      background:var(--card-bg);
      border-radius:10px;
      border:1px solid var(--border);
      padding:10px 12px;
      overflow:hidden;
    }

    .kpi-card::after{
      content:"";
      position:absolute;
      inset:0;
      background:radial-gradient(circle at 0 0,rgba(0,180,216,.18),transparent 55%);
      opacity:0;
      pointer-events:none;
      transition:opacity .4s ease;
    }

    .kpi-card.highlight::after{
      opacity:1;
    }

    .kpi-label{
      font-size:12px;
      color:var(--muted);
      margin-bottom:4px;
    }

    .kpi-value{
      font-size:20px;
      font-weight:700;
      line-height:1.1;
      min-height:1.1em;
    }

    .kpi-extra{
      margin-top:4px;
      font-size:12px;
      color:var(--muted);
    }

    /* Alertas */
    .alerts-columns{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(260px,1fr));
      gap:14px;
      margin-top:8px;
    }

    .alerts-box{
      background:var(--card-bg);
      border-radius:10px;
      border:1px solid var(--border);
      padding:10px 12px 12px;
      position:relative;
      overflow:hidden;
    }

    .alerts-box.has-items::before{
      content:"";
      position:absolute;
      inset:-40%;
      background:radial-gradient(circle at 0 0,rgba(220,38,38,.18),transparent 55%);
      opacity:0;
      pointer-events:none;
      animation:pulseGlow 3s ease-in-out infinite;
    }

    .alerts-box.warning.has-items::before{
      background:radial-gradient(circle at 0 0,rgba(245,158,11,.20),transparent 55%);
    }

    @keyframes pulseGlow{
      0%,100%{opacity:0;}
      50%{opacity:1;}
    }

    .alerts-title{
      display:flex;
      align-items:center;
      gap:6px;
      margin:0 0 6px;
      font-size:15px;
      font-weight:600;
      position:relative;
      z-index:1;
    }

    .alerts-title span.badge{
      font-size:11px;
      padding:2px 6px;
      border-radius:999px;
      border:1px solid var(--border);
      color:var(--muted);
      background:#020617;
    }

    .badge-danger{
      border-color:var(--danger);
      color:var(--danger);
    }
    .badge-warning{
      border-color:var(--warning);
      color:var(--warning);
    }

    .alerts-table{
      width:100%;
      border-collapse:collapse;
      font-size:12px;
      position:relative;
      z-index:1;
    }
    .alerts-table thead{
      background:#111827;
    }
    .alerts-table th,
    .alerts-table td{
      padding:4px 6px;
      border-bottom:1px solid var(--border);
      text-align:left;
      white-space:nowrap;
    }
    .alerts-table tbody tr:nth-child(even){
      background:#111827;
    }

    .status-pill{
      display:inline-flex;
      align-items:center;
      padding:1px 6px;
      border-radius:999px;
      font-size:11px;
      border:1px solid var(--border);
    }
    .status-pill.danger{
      border-color:var(--danger);
      color:var(--danger);
    }
    .status-pill.warning{
      border-color:var(--warning);
      color:var(--warning);
    }

    .link-btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:3px 8px;
      border-radius:999px;
      border:1px solid var(--border);
      font-size:11px;
      color:var(--txt);
      text-decoration:none;
      background:#111827;
    }
    .link-btn:hover{
      background:var(--hover);
    }

    .empty-msg{
      font-size:12px;
      color:var(--muted);
      margin-top:2px;
      position:relative;
      z-index:1;
    }

    /* Tarjetas de navegaci√≥n ya existentes */
    .card{
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:14px;
      padding:20px 18px;
      text-decoration:none;
      color:var(--txt);
      display:flex;
      flex-direction:column;
      gap:8px;
      transition:0.15s;
    }

    .card:hover{
      background:var(--hover);
      transform:translateY(-2px);
    }

    .card-title{
      font-size:18px;
      font-weight:600;
      color:var(--accent);
      display:flex;
      align-items:center;
      gap:6px;
    }

    .card-desc{
      font-size:14px;
      color:var(--muted);
      line-height:1.3;
    }

    footer{
      text-align:center;
      margin-top:30px;
      padding-bottom:20px;
      font-size:13px;
      color:var(--muted);
    }

    /* Toasts / notificaciones */
    .toast-container{
      position:fixed;
      top:16px;
      right:16px;
      display:flex;
      flex-direction:column;
      gap:8px;
      z-index:50;
      pointer-events:none;
    }
    .toast{
      min-width:220px;
      max-width:320px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      background:#020617;
      font-size:13px;
      color:var(--txt);
      display:flex;
      align-items:flex-start;
      gap:8px;
      box-shadow:0 18px 40px rgba(0,0,0,.55);
      opacity:0;
      transform:translateX(10px) translateY(-6px);
      animation:toastIn .22s ease forwards;
      pointer-events:auto;
    }
    .toast.success{border-color:var(--success);}
    .toast.warning{border-color:var(--warning);}
    .toast.error{border-color:var(--danger);}
    .toast-icon{
      font-size:16px;
      line-height:1;
      margin-top:1px;
    }
    .toast-close{
      margin-left:auto;
      cursor:pointer;
      font-size:14px;
      color:var(--muted);
    }
    .toast-title{
      font-weight:600;
      font-size:13px;
    }
    .toast-body{
      font-size:12px;
      color:var(--muted);
    }

    @keyframes toastIn{
      to{
        opacity:1;
        transform:translateX(0) translateY(0);
      }
    }
  </style>
</head>
<body>

<header>
  <div class="brand">
    <img src="img/tmp-quality.png" alt="TMP">
    <div>
      <h1>TMP ¬∑ Control Metrol√≥gico</h1>
      <span>Trazabilidad ¬∑ Instrumentos ¬∑ Laboratorio</span>
    </div>
  </div>
</header>

<main>

  <!-- PANEL DE KPIs LABORATORIO -->
  <section class="kpi-section">
    <h2 class="section-title">Resumen del laboratorio</h2>
    <p class="muted">
      Indicadores calculados en tiempo real a partir de la tabla <code>instrumentos</code> de Supabase.
      Un equipo se considera <b>en uso</b> si su ubicaci√≥n actual es distinta de <b>Laboratorio</b>.
    </p>

    <div class="kpi-grid">
      <div class="kpi-card" data-kpi="total">
        <div class="kpi-label">Instrumentos totales</div>
        <div class="kpi-value" id="kpi-total">‚Äì</div>
        <div class="kpi-extra" id="kpi-total-extra"></div>
      </div>

      <div class="kpi-card" data-kpi="uso">
        <div class="kpi-label">En uso (fuera de laboratorio)</div>
        <div class="kpi-value" id="kpi-uso">‚Äì</div>
        <div class="kpi-extra" id="kpi-uso-extra"></div>
      </div>

      <div class="kpi-card" data-kpi="lab">
        <div class="kpi-label">En laboratorio</div>
        <div class="kpi-value" id="kpi-lab">‚Äì</div>
        <div class="kpi-extra" id="kpi-lab-extra"></div>
      </div>

      <div class="kpi-card" data-kpi="vigentes">
        <div class="kpi-label">Vigentes (calibraci√≥n en plazo)</div>
        <div class="kpi-value" id="kpi-calibrados">‚Äì</div>
        <div class="kpi-extra" id="kpi-calibrados-extra"></div>
      </div>

      <div class="kpi-card" data-kpi="proximos">
        <div class="kpi-label">Pr√≥ximos a calibrar (&lt; 30 d√≠as)</div>
        <div class="kpi-value" id="kpi-proximos">‚Äì</div>
        <div class="kpi-extra" id="kpi-proximos-extra"></div>
      </div>

      <div class="kpi-card" data-kpi="fuera">
        <div class="kpi-label">Fuera de calibraci√≥n</div>
        <div class="kpi-value" id="kpi-fuera">‚Äì</div>
        <div class="kpi-extra" id="kpi-fuera-extra"></div>
      </div>
    </div>
  </section>

  <!-- ALERTAS OPERATIVAS -->
  <section class="alerts-section">
    <h2 class="section-title">Alertas de calibraci√≥n</h2>
    <p class="muted">
      Equipos fuera de calibraci√≥n y pr√≥ximos a vencer. Los operarios pueden localizar estos c√≥digos
      y priorizar su calibraci√≥n.
    </p>

    <div class="alerts-columns">

      <!-- Fuera de calibraci√≥n -->
      <div class="alerts-box" id="box-fuera">
        <h3 class="alerts-title">
          ‚ùå Fuera de calibraci√≥n
          <span class="badge badge-danger" id="badge-fuera-count">0</span>
        </h3>
        <table class="alerts-table">
          <thead>
          <tr>
            <th>C√≥digo</th>
            <th>Ubicaci√≥n</th>
            <th>Pr√≥xima</th>
            <th></th>
          </tr>
          </thead>
          <tbody id="tbody-fuera"></tbody>
        </table>
        <div class="empty-msg" id="msg-fuera">
          No hay instrumentos fuera de calibraci√≥n.
        </div>
      </div>

      <!-- Pr√≥ximos -->
      <div class="alerts-box warning" id="box-prox">
        <h3 class="alerts-title">
          ‚ö†Ô∏è Pr√≥ximos (&lt; 30 d√≠as)
          <span class="badge badge-warning" id="badge-prox-count">0</span>
        </h3>
        <table class="alerts-table">
          <thead>
          <tr>
            <th>C√≥digo</th>
            <th>Ubicaci√≥n</th>
            <th>Pr√≥xima</th>
            <th></th>
          </tr>
          </thead>
          <tbody id="tbody-prox"></tbody>
        </table>
        <div class="empty-msg" id="msg-prox">
          No hay instrumentos con calibraci√≥n pr√≥xima en los pr√≥ximos 30 d√≠as.
        </div>
      </div>

    </div>
  </section>

  <!-- TARJETAS / BOTONES EXISTENTES -->
  <a class="card" href="alta_instrumento.html">
    <div class="card-title">‚ûï Alta / Edici√≥n</div>
    <div class="card-desc">Registrar instrumentos, editar fichas, generar QR y gestionar estados.</div>
  </a>

  <a class="card" href="movimiento.html">
    <div class="card-title">üîÑ Movimientos</div>
    <div class="card-desc">Registrar entradas, salidas, ubicaciones y responsables.</div>
  </a>

  <a class="card" href="qr/qr.index.html">
    <div class="card-title">üè∑ Generar QR</div>
    <div class="card-desc">Crear c√≥digos QR para identificaci√≥n r√°pida y trazabilidad.</div>
  </a>

  <a class="card" href="TMP_Calibraciones_Lab.html">
    <div class="card-title">üìè Calibraciones Lab</div>
    <div class="card-desc">Gesti√≥n de calibraciones internas del laboratorio TMP.</div>
  </a>

  <a class="card" href="App_Patrones_TMP.html">
    <div class="card-title">üìê Patrones</div>
    <div class="card-desc">Inventario y control de patrones del laboratorio.</div>
  </a>

  <a class="card" href="App_Familias_TMP.html">
    <div class="card-title">üß© Familias</div>
    <div class="card-desc">Clasificaci√≥n y agrupaci√≥n de instrumentos TMP.</div>
  </a>

  <a class="card" href="App_Tipos_TMP.html">
    <div class="card-title">üóÇ Tipos de Instrumentos</div>
    <div class="card-desc">Gesti√≥n de tipos y categor√≠as t√©cnicas.</div>
  </a>

  <a class="card" href="criterios.html">
    <div class="card-title">üìò Criterios de Aceptaci√≥n</div>
    <div class="card-desc">Requisitos metrol√≥gicos TMP: aceptaci√≥n interna y externa. Documento clave para auditor√≠as.</div>
  </a>

  <a class="card" href="alcance_kpi.html">
    <div class="card-title">üìä Alcance Laboratorio & KPIs</div>
    <div class="card-desc">Magnitudes cubiertas, rangos y panel de indicadores del laboratorio TMP.</div>
  </a>

</main>

<footer>
  Talleres Mec√°nicos Paramio ¬∑ Sistema de Trazabilidad Metrol√≥gica ¬∑ 2025
</footer>

<div class="toast-container" id="toast-container"></div>

<!-- Cliente Supabase: usa el MISMO config que movimientos -->
<script type="module" src="config.mjs"></script>

<script type="module">
  const sb = window.supabase;

  const elTotal = document.getElementById('kpi-total');
  const elTotalExtra = document.getElementById('kpi-total-extra');
  const elUso = document.getElementById('kpi-uso');
  const elUsoExtra = document.getElementById('kpi-uso-extra');
  const elLab = document.getElementById('kpi-lab');
  const elLabExtra = document.getElementById('kpi-lab-extra');
  const elCal = document.getElementById('kpi-calibrados');
  const elCalExtra = document.getElementById('kpi-calibrados-extra');
  const elProx = document.getElementById('kpi-proximos');
  const elProxExtra = document.getElementById('kpi-proximos-extra');
  const elFuera = document.getElementById('kpi-fuera');
  const elFueraExtra = document.getElementById('kpi-fuera-extra');

  const tbodyFuera = document.getElementById('tbody-fuera');
  const tbodyProx = document.getElementById('tbody-prox');
  const badgeFuera = document.getElementById('badge-fuera-count');
  const badgeProx = document.getElementById('badge-prox-count');
  const msgFuera = document.getElementById('msg-fuera');
  const msgProx = document.getElementById('msg-prox');
  const boxFuera = document.getElementById('box-fuera');
  const boxProx = document.getElementById('box-prox');

  const toastContainer = document.getElementById('toast-container');

  function showToast({title, body, type="success"}){
    const t = document.createElement('div');
    t.className = `toast ${type}`;
    t.innerHTML = `
      <div class="toast-icon">
        ${type==="success" ? "‚úÖ" : type==="warning" ? "‚ö†Ô∏è" : "‚ùå"}
      </div>
      <div>
        <div class="toast-title">${title}</div>
        ${body ? `<div class="toast-body">${body}</div>` : ""}
      </div>
      <div class="toast-close">‚úï</div>
    `;
    t.querySelector(".toast-close").onclick = () => {
      t.style.opacity = "0";
      t.style.transform = "translateX(8px)";
      setTimeout(()=> t.remove(), 180);
    };
    toastContainer.appendChild(t);
    setTimeout(()=> t.querySelector(".toast-close").click(), 6000);
  }

  function parseDate(dStr) {
    if (!dStr) return null;
    const d = new Date(dStr);
    return isNaN(d) ? null : d;
  }

  function formatDate(d) {
    if (!d) return '‚Äî';
    const dd = String(d.getDate()).padStart(2, '0');
    const mm = String(d.getMonth() + 1).padStart(2, '0');
    const yy = d.getFullYear();
    return `${dd}/${mm}/${yy}`;
  }

  function animateNumber(el, target){
    const start = 0;
    const duration = 700;
    const startTime = performance.now();
    const kpiCard = el.closest(".kpi-card");

    function frame(now){
      const t = Math.min(1, (now - startTime) / duration);
      const val = Math.round(start + (target - start) * t);
      el.textContent = val;
      if (t < 1) {
        requestAnimationFrame(frame);
      } else if (kpiCard) {
        kpiCard.classList.add("highlight");
        setTimeout(()=> kpiCard.classList.remove("highlight"), 600);
      }
    }
    requestAnimationFrame(frame);
  }

  async function cargarDashboard() {
    if (!sb){
      console.error("Supabase no est√° disponible en window.supabase");
      showToast({
        title:"Sin conexi√≥n Supabase",
        body:"Revisa config.js o la conexi√≥n a Internet.",
        type:"error"
      });
      return;
    }

    const { data: instrumentos, error } = await sb
      .from('instrumentos')
      .select('codigo, proxima_calibracion, ubicacion_actual');

    if (error) {
      console.error('Error cargando instrumentos', error);
      showToast({
        title:"Error al cargar datos",
        body:"Revisa la consola del navegador para m√°s detalles.",
        type:"error"
      });
      return;
    }

    const hoy = new Date();
    const en30 = new Date();
    en30.setDate(hoy.getDate() + 30);

    const total = instrumentos.length;

    let enLab = 0;
    let enUso = 0;

    let vigentes = 0;
    let fueraCal = 0;
    let proximosCount = 0;

    const fueraLista = [];
    const proximosLista = [];

    instrumentos.forEach(inst => {
      const ubic = (inst.ubicacion_actual || '').trim();

      if (ubic === 'Laboratorio') enLab++;
      else enUso++;

      const prox = parseDate(inst.proxima_calibracion);
      if (!prox) return;

      if (prox < hoy) {
        fueraCal++;
        fueraLista.push({ ...inst, proxDate: prox });
      } else if (prox >= hoy && prox <= en30) {
        proximosCount++;
        proximosLista.push({ ...inst, proxDate: prox });
      } else {
        vigentes++;
      }
    });

    const pct = (parte, total) => total > 0 ? Math.round((parte / total) * 100) : 0;

    animateNumber(elTotal, total || 0);
    elTotalExtra.textContent = total ? "Instrumentos registrados en el sistema" : "";

    animateNumber(elUso, enUso);
    elUsoExtra.textContent = total ? `${pct(enUso, total)}% del total` : '';

    animateNumber(elLab, enLab);
    elLabExtra.textContent = total ? `${pct(enLab, total)}% del total` : '';

    animateNumber(elCal, vigentes);
    elCalExtra.textContent = total ? `${pct(vigentes, total)}% en plazo de calibraci√≥n` : '';

    animateNumber(elProx, proximosCount);
    elProxExtra.textContent = total ? `${pct(proximosCount, total)}% del total` : '';

    animateNumber(elFuera, fueraCal);
    elFueraExtra.textContent = total ? `${pct(fueraCal, total)}% del total` : '';

    fueraLista.sort((a, b) => a.proxDate - b.proxDate);
    proximosLista.sort((a, b) => a.proxDate - b.proxDate);

    tbodyFuera.innerHTML = '';
    tbodyProx.innerHTML = '';

    fueraLista.forEach(inst => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${inst.codigo || ''}</td>
        <td>${inst.ubicacion_actual || ''}</td>
        <td>${formatDate(inst.proxDate)}</td>
        <td>
          <a class="link-btn" href="alta_instrumento.html?codigo=${encodeURIComponent(inst.codigo || '')}">
            Ver
          </a>
        </td>
      `;
      tbodyFuera.appendChild(tr);
    });

    proximosLista.forEach(inst => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${inst.codigo || ''}</td>
        <td>${inst.ubicacion_actual || ''}</td>
        <td>${formatDate(inst.proxDate)}</td>
        <td>
          <a class="link-btn" href="alta_instrumento.html?codigo=${encodeURIComponent(inst.codigo || '')}">
            Ver
          </a>
        </td>
      `;
      tbodyProx.appendChild(tr);
    });

    badgeFuera.textContent = fueraCal;
    badgeProx.textContent = proximosCount;

    msgFuera.style.display = fueraCal === 0 ? 'block' : 'none';
    msgProx.style.display = proximosCount === 0 ? 'block' : 'none';

    boxFuera.classList.toggle("has-items", fueraCal > 0);
    boxProx.classList.toggle("has-items", proximosCount > 0);

    if (fueraCal > 0 || proximosCount > 0){
      showToast({
        title:"Dashboard actualizado",
        body:`${fueraCal} fuera de calibraci√≥n ¬∑ ${proximosCount} pr√≥ximos a calibrar`,
        type: fueraCal > 0 ? "warning" : "success"
      });
    } else {
      showToast({
        title:"Dashboard actualizado",
        body:"Todos los instrumentos est√°n dentro de plazo de calibraci√≥n.",
        type:"success"
      });
    }
  }

  cargarDashboard();
</script>

</body>
</html>

