<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TMP ¬∑ Trazabilidad Metrol√≥gica</title>

  <style>
    :root{
      --bg:#0d1117;
      --panel:#161b22;
      --txt:#f0f6fc;
      --muted:#8b949e;
      --border:#30363d;
      --card-bg:#1c2431;
      --hover:#263041;
      --accent:#00b4d8;
      --danger:#b91c1c;
      --warning:#f59e0b;
      --success:#22c55e;
    }

    body{
      margin:0;
      font-family:system-ui,-apple-system,"Segoe UI",Roboto;
      background:var(--bg);
      color:var(--txt);
    }

    header{
      background:var(--panel);
      border-bottom:1px solid var(--border);
      padding:16px 20px;
      display:flex;
      align-items:center;
      justify-content:space-between;
    }

    .brand{
      display:flex;
      align-items:center;
      gap:12px;
    }
    .brand img{
      height:46px;
    }
    .brand h1{
      margin:0;
      font-size:20px;
    }
    .brand span{
      font-size:13px;
      color:var(--muted);
    }

    main{
      max-width:1100px;
      margin:26px auto;
      padding:0 18px;
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(260px,1fr));
      gap:18px;
    }

    .kpi-section,
    .alerts-section{
      grid-column:1 / -1;
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:14px;
      padding:18px 18px 16px;
    }

    .section-title{
      margin:0 0 8px;
      font-size:18px;
      font-weight:600;
      color:var(--accent);
    }

    .muted{
      font-size:13px;
      color:var(--muted);
      margin:0 0 12px;
    }

    .kpi-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(150px,1fr));
      gap:10px;
    }

    .kpi-card{
      background:var(--card-bg);
      border-radius:10px;
      border:1px solid var(--border);
      padding:10px 12px;
      transition:all .3s ease;
    }

    .kpi-card.updated {
      background:#113344;
      box-shadow:0 0 12px rgba(0,180,216,.4);
    }

    .kpi-label{
      font-size:12px;
      color:var(--muted);
      margin-bottom:4px;
    }

    .kpi-value{
      font-size:20px;
      font-weight:700;
      line-height:1.1;
    }

    .kpi-extra{
      margin-top:4px;
      font-size:12px;
      color:var(--muted);
    }

    .alerts-columns{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(260px,1fr));
      gap:14px;
      margin-top:8px;
    }

    .alerts-box{
      background:var(--card-bg);
      border-radius:10px;
      border:1px solid var(--border);
      padding:10px 12px 12px;
    }

    .alerts-title{
      display:flex;
      align-items:center;
      gap:6px;
      margin:0 0 6px;
      font-size:15px;
      font-weight:600;
    }

    .alerts-title span.badge{
      font-size:11px;
      padding:2px 6px;
      border-radius:999px;
      border:1px solid var(--border);
      color:var(--muted);
    }

    .badge-danger{
      border-color:var(--danger);
      color:var(--danger);
      animation:blink 1.6s infinite;
    }
    .badge-warning{
      border-color:var(--warning);
      color:var(--warning);
    }

    @keyframes blink {
      0%, 100% { opacity:1; }
      50% { opacity:.35; }
    }

    .alerts-table{
      width:100%;
      border-collapse:collapse;
      font-size:12px;
    }

    .alerts-table th,
    .alerts-table td{
      padding:4px 6px;
      border-bottom:1px solid var(--border);
      text-align:left;
      white-space:nowrap;
    }

    .link-btn{
      display:inline-flex;
      padding:3px 8px;
      border-radius:999px;
      border:1px solid var(--border);
      font-size:11px;
      text-decoration:none;
      background:#111827;
      color:var(--txt);
    }

    .link-btn:hover{
      background:var(--hover);
    }
  </style>
</head>
<body>

<header>
  <div class="brand">
    <img src="img/tmp-quality.png" alt="TMP">
    <div>
      <h1>TMP ¬∑ Control Metrol√≥gico</h1>
      <span>Trazabilidad ¬∑ Instrumentos ¬∑ Laboratorio</span>
    </div>
  </div>
</header>

<main>

  <!-- KPIs -->
  <section class="kpi-section">
    <h2 class="section-title">Resumen del laboratorio</h2>
    <p class="muted">Indicadores calculados en tiempo real desde Supabase.</p>

    <div class="kpi-grid">

      <div class="kpi-card" id="kpi-card-total">
        <div class="kpi-label">Instrumentos totales</div>
        <div class="kpi-value" id="kpi-total">‚Äì</div>
        <div class="kpi-extra" id="kpi-total-extra"></div>
      </div>

      <div class="kpi-card" id="kpi-card-uso">
        <div class="kpi-label">En uso</div>
        <div class="kpi-value" id="kpi-uso">‚Äì</div>
        <div class="kpi-extra" id="kpi-uso-extra"></div>
      </div>

      <div class="kpi-card" id="kpi-card-lab">
        <div class="kpi-label">En laboratorio</div>
        <div class="kpi-value" id="kpi-lab">‚Äì</div>
        <div class="kpi-extra" id="kpi-lab-extra"></div>
      </div>

      <div class="kpi-card" id="kpi-card-cal">
        <div class="kpi-label">Calibrados</div>
        <div class="kpi-value" id="kpi-calibrados">‚Äì</div>
        <div class="kpi-extra" id="kpi-calibrados-extra"></div>
      </div>

      <div class="kpi-card" id="kpi-card-prox">
        <div class="kpi-label">Pr√≥ximos (&lt; 30 d√≠as)</div>
        <div class="kpi-value" id="kpi-proximos">‚Äì</div>
        <div class="kpi-extra" id="kpi-proximos-extra"></div>
      </div>

      <div class="kpi-card" id="kpi-card-fuera">
        <div class="kpi-label">Fuera de calibraci√≥n</div>
        <div class="kpi-value" id="kpi-fuera">‚Äì</div>
        <div class="kpi-extra" id="kpi-fuera-extra"></div>
      </div>

    </div>
  </section>

  <!-- ALERTAS -->
  <section class="alerts-section">
    <h2 class="section-title">Alertas de calibraci√≥n</h2>
    <p class="muted">Estados cr√≠ticos detectados autom√°ticamente.</p>

    <div class="alerts-columns">

      <div class="alerts-box">
        <h3 class="alerts-title">
          ‚ùå Fuera de calibraci√≥n
          <span class="badge badge-danger" id="badge-fuera-count">0</span>
        </h3>

        <table class="alerts-table">
          <thead>
            <tr>
              <th>C√≥digo</th>
              <th>Ubicaci√≥n</th>
              <th>Pr√≥xima</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="tbody-fuera"></tbody>
        </table>

      </div>

      <div class="alerts-box">
        <h3 class="alerts-title">
          ‚ö†Ô∏è Pr√≥ximos (&lt; 30 d√≠as)
          <span class="badge badge-warning" id="badge-prox-count">0</span>
        </h3>

        <table class="alerts-table">
          <thead>
            <tr>
              <th>C√≥digo</th>
              <th>Ubicaci√≥n</th>
              <th>Pr√≥xima</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="tbody-prox"></tbody>
        </table>

      </div>

    </div>
  </section>

  <!-- TARJETAS -->
  <a class="card" href="alta_instrumento.html">‚ûï Alta / Edici√≥n</a>
  <a class="card" href="movimiento.html">üîÑ Movimientos</a>
  <a class="card" href="qr/qr.index.html">üè∑ Generar QR</a>
  <a class="card" href="TMP_Calibraciones_Lab.html">üìè Calibraciones Lab</a>
  <a class="card" href="App_Patrones_TMP.html">üìê Patrones</a>
  <a class="card" href="App_Familias_TMP.html">üß© Familias</a>
  <a class="card" href="App_Tipos_TMP.html">üóÇ Tipos</a>
  <a class="card" href="criterios.html">üìò Criterios</a>
  <a class="card" href="alcance_kpi.html">üìä Alcance & KPIs</a>

</main>

<footer>¬© TMP ‚Äî Sistema Metrol√≥gico ‚Äî 2025</footer>

<!-- CARGAR SUPABASE CORRECTAMENTE -->
<script type="module" src="config.mjs"></script>

<script type="module">
const supabase = window.supabase;

/* ==== FUNCIONES ==== */
function parseDate(str) {
  if (!str) return null;
  const d = new Date(str);
  return isNaN(d) ? null : d;
}

function formatDate(d){
  if (!d) return "‚Äî";
  return `${String(d.getDate()).padStart(2,"0")}/${String(d.getMonth()+1).padStart(2,"0")}/${d.getFullYear()}`;
}

function animateCard(el){
  el.classList.add("updated");
  setTimeout(()=>el.classList.remove("updated"), 900);
}

/* ==== CARGAR DASHBOARD ==== */
async function cargarDashboard() {
  const { data: instrumentos, error } = await supabase
    .from("instrumentos")
    .select("*");

  if (error) {
    console.error(error);
    return;
  }

  const total = instrumentos.length;

  const hoy = new Date();
  const mas30 = new Date();
  mas30.setDate(hoy.getDate() + 30);

  let enLab = 0;
  let enUso = 0;
  let calibrados = 0;
  let fueraLista = [];
  let proxLista = [];

  instrumentos.forEach(inst => {
    // uso / laboratorio
    if ((inst.ubicacion_actual || "").toLowerCase() === "laboratorio") enLab++;
    else enUso++;

    // calibraci√≥n
    if (inst.estado === "Calibrado") calibrados++;

    const prox = parseDate(inst.proxima_calibracion);
    if (prox) {
      if (prox < hoy) fueraLista.push(inst);
      else if (prox <= mas30) proxLista.push(inst);
    }
  });

  // KPIs
  kpi_total.textContent = total;
  kpi_uso.textContent = enUso;
  kpi_lab.textContent = enLab;
  kpi_calibrados.textContent = calibrados;
  kpi_fuera.textContent = fueraLista.length;
  kpi_proximos.textContent = proxLista.length;

  animateCard(kpi_card_total);
  animateCard(kpi_card_uso);
  animateCard(kpi_card_lab);
  animateCard(kpi_card_cal);
  animateCard(kpi_card_fuera);
  animateCard(kpi_card_prox);

  // Tablas
  tbody_fuera.innerHTML = fueraLista
    .map(i => `
      <tr>
        <td>${i.codigo}</td>
        <td>${i.ubicacion_actual}</td>
        <td>${formatDate(parseDate(i.proxima_calibracion))}</td>
        <td><a class="link-btn" href="alta_instrumento.html?codigo=${i.codigo}">Ver</a></td>
      </tr>
    `)
    .join("");

  tbody_prox.innerHTML = proxLista
    .map(i => `
      <tr>
        <td>${i.codigo}</td>
        <td>${i.ubicacion_actual}</td>
        <td>${formatDate(parseDate(i.proxima_calibracion))}</td>
        <td><a class="link-btn" href="alta_instrumento.html?codigo=${i.codigo}">Ver</a></td>
      </tr>
    `)
    .join("");

  badge_fuera_count.textContent = fueraLista.length;
  badge_prox_count.textContent = proxLista.length;
}

cargarDashboard();
setInterval(cargarDashboard, 10000); // auto refresco cada 10s
</script>

</body>
</html>
