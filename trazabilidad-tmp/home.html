<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TMP ¬∑ Trazabilidad Metrol√≥gica</title>

  <style>
    :root{
      --bg:#0d1117;
      --panel:#161b22;
      --txt:#f0f6fc;
      --muted:#8b949e;
      --border:#30363d;
      --card-bg:#1c2431;
      --hover:#263041;
      --accent:#22c55e;
      --danger:#ef4444;
      --warning:#f59e0b;
      --success:#22c55e;
    }

    *{box-sizing:border-box;}

    body{
      margin:0;
      font-family:system-ui,-apple-system,"Segoe UI",Roboto;
      background:radial-gradient(circle at 0 0,#111827 0,transparent 55%),
                 radial-gradient(circle at 100% 0,#0f172a 0,transparent 55%),
                 var(--bg);
      color:var(--txt);
    }

    header{
      background:linear-gradient(135deg,#020617,#020617 55%,#02141d);
      border-bottom:1px solid var(--border);
      padding:16px 20px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      position:sticky;
      top:0;
      z-index:5;
      backdrop-filter:blur(10px);
    }

    .brand{
      display:flex;
      align-items:center;
      gap:12px;
    }
    .brand img{
      height:46px;
    }
    .brand h1{
      margin:0;
      font-size:20px;
    }
    .brand span{
      font-size:13px;
      color:var(--muted);
    }

    main{
      max-width:1100px;
      margin:26px auto;
      padding:0 18px 40px;
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(260px,1fr));
      gap:18px;
    }

    /* ======================= KPIs ======================= */

    .kpi-section,
    .alerts-section{
      grid-column:1 / -1;
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:18px;
      padding:18px;
      box-shadow:0 16px 40px rgba(0,0,0,.4);
      position:relative;
      overflow:hidden;
    }

    .section-title{
      margin:0 0 8px;
      font-size:18px;
      font-weight:600;
      color:var(--accent);
      letter-spacing:.02em;
    }

    .muted{
      font-size:13px;
      color:var(--muted);
      margin-bottom:12px;
    }

    .kpi-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(150px,1fr));
      gap:10px;
    }

    .kpi-card{
      background:var(--card-bg);
      border-radius:14px;
      border:1px solid var(--border);
      padding:10px 12px;
      transition:all .3s ease;
      position:relative;
      overflow:hidden;
      box-shadow:0 10px 24px rgba(0,0,0,.45);
    }

    .kpi-card:hover{
      transform:translateY(-3px) scale(1.01);
      box-shadow:0 18px 40px rgba(0,0,0,.65);
    }

    .kpi-label{
      font-size:12px;
      color:var(--muted);
      margin-bottom:4px;
    }

    .kpi-value{
      font-size:22px;
      font-weight:700;
      line-height:1.1;
    }

    /* ============ ALERTAS ============= */

    .alert-summary-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(260px,1fr));
      gap:12px;
    }

    .alert-summary-card{
      background:#020617;
      border-radius:14px;
      border:1px solid var(--border);
      padding:10px 12px;
      position:relative;
      display:flex;
      flex-direction:column;
      gap:6px;
    }

    .alert-title-main{
      font-size:15px;
      font-weight:600;
      display:flex;
      align-items:center;
      gap:6px;
    }

    .badge{
      font-size:11px;
      padding:3px 9px;
      border-radius:999px;
      border:1px solid var(--border);
    }

    /* ===================== TARJETAS ===================== */

    .card{
      position:relative;
      background:var(--panel);
      border-radius:18px;
      border:1px solid var(--border);
      padding:18px;
      text-decoration:none;
      color:var(--txt);
      display:flex;
      flex-direction:column;
      gap:6px;
      transition:transform .2s ease, box-shadow .25s ease;
    }

    .card:hover{
      transform:translateY(-4px) scale(1.01);
      box-shadow:0 18px 40px rgba(0,0,0,.7);
    }

    .card-title{
      font-size:17px;
      font-weight:600;
      color:var(--accent);
      display:flex;
      align-items:center;
      gap:8px;
    }

    .card-desc{
      font-size:13px;
      color:var(--muted);
    }

    /* ================ CHAT ================ */

    .chat-fab{
      position:fixed;
      right:22px;
      bottom:22px;
      width:54px;
      height:54px;
      background:#22c55e;
      border-radius:50%;
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      font-size:24px;
      color:white;
      z-index:20;
      box-shadow:0 8px 24px rgba(0,0,0,.6);
      transition:transform .2s ease;
    }

    .chat-fab:hover{
      transform:scale(1.08);
    }

    .chat-fab-badge{
      position:absolute;
      top:-6px;
      right:-6px;
      background:#ef4444;
      color:white;
      font-size:12px;
      padding:2px 6px;
      border-radius:999px;
      display:none;
    }

    .chat-panel{
      position:fixed;
      right:0;
      bottom:0;
      width:330px;
      height:80%;
      max-height:600px;
      background:var(--panel);
      border-left:1px solid var(--border);
      border-top:1px solid var(--border);
      transform:translateY(100%);
      transition:transform .28s ease;
      z-index:30;
      display:flex;
      flex-direction:column;
    }

    .chat-panel.open{
      transform:translateY(0);
    }

    .chat-header{
      padding:12px;
      border-bottom:1px solid var(--border);
      display:flex;
      align-items:center;
      justify-content:space-between;
    }

    .chat-title{
      font-size:15px;
      font-weight:600;
      color:var(--accent);
    }

    .chat-subtitle{
      font-size:11px;
      color:var(--muted);
    }

    .chat-close-btn{
      background:none;
      border:none;
      color:var(--muted);
      font-size:18px;
      cursor:pointer;
    }

    .chat-messages{
      flex:1;
      padding:10px;
      overflow-y:auto;
      font-size:13px;
    }

    .chat-message{
      background:#1c2431;
      padding:8px 10px;
      border-radius:10px;
      margin-bottom:10px;
      border:1px solid var(--border);
    }

    .chat-message.mine{
      background:#0f172a;
      border-color:#22c55e;
    }

    .chat-message-header{
      font-size:11px;
      color:var(--muted);
      display:flex;
      justify-content:space-between;
      margin-bottom:4px;
    }

    .chat-tags{
      margin-top:4px;
      font-size:11px;
      display:flex;
      flex-wrap:wrap;
      gap:4px;
    }

    .chat-tag{
      padding:2px 6px;
      border-radius:999px;
      background:#020617;
      border:1px solid var(--border);
    }

    .chat-tag-important{
      border-color:#ef4444;
      color:#ef4444;
    }

    .chat-tag-dest{
      border-color:#22c55e;
      color:#22c55e;
    }

    .chat-input-area{
      border-top:1px solid var(--border);
      padding:8px;
    }

    .chat-input-row textarea{
      width:100%;
      background:#0b1627;
      border:1px solid var(--border);
      border-radius:8px;
      padding:8px;
      color:var(--txt);
      font-size:13px;
      resize:none;
    }

    .chat-input-extra{
      margin-top:6px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      font-size:12px;
    }

    .chat-send-btn{
      background:#22c55e;
      border:none;
      padding:6px 12px;
      border-radius:8px;
      cursor:pointer;
      color:#fff;
      font-weight:600;
    }

    .chat-status{
      font-size:12px;
      color:var(--muted);
      margin-top:4px;
      height:14px;
    }

    /* PANEL DESTINATARIOS */
    .chat-dest-panel{
      display:none;
      background:#0b1220;
      border:1px solid var(--border);
      border-radius:10px;
      padding:10px;
      margin-top:8px;
      max-height:160px;
      overflow-y:auto;
    }

    .chat-dest-item{
      display:flex;
      align-items:center;
      gap:6px;
      margin-bottom:4px;
    }

  </style>
</head>
<body>

<header>
  <div class="brand">
    <img src="img/tmp-quality.png" alt="TMP">
    <div>
      <h1>TMP ¬∑ Control Metrol√≥gico</h1>
      <span>Trazabilidad ¬∑ Instrumentos ¬∑ Laboratorio</span>
    </div>
  </div>
</header>

<!-- TOAST DE ALERTA GLOBAL -->
<div id="toast" class="toast">
  <div class="toast-icon">üö®</div>
  <div>
    <div class="toast-msg-main" id="toast-main">Atenci√≥n metrol√≥gica requerida</div>
    <div class="toast-msg-sub" id="toast-sub">Hay equipos que requieren calibraci√≥n prioritaria.</div>
  </div>
  <button class="toast-close" id="toast-close">‚úï</button>
</div>

<main>

  <!-- KPIs -->
  <section class="kpi-section">
    <h2 class="section-title">Resumen del laboratorio</h2>
    <p class="muted">Indicadores calculados en tiempo real desde Supabase.</p>

    <div class="kpi-grid">

      <div class="kpi-card" id="kpi-card-total">
        <div class="kpi-label">Instrumentos totales</div>
        <div class="kpi-value" id="kpi-total">‚Äì</div>
        <div class="kpi-extra" id="kpi-total-extra"></div>
      </div>

      <a href="listado_instrumentos.html?filtro=uso" class="kpi-link">
        <div class="kpi-card" id="kpi-card-uso">
          <div class="kpi-label">En uso (fuera de laboratorio)</div>
          <div class="kpi-value" id="kpi-uso">‚Äì</div>
          <div class="kpi-extra" id="kpi-uso-extra"></div>
        </div>
      </a>
   
      <a href="listado_instrumentos.html?filtro=laboratorio" class="kpi-link">
        <div class="kpi-card" id="kpi-card-lab">
          <div class="kpi-label">En laboratorio</div>
          <div class="kpi-value" id="kpi-lab">‚Äì</div>
          <div class="kpi-extra" id="kpi-lab-extra"></div>
        </div>
      </a>

      <a href="listado_instrumentos.html?filtro=calibrados" class="kpi-link">
        <div class="kpi-card" id="kpi-card-cal">
          <div class="kpi-label">Calibrados</div>
          <div class="kpi-value" id="kpi-calibrados">‚Äì</div>
          <div class="kpi-extra" id="kpi-calibrados-extra"></div>
        </div>
      </a>

      <div class="kpi-card" id="kpi-card-prox">
        <div class="kpi-label">Pr√≥ximos (&lt; 30 d√≠as)</div>
        <div class="kpi-value" id="kpi-proximos">‚Äì</div>
        <div class="kpi-extra" id="kpi-proximos-extra"></div>
      </div>

      <div class="kpi-card" id="kpi-card-fuera">
        <div class="kpi-label">Fuera de calibraci√≥n</div>
        <div class="kpi-value" id="kpi-fuera">‚Äì</div>
        <div class="kpi-extra" id="kpi-fuera-extra"></div>
      </div>

    </div>
  </section>

  <!-- ALERTAS -->
  <section class="alerts-section">
    <div class="alerts-header">
      <div>
        <h2 class="section-title">Alertas de calibraci√≥n</h2>
        <p class="muted">Vista compacta de lo realmente cr√≠tico. Detalle completo disponible bajo demanda.</p>
      </div>
      <div class="badge badge-soft" id="badge-resumen-global">Sin alertas cr√≠ticas</div>
    </div>

    <div class="alert-summary-grid">

      <!-- Fuera de calibraci√≥n -->
      <div class="alert-summary-card" id="card-alert-fuera">
        <div class="alert-title-row">
          <div class="alert-title-main">
            <span>‚ùå Fuera de calibraci√≥n</span>
            <span class="badge badge-danger" id="badge-fuera-count">0</span>
          </div>
        </div>
        <div class="alert-meta" id="meta-fuera">
          No hay instrumentos fuera de calibraci√≥n.
        </div>

        <table class="mini-table" id="table-fuera-top" style="display:none;">
          <thead>
            <tr>
              <th>C√≥digo</th>
              <th>Ubicaci√≥n</th>
              <th>Vencido (d√≠as)</th>
              <th>Severidad</th>
            </tr>
          </thead>
          <tbody id="tbody-fuera-top"></tbody>
        </table>

        <div class="alert-actions">
          <button class="btn btn-primary" id="btn-fuera-ver-todos" style="display:none;">Ver todos</button>
          <a href="TMP_Calibraciones_Lab.html" class="btn">Ir a Calibraciones Lab</a>
        </div>
      </div>

      <!-- Pr√≥ximos -->
      <div class="alert-summary-card" id="card-alert-prox">
        <div class="alert-title-row">
          <div class="alert-title-main">
            <span>‚ö†Ô∏è Pr√≥ximos (&lt; 30 d√≠as)</span>
            <span class="badge badge-warning" id="badge-prox-count">0</span>
          </div>
        </div>
        <div class="alert-meta" id="meta-prox">
          No hay instrumentos con calibraci√≥n pr√≥xima en los pr√≥ximos 30 d√≠as.
        </div>

        <table class="mini-table" id="table-prox-top" style="display:none;">
          <thead>
            <tr>
              <th>C√≥digo</th>
              <th>Ubicaci√≥n</th>
              <th>Faltan (d√≠as)</th>
              <th>Severidad</th>
            </tr>
          </thead>
          <tbody id="tbody-prox-top"></tbody>
        </table>

        <div class="alert-actions">
          <button class="btn btn-primary" id="btn-prox-ver-todos" style="display:none;">Ver todos</button>
          <a href="TMP_Calibraciones_Lab.html" class="btn">Planificar calibraci√≥n</a>
        </div>
      </div>

    </div>
  </section>

  <!-- √öLTIMOS MOVIMIENTOS -->
  <section class="mov-section">
    <div class="mov-header">
      <div>
        <h2 class="section-title">√öltimos movimientos</h2>
        <p class="muted">Entradas, salidas y movimientos recientes. Incluye responsables y operarios.</p>
      </div>
      <div class="mov-toolbar">
        <input id="mov-search" type="text" placeholder="Buscar...">
        <select id="mov-tipo">
          <option value="">Todos los tipos</option>
          <option value="Entrada">Entrada</option>
          <option value="Salida">Salida</option>
          <option value="Pr√©stamo externo">Pr√©stamo externo</option>
          <option value="Revisi√≥n / reparaci√≥n">Revisi√≥n / reparaci√≥n</option>
          <option value="Env√≠o a calibraci√≥n externa">Env√≠o a calibraci√≥n externa</option>
        </select>
      </div>
    </div>

    <table class="mini-table" id="table-movimientos">
      <thead>
        <tr>
          <th>Fecha</th>
          <th>C√≥digo</th>
          <th>Tipo</th>
          <th>Operario 1</th>
          <th>Operario 2</th>
          <th>Destino</th>
          <th>Responsable</th>
          <th>Calibraci√≥n</th>
          <th></th>
        </tr>
      </thead>
      <tbody id="tbody-movimientos">
        <tr><td colspan="9">Cargando movimientos...</td></tr>
      </tbody>
    </table>

    <div class="mov-pagination">
      <div>
        <button class="btn" id="mov-prev">&lt; Anterior</button>
        <button class="btn" id="mov-next">Siguiente &gt;</button>
      </div>
      <div id="mov-page-info">‚Äì</div>
    </div>
  </section>

  <!-- TARJETAS -->
  <a class="card" href="alta_instrumento.html">
    <div class="card-title">‚ûï Alta / Edici√≥n</div>
    <div class="card-desc">Registrar instrumentos, editar fichas, generar QR y gestionar estados.</div>
  </a>

  <a class="card" href="movimiento.html">
    <div class="card-title">üîÑ Movimientos</div>
    <div class="card-desc">Registrar entradas, salidas y ubicaciones.</div>
  </a>

  <a class="card" href="qr/qr.index.html">
    <div class="card-title">üè∑ Generar QR</div>
    <div class="card-desc">Crear c√≥digos QR para trazabilidad r√°pida.</div>
  </a>

  <a class="card" href="TMP_Calibraciones_Lab.html">
    <div class="card-title">üìè Calibraciones Lab</div>
    <div class="card-desc">Gesti√≥n de calibraciones internas.</div>
  </a>

  <a class="card" href="App_Patrones_TMP.html">
    <div class="card-title">üìê Patrones</div>
    <div class="card-desc">Inventario y control de patrones.</div>
  </a>

  <a class="card" href="App_Familias_TMP.html">
    <div class="card-title">üß© Familias</div>
    <div class="card-desc">Clasificaci√≥n y agrupaci√≥n de instrumentos.</div>
  </a>

  <a class="card" href="criterios.html">
    <div class="card-title">üìò Criterios de Aceptaci√≥n</div>
    <div class="card-desc">Documento clave para auditor√≠as.</div>
  </a>

  <a class="card" href="alcance_kpi.html">
    <div class="card-title">üìä Alcance Laboratorio & KPIs</div>
    <div class="card-desc">Magnitudes cubiertas y KPI avanzados.</div>
  </a>

  <a class="card" href="buscar_instrumento.html">
    <div class="card-title">üîé Buscar instrumento</div>
    <div class="card-desc">Consulta de existencia, estado y ficha.</div>
  </a>

  <a class="card" href="equipos-referencia-crear.html">
    <div class="card-title">üìã Crear tabla de equipos</div>
    <div class="card-desc">Registrar referencia con los equipos necesarios.</div>
  </a>

  <a class="card" href="equipos-referencia-consulta.html">
    <div class="card-title">üîç Consultar tablas de equipos</div>
    <div class="card-desc">Buscar referencia y ver equipos definidos.</div>
  </a>

  <footer>
    Talleres Mec√°nicos Paramio ¬∑ Sistema de Trazabilidad Metrol√≥gica ¬∑ 2025
  </footer>

</main>

<!-- DIALOGOS -->
<dialog id="dialog-fuera">
  <div class="dialog-header">
    <div>
      <div class="dialog-title">Equipos fuera de calibraci√≥n</div>
      <div class="dialog-sub" id="dialog-fuera-sub">Listado completo de instrumentos vencidos.</div>
    </div>
    <button class="btn" id="dialog-fuera-cerrar">Cerrar</button>
  </div>
  <div class="dialog-table-wrap">
    <table class="dialog-table">
      <thead>
        <tr>
          <th>C√≥digo</th>
          <th>Ubicaci√≥n</th>
          <th>Pr√≥xima calibraci√≥n</th>
          <th>Vencido (d√≠as)</th>
          <th></th>
        </tr>
      </thead>
      <tbody id="tbody-fuera-modal"></tbody>
    </table>
  </div>
</dialog>

<dialog id="dialog-prox">
  <div class="dialog-header">
    <div>
      <div class="dialog-title">Equipos pr√≥ximos a calibrar (&lt;30 d√≠as)</div>
      <div class="dialog-sub" id="dialog-prox-sub">Listado completo de instrumentos cuya calibraci√≥n vence pronto.</div>
    </div>
    <button class="btn" id="dialog-prox-cerrar">Cerrar</button>
  </div>
  <div class="dialog-table-wrap">
    <table class="dialog-table">
      <thead>
        <tr>
          <th>C√≥digo</th>
          <th>Ubicaci√≥n</th>
          <th>Pr√≥xima calibraci√≥n</th>
          <th>Faltan (d√≠as)</th>
          <th></th>
        </tr>
      </thead>
      <tbody id="tbody-prox-modal"></tbody>
    </table>
  </div>
</dialog>

<!-- CHAT -->
<div id="chat-fab" class="chat-fab">
  <span class="chat-fab-icon">üí¨</span>
  <span id="chat-fab-badge" class="chat-fab-badge" style="display:none;">0</span>
</div>

<div id="chat-panel" class="chat-panel">
  <div class="chat-header">
    <div>
      <div class="chat-title">Chat interno TMP</div>
      <div class="chat-subtitle">
        Avisos generales y mensajes importantes. Usuario: <span id="chat-user-label">-</span>
      </div>
    </div>
    <button id="chat-close" class="chat-close-btn">‚úï</button>
  </div>

  <div id="chat-messages" class="chat-messages">
    <div class="chat-empty">Todav√≠a no hay mensajes en el chat.</div>
  </div>

  <div class="chat-input-area">
    <div class="chat-input-row">
      <textarea id="chat-input" rows="2" placeholder="Escribe un mensaje..."></textarea>
    </div>

    <div class="chat-input-extra">
      <label class="chat-important-label">
        <input type="checkbox" id="chat-important">
        <span>IMPORTANTE</span>
      </label>

      <div class="chat-to-label">
        <span>Para:</span>
        <button type="button" id="chat-dest-open" class="chat-dest-btn">
          <span id="chat-dest-summary">Todos</span>
        </button>
      </div>

      <button id="chat-send" class="chat-send-btn">Enviar</button>
    </div>

    <div id="chat-status" class="chat-status"></div>

    <div id="chat-dest-panel" class="chat-dest-panel">
      <div class="chat-dest-header">
        <div class="chat-dest-title">Seleccionar destinatarios</div>
        <button type="button" id="chat-dest-close" class="chat-dest-close">‚úï</button>
      </div>
      <div id="chat-dest-body"></div>
      <div class="chat-dest-footer">
        <button type="button" id="chat-dest-apply" class="chat-send-btn">Aplicar</button>
      </div>
    </div>

  </div>
</div>
<!-- CARGAR SUPABASE -->
<script type="module" src="config.mjs"></script>

<!-- SCRIPT PRINCIPAL DASHBOARD (KPIs + MOVIMIENTOS) -->
<script type="module">
  const supabase = window.supabase;

  /* ============================================================
     HELPERS DOM
  ============================================================ */
  const kpi_total          = document.getElementById("kpi-total");
  const kpi_uso            = document.getElementById("kpi-uso");
  const kpi_lab            = document.getElementById("kpi-lab");
  const kpi_calibrados     = document.getElementById("kpi-calibrados");
  const kpi_proximos       = document.getElementById("kpi-proximos");
  const kpi_fuera          = document.getElementById("kpi-fuera");

  const kpi_total_extra      = document.getElementById("kpi-total-extra");
  const kpi_uso_extra        = document.getElementById("kpi-uso-extra");
  const kpi_lab_extra        = document.getElementById("kpi-lab-extra");
  const kpi_calibrados_extra = document.getElementById("kpi-calibrados-extra");
  const kpi_proximos_extra   = document.getElementById("kpi-proximos-extra");
  const kpi_fuera_extra      = document.getElementById("kpi-fuera-extra");

  const badgeResumenGlobal = document.getElementById("badge-resumen-global");
  const badge_fuera_count = document.getElementById("badge-fuera-count");
  const badge_prox_count  = document.getElementById("badge-prox-count");

  const meta_fuera = document.getElementById("meta-fuera");
  const meta_prox  = document.getElementById("meta-prox");

  const table_fuera_top = document.getElementById("table-fuera-top");
  const table_prox_top  = document.getElementById("table-prox-top");
  const tbody_fuera_top = document.getElementById("tbody-fuera-top");
  const tbody_prox_top  = document.getElementById("tbody-prox-top");

  const btn_fuera_ver_todos = document.getElementById("btn-fuera-ver-todos");
  const btn_prox_ver_todos  = document.getElementById("btn-prox-ver-todos");

  const dlgFuera = document.getElementById("dialog-fuera");
  const dlgProx  = document.getElementById("dialog-prox");

  const dlgFueraCerrar = document.getElementById("dialog-fuera-cerrar");
  const dlgProxCerrar  = document.getElementById("dialog-prox-cerrar");

  const tbody_fuera_modal = document.getElementById("tbody-fuera-modal");
  const tbody_prox_modal  = document.getElementById("tbody-prox-modal");

  // MOVIMIENTOS
  const tbodyMov       = document.getElementById("tbody-movimientos");
  const movSearch      = document.getElementById("mov-search");
  const movTipoSelect  = document.getElementById("mov-tipo");
  const movPrevBtn     = document.getElementById("mov-prev");
  const movNextBtn     = document.getElementById("mov-next");
  const movPageInfo    = document.getElementById("mov-page-info");

  let cacheMovimientos = [];
  const MOV_POR_PAG = 8;
  let movPaginaActual = 1;

  /* ============================================================
      UTILIDADES
  ============================================================ */

  function parseDate(str) {
    if (!str) return null;
    const norm = String(str).replace(/_/g, "-");
    const d = new Date(norm);
    return isNaN(d) ? null : d;
  }

  function formatDate(d){
    if (!d) return "‚Äî";
    const dd = String(d.getDate()).padStart(2,"0");
    const mm = String(d.getMonth() + 1).padStart(2,"0");
    const yy = d.getFullYear();
    return `${dd}/${mm}/${yy}`;
  }

  function daysBetween(a,b){
    const MS = 86400000;
    return Math.floor((a - b)/MS);
  }

  function pct(part, total){
    if (!total) return "0%";
    return `${Math.round((part/total)*100)}%`;
  }

  function estadoCalibracion(inst){
    const hoy = new Date();
    const prox = parseDate(inst.fecha_proxima_calibracion) || parseDate(inst.proxima_calibracion);

    if (!prox) return {estado:"SIN FECHA", clase:"calib-warn"};

    if (prox < hoy) return {estado:"FUERA", clase:"calib-bad"};

    const mas30 = new Date(hoy.getTime() + 30*86400000);
    if (prox <= mas30) return {estado:"PR√ìXIMA", clase:"calib-warn"};

    return {estado:"OK", clase:"calib-ok"};
  }

  /* ============================================================
      CARGA DEL DASHBOARD
  ============================================================ */
  async function cargarDashboard(){
    if (!supabase) return;

    const { data: instrumentos, error } = await supabase
      .from("instrumentos")
      .select("codigo, estado, ubicacion_actual, fecha_proxima_calibracion, proxima_calibracion");

    if (error){
      console.error("Error cargando instrumentos:", error);
      return;
    }

    const total = instrumentos.length;
    const hoy = new Date();
    const mas30 = new Date(hoy.getTime() + 30*86400000);

    let enLab = 0;
    let enUso = 0;
    let calibrados = 0;

    const fueraLista = [];
    const proxLista = [];

    instrumentos.forEach(inst => {
      const ubic = (inst.ubicacion_actual || "").trim().toLowerCase();
      if (ubic === "laboratorio") enLab++;
      else enUso++;

      const prox = parseDate(inst.fecha_proxima_calibracion) || parseDate(inst.proxima_calibracion);

      if (prox) {
        if (prox < hoy){
          fueraLista.push(inst);
        } else {
          calibrados++;
          if (prox <= mas30) proxLista.push(inst);
        }
      }
    });

    // KPIs
    kpi_total.textContent      = total;
    kpi_uso.textContent        = enUso;
    kpi_lab.textContent        = enLab;
    kpi_calibrados.textContent = calibrados;
    kpi_proximos.textContent   = proxLista.length;
    kpi_fuera.textContent      = fueraLista.length;

    kpi_uso_extra.textContent        = total ? `${pct(enUso,total)} del total` : "";
    kpi_lab_extra.textContent        = total ? `${pct(enLab,total)} del total` : "";
    kpi_calibrados_extra.textContent = total ? `${pct(calibrados,total)} en vigor` : "";
    kpi_proximos_extra.textContent   = total ? `${pct(proxLista.length,total)} del total` : "";
    kpi_fuera_extra.textContent      = total ? `${pct(fueraLista.length,total)} del total` : "";

    /* ------- ALERTAS -------- */
    badge_fuera_count.textContent = fueraLista.length;
    badge_prox_count.textContent  = proxLista.length;

    // Fuera de calibraci√≥n
    if (fueraLista.length === 0){
      meta_fuera.textContent = "No hay instrumentos fuera de calibraci√≥n.";
      table_fuera_top.style.display = "none";
      btn_fuera_ver_todos.style.display = "none";
      tbody_fuera_modal.innerHTML = "";
    } else {
      const orden = [...fueraLista].sort((a,b)=>{
        const da = parseDate(a.fecha_proxima_calibracion) || parseDate(a.proxima_calibracion);
        const db = parseDate(b.fecha_proxima_calibracion) || parseDate(b.proxima_calibracion);
        return da - db;
      });

      const top = orden.slice(0,3);

      meta_fuera.textContent = `${fueraLista.length} equipos vencidos.`;
      table_fuera_top.style.display = "table";
      btn_fuera_ver_todos.style.display = "inline-flex";

      tbody_fuera_top.innerHTML = top.map(inst=>{
        const dp = parseDate(inst.fecha_proxima_calibracion) || parseDate(inst.proxima_calibracion);
        const dias = dp ? daysBetween(hoy, dp) : 0;
        return `
          <tr>
            <td>${inst.codigo}</td>
            <td>${inst.ubicacion_actual}</td>
            <td>${dias}</td>
            <td><span class="chip-severity chip-critical">CR√çTICO</span></td>
          </tr>`;
      }).join("");

      tbody_fuera_modal.innerHTML = orden.map(inst=>{
        const dp = parseDate(inst.fecha_proxima_calibracion) || parseDate(inst.proxima_calibracion);
        const dias = dp ? daysBetween(hoy, dp) : 0;
        return `
          <tr>
            <td>${inst.codigo}</td>
            <td>${inst.ubicacion_actual}</td>
            <td>${formatDate(dp)}</td>
            <td>${dias}</td>
            <td><a class="btn" href="alta_instrumento.html?codigo=${inst.codigo}">Ver ficha</a></td>
          </tr>`;
      }).join("");
    }

    // Pr√≥ximos 30 d√≠as
    if (proxLista.length === 0){
      meta_prox.textContent = "No hay instrumentos pr√≥ximos.";
      table_prox_top.style.display = "none";
      btn_prox_ver_todos.style.display = "none";
      tbody_prox_modal.innerHTML = "";
    } else {
      const orden = [...proxLista].sort((a,b)=>{
        const da = parseDate(a.fecha_proxima_calibracion) || parseDate(a.proxima_calibracion);
        const db = parseDate(b.fecha_proxima_calibracion) || parseDate(b.proxima_calibracion);
        return da - db;
      });

      const top = orden.slice(0,3);

      meta_prox.textContent = `${proxLista.length} equipos pr√≥ximos.`;
      table_prox_top.style.display = "table";
      btn_prox_ver_todos.style.display = "inline-flex";

      tbody_prox_top.innerHTML = top.map(inst=>{
        const dp = parseDate(inst.fecha_proxima_calibracion) || parseDate(inst.proxima_calibracion);
        const dias = dp ? daysBetween(dp, hoy) * -1 : 0;
        return `
          <tr>
            <td>${inst.codigo}</td>
            <td>${inst.ubicacion_actual}</td>
            <td>${dias}</td>
            <td><span class="chip-severity chip-info">INFO</span></td>
          </tr>`;
      }).join("");

      tbody_prox_modal.innerHTML = orden.map(inst=>{
        const dp = parseDate(inst.fecha_proxima_calibracion) || parseDate(inst.proxima_calibracion);
        const dias = dp ? daysBetween(dp, hoy) * -1 : 0;
        return `
          <tr>
            <td>${inst.codigo}</td>
            <td>${inst.ubicacion_actual}</td>
            <td>${formatDate(dp)}</td>
            <td>${dias}</td>
            <td><a class="btn" href="alta_instrumento.html?codigo=${inst.codigo}">Ver ficha</a></td>
          </tr>`;
      }).join("");
    }

  }

  /* ============================================================
      MOVIMIENTOS
  ============================================================ */

  function aplicarFiltrosMov(){
    const q = (movSearch.value || "").toLowerCase();
    const tipo = movTipoSelect.value;

    return cacheMovimientos.filter(mov => {
      if (tipo && mov.tipo_movimiento !== tipo) return false;

      if (q){
        const hay =
          (mov.codigo_instrumento || "").toLowerCase().includes(q) ||
          (mov.destino || "").toLowerCase().includes(q) ||
          (mov.responsable || "").toLowerCase().includes(q) ||
          (mov.operario1 || "").toLowerCase().includes(q) ||
          (mov.operario2 || "").toLowerCase().includes(q);

        if (!hay) return false;
      }

      return true;
    });
  }

  function renderMovimientos(){
    const filtrados = aplicarFiltrosMov();
    const total = filtrados.length;

    if (total === 0){
      tbodyMov.innerHTML = `<tr><td colspan="9">No hay movimientos coincidentes.</td></tr>`;
      movPageInfo.textContent = "0 de 0";
      movPrevBtn.disabled = true;
      movNextBtn.disabled = true;
      return;
    }

    const totalPag = Math.max(1, Math.ceil(total / MOV_POR_PAG));
    if (movPaginaActual > totalPag) movPaginaActual = totalPag;
    if (movPaginaActual < 1) movPaginaActual = 1;

    const ini = (movPaginaActual - 1) * MOV_POR_PAG;
    const fin = ini + MOV_POR_PAG;

    const page = filtrados.slice(ini, fin);

    tbodyMov.innerHTML = page.map(mov=>{
      const fecha = mov.fecha ? new Date(mov.fecha) : null;
      const fechaTxt = fecha
        ? fecha.toLocaleString("es-ES",{dateStyle:"short", timeStyle:"short"})
        : "‚Äî";

      const estado = mov.estadoCal || {estado:"", clase:""};

      let icon = "‚úö";
      let tipoClase = "mov-row-ok";

      if (mov.tipo_movimiento === "Entrada"){ icon="‚¨Ö"; tipoClase="mov-row-in"; }
      if (mov.tipo_movimiento === "Salida"){ icon="‚û°"; tipoClase="mov-row-out"; }
      if (mov.tipo_movimiento === "Pr√©stamo externo"){ icon="üîÅ"; }
      if (mov.tipo_movimiento === "Revisi√≥n / reparaci√≥n"){ icon="üõ†"; }
      if (mov.tipo_movimiento === "Env√≠o a calibraci√≥n externa"){ icon="üì¶"; }

      let op1="", op2="";
      if (mov.tipo_movimiento === "Salida"){
        if (mov.operario1) op1 = `<span class="op-chip op1">${mov.operario1}</span>`;
        if (mov.operario2) op2 = `<span class="op-chip op2">${mov.operario2}</span>`;
      }

      return `
        <tr>
          <td>${fechaTxt}</td>
          <td>${mov.codigo_instrumento || ""}</td>
          <td class="${tipoClase}">${icon} ${mov.tipo_movimiento}</td>
          <td>${op1 || "-"}</td>
          <td>${op2 || "-"}</td>
          <td>${mov.destino || "-"}</td>
          <td>${mov.responsable || "-"}</td>
          <td>${estado.estado ? `<span class="calib-chip ${estado.clase}">${estado.estado}</span>` : ""}</td>
          <td><a class="btn" href="/qr/qr.info_instrumentos.html?codigo=${mov.codigo_instrumento}">Ver ficha</a></td>
        </tr>
      `;
    }).join("");

    movPageInfo.textContent = `P√°gina ${movPaginaActual} de ${totalPag} ¬∑ ${total}`;
    movPrevBtn.disabled = movPaginaActual <= 1;
    movNextBtn.disabled = movPaginaActual >= totalPag;
  }

  async function cargarMovimientos(){
    const { data: movs, error } = await supabase
      .from("movimientos")
      .select("fecha, codigo_instrumento, tipo_movimiento, destino, responsable, operario1, operario2")
      .order("fecha",{ascending:false})
      .limit(120);

    if (error){
      tbodyMov.innerHTML = `<tr><td colspan="9">Error al cargar movimientos.</td></tr>`;
      return;
    }

    const codigos = [...new Set(movs.map(m=>m.codigo_instrumento).filter(Boolean))];

    let mapaInst = {};
    if (codigos.length > 0){
      const {data: insts, error:err2} = await supabase
        .from("instrumentos")
        .select("codigo, fecha_proxima_calibracion, proxima_calibracion")
        .in("codigo", codigos);

      if (!err2){
        insts.forEach(inst => mapaInst[inst.codigo]=inst);
      }
    }

    cacheMovimientos = movs.map(m=>{
      const inst = mapaInst[m.codigo_instrumento];
      return {
        ...m,
        estadoCal: inst ? estadoCalibracion(inst) : {estado:"", clase:""}
      };
    });

    movPaginaActual = 1;
    renderMovimientos();
  }

  /* ============================================================
      EVENTOS
  ============================================================ */

  btn_fuera_ver_todos.addEventListener("click",()=>dlgFuera.showModal());
  btn_prox_ver_todos .addEventListener("click",()=>dlgProx.showModal());
  dlgFueraCerrar.addEventListener("click",()=>dlgFuera.close());
  dlgProxCerrar .addEventListener("click",()=>dlgProx.close());

  movSearch.addEventListener("input",()=>{movPaginaActual=1;renderMovimientos();});
  movTipoSelect.addEventListener("change",()=>{movPaginaActual=1;renderMovimientos();});

  movPrevBtn.addEventListener("click",()=>{movPaginaActual--;renderMovimientos();});
  movNextBtn.addEventListener("click",()=>{movPaginaActual++;renderMovimientos();});

  cargarDashboard();
  cargarMovimientos();

  setInterval(()=>{
    cargarDashboard();
    cargarMovimientos();
  }, 30000);

</script>

<!-- SCRIPT CHAT INTERNO TMP (CORREGIDO Y √öNICO) -->
<script type="module">
  const supabaseChat = window.supabase;

  let operario = null;
  try { operario = JSON.parse(localStorage.getItem("operario")); } catch {}
  const CHAT_USERNAME = operario?.username || "invitado";
  const CHAT_NOMBRE   = operario?.nombre   || CHAT_USERNAME;

  /* ===================== DOM ===================== */
  const chatFab      = document.getElementById("chat-fab");
  const chatBadge    = document.getElementById("chat-fab-badge");
  const chatPanel    = document.getElementById("chat-panel");
  const chatClose    = document.getElementById("chat-close");
  const chatMessages = document.getElementById("chat-messages");
  const chatInput    = document.getElementById("chat-input");
  const chatSend     = document.getElementById("chat-send");
  const chatImportant= document.getElementById("chat-important");
  const chatStatus   = document.getElementById("chat-status");
  const chatUserLabel= document.getElementById("chat-user-label");

  const destOpen     = document.getElementById("chat-dest-open");
  const destPanel    = document.getElementById("chat-dest-panel");
  const destBody     = document.getElementById("chat-dest-body");
  const destClose    = document.getElementById("chat-dest-close");
  const destApply    = document.getElementById("chat-dest-apply");
  const destSummary  = document.getElementById("chat-dest-summary");

  chatUserLabel.textContent = `${CHAT_NOMBRE} (${CHAT_USERNAME})`;

  /* ===================== ESTADO ===================== */
  let chatList = [];
  let operariosLista = [];
  let mapaOperarios = {};
  let destinatarios = [];  // vac√≠o = TODOS

  /* ===================== UTILIDADES ===================== */

  function normArray(v){
    if (!v) return [];
    if (Array.isArray(v)) return v;
    try { const p=JSON.parse(v); return Array.isArray(p)?p:[]; } catch { return []; }
  }

  function formatTS(ts){
    const d = new Date(ts);
    if (isNaN(d)) return "";
    const dd=String(d.getDate()).padStart(2,"0");
    const mm=String(d.getMonth()+1).padStart(2,"0");
    const hh=String(d.getHours()).padStart(2,"0");
    const mi=String(d.getMinutes()).padStart(2,"0");
    return `${dd}/${mm} ${hh}:${mi}`;
  }

  function esParaMi(msg){
    if (msg.autor === CHAT_USERNAME) return true;

    const dest = normArray(msg.destinatarios);
    if (dest.length === 0) return true;

    return dest.includes(CHAT_USERNAME);
  }

  function actualizarBadge(){
    let count = 0;
    chatList.forEach(msg=>{
      if (!msg.importante) return;
      if (!esParaMi(msg)) return;

      const leidos = normArray(msg.leido_por);
      if (!leidos.includes(CHAT_USERNAME)) count++;
    });

    if (count > 0){
      chatBadge.textContent = count;
      chatBadge.style.display="flex";
    } else {
      chatBadge.style.display="none";
    }
  }

  /* ===================== RENDER ===================== */

  function renderChat(){
    const visibles = chatList.filter(esParaMi);

    if (visibles.length === 0){
      chatMessages.innerHTML = `<div class="chat-empty">Todav√≠a no hay mensajes.</div>`;
      actualizarBadge();
      return;
    }

    chatMessages.innerHTML = visibles.map(msg=>{
      const mine = msg.autor === CHAT_USERNAME;
      const cls = mine ? "chat-message mine" : "chat-message";
      const autor = mapaOperarios[msg.autor]?.nombre || msg.autor;

      const leidos = normArray(msg.leido_por);
      const yaLeido = leidos.includes(CHAT_USERNAME);

      const dest = normArray(msg.destinatarios);
      const destLabel = dest.length
        ? "Para: " + dest.map(u=>mapaOperarios[u]?.nombre||u).join(", ")
        : "";

      let tags = "";
      if (msg.importante){
        tags += `<span class="chat-tag chat-tag-important">IMPORTANTE</span>`;
      }
      if (dest.length){
        tags += `<span class="chat-tag chat-tag-dest">${destLabel}</span>`;
      }

      let btnHecho = "";
      if (msg.importante && !mine && !yaLeido){
        btnHecho = `<button class="chat-done-btn" data-id="${msg.id}">Hecho</button>`;
      }

      return `
        <div class="${cls}">
          <div class="chat-message-header">
            <span>${autor}</span>
            <span>${formatTS(msg.created_at)}</span>
          </div>
          <div class="chat-text">${(msg.mensaje||"").replace(/</g,"&lt;")}</div>
          <div class="chat-tags">${tags} ${btnHecho}</div>
        </div>
      `;
    }).join("");

    document.querySelectorAll(".chat-done-btn").forEach(btn=>{
      btn.addEventListener("click", async ()=>{
        const id = btn.getAttribute("data-id");
        await marcarHecho(id);
      });
    });

    chatMessages.scrollTop = chatMessages.scrollHeight;

    actualizarBadge();
  }

  async function marcarHecho(id){
    const msg = chatList.find(m=>String(m.id)===String(id));
    if (!msg) return;

    let leidos = normArray(msg.leido_por);
    if (!leidos.includes(CHAT_USERNAME)) leidos.push(CHAT_USERNAME);

    const {data,error} = await supabaseChat
      .from("chat_mensajes")
      .update({leido_por:leidos})
      .eq("id",id)
      .select()
      .single();

    if (!error){
      const idx = chatList.findIndex(m=>m.id===data.id);
      if (idx>=0){
        chatList[idx]=data;
        renderChat();
      }
    }
  }

  /* ===================== DESTINATARIOS ===================== */

  function actualizarResumenDest(){
    if (!destinatarios.length){
      destSummary.textContent = "Todos";
      return;
    }
    const n = destinatarios.map(u=>mapaOperarios[u]?.nombre||u);
    if (n.length<=2) destSummary.textContent = n.join(", ");
    else destSummary.textContent = `${n[0]}, ${n[1]} +${n.length-2}`;
  }

  function abrirDest(){
    destPanel.style.display="block";
    const checks = destBody.querySelectorAll("input[type=checkbox]");
    checks.forEach(ch=>{
      if (destinatarios.length===0){
        ch.checked = (ch.value==="__todos__");
      } else {
        if (ch.value==="__todos__") ch.checked=false;
        else ch.checked = destinatarios.includes(ch.value);
      }
    });
  }

  function cerrarDest(){ destPanel.style.display="none"; }

  destOpen.addEventListener("click", abrirDest);
  destClose.addEventListener("click", cerrarDest);

  destApply.addEventListener("click",()=>{
    const inputs = destBody.querySelectorAll("input[type=checkbox]");
    let sel = [];
    let todos=false;

    inputs.forEach(inp=>{
      if (inp.checked){
        if (inp.value==="__todos__") todos=true;
        else sel.push(inp.value);
      }
    });

    destinatarios = (todos || sel.length===0) ? [] : sel;

    actualizarResumenDest();
    cerrarDest();
  });

  /* ===================== ENVIAR MENSAJE ===================== */

  async function enviar(){
    const texto = chatInput.value.trim();
    if (!texto) return;

    chatSend.disabled=true;
    chatStatus.textContent="Enviando...";

    const payload = {
      autor: CHAT_USERNAME,
      mensaje: texto,
      importante: !!chatImportant.checked,
      destinatarios: destinatarios.length ? destinatarios : null
    };

    const {error} = await supabaseChat
      .from("chat_mensajes")
      .insert(payload);

    if (!error){
      chatInput.value="";
      chatImportant.checked=false;
      destinatarios=[];
      actualizarResumenDest();
      chatStatus.textContent="Enviado";
      setTimeout(()=>chatStatus.textContent="",1500);
    } else {
      chatStatus.textContent="Error enviando.";
    }

    chatSend.disabled=false;
  }

  chatSend.addEventListener("click", enviar);

  chatInput.addEventListener("keydown", e=>{
    if (e.key==="Enter" && e.ctrlKey){
      e.preventDefault();
      enviar();
    }
  });

  /* ===================== CARGA INICIAL ===================== */
  async function cargarOperarios(){
    const {data} = await supabaseChat
      .from("operarios")
      .select("username,nombre")
      .order("nombre",{ascending:true});

    operariosLista = data || [];
    mapaOperarios = {};
    operariosLista.forEach(op=> mapaOperarios[op.username]=op );

    destBody.innerHTML = `
      <label class="chat-dest-item">
        <input type="checkbox" value="__todos__" checked>
        <span>Todos</span>
      </label>
    `;

    operariosLista.forEach(op=>{
      const el = document.createElement("label");
      el.className="chat-dest-item";
      el.innerHTML = `
        <input type="checkbox" value="${op.username}">
        <span>${op.nombre}</span>
      `;
      destBody.appendChild(el);
    });

    actualizarResumenDest();
  }

  async function cargarMensajes(){
    const {data} = await supabaseChat
      .from("chat_mensajes")
      .select("*")
      .order("created_at",{ascending:true})
      .limit(300);

    chatList = data || [];
    renderChat();
  }

  /* ===================== TOGGLE PANEL ===================== */
  function togglePanel(){
    chatPanel.classList.toggle("open");
    if (chatPanel.classList.contains("open")){
      setTimeout(()=>{ chatMessages.scrollTop = chatMessages.scrollHeight; },80);
    }
  }

  chatFab.addEventListener("click", togglePanel);
  chatClose.addEventListener("click", togglePanel);

  /* ===================== REALTIME ===================== */
  function activarRealtime(){
    supabaseChat
      .channel("chat_mensajes_changes")
      .on("postgres_changes",
        {event:"INSERT",schema:"public",table:"chat_mensajes"},
        payload=>{
          chatList.push(payload.new);
          renderChat();
        }
      )
      .on("postgres_changes",
        {event:"UPDATE",schema:"public",table:"chat_mensajes"},
        payload=>{
          const idx = chatList.findIndex(m=>m.id===payload.new.id);
          if (idx>=0) chatList[idx]=payload.new;
          else chatList.push(payload.new);
          renderChat();
        }
      )
      .subscribe();
  }

  /* ===================== INIT ===================== */
  async function init(){
    if (!supabaseChat){
      console.error("Supabase no disponible para chat.");
      return;
    }

    await cargarOperarios();
    await cargarMensajes();
    activarRealtime();
  }

  init();

</script>

</body>
</html>
