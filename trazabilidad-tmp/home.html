<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TMP ¬∑ Trazabilidad Metrol√≥gica</title>

  <style>
    :root{
      --bg:#0d1117;
      --panel:#161b22;
      --txt:#f0f6fc;
      --muted:#8b949e;
      --border:#30363d;
      --card-bg:#1c2431;
      --hover:#263041;
      --accent:#00b4d8;
      --danger:#b91c1c;
      --warning:#f59e0b;
      --success:#22c55e;
    }

    body{
      margin:0;
      font-family:system-ui,-apple-system,"Segoe UI",Roboto;
      background:var(--bg);
      color:var(--txt);
    }

    header{
      background:var(--panel);
      border-bottom:1px solid var(--border);
      padding:16px 20px;
      display:flex;
      align-items:center;
      justify-content:space-between;
    }

    .brand{
      display:flex;
      align-items:center;
      gap:12px;
    }
    .brand img{
      height:46px;
    }
    .brand h1{
      margin:0;
      font-size:20px;
    }
    .brand span{
      font-size:13px;
      color:var(--muted);
    }

    main{
      max-width:1100px;
      margin:26px auto;
      padding:0 18px;
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(260px,1fr));
      gap:18px;
    }

    /* Bloques superiores: KPIs + alertas ocupan todo el ancho */
    .kpi-section,
    .alerts-section{
      grid-column:1 / -1;
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:14px;
      padding:18px 18px 16px;
    }

    .section-title{
      margin:0 0 8px;
      font-size:18px;
      font-weight:600;
      color:var(--accent);
    }

    .muted{
      font-size:13px;
      color:var(--muted);
      margin:0 0 12px;
    }

    /* KPIs */
    .kpi-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(150px,1fr));
      gap:10px;
    }

    .kpi-card{
      background:var(--card-bg);
      border-radius:10px;
      border:1px solid var(--border);
      padding:10px 12px;
      transition:all .3s ease;
    }

    .kpi-card.updated {
      background:#113344;
      box-shadow:0 0 12px rgba(0,180,216,.4);
    }

    .kpi-label{
      font-size:12px;
      color:var(--muted);
      margin-bottom:4px;
    }

    .kpi-value{
      font-size:20px;
      font-weight:700;
      line-height:1.1;
    }

    .kpi-extra{
      margin-top:4px;
      font-size:12px;
      color:var(--muted);
    }

    /* Alertas */
    .alerts-columns{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(260px,1fr));
      gap:14px;
      margin-top:8px;
    }

    .alerts-box{
      background:var(--card-bg);
      border-radius:10px;
      border:1px solid var(--border);
      padding:10px 12px 12px;
    }

    .alerts-title{
      display:flex;
      align-items:center;
      gap:6px;
      margin:0 0 6px;
      font-size:15px;
      font-weight:600;
    }

    .alerts-title span.badge{
      font-size:11px;
      padding:2px 6px;
      border-radius:999px;
      border:1px solid var(--border);
      color:var(--muted);
    }

    .badge-danger{
      border-color:var(--danger);
      color:var(--danger);
      animation:blink 1.6s infinite;
    }
    .badge-warning{
      border-color:var(--warning);
      color:var(--warning);
    }

    @keyframes blink {
      0%, 100% { opacity:1; }
      50% { opacity:.35; }
    }

    .alerts-table{
      width:100%;
      border-collapse:collapse;
      font-size:12px;
    }

    .alerts-table th,
    .alerts-table td{
      padding:4px 6px;
      border-bottom:1px solid var(--border);
      text-align:left;
      white-space:nowrap;
    }

    .alerts-table thead{
      background:#111827;
    }

    .alerts-table tbody tr:nth-child(even){
      background:#111827;
    }

    .link-btn{
      display:inline-flex;
      padding:3px 8px;
      border-radius:999px;
      border:1px solid var(--border);
      font-size:11px;
      text-decoration:none;
      background:#111827;
      color:var(--txt);
    }

    .link-btn:hover{
      background:var(--hover);
    }

    /* Tarjetas de navegaci√≥n (como antes) */
    .card{
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:14px;
      padding:20px 18px;
      text-decoration:none;
      color:var(--txt);
      display:flex;
      flex-direction:column;
      gap:8px;
      transition:0.15s;
    }

    .card:hover{
      background:var(--hover);
      transform:translateY(-2px);
    }

    .card-title{
      font-size:18px;
      font-weight:600;
      color:var(--accent);
    }

    .card-desc{
      font-size:14px;
      color:var(--muted);
      line-height:1.3;
    }

    footer{
      grid-column:1 / -1;
      text-align:center;
      margin-top:10px;
      padding-bottom:20px;
      font-size:13px;
      color:var(--muted);
    }
  </style>
</head>
<body>

<header>
  <div class="brand">
    <img src="img/tmp-quality.png" alt="TMP">
    <div>
      <h1>TMP ¬∑ Control Metrol√≥gico</h1>
      <span>Trazabilidad ¬∑ Instrumentos ¬∑ Laboratorio</span>
    </div>
  </div>
</header>

<main>

  <!-- KPIs -->
  <section class="kpi-section">
    <h2 class="section-title">Resumen del laboratorio</h2>
    <p class="muted">Indicadores calculados en tiempo real desde Supabase.</p>

    <div class="kpi-grid">

      <div class="kpi-card" id="kpi-card-total">
        <div class="kpi-label">Instrumentos totales</div>
        <div class="kpi-value" id="kpi-total">‚Äì</div>
        <div class="kpi-extra" id="kpi-total-extra"></div>
      </div>

      <div class="kpi-card" id="kpi-card-uso">
        <div class="kpi-label">En uso (fuera de laboratorio)</div>
        <div class="kpi-value" id="kpi-uso">‚Äì</div>
        <div class="kpi-extra" id="kpi-uso-extra"></div>
      </div>

      <div class="kpi-card" id="kpi-card-lab">
        <div class="kpi-label">En laboratorio</div>
        <div class="kpi-value" id="kpi-lab">‚Äì</div>
        <div class="kpi-extra" id="kpi-lab-extra"></div>
      </div>

      <div class="kpi-card" id="kpi-card-cal">
        <div class="kpi-label">Calibrados</div>
        <div class="kpi-value" id="kpi-calibrados">‚Äì</div>
        <div class="kpi-extra" id="kpi-calibrados-extra"></div>
      </div>

      <div class="kpi-card" id="kpi-card-prox">
        <div class="kpi-label">Pr√≥ximos (&lt; 30 d√≠as)</div>
        <div class="kpi-value" id="kpi-proximos">‚Äì</div>
        <div class="kpi-extra" id="kpi-proximos-extra"></div>
      </div>

      <div class="kpi-card" id="kpi-card-fuera">
        <div class="kpi-label">Fuera de calibraci√≥n</div>
        <div class="kpi-value" id="kpi-fuera">‚Äì</div>
        <div class="kpi-extra" id="kpi-fuera-extra"></div>
      </div>

    </div>
  </section>

  <!-- ALERTAS -->
  <section class="alerts-section">
    <h2 class="section-title">Alertas de calibraci√≥n</h2>
    <p class="muted">Estados cr√≠ticos detectados autom√°ticamente.</p>

    <div class="alerts-columns">

      <div class="alerts-box">
        <h3 class="alerts-title">
          ‚ùå Fuera de calibraci√≥n
          <span class="badge badge-danger" id="badge-fuera-count">0</span>
        </h3>

        <table class="alerts-table">
          <thead>
            <tr>
              <th>C√≥digo</th>
              <th>Ubicaci√≥n</th>
              <th>Pr√≥xima</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="tbody-fuera"></tbody>
        </table>
      </div>

      <div class="alerts-box">
        <h3 class="alerts-title">
          ‚ö†Ô∏è Pr√≥ximos (&lt; 30 d√≠as)
          <span class="badge badge-warning" id="badge-prox-count">0</span>
        </h3>

        <table class="alerts-table">
          <thead>
            <tr>
              <th>C√≥digo</th>
              <th>Ubicaci√≥n</th>
              <th>Pr√≥xima</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="tbody-prox"></tbody>
        </table>
      </div>

    </div>
  </section>

  <!-- TARJETAS / ACCESOS (dise√±o original) -->
  <a class="card" href="alta_instrumento.html">
    <div class="card-title">‚ûï Alta / Edici√≥n</div>
    <div class="card-desc">Registrar instrumentos, editar fichas, generar QR y gestionar estados.</div>
  </a>

  <a class="card" href="movimiento.html">
    <div class="card-title">üîÑ Movimientos</div>
    <div class="card-desc">Registrar entradas, salidas, ubicaciones y responsables.</div>
  </a>

  <a class="card" href="qr/qr.index.html">
    <div class="card-title">üè∑ Generar QR</div>
    <div class="card-desc">Crear c√≥digos QR para identificaci√≥n r√°pida y trazabilidad.</div>
  </a>

  <a class="card" href="TMP_Calibraciones_Lab.html">
    <div class="card-title">üìè Calibraciones Lab</div>
    <div class="card-desc">Gesti√≥n de calibraciones internas del laboratorio TMP.</div>
  </a>

  <a class="card" href="App_Patrones_TMP.html">
    <div class="card-title">üìê Patrones</div>
    <div class="card-desc">Inventario y control de patrones del laboratorio.</div>
  </a>

  <a class="card" href="App_Familias_TMP.html">
    <div class="card-title">üß© Familias</div>
    <div class="card-desc">Clasificaci√≥n y agrupaci√≥n de instrumentos TMP.</div>
  </a>

  <a class="card" href="App_Tipos_TMP.html">
    <div class="card-title">üóÇ Tipos de Instrumentos</div>
    <div class="card-desc">Gesti√≥n de tipos y categor√≠as t√©cnicas.</div>
  </a>

  <a class="card" href="criterios.html">
    <div class="card-title">üìò Criterios de Aceptaci√≥n</div>
    <div class="card-desc">Requisitos metrol√≥gicos TMP: aceptaci√≥n interna y externa. Documento clave para auditor√≠as.</div>
  </a>

  <a class="card" href="alcance_kpi.html">
    <div class="card-title">üìä Alcance Laboratorio & KPIs</div>
    <div class="card-desc">Magnitudes cubiertas, rangos y panel de indicadores del laboratorio TMP.</div>
  </a>

  <footer>
    Talleres Mec√°nicos Paramio ¬∑ Sistema de Trazabilidad Metrol√≥gica ¬∑ 2025
  </footer>

</main>

<!-- CARGAR SUPABASE -->
<script type="module" src="config.mjs"></script>

<script type="module">
  const supabase = window.supabase;

  if (!supabase) {
    console.error("Supabase no disponible en home.html");
  }

  // Referencias DOM (en m√≥dulos NO se crean variables globales por id)
  const kpi_total          = document.getElementById("kpi-total");
  const kpi_uso            = document.getElementById("kpi-uso");
  const kpi_lab            = document.getElementById("kpi-lab");
  const kpi_calibrados     = document.getElementById("kpi-calibrados");
  const kpi_proximos       = document.getElementById("kpi-proximos");
  const kpi_fuera          = document.getElementById("kpi-fuera");

  const kpi_total_extra    = document.getElementById("kpi-total-extra");
  const kpi_uso_extra      = document.getElementById("kpi-uso-extra");
  const kpi_lab_extra      = document.getElementById("kpi-lab-extra");
  const kpi_calibrados_extra = document.getElementById("kpi-calibrados-extra");
  const kpi_proximos_extra = document.getElementById("kpi-proximos-extra");
  const kpi_fuera_extra    = document.getElementById("kpi-fuera-extra");

  const kpi_card_total = document.getElementById("kpi-card-total");
  const kpi_card_uso   = document.getElementById("kpi-card-uso");
  const kpi_card_lab   = document.getElementById("kpi-card-lab");
  const kpi_card_cal   = document.getElementById("kpi-card-cal");
  const kpi_card_prox  = document.getElementById("kpi-card-prox");
  const kpi_card_fuera = document.getElementById("kpi-card-fuera");

  const tbody_fuera        = document.getElementById("tbody-fuera");
  const tbody_prox         = document.getElementById("tbody-prox");
  const badge_fuera_count  = document.getElementById("badge-fuera-count");
  const badge_prox_count   = document.getElementById("badge-prox-count");

  function parseDate(str) {
    if (!str) return null;
    const d = new Date(str);
    return isNaN(d) ? null : d;
  }

  function formatDate(d){
    if (!d) return "‚Äî";
    return `${String(d.getDate()).padStart(2,"0")}/${String(d.getMonth()+1).padStart(2,"0")}/${d.getFullYear()}`;
  }

  function animateCard(el){
    if (!el) return;
    el.classList.add("updated");
    setTimeout(()=>el.classList.remove("updated"), 900);
  }

  function pct(part, total){
    if (!total) return "0%";
    return `${Math.round((part/total)*100)}%`;
  }

  async function cargarDashboard() {
    if (!supabase) return;

    const { data: instrumentos, error } = await supabase
      .from("instrumentos")
      .select("codigo, estado, ubicacion_actual, proxima_calibracion");

    if (error) {
      console.error("Error cargando instrumentos en home:", error);
      return;
    }

    const total = instrumentos.length;
    const hoy = new Date();
    const mas30 = new Date();
    mas30.setDate(hoy.getDate() + 30);

    let enLab = 0;
    let enUso = 0;
    let calibrados = 0;
    const fueraLista = [];
    const proxLista  = [];

    instrumentos.forEach(inst => {
      const ubic = (inst.ubicacion_actual || "").trim().toLowerCase();
      if (ubic === "laboratorio") enLab++;
      else enUso++;

      if ((inst.estado || "").trim().toLowerCase() === "calibrado") {
        calibrados++;
      }

      const prox = parseDate(inst.proxima_calibracion);
      if (prox) {
        if (prox < hoy) {
          fueraLista.push(inst);
        } else if (prox >= hoy && prox <= mas30) {
          proxLista.push(inst);
        }
      }
    });

    // KPIs
    kpi_total.textContent      = total;
    kpi_uso.textContent        = enUso;
    kpi_lab.textContent        = enLab;
    kpi_calibrados.textContent = calibrados;
    kpi_proximos.textContent   = proxLista.length;
    kpi_fuera.textContent      = fueraLista.length;

    kpi_total_extra.textContent      = "";
    kpi_uso_extra.textContent        = total ? `${pct(enUso,total)} del total` : "";
    kpi_lab_extra.textContent        = total ? `${pct(enLab,total)} del total` : "";
    kpi_calibrados_extra.textContent = total ? `${pct(calibrados,total)} calibrados` : "";
    kpi_proximos_extra.textContent   = total ? `${pct(proxLista.length,total)} del total` : "";
    kpi_fuera_extra.textContent      = total ? `${pct(fueraLista.length,total)} del total` : "";

    animateCard(kpi_card_total);
    animateCard(kpi_card_uso);
    animateCard(kpi_card_lab);
    animateCard(kpi_card_cal);
    animateCard(kpi_card_prox);
    animateCard(kpi_card_fuera);

    // Tablas
    tbody_fuera.innerHTML = fueraLista
      .sort((a,b) => new Date(a.proxima_calibracion) - new Date(b.proxima_calibracion))
      .map(i => `
        <tr>
          <td>${i.codigo || ""}</td>
          <td>${i.ubicacion_actual || ""}</td>
          <td>${formatDate(parseDate(i.proxima_calibracion))}</td>
          <td>
            <a class="link-btn" href="alta_instrumento.html?codigo=${encodeURIComponent(i.codigo || "")}">
              Ver
            </a>
          </td>
        </tr>
      `)
      .join("");

    tbody_prox.innerHTML = proxLista
      .sort((a,b) => new Date(a.proxima_calibracion) - new Date(b.proxima_calibracion))
      .map(i => `
        <tr>
          <td>${i.codigo || ""}</td>
          <td>${i.ubicacion_actual || ""}</td>
          <td>${formatDate(parseDate(i.proxima_calibracion))}</td>
          <td>
            <a class="link-btn" href="alta_instrumento.html?codigo=${encodeURIComponent(i.codigo || "")}">
              Ver
            </a>
          </td>
        </tr>
      `)
      .join("");

    badge_fuera_count.textContent = fueraLista.length;
    badge_prox_count.textContent  = proxLista.length;
  }

  cargarDashboard();
  // Auto-refresco cada 30s (puedes subirlo/bajarlo)
  setInterval(cargarDashboard, 30000);
</script>

</body>
</html>
