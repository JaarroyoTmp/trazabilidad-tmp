<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TMP ¬∑ Trazabilidad Metrol√≥gica</title>

  <style>
    :root{
      --bg:#0d1117;
      --panel:#161b22;
      --txt:#f0f6fc;
      --muted:#8b949e;
      --border:#30363d;
      --card-bg:#1c2431;
      --hover:#263041;
      --accent:#00b4d8;
      --danger:#b91c1c;
      --warning:#f59e0b;
      --success:#22c55e;
    }

    body{
      margin:0;
      font-family:system-ui,-apple-system,"Segoe UI",Roboto;
      background:var(--bg);
      color:var(--txt);
    }

    header{
      background:var(--panel);
      border-bottom:1px solid var(--border);
      padding:16px 20px;
      display:flex;
      align-items:center;
      justify-content:space-between;
    }

    .brand{
      display:flex;
      align-items:center;
      gap:12px;
    }
    .brand img{
      height:46px;
    }
    .brand h1{
      margin:0;
      font-size:20px;
    }
    .brand span{
      font-size:13px;
      color:var(--muted);
    }

    main{
      max-width:1100px;
      margin:26px auto;
      padding:0 18px;
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(260px,1fr));
      gap:18px;
    }

    /* Bloques de informaci√≥n (KPIs + alertas) ocupan todo el ancho de la grid */
    .kpi-section,
    .alerts-section{
      grid-column:1 / -1;
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:14px;
      padding:18px 18px 16px;
    }

    .section-title{
      margin:0 0 8px;
      font-size:18px;
      font-weight:600;
      color:var(--accent);
    }

    .muted{
      font-size:13px;
      color:var(--muted);
      margin:0 0 12px;
    }

    /* KPIs */
    .kpi-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(150px,1fr));
      gap:10px;
    }

    .kpi-card{
      background:var(--card-bg);
      border-radius:10px;
      border:1px solid var(--border);
      padding:10px 12px;
    }

    .kpi-label{
      font-size:12px;
      color:var(--muted);
      margin-bottom:4px;
    }

    .kpi-value{
      font-size:20px;
      font-weight:700;
      line-height:1.1;
    }

    .kpi-extra{
      margin-top:4px;
      font-size:12px;
      color:var(--muted);
    }

    /* Alertas */
    .alerts-columns{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(260px,1fr));
      gap:14px;
      margin-top:8px;
    }

    .alerts-box{
      background:var(--card-bg);
      border-radius:10px;
      border:1px solid var(--border);
      padding:10px 12px 12px;
    }

    .alerts-title{
      display:flex;
      align-items:center;
      gap:6px;
      margin:0 0 6px;
      font-size:15px;
      font-weight:600;
    }

    .alerts-title span.badge{
      font-size:11px;
      padding:2px 6px;
      border-radius:999px;
      border:1px solid var(--border);
      color:var(--muted);
    }

    .badge-danger{
      border-color:var(--danger);
      color:var(--danger);
    }
    .badge-warning{
      border-color:var(--warning);
      color:var(--warning);
    }

    .alerts-table{
      width:100%;
      border-collapse:collapse;
      font-size:12px;
    }
    .alerts-table thead{
      background:#111827;
    }
    .alerts-table th,
    .alerts-table td{
      padding:4px 6px;
      border-bottom:1px solid var(--border);
      text-align:left;
      white-space:nowrap;
    }
    .alerts-table tbody tr:nth-child(even){
      background:#111827;
    }

    .status-pill{
      display:inline-flex;
      align-items:center;
      padding:1px 6px;
      border-radius:999px;
      font-size:11px;
      border:1px solid var(--border);
    }
    .status-pill.danger{
      border-color:var(--danger);
      color:var(--danger);
    }
    .status-pill.warning{
      border-color:var(--warning);
      color:var(--warning);
    }

    .link-btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:3px 8px;
      border-radius:999px;
      border:1px solid var(--border);
      font-size:11px;
      color:var(--txt);
      text-decoration:none;
      background:#111827;
    }
    .link-btn:hover{
      background:var(--hover);
    }

    .empty-msg{
      font-size:12px;
      color:var(--muted);
      margin-top:2px;
    }

    /* Tarjetas de navegaci√≥n ya existentes */
    .card{
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:14px;
      padding:20px 18px;
      text-decoration:none;
      color:var(--txt);
      display:flex;
      flex-direction:column;
      gap:8px;
      transition:0.15s;
    }

    .card:hover{
      background:var(--hover);
      transform:translateY(-2px);
    }

    .card-title{
      font-size:18px;
      font-weight:600;
      color:var(--accent);
    }

    .card-desc{
      font-size:14px;
      color:var(--muted);
      line-height:1.3;
    }

    footer{
      text-align:center;
      margin-top:30px;
      padding-bottom:20px;
      font-size:13px;
      color:var(--muted);
    }
  </style>
</head>
<body>

<header>
  <div class="brand">
    <img src="img/tmp-quality.png" alt="TMP">
    <div>
      <h1>TMP ¬∑ Control Metrol√≥gico</h1>
      <span>Trazabilidad ¬∑ Instrumentos ¬∑ Laboratorio</span>
    </div>
  </div>
</header>

<main>

  <!-- PANEL DE KPIs LABORATORIO -->
  <section class="kpi-section">
    <h2 class="section-title">Resumen del laboratorio</h2>
    <p class="muted">
      Indicadores calculados en tiempo real a partir de la tabla <code>instrumentos</code> de Supabase.
    </p>

    <div class="kpi-grid">
      <div class="kpi-card">
        <div class="kpi-label">Instrumentos totales</div>
        <div class="kpi-value" id="kpi-total">‚Äì</div>
        <div class="kpi-extra" id="kpi-total-extra"></div>
      </div>

      <div class="kpi-card">
        <div class="kpi-label">En uso (fuera de laboratorio)</div>
        <div class="kpi-value" id="kpi-uso">‚Äì</div>
        <div class="kpi-extra" id="kpi-uso-extra"></div>
      </div>

      <div class="kpi-card">
        <div class="kpi-label">En laboratorio</div>
        <div class="kpi-value" id="kpi-lab">‚Äì</div>
        <div class="kpi-extra" id="kpi-lab-extra"></div>
      </div>

      <div class="kpi-card">
        <div class="kpi-label">Calibrados</div>
        <div class="kpi-value" id="kpi-calibrados">‚Äì</div>
        <div class="kpi-extra" id="kpi-calibrados-extra"></div>
      </div>

      <div class="kpi-card">
        <div class="kpi-label">Pr√≥ximos a calibrar (&lt; 30 d√≠as)</div>
        <div class="kpi-value" id="kpi-proximos">‚Äì</div>
        <div class="kpi-extra" id="kpi-proximos-extra"></div>
      </div>

      <div class="kpi-card">
        <div class="kpi-label">Fuera de calibraci√≥n</div>
        <div class="kpi-value" id="kpi-fuera">‚Äì</div>
        <div class="kpi-extra" id="kpi-fuera-extra"></div>
      </div>
    </div>
  </section>

  <!-- ALERTAS OPERATIVAS -->
  <section class="alerts-section">
    <h2 class="section-title">Alertas de calibraci√≥n</h2>
    <p class="muted">
      Equipos fuera de calibraci√≥n y pr√≥ximos a vencer. Los operarios pueden localizar estos c√≥digos
      y priorizar su calibraci√≥n.
    </p>

    <div class="alerts-columns">

      <!-- Fuera de calibraci√≥n -->
      <div class="alerts-box">
        <h3 class="alerts-title">
          ‚ùå Fuera de calibraci√≥n
          <span class="badge badge-danger" id="badge-fuera-count">0</span>
        </h3>
        <table class="alerts-table">
          <thead>
          <tr>
            <th>C√≥digo</th>
            <th>Ubicaci√≥n</th>
            <th>Pr√≥xima</th>
            <th></th>
          </tr>
          </thead>
          <tbody id="tbody-fuera"></tbody>
        </table>
        <div class="empty-msg" id="msg-fuera" style="display:none;">
          No hay instrumentos fuera de calibraci√≥n.
        </div>
      </div>

      <!-- Pr√≥ximos -->
      <div class="alerts-box">
        <h3 class="alerts-title">
          ‚ö†Ô∏è Pr√≥ximos (&lt; 30 d√≠as)
          <span class="badge badge-warning" id="badge-prox-count">0</span>
        </h3>
        <table class="alerts-table">
          <thead>
          <tr>
            <th>C√≥digo</th>
            <th>Ubicaci√≥n</th>
            <th>Pr√≥xima</th>
            <th></th>
          </tr>
          </thead>
          <tbody id="tbody-prox"></tbody>
        </table>
        <div class="empty-msg" id="msg-prox" style="display:none;">
          No hay instrumentos con calibraci√≥n pr√≥xima en los pr√≥ximos 30 d√≠as.
        </div>
      </div>

    </div>
  </section>

  <!-- TARJETAS / BOTONES EXISTENTES -->
  <a class="card" href="alta_instrumento.html">
    <div class="card-title">‚ûï Alta / Edici√≥n</div>
    <div class="card-desc">Registrar instrumentos, editar fichas, generar QR y gestionar estados.</div>
  </a>

  <a class="card" href="movimiento.html">
    <div class="card-title">üîÑ Movimientos</div>
    <div class="card-desc">Registrar entradas, salidas, ubicaciones y responsables.</div>
  </a>

  <a class="card" href="qr/qr.index.html">
    <div class="card-title">üè∑ Generar QR</div>
    <div class="card-desc">Crear c√≥digos QR para identificaci√≥n r√°pida y trazabilidad.</div>
  </a>

  <a class="card" href="TMP_Calibraciones_Lab.html">
    <div class="card-title">üìè Calibraciones Lab</div>
    <div class="card-desc">Gesti√≥n de calibraciones internas del laboratorio TMP.</div>
  </a>

  <a class="card" href="App_Patrones_TMP.html">
    <div class="card-title">üìê Patrones</div>
    <div class="card-desc">Inventario y control de patrones del laboratorio.</div>
  </a>

  <a class="card" href="App_Familias_TMP.html">
    <div class="card-title">üß© Familias</div>
    <div class="card-desc">Clasificaci√≥n y agrupaci√≥n de instrumentos TMP.</div>
  </a>

  <a class="card" href="App_Tipos_TMP.html">
    <div class="card-title">üóÇ Tipos de Instrumentos</div>
    <div class="card-desc">Gesti√≥n de tipos y categor√≠as t√©cnicas.</div>
  </a>

  <a class="card" href="criterios.html">
    <div class="card-title">üìò Criterios de Aceptaci√≥n</div>
    <div class="card-desc">Requisitos metrol√≥gicos TMP: aceptaci√≥n interna y externa. Documento clave para auditor√≠as.</div>
  </a>

  <a class="card" href="alcance_kpi.html">
    <div class="card-title">üìä Alcance Laboratorio & KPIs</div>
    <div class="card-desc">Magnitudes cubiertas, rangos y panel de indicadores del laboratorio TMP.</div>
  </a>

</main>

<footer>
  Talleres Mec√°nicos Paramio ¬∑ Sistema de Trazabilidad Metrol√≥gica ¬∑ 2025
</footer>

<!-- Cliente Supabase -->
<script type="module" src="config.mjs"></script>
<script type="module">
  const supabase = window.supabase;

  const elTotal = document.getElementById('kpi-total');
  const elTotalExtra = document.getElementById('kpi-total-extra');
  const elUso = document.getElementById('kpi-uso');
  const elUsoExtra = document.getElementById('kpi-uso-extra');
  const elLab = document.getElementById('kpi-lab');
  const elLabExtra = document.getElementById('kpi-lab-extra');
  const elCal = document.getElementById('kpi-calibrados');
  const elCalExtra = document.getElementById('kpi-calibrados-extra');
  const elProx = document.getElementById('kpi-proximos');
  const elProxExtra = document.getElementById('kpi-proximos-extra');
  const elFuera = document.getElementById('kpi-fuera');
  const elFueraExtra = document.getElementById('kpi-fuera-extra');

  const tbodyFuera = document.getElementById('tbody-fuera');
  const tbodyProx = document.getElementById('tbody-prox');
  const badgeFuera = document.getElementById('badge-fuera-count');
  const badgeProx = document.getElementById('badge-prox-count');
  const msgFuera = document.getElementById('msg-fuera');
  const msgProx = document.getElementById('msg-prox');

  function parseDate(dStr) {
    if (!dStr) return null;
    const d = new Date(dStr);
    return isNaN(d) ? null : d;
  }

  function formatDate(d) {
    if (!d) return '‚Äî';
    const dd = String(d.getDate()).padStart(2, '0');
    const mm = String(d.getMonth() + 1).padStart(2, '0');
    const yy = d.getFullYear();
    return `${dd}/${mm}/${yy}`;
  }

  async function cargarDashboard() {
    const { data: instrumentos, error } = await supabase
      .from('instrumentos')
      .select('codigo_interno, estado, ubicacion, proxima_calibracion_est, fecha_ultima_calibracion_est');

    if (error) {
      console.error('Error cargando instrumentos', error);
      return;
    }

    const hoy = new Date();
    const en30 = new Date();
    en30.setDate(hoy.getDate() + 30);

    const total = instrumentos.length;

    let enLab = 0;
    let enUso = 0;
    let calibrados = 0;
    let fueraCal = 0;
    let proximosCount = 0;

    const fueraLista = [];
    const proximosLista = [];

    instrumentos.forEach(inst => {
      const ubic = (inst.ubicacion || '').trim();
      const estado = (inst.estado || '').trim();

      if (ubic === 'Laboratorio') enLab++;
      else enUso++;

      if (estado === 'Calibrado') calibrados++;
      if (estado === 'Fuera de calibraci√≥n') fueraCal++;

      const prox = parseDate(inst.proxima_calibracion_est);
      if (prox) {
        // Si ya est√° vencida, lo consideramos fuera de calibraci√≥n tambi√©n
        if (prox < hoy) {
          if (!fueraLista.some(i => i.codigo_interno === inst.codigo_interno)) {
            fueraLista.push({ ...inst, proxDate: prox });
          }
        } else if (prox >= hoy && prox <= en30) {
          proximosLista.push({ ...inst, proxDate: prox });
        }
      }
    });

    // KPIs num√©ricos
    const pct = (parte, total) => total > 0 ? Math.round((parte / total) * 100) : 0;

    elTotal.textContent = total || '0';

    elUso.textContent = enUso;
    elUsoExtra.textContent = total ? `${pct(enUso, total)}% del total` : '';

    elLab.textContent = enLab;
    elLabExtra.textContent = total ? `${pct(enLab, total)}% del total` : '';

    elCal.textContent = calibrados;
    elCalExtra.textContent = total ? `${pct(calibrados, total)}% calibrados` : '';

    // Recalcular fuera / pr√≥ximos utilizando listas calculadas
    fueraCal = fueraLista.length;
    proximosCount = proximosLista.length;

    elProx.textContent = proximosCount;
    elProxExtra.textContent = total ? `${pct(proximosCount, total)}% del total` : '';

    elFuera.textContent = fueraCal;
    elFueraExtra.textContent = total ? `${pct(fueraCal, total)}% del total` : '';

    // Alertas - ordenar por fecha
    fueraLista.sort((a, b) => a.proxDate - b.proxDate);
    proximosLista.sort((a, b) => a.proxDate - b.proxDate);

    // Pintar tablas
    tbodyFuera.innerHTML = '';
    tbodyProx.innerHTML = '';

    fueraLista.forEach(inst => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${inst.codigo_interno || ''}</td>
        <td>${inst.ubicacion || ''}</td>
        <td>${formatDate(inst.proxDate)}</td>
        <td>
          <a class="link-btn" href="alta_instrumento.html?codigo=${encodeURIComponent(inst.codigo_interno || '')}">
            Ver
          </a>
        </td>
      `;
      tbodyFuera.appendChild(tr);
    });

    proximosLista.forEach(inst => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${inst.codigo_interno || ''}</td>
        <td>${inst.ubicacion || ''}</td>
        <td>${formatDate(inst.proxDate)}</td>
        <td>
          <a class="link-btn" href="alta_instrumento.html?codigo=${encodeURIComponent(inst.codigo_interno || '')}">
            Ver
          </a>
        </td>
      `;
      tbodyProx.appendChild(tr);
    });

    badgeFuera.textContent = fueraCal;
    badgeProx.textContent = proximosCount;

    msgFuera.style.display = fueraCal === 0 ? 'block' : 'none';
    msgProx.style.display = proximosCount === 0 ? 'block' : 'none';
  }

  cargarDashboard();
</script>

</body>
</html>
