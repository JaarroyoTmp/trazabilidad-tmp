<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TMP ¬∑ Trazabilidad Metrol√≥gica</title>

  <style>
    :root{
      --bg:#0d1117;
      --panel:#161b22;
      --txt:#f0f6fc;
      --muted:#8b949e;
      --border:#30363d;
      --card-bg:#1c2431;
      --hover:#263041;
      --accent:#00b4d8;
      --danger:#b91c1c;
      --warning:#f59e0b;
      --success:#22c55e;
    }

    body{
      margin:0;
      font-family:system-ui,-apple-system,"Segoe UI",Roboto;
      background:var(--bg);
      color:var(--txt);
    }

    header{
      background:var(--panel);
      border-bottom:1px solid var(--border);
      padding:16px 20px;
      display:flex;
      align-items:center;
      justify-content:space-between;
    }

    .brand{
      display:flex;
      align-items:center;
      gap:12px;
    }
    .brand img{
      height:46px;
    }
    .brand h1{
      margin:0;
      font-size:20px;
    }
    .brand span{
      font-size:13px;
      color:var(--muted);
    }

    main{
      max-width:1100px;
      margin:26px auto;
      padding:0 18px;
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(260px,1fr));
      gap:18px;
    }

    /* Bloques superiores */
    .kpi-section,
    .alerts-section{
      grid-column:1 / -1;
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:14px;
      padding:18px 18px 16px;
    }

    .section-title{
      margin:0 0 8px;
      font-size:18px;
      font-weight:600;
      color:var(--accent);
    }

    .muted{
      font-size:13px;
      color:var(--muted);
      margin:0 0 12px;
    }

    /* KPIs */
    .kpi-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(150px,1fr));
      gap:10px;
    }

    .kpi-card{
      background:var(--card-bg);
      border-radius:10px;
      border:1px solid var(--border);
      padding:10px 12px;
      transition:all .3s ease;
    }

    .kpi-card.updated {
      background:#113344;
      box-shadow:0 0 12px rgba(0,180,216,.4);
    }

    .kpi-label{
      font-size:12px;
      color:var(--muted);
      margin-bottom:4px;
    }

    .kpi-value{
      font-size:20px;
      font-weight:700;
      line-height:1.1;
    }

    .kpi-extra{
      margin-top:4px;
      font-size:12px;
      color:var(--muted);
    }

    /* Alertas */
    .alerts-columns{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(260px,1fr));
      gap:14px;
      margin-top:8px;
    }

    .alerts-box{
      background:var(--card-bg);
      border-radius:10px;
      border:1px solid var(--border);
      padding:10px 12px 12px;
    }

    .alerts-title{
      display:flex;
      align-items:center;
      gap:6px;
      margin:0 0 6px;
      font-size:15px;
      font-weight:600;
    }

    .alerts-title span.badge{
      font-size:11px;
      padding:2px 6px;
      border-radius:999px;
      border:1px solid var(--border);
      color:var(--muted);
    }

    .badge-danger{
      border-color:var(--danger);
      color:var(--danger);
      animation:blink 1.6s infinite;
    }
    .badge-warning{
      border-color:var(--warning);
      color:var(--warning);
    }

    @keyframes blink {
      0%, 100% { opacity:1; }
      50% { opacity:.35; }
    }

    .alerts-table{
      width:100%;
      border-collapse:collapse;
      font-size:12px;
    }

    .alerts-table th,
    .alerts-table td{
      padding:4px 6px;
      border-bottom:1px solid var(--border);
      text-align:left;
      white-space:nowrap;
    }

    .alerts-table thead{
      background:#111827;
    }

    .alerts-table tbody tr:nth-child(even){
      background:#111827;
    }

    .link-btn{
      display:inline-flex;
      padding:3px 8px;
      border-radius:999px;
      border:1px solid var(--border);
      font-size:11px;
      text-decoration:none;
      background:#111827;
      color:var(--txt);
    }

    .link-btn:hover{
      background:var(--hover);
    }

    /* Tarjetas */
    .card{
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:14px;
      padding:20px 18px;
      text-decoration:none;
      color:var(--txt);
      display:flex;
      flex-direction:column;
      gap:8px;
      transition:0.15s;
    }

    .card:hover{
      background:var(--hover);
      transform:translateY(-2px);
    }

    .card-title{
      font-size:18px;
      font-weight:600;
      color:var(--accent);
    }

    .card-desc{
      font-size:14px;
      color:var(--muted);
      line-height:1.3;
    }

    footer{
      grid-column:1 / -1;
      text-align:center;
      margin-top:10px;
      padding-bottom:20px;
      font-size:13px;
      color:var(--muted);
    }
  </style>
</head>

<body>

<header>
  <div class="brand">
    <img src="img/tmp-quality.png" alt="TMP">
    <div>
      <h1>TMP ¬∑ Control Metrol√≥gico</h1>
      <span>Trazabilidad ¬∑ Instrumentos ¬∑ Laboratorio</span>
    </div>
  </div>
</header>

<main>

  <!-- KPIs -->
  <section class="kpi-section">
    <h2 class="section-title">Resumen del laboratorio</h2>
    <p class="muted">Indicadores calculados en tiempo real desde Supabase.</p>

    <div class="kpi-grid">

      <div class="kpi-card" id="kpi-card-total">
        <div class="kpi-label">Instrumentos totales</div>
        <div class="kpi-value" id="kpi-total">‚Äì</div>
        <div class="kpi-extra" id="kpi-total-extra"></div>
      </div>

      <div class="kpi-card" id="kpi-card-uso">
        <div class="kpi-label">En uso (fuera de laboratorio)</div>
        <div class="kpi-value" id="kpi-uso">‚Äì</div>
        <div class="kpi-extra" id="kpi-uso-extra"></div>
      </div>

      <div class="kpi-card" id="kpi-card-lab">
        <div class="kpi-label">En laboratorio</div>
        <div class="kpi-value" id="kpi-lab">‚Äì</div>
        <div class="kpi-extra" id="kpi-lab-extra"></div>
      </div>

      <div class="kpi-card" id="kpi-card-cal">
        <div class="kpi-label">Calibrados</div>
        <div class="kpi-value" id="kpi-calibrados">‚Äì</div>
        <div class="kpi-extra" id="kpi-calibrados-extra"></div>
      </div>

      <div class="kpi-card" id="kpi-card-prox">
        <div class="kpi-label">Pr√≥ximos (&lt; 30 d√≠as)</div>
        <div class="kpi-value" id="kpi-proximos">‚Äì</div>
        <div class="kpi-extra" id="kpi-proximos-extra"></div>
      </div>

      <div class="kpi-card" id="kpi-card-fuera">
        <div class="kpi-label">Fuera de calibraci√≥n</div>
        <div class="kpi-value" id="kpi-fuera">‚Äì</div>
        <div class="kpi-extra" id="kpi-fuera-extra"></div>
      </div>

    </div>
  </section>

  <!-- ALERTAS -->
  <section class="alerts-section">
    <h2 class="section-title">Alertas de calibraci√≥n</h2>
    <p class="muted">Estados cr√≠ticos detectados autom√°ticamente.</p>

    <div class="alerts-columns">

      <div class="alerts-box">
        <h3 class="alerts-title">
          ‚ùå Fuera de calibraci√≥n
          <span class="badge badge-danger" id="badge-fuera-count">0</span>
        </h3>
        <table class="alerts-table">
          <thead>
            <tr>
              <th>C√≥digo</th>
              <th>Ubicaci√≥n</th>
              <th>Pr√≥xima</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="tbody-fuera"></tbody>
        </table>
      </div>

      <div class="alerts-box">
        <h3 class="alerts-title">
          ‚ö†Ô∏è Pr√≥ximos (&lt; 30 d√≠as)
          <span class="badge badge-warning" id="badge-prox-count">0</span>
        </h3>

        <table class="alerts-table">
          <thead>
            <tr>
              <th>C√≥digo</th>
              <th>Ubicaci√≥n</th>
              <th>Pr√≥xima</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="tbody-prox"></tbody>
        </table>
      </div>

    </div>
  </section>

  <!-- Tarjetas navegaci√≥n -->
  <a class="card" href="alta_instrumento.html">
    <div class="card-title">‚ûï Alta / Edici√≥n</div>
    <div class="card-desc">Registrar instrumentos, editar fichas, generar QR y gestionar estados.</div>
  </a>

  <a class="card" href="movimiento.html">
    <div class="card-title">üîÑ Movimientos</div>
    <div class="card-desc">Registrar entradas, salidas, ubicaciones y responsables.</div>
  </a>

  <a class="card" href="qr/qr.index.html">
    <div class="card-title">üè∑ Generar QR</div>
    <div class="card-desc">Crear c√≥digos QR para identificaci√≥n r√°pida y trazabilidad.</div>
  </a>

  <a class="card" href="TMP_Calibraciones_Lab.html">
    <div class="card-title">üìè Calibraciones Lab</div>
    <div class="card-desc">Gesti√≥n de calibraciones internas del laboratorio TMP.</div>
  </a>

  <a class="card" href="App_Patrones_TMP.html">
    <div class="card-title">üìê Patrones</div>
    <div class="card-desc">Inventario y control de patrones del laboratorio.</div>
  </a>

  <a class="card" href="App_Familias_TMP.html">
    <div class="card-title">üß© Familias</div>
    <div class="card-desc">Clasificaci√≥n y agrupaci√≥n de instrumentos TMP.</div>
  </a>

  <a class="card" href="App_Tipos_TMP.html">
    <div class="card-title">üóÇ Tipos de Instrumentos</div>
    <div class="card-desc">Gesti√≥n de tipos y categor√≠as t√©cnicas.</div>
  </a>

  <a class="card" href="criterios.html">
    <div class="card-title">üìò Criterios de Aceptaci√≥n</div>
    <div class="card-desc">Requisitos metrol√≥gicos TMP: aceptaci√≥n interna y externa. Documento clave para auditor√≠as.</div>
  </a>

  <!-- NUEVO: Acceso al panel de alcance -->
  <a class="card" href="alcance_kpi.html">
    <div class="card-title">üìä Alcance Laboratorio & KPIs</div>
    <div class="card-desc">
      Magnitudes cubiertas, rangos, resoluciones y visi√≥n general del laboratorio TMP.
    </div>
  </a>

  <footer>
    Talleres Mec√°nicos Paramio ¬∑ Sistema de Trazabilidad Metrol√≥gica ¬∑ 2025
  </footer>

</main>

<!-- SUPABASE -->
<script type="module" src="config.mjs"></script>

<script type="module">
/* EXACTO COMO T√ö LO TEN√çAS ‚Äì NO LO MODIFICO */

const supabase = window.supabase;

/* ‚Ä¶ TODA TU L√ìGICA DE KPIs, ALERTAS Y AUTO-REFRESCO ‚Ä¶ (no la borro) */

async function cargarDashboard() {

  const { data: instrumentos, error } = await supabase
    .from("instrumentos")
    .select("codigo, estado, ubicacion_actual, proxima_calibracion");

  if (error) return;

  const total = instrumentos.length;

  let enLab = 0, enUso = 0, calibrados = 0;
  const fueraLista = [];
  const proxLista = [];

  const hoy = new Date();
  const mas30 = new Date();
  mas30.setDate(hoy.getDate() + 30);

  instrumentos.forEach(inst => {
    const ubic = (inst.ubicacion_actual || "").toLowerCase();
    if (ubic === "laboratorio") enLab++;
    else enUso++;

    if ((inst.estado || "").toLowerCase() === "calibrado") calibrados++;

    const prox = inst.proxima_calibracion ? new Date(inst.proxima_calibracion) : null;
    if (prox) {
      if (prox < hoy) fueraLista.push(inst);
      else if (prox <= mas30) proxLista.push(inst);
    }
  });

  document.getElementById("kpi-total").textContent = total;
  document.getElementById("kpi-uso").textContent = enUso;
  document.getElementById("kpi-lab").textContent = enLab;
  document.getElementById("kpi-calibrados").textContent = calibrados;
  document.getElementById("kpi-proximos").textContent = proxLista.length;
  document.getElementById("kpi-fuera").textContent = fueraLista.length;

  document.getElementById("tbody-fuera").innerHTML = fueraLista.map(i => `
    <tr>
      <td>${i.codigo}</td>
      <td>${i.ubicacion_actual || ""}</td>
      <td>${i.proxima_calibracion ? new Date(i.proxima_calibracion).toLocaleDateString() : "‚Äî"}</td>
      <td>
        <a class="link-btn" href="alta_instrumento.html?codigo=${i.codigo}">
          Ver
        </a>
      </td>
    </tr>
  `).join("");

  document.getElementById("tbody-prox").innerHTML = proxLista.map(i => `
    <tr>
      <td>${i.codigo}</td>
      <td>${i.ubicacion_actual || ""}</td>
      <td>${i.proxima_calibracion ? new Date(i.proxima_calibracion).toLocaleDateString() : "‚Äî"}</td>
      <td>
        <a class="link-btn" href="alta_instrumento.html?codigo=${i.codigo}">
          Ver
        </a>
      </td>
    </tr>
  `).join("");

  document.getElementById("badge-fuera-count").textContent = fueraLista.length;
  document.getElementById("badge-prox-count").textContent = proxLista.length;
}

cargarDashboard();
setInterval(cargarDashboard, 30000);
</script>

</body>
</html>
