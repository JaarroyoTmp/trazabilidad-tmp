<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TMP ¬∑ Trazabilidad Metrol√≥gica</title>

  <style>
    :root{
      --bg:#0d1117;
      --panel:#161b22;
      --txt:#f0f6fc;
      --muted:#8b949e;
      --border:#30363d;
      --card-bg:#1c2431;
      --hover:#263041;
      --accent:#00b4d8;

      --danger:#dc2626;
      --warning:#f59e0b;
      --success:#22c55e;
    }

    *{box-sizing:border-box;}

    body{
      margin:0;
      font-family:system-ui,-apple-system,"Segoe UI",Roboto;
      background:var(--bg);
      color:var(--txt);
    }

    /* HEADER */
    header{
      background:var(--panel);
      border-bottom:1px solid var(--border);
      padding:16px 20px;
      display:flex;
      align-items:center;
      justify-content:space-between;
    }

    .brand{
      display:flex;
      align-items:center;
      gap:12px;
    }
    .brand img{
      height:46px;
    }
    .brand h1{
      margin:0;
      font-size:20px;
    }
    .brand span{
      font-size:13px;
      color:var(--muted);
    }

    .header-actions{
      display:flex;
      gap:10px;
      align-items:center;
    }

    .btn-refresh{
      border-radius:999px;
      border:1px solid var(--border);
      background:#111827;
      color:var(--txt);
      font-size:12px;
      padding:7px 12px;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    .btn-refresh:hover{background:var(--hover);}

    .small-badge{
      font-size:11px;
      color:var(--muted);
    }

    /* GRID PRINCIPAL */
    main{
      max-width:1100px;
      margin:26px auto;
      padding:0 18px;
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(260px,1fr));
      gap:18px;
    }

    /* SECCIONES GRANDES */
    .kpi-section,
    .alerts-section{
      grid-column:1 / -1;
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:14px;
      padding:18px 18px 16px;
      animation:fadeIn .5s ease both;
    }

    .section-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      margin-bottom:4px;
    }

    .section-title{
      margin:0;
      font-size:18px;
      font-weight:600;
      color:var(--accent);
    }

    .muted{
      font-size:13px;
      color:var(--muted);
      margin:0 0 12px;
    }

    /* KPIs */
    .kpi-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(150px,1fr));
      gap:10px;
    }

    .kpi-card{
      background:var(--card-bg);
      border-radius:10px;
      border:1px solid var(--border);
      padding:10px 12px;
      animation:fadeInUp .4s ease both;
    }

    .kpi-label{
      font-size:12px;
      color:var(--muted);
      margin-bottom:4px;
    }

    .kpi-value{
      font-size:22px;
      font-weight:700;
      line-height:1.1;
    }

    .kpi-extra{
      margin-top:4px;
      font-size:12px;
      color:var(--muted);
    }

    /* ALERTAS */
    .alerts-columns{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(260px,1fr));
      gap:14px;
      margin-top:8px;
    }

    .alerts-box{
      background:var(--card-bg);
      border-radius:10px;
      border:1px solid var(--border);
      padding:10px 12px 12px;
    }

    .alerts-title{
      display:flex;
      align-items:center;
      gap:6px;
      margin:0 0 6px;
      font-size:15px;
      font-weight:600;
    }

    .alerts-title span.badge{
      font-size:11px;
      padding:2px 6px;
      border-radius:999px;
      border:1px solid var(--border);
      color:var(--muted);
    }

    .badge-danger{
      border-color:var(--danger);
      color:var(--danger);
    }
    .badge-warning{
      border-color:var(--warning);
      color:var(--warning);
    }

    .alerts-table{
      width:100%;
      border-collapse:collapse;
      font-size:12px;
    }
    .alerts-table thead{
      background:#111827;
    }
    .alerts-table th,
    .alerts-table td{
      padding:4px 6px;
      border-bottom:1px solid var(--border);
      text-align:left;
      white-space:nowrap;
    }
    .alerts-table tbody tr:nth-child(even){
      background:#111827;
    }

    .link-btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:3px 8px;
      border-radius:999px;
      border:1px solid var(--border);
      font-size:11px;
      color:var(--txt);
      text-decoration:none;
      background:#111827;
    }
    .link-btn:hover{
      background:var(--hover);
    }

    .empty-msg{
      font-size:12px;
      color:var(--muted);
      margin-top:2px;
    }

    /* TARJETAS / MEN√ö PRINCIPAL */
    .card{
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:14px;
      padding:20px 18px;
      text-decoration:none;
      color:var(--txt);
      display:flex;
      flex-direction:column;
      gap:8px;
      transition:0.15s;
      animation:fadeInUp .5s ease both;
    }

    .card:hover{
      background:var(--hover);
      transform:translateY(-2px);
    }

    .card-title{
      font-size:18px;
      font-weight:600;
      color:var(--accent);
    }

    .card-desc{
      font-size:14px;
      color:var(--muted);
      line-height:1.3;
    }

    footer{
      text-align:center;
      margin-top:30px;
      padding-bottom:20px;
      font-size:13px;
      color:var(--muted);
    }

    /* TOASTS */
    #toast-container{
      position:fixed;
      top:16px;
      right:16px;
      display:flex;
      flex-direction:column;
      gap:8px;
      z-index:9999;
    }
    .toast{
      min-width:220px;
      max-width:320px;
      padding:10px 14px;
      border-radius:10px;
      font-size:13px;
      color:#f9fafb;
      box-shadow:0 10px 20px rgba(0,0,0,.45);
      opacity:0;
      transform:translateX(16px);
      animation:toastIn .25s ease forwards;
      display:flex;
      align-items:flex-start;
      gap:8px;
    }
    .toast-info{background:#0ea5e9;}
    .toast-success{background:#16a34a;}
    .toast-warning{background:#facc15;color:#111827;}
    .toast-danger{background:#b91c1c;}

    .toast-close{
      margin-left:auto;
      cursor:pointer;
      font-weight:bold;
      font-size:14px;
      opacity:.8;
    }
    .toast-close:hover{opacity:1;}

    /* ANIMACIONES */
    @keyframes fadeIn {
      from {opacity:0; transform:translateY(6px);}
      to   {opacity:1; transform:translateY(0);}
    }
    @keyframes fadeInUp {
      from {opacity:0; transform:translateY(18px);}
      to   {opacity:1; transform:translateY(0);}
    }
    @keyframes toastIn {
      from {opacity:0; transform:translateX(16px);}
      to   {opacity:1; transform:translateX(0);}
    }

    /* Parpadeo filas cr√≠ticas */
    .row-danger{
      animation:blinkDanger 1.2s infinite;
    }
    .row-warning{
      animation:blinkWarn 1.6s infinite;
    }
    @keyframes blinkDanger{
      0%,100%{background:transparent;}
      50%{background:rgba(220,38,38,0.22);}
    }
    @keyframes blinkWarn{
      0%,100%{background:transparent;}
      50%{background:rgba(234,179,8,0.18);}
    }

    @media (max-width:640px){
      header{
        flex-direction:column;
        align-items:flex-start;
        gap:10px;
      }
      .header-actions{
        width:100%;
        justify-content:space-between;
      }
    }
  </style>
</head>
<body>

<header>
  <div class="brand">
    <img src="img/tmp-quality.png" alt="TMP">
    <div>
      <h1>TMP ¬∑ Control Metrol√≥gico</h1>
      <span>Trazabilidad ¬∑ Instrumentos ¬∑ Laboratorio</span>
    </div>
  </div>
  <div class="header-actions">
    <button class="btn-refresh" id="btn-refresh">
      üîÑ Actualizar ahora
    </button>
    <span class="small-badge" id="last-update">√öltima actualizaci√≥n: ‚Äî</span>
  </div>
</header>

<main>

  <!-- PANEL DE KPIs LABORATORIO -->
  <section class="kpi-section">
    <div class="section-header">
      <h2 class="section-title">Resumen del laboratorio</h2>
    </div>
    <p class="muted">
      Indicadores calculados en tiempo real a partir de la tabla <code>instrumentos</code> de Supabase.
      Un equipo se considera <b>en uso</b> si su ubicaci√≥n actual es distinta de <code>Laboratorio</code>.
    </p>

    <div class="kpi-grid">
      <div class="kpi-card">
        <div class="kpi-label">Instrumentos totales</div>
        <div class="kpi-value" id="kpi-total">‚Äì</div>
        <div class="kpi-extra" id="kpi-total-extra"></div>
      </div>

      <div class="kpi-card">
        <div class="kpi-label">En uso (fuera de laboratorio)</div>
        <div class="kpi-value" id="kpi-uso">‚Äì</div>
        <div class="kpi-extra" id="kpi-uso-extra"></div>
      </div>

      <div class="kpi-card">
        <div class="kpi-label">En laboratorio</div>
        <div class="kpi-value" id="kpi-lab">‚Äì</div>
        <div class="kpi-extra" id="kpi-lab-extra"></div>
      </div>

      <div class="kpi-card">
        <div class="kpi-label">Calibrados (estado = ‚ÄúCalibrado‚Äù)</div>
        <div class="kpi-value" id="kpi-calibrados">‚Äì</div>
        <div class="kpi-extra" id="kpi-calibrados-extra"></div>
      </div>

      <div class="kpi-card">
        <div class="kpi-label">Pr√≥ximos a calibrar (&lt; 30 d√≠as)</div>
        <div class="kpi-value" id="kpi-proximos">‚Äì</div>
        <div class="kpi-extra" id="kpi-proximos-extra"></div>
      </div>

      <div class="kpi-card">
        <div class="kpi-label">Fuera de calibraci√≥n</div>
        <div class="kpi-value" id="kpi-fuera">‚Äì</div>
        <div class="kpi-extra" id="kpi-fuera-extra"></div>
      </div>
    </div>
  </section>

  <!-- ALERTAS OPERATIVAS -->
  <section class="alerts-section">
    <div class="section-header">
      <h2 class="section-title">Alertas de calibraci√≥n</h2>
    </div>
    <p class="muted">
      Equipos fuera de calibraci√≥n y pr√≥ximos a vencer. Desde aqu√≠ se puede ir directo a la ficha del instrumento
      para planificar su calibraci√≥n o retirada de uso.
    </p>

    <div class="alerts-columns">

      <!-- Fuera de calibraci√≥n -->
      <div class="alerts-box">
        <h3 class="alerts-title">
          ‚ùå Fuera de calibraci√≥n
          <span class="badge badge-danger" id="badge-fuera-count">0</span>
        </h3>
        <table class="alerts-table">
          <thead>
            <tr>
              <th>C√≥digo</th>
              <th>Ubicaci√≥n</th>
              <th>Pr√≥xima</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="tbody-fuera"></tbody>
        </table>
        <div class="empty-msg" id="msg-fuera" style="display:none;">
          No hay instrumentos fuera de calibraci√≥n.
        </div>
      </div>

      <!-- Pr√≥ximos -->
      <div class="alerts-box">
        <h3 class="alerts-title">
          ‚ö†Ô∏è Pr√≥ximos (&lt; 30 d√≠as)
          <span class="badge badge-warning" id="badge-prox-count">0</span>
        </h3>
        <table class="alerts-table">
          <thead>
            <tr>
              <th>C√≥digo</th>
              <th>Ubicaci√≥n</th>
              <th>Pr√≥xima</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="tbody-prox"></tbody>
        </table>
        <div class="empty-msg" id="msg-prox" style="display:none;">
          No hay instrumentos pr√≥ximos a calibrar en los pr√≥ximos 30 d√≠as.
        </div>
      </div>

    </div>
  </section>

  <!-- TARJETAS / BOTONES EXISTENTES -->
  <a class="card" href="alta_instrumento.html">
    <div class="card-title">‚ûï Alta / Edici√≥n</div>
    <div class="card-desc">Registrar instrumentos, editar fichas, generar QR y gestionar estados.</div>
  </a>

  <a class="card" href="movimiento.html">
    <div class="card-title">üîÑ Movimientos</div>
    <div class="card-desc">Registrar entradas, salidas, ubicaciones y responsables.</div>
  </a>

  <a class="card" href="qr/qr.index.html">
    <div class="card-title">üè∑ Generar QR</div>
    <div class="card-desc">Crear c√≥digos QR para identificaci√≥n r√°pida y trazabilidad.</div>
  </a>

  <a class="card" href="TMP_Calibraciones_Lab.html">
    <div class="card-title">üìè Calibraciones Lab</div>
    <div class="card-desc">Gesti√≥n de calibraciones internas del laboratorio TMP.</div>
  </a>

  <a class="card" href="App_Patrones_TMP.html">
    <div class="card-title">üìê Patrones</div>
    <div class="card-desc">Inventario y control de patrones del laboratorio.</div>
  </a>

  <a class="card" href="App_Familias_TMP.html">
    <div class="card-title">üß© Familias</div>
    <div class="card-desc">Clasificaci√≥n y agrupaci√≥n de instrumentos TMP.</div>
  </a>

  <a class="card" href="App_Tipos_TMP.html">
    <div class="card-title">üóÇ Tipos de Instrumentos</div>
    <div class="card-desc">Gesti√≥n de tipos y categor√≠as t√©cnicas.</div>
  </a>

  <a class="card" href="criterios.html">
    <div class="card-title">üìò Criterios de Aceptaci√≥n</div>
    <div class="card-desc">Requisitos metrol√≥gicos TMP: aceptaci√≥n interna y externa. Documento clave para auditor√≠as.</div>
  </a>

  <a class="card" href="alcance_kpi.html">
    <div class="card-title">üìä Alcance Laboratorio & KPIs</div>
    <div class="card-desc">Magnitudes cubiertas, rangos y panel de indicadores del laboratorio TMP.</div>
  </a>

</main>

<footer>
  Talleres Mec√°nicos Paramio ¬∑ Sistema de Trazabilidad Metrol√≥gica ¬∑ 2025
</footer>

<!-- Contenedor de notificaciones -->
<div id="toast-container"></div>

<!-- Cliente Supabase -->
<script type="module" src="config.mjs"></script>
<script type="module">
  const supabase = window.supabase;

  const elTotal = document.getElementById('kpi-total');
  const elTotalExtra = document.getElementById('kpi-total-extra');
  const elUso = document.getElementById('kpi-uso');
  const elUsoExtra = document.getElementById('kpi-uso-extra');
  const elLab = document.getElementById('kpi-lab');
  const elLabExtra = document.getElementById('kpi-lab-extra');
  const elCal = document.getElementById('kpi-calibrados');
  const elCalExtra = document.getElementById('kpi-calibrados-extra');
  const elProx = document.getElementById('kpi-proximos');
  const elProxExtra = document.getElementById('kpi-proximos-extra');
  const elFuera = document.getElementById('kpi-fuera');
  const elFueraExtra = document.getElementById('kpi-fuera-extra');

  const tbodyFuera = document.getElementById('tbody-fuera');
  const tbodyProx = document.getElementById('tbody-prox');
  const badgeFuera = document.getElementById('badge-fuera-count');
  const badgeProx = document.getElementById('badge-prox-count');
  const msgFuera = document.getElementById('msg-fuera');
  const msgProx = document.getElementById('msg-prox');

  const btnRefresh = document.getElementById('btn-refresh');
  const lastUpdateEl = document.getElementById('last-update');

  /* ========== TOASTS ========== */
  function showToast(message, type="info", timeout=3500){
    const cont = document.getElementById('toast-container');
    const div = document.createElement('div');
    div.className = `toast toast-${type}`;
    div.innerHTML = `<span>${message}</span><span class="toast-close">√ó</span>`;
    cont.appendChild(div);

    const closer = div.querySelector('.toast-close');
    closer.onclick = () => {
      div.style.opacity = '0';
      div.style.transform = 'translateX(16px)';
      setTimeout(()=>div.remove(), 250);
    };

    setTimeout(()=>{
      if (!document.body.contains(div)) return;
      div.style.opacity = '0';
      div.style.transform = 'translateX(16px)';
      setTimeout(()=>div.remove(), 250);
    }, timeout);
  }

  /* ========== UTILIDADES FECHAS / PORCENTAJE ========== */
  function parseDate(dStr){
    if (!dStr) return null;
    const d = new Date(dStr);
    return isNaN(d) ? null : d;
  }

  function formatDate(d){
    if (!d) return '‚Äî';
    const dd = String(d.getDate()).padStart(2,'0');
    const mm = String(d.getMonth()+1).padStart(2,'0');
    const yy = d.getFullYear();
    return `${dd}/${mm}/${yy}`;
  }

  function pct(part, total){
    return total > 0 ? Math.round((part/total)*100) : 0;
  }

  function animateCount(el, value){
    const end = Number(value) || 0;
    let current = 0;
    const step = Math.max(1, Math.round(end / 30));
    const interval = setInterval(()=>{
      current += step;
      if (current >= end){
        current = end;
        clearInterval(interval);
      }
      el.textContent = current;
    }, 20);
  }

  function updateLastUpdate(){
    const now = new Date();
    const hh = String(now.getHours()).padStart(2,'0');
    const mm = String(now.getMinutes()).padStart(2,'0');
    const ss = String(now.getSeconds()).padStart(2,'0');
    lastUpdateEl.textContent = `√öltima actualizaci√≥n: ${formatDate(now)} ${hh}:${mm}:${ss}`;
  }

  /* ========== DASHBOARD ========== */
  async function cargarDashboard(showToasts=true){
    if (!supabase){
      console.error("Supabase no est√° disponible (revisa config.mjs)");
      if (showToasts) showToast("Supabase no est√° disponible", "danger");
      return;
    }

    if (showToasts) showToast("Actualizando datos del laboratorio‚Ä¶","info",2500);

    const { data: instrumentos, error } = await supabase
      .from('instrumentos')
      .select('codigo, descripcion, estado, ubicacion_actual, proxima_calibracion, fecha_ultima_calibracion');

    if (error){
      console.error(error);
      if (showToasts) showToast("Error consultando instrumentos en Supabase","danger");
      return;
    }

    const hoy = new Date();
    const en30 = new Date();
    en30.setDate(hoy.getDate() + 30);

    const total = instrumentos.length;
    let enLab = 0;
    let enUso = 0;
    let calibrados = 0;
    const fueraLista = [];
    const proximosLista = [];

    instrumentos.forEach(inst=>{
      const ubic = (inst.ubicacion_actual || '').trim();
      const estado = (inst.estado || '').trim();
      const prox = parseDate(inst.proxima_calibracion);

      // Regla: Laboratorio => NO en uso
      if (ubic === 'Laboratorio') enLab++;
      else enUso++;

      if (estado === 'Calibrado') calibrados++;

      if (prox){
        if (prox < hoy){
          fueraLista.push({ ...inst, proxDate: prox });
        }else if (prox >= hoy && prox <= en30){
          proximosLista.push({ ...inst, proxDate: prox });
        }
      }
    });

    // KPIs
    animateCount(elTotal, total);
    elTotalExtra.textContent = total ? 'Instrumentos registrados en el sistema' : '';

    animateCount(elUso, enUso);
    elUsoExtra.textContent = total ? `${pct(enUso,total)}% del total` : '';

    animateCount(elLab, enLab);
    elLabExtra.textContent = total ? `${pct(enLab,total)}% del total` : '';

    animateCount(elCal, calibrados);
    elCalExtra.textContent = total ? `${pct(calibrados,total)}% con estado "Calibrado"` : '';

    animateCount(elProx, proximosLista.length);
    elProxExtra.textContent = total ? `${pct(proximosLista.length,total)}% del total` : '';

    animateCount(elFuera, fueraLista.length);
    elFueraExtra.textContent = total ? `${pct(fueraLista.length,total)}% del total` : '';

    // Tablas de alertas
    tbodyFuera.innerHTML = '';
    tbodyProx.innerHTML = '';

    fueraLista.sort((a,b)=>a.proxDate - b.proxDate);
    proximosLista.sort((a,b)=>a.proxDate - b.proxDate);

    fueraLista.forEach(inst=>{
      const tr = document.createElement('tr');
      tr.classList.add('row-danger');
      tr.innerHTML = `
        <td>${inst.codigo || ''}</td>
        <td>${inst.ubicacion_actual || ''}</td>
        <td>${formatDate(inst.proxDate)}</td>
        <td><a class="link-btn" href="alta_instrumento.html?codigo=${encodeURIComponent(inst.codigo || '')}">Ver</a></td>
      `;
      tbodyFuera.appendChild(tr);
    });

    proximosLista.forEach(inst=>{
      const tr = document.createElement('tr');
      tr.classList.add('row-warning');
      tr.innerHTML = `
        <td>${inst.codigo || ''}</td>
        <td>${inst.ubicacion_actual || ''}</td>
        <td>${formatDate(inst.proxDate)}</td>
        <td><a class="link-btn" href="alta_instrumento.html?codigo=${encodeURIComponent(inst.codigo || '')}">Ver</a></td>
      `;
      tbodyProx.appendChild(tr);
    });

    badgeFuera.textContent = fueraLista.length;
    badgeProx.textContent = proximosLista.length;

    msgFuera.style.display = fueraLista.length === 0 ? 'block' : 'none';
    msgProx.style.display = proximosLista.length === 0 ? 'block' : 'none';

    updateLastUpdate();

    if (showToasts){
      showToast("Panel actualizado correctamente","success");
      if (fueraLista.length > 0){
        showToast(`Hay ${fueraLista.length} instrumento(s) fuera de calibraci√≥n`,"danger",4000);
      }
      if (proximosLista.length > 0){
        showToast(`Hay ${proximosLista.length} instrumento(s) pr√≥ximos a calibrar`,"warning",4000);
      }
    }
  }

  // Eventos
  btnRefresh.addEventListener('click', ()=>cargarDashboard(true));

  // Primera carga
  cargarDashboard(true);

  // Auto-refresco cada 60 segundos
  setInterval(()=>cargarDashboard(false), 60000);
</script>

</body>
</html>

